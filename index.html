<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Richard Yang, Java Developer, Senior software engineer" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Nothing seek, nothing find">
<meta property="og:type" content="website">
<meta property="og:title" content="Richard Yang">
<meta property="og:url" content="https://richyang.me/index.html">
<meta property="og:site_name" content="Richard Yang">
<meta property="og:description" content="Nothing seek, nothing find">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Richard Yang">
<meta name="twitter:description" content="Nothing seek, nothing find">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    },
    algolia: {
      applicationID: 'X0H1P7HDKY',
      apiKey: 'ddc0af00a6e07c9b1be9f4da4cf5b9d9',
      indexName: 'richyang.me',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>




  <title> Richard Yang </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <!--span class="logo-line-before"><i></i></span-->
      <span class="site-title">Richard Yang</span>
      <!--span class="logo-line-after"><i></i></span-->
    </a>
  </div>
  <p class="site-subtitle">Full-stack software engineer mainly focusing on Java-based technologies and web front-end</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-books">
          <a href="https://www.gitbook.com/@richdyang" rel="section">
            
            Books
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-showcase">
          <a href="/showcase" rel="section">
            
            Showcase
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-resume">
          <a href="http://linkedin.com/in/richdyang" rel="section">
            
            Résumé
          </a>
        </li>
        
      
        
        
      
        
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            About
          </a>
        </li>
        
      
        
        
      
        
        
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
            <i class="menu-item-icon fa fa-search fa-lg"></i>Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>

<div class="social-links" style="float: right; padding-left: 50px; margin-right: 10px">
      
        
          <span class="links-of-author-item">
            <a href="http://linkedin.com/in/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-linkedin"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://github.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-github-alt"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://bitbucket.org/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-bitbucket"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://twitter.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-twitter"></i>
                </span>
                 
              
            </a>
          </span>
        
      
  </div>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/19/swift-3-for-a-java-or-es6-typescript-developer/" itemprop="url">
                  Swift 3.0 for a Java or ES6/TypeScript developer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-01-19T17:11:25+08:00" content="2017-01-19">
              2017-01-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/19/swift-3-for-a-java-or-es6-typescript-developer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/19/swift-3-for-a-java-or-es6-typescript-developer/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Basic-Operators"><a href="#Basic-Operators" class="headerlink" title="Basic Operators"></a>Basic Operators</h1><h2 id="Assignment-Operator"><a href="#Assignment-Operator" class="headerlink" title="Assignment Operator"></a>Assignment Operator</h2><figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> b = <span class="number">10</span> <span class="comment">// constant</span></div><div class="line"><span class="keyword">var</span> a = <span class="number">5</span>	  <span class="comment">// variable</span></div><div class="line">a = b</div></pre></td></tr></table></figure>
<p><code>let</code> is not the same as that in ES6.<br>It is more or like <code>final</code> in Java. It means the variable (value or reference) cannot be changed once initialization.</p>
<p>But <code>let</code> in Swift has stronger semantics, which enable <em>immutability</em> or constant. It means not only the reference cannot be mutable but also the object it refers cannot be mutable.</p>
<figure class="highlight swift"><figcaption><span>swift</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line">arr[<span class="number">0</span>] = <span class="number">3</span> <span class="comment">// error</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">int</span>[] arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line">arr[<span class="number">0</span>] = <span class="number">3</span> <span class="comment">// ok</span></div></pre></td></tr></table></figure>
<p>multiple assignment with tuple:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> (x, y) = (<span class="number">1</span>, <span class="number">2</span>)</div></pre></td></tr></table></figure>
<h2 id="vs-vs"><a href="#vs-vs" class="headerlink" title="== vs. ===, != vs. !=="></a>== vs. ===, != vs. !==</h2><p><code>==</code> is the equal operator, while <code>===</code> is identity operator which is used to test wthether two object references both refer to the same object instance.</p>
<p>tuples are compared from left to right.</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">(1, "zebra") &lt; (2, "apple)</div><div class="line"></div><div class="line">(3, "apple") &lt; (3, "bird")</div></pre></td></tr></table></figure>
<h2 id="Nil-Colaescing-Operator"><a href="#Nil-Colaescing-Operator" class="headerlink" title="Nil-Colaescing Operator"></a>Nil-Colaescing Operator</h2><figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> a : <span class="type">String</span>? = <span class="string">"aaaa"</span></div><div class="line"><span class="keyword">var</span> b = a ?? b</div></pre></td></tr></table></figure>
<p><code>a ?? b</code> is shorthand for <code>a != nil  ? a! : b</code></p>
<h2 id="Range-Operators"><a href="#Range-Operators" class="headerlink" title="Range Operators"></a>Range Operators</h2><ul>
<li>closed range operator: <code>a...b</code> </li>
<li>half-open range operator: <code>a..&lt;b</code></li>
</ul>
<h1 id="Strings-and-Characters"><a href="#Strings-and-Characters" class="headerlink" title="Strings and Characters"></a>Strings and Characters</h1><p>Every string is composed of encoding-indepent Unicode characters.</p>
<p><code>String</code> type is a value type. When you pass a String to a function or assign to a constant/variable, its value is copied.</p>
<blockquote>
<p>Actually, it seems to have the similar attribute of immutability as that in Java.</p>
</blockquote>
<h2 id="Character"><a href="#Character" class="headerlink" title="Character"></a>Character</h2><p>Character can be created from a single-character string literal.</p>
<p><code>let ch : Character = &quot;1&quot;</code></p>
<h2 id="String-Interpolation"><a href="#String-Interpolation" class="headerlink" title="String Interpolation"></a>String Interpolation</h2><p>String interpolation in Swift is different from that in Javascript.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> a = <span class="number">3</span></div><div class="line"><span class="keyword">let</span> message = <span class="string">"the number is: \(a), its double is: \(Double(a) * 2)"</span></div></pre></td></tr></table></figure>
<p>In ES6:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> a = <span class="number">3</span></div><div class="line"><span class="keyword">let</span> message = <span class="string">`the number is: <span class="subst">$&#123;a&#125;</span>, its double is: <span class="subst">$&#123;a*2&#125;</span>`</span></div></pre></td></tr></table></figure>
<h2 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h2><blockquote>
<p>Unicode code point is a number for every character in Unicode.<br>Unicode scalar is any Unicode code point in the range U+0000 ~ U+D7FF or U+E000 ~ U+10FFFF.<br>The range in U+D800 ~ U+DFFF is for surrogate pair code points.</p>
</blockquote>
<ul>
<li>escaped special charaters: <code>\0, \\, \t, \n, \r, \&quot;, \&#39;</code> ..</li>
<li>Unicode scalar: <code>\u{00FF}</code> …</li>
</ul>
<p>The unicode literal is different from that in Java and Javascript. In Java/Javascript, it is like <code>\u00FF</code> without brackets.</p>
<p>Swift <code>Character</code> is not only single Unicode character, it can combine one or more Unicode scalars. Actually, every instance of Swift’s <code>Character</code> represents a single <em>extended grapheme cluster</em>.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> eAcute: <span class="type">Character</span> = <span class="string">"\u&#123;E9&#125;"</span>          </div><div class="line"><span class="keyword">let</span> combinedEacute: <span class="type">Character</span> = <span class="string">"\u&#123;65&#125;\u&#123;301&#125;"</span> <span class="comment">// e followed by  ́</span></div><div class="line"><span class="comment">// both are rednered as é</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Using <strong>extended grapheme clusters</strong> makes Swift’s <code>Character</code> is so much different from characters in other programming languages.</p>
</blockquote>
<h2 id="Accessing-and-Mofifying-a-String"><a href="#Accessing-and-Mofifying-a-String" class="headerlink" title="Accessing and Mofifying a String"></a>Accessing and Mofifying a String</h2><p>Due to the representation of Swift <code>Character</code>, the access and modification ways are special accordingly.</p>
<p>Each <code>String</code> value has an associated <em>index type</em>, <code>String.Index</code>.</p>
<p><code>String</code> has <code>startIndex</code> and <code>endIndex</code> properties, which is the half-open range with <code>endIndex</code> exclusive.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> greeting = <span class="string">"Hello world!"</span></div><div class="line">greeting[greeting.startIndex]</div><div class="line"><span class="comment">// H</span></div><div class="line"><span class="keyword">var</span> index = greeting.index(before: greeting.endIndex)</div><div class="line">greeting[index]</div><div class="line"><span class="comment">// !</span></div><div class="line">index = greeting.index(after: greeting.startIndex)</div><div class="line">greeting[index]</div><div class="line"><span class="comment">// u</span></div><div class="line">index = greeting.index(greeting.startIndex, offsetBy: <span class="number">2</span>)</div><div class="line">greeting[index]</div><div class="line"><span class="comment">// l</span></div></pre></td></tr></table></figure>
<h1 id="Control-Flow"><a href="#Control-Flow" class="headerlink" title="Control Flow"></a>Control Flow</h1><h2 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h2><p>No need to use explict <code>break</code> in each <code>case</code> branch.</p>
<p>But if you want the behaviours when missing <code>break</code> in Java, you can use the <code>fallthrough</code> keyword.</p>
<ul>
<li>Interval Matching</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> number = <span class="number">62</span></div><div class="line"><span class="keyword">let</span> desc : <span class="type">String</span></div><div class="line"><span class="keyword">switch</span> number &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		desc = <span class="string">"no"</span></div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>..&lt;<span class="number">5</span>:</div><div class="line">		desc = <span class="string">"a few"</span></div><div class="line">	<span class="keyword">case</span> <span class="number">5</span>..&lt;<span class="number">12</span>:</div><div class="line">		desc = <span class="string">"several"</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		desc = <span class="string">"many"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>compound cases</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> someCharacter: <span class="type">Character</span> = <span class="string">"e"</span></div><div class="line"><span class="keyword">switch</span> someCharacter &#123;</div><div class="line">	<span class="keyword">case</span> <span class="string">"a"</span>, <span class="string">"e"</span>, <span class="string">"i"</span>, <span class="string">"o"</span>, <span class="string">"u"</span>:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"\(someCharacter) is a vowel"</span>)</div><div class="line">	<span class="keyword">case</span> <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"j"</span>, <span class="string">"k"</span>, <span class="string">"l"</span>, <span class="string">"m"</span>,</div><div class="line">	     <span class="string">"n"</span>, <span class="string">"p"</span>, <span class="string">"q"</span>, <span class="string">"r"</span>, <span class="string">"s"</span>, <span class="string">"t"</span>, <span class="string">"v"</span>, <span class="string">"w"</span>, <span class="string">"x"</span>, <span class="string">"y"</span>, <span class="string">"z"</span>:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"\(someCharacter) is a consonant"</span>)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"\(someCharacter) is not a vowel or a consonant"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>test multiple values with <code>tuple</code></li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> somePoint = (<span class="number">1</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">switch</span> somePoint &#123;</div><div class="line">	<span class="keyword">case</span> (<span class="number">0</span>, <span class="number">0</span>):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(0, 0) is at the origin"</span>)</div><div class="line">	<span class="keyword">case</span> (<span class="number">_</span>, <span class="number">0</span>):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(somePoint.0), 0) is on the x-axis"</span>)</div><div class="line">	<span class="keyword">case</span> (<span class="number">0</span>, <span class="number">_</span>):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(0, \(somePoint.1)) is on the y-axis"</span>)</div><div class="line">	<span class="keyword">case</span> (-<span class="number">2</span>...<span class="number">2</span>, -<span class="number">2</span>...<span class="number">2</span>):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(somePoint.0), \(somePoint.1)) is inside the box"</span>)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(somePoint.0), \(somePoint.1)) is outside of the box"</span>)</div><div class="line">&#125;”</div></pre></td></tr></table></figure>
<ul>
<li>value binding</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> anotherPoint = (<span class="number">2</span>, <span class="number">0</span>)</div><div class="line"><span class="keyword">switch</span> anotherPoint &#123;</div><div class="line">	<span class="keyword">case</span> (<span class="keyword">let</span> x, <span class="number">0</span>):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"on the x-axis with an x value of \(x)"</span>)</div><div class="line">	<span class="keyword">case</span> (<span class="number">0</span>, <span class="keyword">let</span> y):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"on the y-axis with a y value of \(y)"</span>)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">let</span> (x, y):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"somewhere else at (\(x), \(y))"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>where</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> yetAnotherPoint = (<span class="number">1</span>, -<span class="number">1</span>)</div><div class="line"><span class="keyword">switch</span> yetAnotherPoint &#123;</div><div class="line">	<span class="keyword">case</span> <span class="keyword">let</span> (x, y) <span class="keyword">where</span> x == y:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(x), \(y)) is on the line x == y"</span>)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">let</span> (x, y) <span class="keyword">where</span> x == -y:</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(x), \(y)) is on the line x == -y"</span>)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">let</span> (x, y):</div><div class="line">	    <span class="built_in">print</span>(<span class="string">"(\(x), \(y)) is just some arbitrary point"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/27/elementref-viewcontainerref-templateref/" itemprop="url">
                  ElementRef vs. ViewContainerRef vs. TemplateRef
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-27T17:11:25+08:00" content="2016-12-27">
              2016-12-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/27/elementref-viewcontainerref-templateref/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/12/27/elementref-viewcontainerref-templateref/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>In Angular2, there are many *Ref class: <code>ElementRef</code>, <code>ViewContainerRef</code>, <code>TemplateRef</code>.</p>
<p>What do they means?</p>
<ol>
<li>Nearly every components (Components, Attribute Directives, Structural Directives) have ViewContainerRef, which is the host of its view.</li>
</ol>
<p>ViewContainerRef has two important methods:<br><code>createEmbeddedView(templateRef: TemplateRef&lt;C&gt;, context?: C, index?: number) : EmbeddedViewRef&lt;C&gt;</code><br>This method is to create a view from a HTML template.<br><code>createComponent(componentFactory: ComponentFactory&lt;C&gt;, index?: number, injector?: Injector, projectableNodes?: any[][]) : ComponentRef&lt;C&gt;</code><br>This method is to initialize a component and insert its host view to the view container.</p>
<ol>
<li>From ViewContainerRef, we can get its ElementRef (further access its native DOM element).</li>
<li>For structural directives, since they are implemented through HTML template element, so it can get a TemplateRef.</li>
</ol>
<figure class="highlight typescript"><figcaption><span>Component</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;AfterContentInit, Component, ElementRef, ViewContainerRef&#125; from <span class="string">'@angular/core'</span>;</div><div class="line"></div><div class="line">@Component(&#123;</div><div class="line">	selector: <span class="string">'app'</span>,</div><div class="line">	template: <span class="string">`</span></div><div class="line">  &lt;h1&gt;My App&lt;/h1&gt;</div><div class="line">  &lt;pre style="background: #eee; padding: 1rem; border-radius: 3px; overflow: auto;"&gt; </div><div class="line">    &lt;code&gt;&#123;&#123; node &#125;&#125;&lt;/code&gt;</div><div class="line">  &lt;/pre&gt;</div><div class="line">`</div><div class="line">&#125;)</div><div class="line"><span class="keyword">export</span> <span class="keyword">class</span> App <span class="keyword">implements</span> AfterContentInit &#123;</div><div class="line">  node: <span class="built_in">string</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">constructor</span>(private viewContainerRef: ViewContainerRef) &#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  ngAfterContentInit() &#123;</div><div class="line">    <span class="keyword">let</span> elementRef = <span class="keyword">this</span>.viewContainerRef.element;</div><div class="line">    <span class="keyword">const</span> tmp = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</div><div class="line">    <span class="keyword">const</span> el = elementRef.nativeElement.cloneNode(<span class="literal">true</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">console</span>.log(elementRef)</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.viewContainerRef)</div><div class="line">    </div><div class="line">    tmp.appendChild(el);</div><div class="line">    <span class="keyword">this</span>.node = tmp.innerHTML;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>Attribute Directive</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;Directive, ViewContainerRef, ElementRef, Renderer&#125; from <span class="string">'angular2/core'</span>;</div><div class="line"></div><div class="line">@Directive(&#123;</div><div class="line">  selector: <span class="string">'[my-outline]'</span>,</div><div class="line">  host: &#123;</div><div class="line">    <span class="string">'(mouseenter)'</span>: <span class="string">'onMouseEnter()'</span>,</div><div class="line">    <span class="string">'(mouseleave)'</span>: <span class="string">'onMouseLeave()'</span></div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"><span class="keyword">export</span> <span class="keyword">class</span> MyOutline &#123;</div><div class="line">  <span class="keyword">constructor</span>(private viewContainerRef:ViewContainerRef, private _element: ElementRef, private _renderer:Renderer) &#123; &#125;</div><div class="line">  onMouseEnter() &#123; <span class="keyword">this</span>._outlineToggle(<span class="literal">true</span>); &#125;</div><div class="line">  onMouseLeave() &#123; <span class="keyword">this</span>._outlineToggle(<span class="literal">false</span>); &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> _outlineToggle() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.viewContainerRef)</div><div class="line">    <span class="keyword">this</span>._renderer.setElementStyle(<span class="keyword">this</span>._element.nativeElement, <span class="string">'border'</span>, <span class="string">'solid red 1px'</span> );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight typescript"><figcaption><span>Structural Directive</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;Directive, Input&#125; from <span class="string">'angular2/core'</span>;</div><div class="line"><span class="keyword">import</span> &#123;TemplateRef, ViewContainerRef&#125; from <span class="string">'angular2/core'</span>;</div><div class="line"></div><div class="line">@Directive(&#123; selector: <span class="string">'[repeatMe]'</span> &#125;)</div><div class="line"><span class="keyword">export</span> <span class="keyword">class</span> RepeatMe &#123;</div><div class="line">  <span class="keyword">constructor</span>(</div><div class="line">    private _templateRef: TemplateRef,</div><div class="line">    private _viewContainer: ViewContainerRef</div><div class="line">    ) &#123;&#125;</div><div class="line">  </div><div class="line">  @Input() <span class="keyword">set</span> repeatMe(count: int) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">      <span class="keyword">this</span>._viewContainer.createEmbeddedView(<span class="keyword">this</span>._templateRef);</div><div class="line">    &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In Angular2, the View is refered to the template of a component defined in the @Component decorator.</p>
<p>There are another view query docorators in Angualar.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">import &#123; Component, ViewChild &#125; from &apos;@angular/core&apos;;</div><div class="line">import &#123; UserProfile &#125; from &apos;../user-profile&apos;;</div><div class="line"></div><div class="line">@Component(&#123;</div><div class="line">  template: &apos;&lt;user-profile (click)=&quot;update()&quot;&gt;&lt;/user-profile&gt;&apos;,</div><div class="line">&#125;)</div><div class="line">export class MasterPage &#123;</div><div class="line">  // ViewChild takes a class type or a reference name string.</div><div class="line">  // Here we are using the type</div><div class="line">  @ViewChild(UserProfile) userProfile: UserProfile</div><div class="line"></div><div class="line">  constructor() &#123; &#125;</div><div class="line"></div><div class="line">  ngAfterViewInit() &#123;</div><div class="line">    // After the view is initialized, this.userProfile will be available</div><div class="line">    this.update();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  update() &#123;</div><div class="line">    this.userProfile.sendData();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Here we use <code>@ViewChild</code> to query the component, since the view is associated with a component.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/05/ThreadLocal/" itemprop="url">
                  ThreadLocal
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-05T19:52:25+08:00" content="2016-09-05">
              2016-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/05/ThreadLocal/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/05/ThreadLocal/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="how-to-use"><a href="#how-to-use" class="headerlink" title="how to use?"></a>how to use?</h1><p>Basically, <code>ThreadLocal</code> is used for these scenarios: <strong>whenever you set a value/reference within this thread, you can get it from this thread. But it cannot guarantee you can ONLY get it from this thread.</strong></p>
<p>When wrongly used, it may cause something counter-intuitive. For example, when you set a value/reference to a ThreadLocal, you also share it with other threads (say other threads can access the reference and mutable it.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalHolder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ThreadLocal&lt;SomeObject&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;SomeObject&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> SomeObject <span class="title">initialValue</span><span class="params">()</span> </span>&#123; <span class="comment">// set the initial value when first getting or after removing</span></div><div class="line">            <span class="keyword">return</span> SomeObject.DEFAULT;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        getAndPrint();</div><div class="line">        threadLocal.set(<span class="keyword">new</span> SomeObject(Thread.currentThread().getId()));</div><div class="line">        getAndPrint();</div><div class="line">        threadLocal.remove();</div><div class="line">        getAndPrint();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndPrint</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeObject someObject = threadLocal.get();</div><div class="line">        System.out.println(String.format(<span class="string">"Thread %d: %d"</span>, Thread.currentThread().getId(), someObject.getValue()));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeObject</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SomeObject DEFAULT = <span class="keyword">new</span> SomeObject(<span class="number">0L</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> value;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SomeObject</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> ThreadLocalHolder threadLocalHolder = <span class="keyword">new</span> ThreadLocalHolder();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadCount = <span class="number">200</span>;</div><div class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(threadCount);</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; threadCount; ++i) &#123;</div><div class="line">            executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    threadLocalHolder.foo();</div><div class="line">                    countDownLatch.countDown();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        countDownLatch.await();</div><div class="line">        executorService.shutdown();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Possible “incorrect” usage: Here we share the reference by setting it to the a field of ThreadLocalHolder, so another thread can mutate its value. From the respective of the first thread, this thread sets it but its state can still be visible and modified by other threads. Sometime it seems to voilate the original purpose of <code>ThreadLocal</code>.<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/09/05/ThreadLocal/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/05/dive-into-jmm/" itemprop="url">
                  Dive into JMM
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-05T13:34:25+08:00" content="2016-09-05">
              2016-09-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/05/dive-into-jmm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/05/dive-into-jmm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>JMM is an advanced and abstract topic in Java. It provides well-defined semantics for synchronization and help us reason the code execution in a multi-thread enviorionment.</p>
<p>Keywords: main memory, local memory, reordering, visibility, memory barrier/fence</p>
<h1 id="What-do-the-issues-come-from"><a href="#What-do-the-issues-come-from" class="headerlink" title="What do the issues come from?"></a>What do the issues come from?</h1><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="http://gee.cs.oswego.edu/dl/jmm/cookbook.html" target="_blank" rel="external">The JSR-133 Cookbook for Compiler Writers</a></li>
<li><a href="https://www.infoq.com/articles/memory_barriers_jvm_concurrency" target="_blank" rel="external">Memory Barriers and JVM Concurrency</a></li>
</ul>
<p>//TODO</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/02/double-checked-locking-in-singleton/" itemprop="url">
                  Double Checked Locking in lazy-initialization Singleton
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-02T19:36:25+08:00" content="2016-09-02">
              2016-09-02
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/02/double-checked-locking-in-singleton/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/02/double-checked-locking-in-singleton/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="double-checked-locking-idiom-aka-DCL"><a href="#double-checked-locking-idiom-aka-DCL" class="headerlink" title="double-checked locking idiom (aka. DCL)"></a>double-checked locking idiom (aka. DCL)</h1><h2 id="broken-versions"><a href="#broken-versions" class="headerlink" title="broken versions"></a>broken versions</h2><p>Here we follow the evolution process of how to create a lazy-initialization singleton.</p>
<figure class="highlight java"><figcaption><span>naive version</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton DEFAULT;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(DEFAULT == <span class="keyword">null</span>) &#123;</div><div class="line">            DEFAULT = <span class="keyword">new</span> Singleton();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> DEFAULT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">// other instance methods</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Race condition:</p>
<ul>
<li>when thread 1 has executed <code>if(DEFAULT == null)</code> and then is preempted by thread 2.</li>
<li>Thread 2 checks DEFAULT is null, it instantiates the DEFAULT.</li>
<li>Thread 1 starts executing again, then it instantiates the DEFAULT once again and overwrites the DEFAULT reference.</li>
</ul>
<p>Actually, more than one instances are created in the heap.</p>
<p>Now we fix it to synchronize the instantiation.<br><figure class="highlight java"><figcaption><span>synchronized version</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton DEFAULT;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(DEFAULT == <span class="keyword">null</span>) &#123;</div><div class="line">            DEFAULT = <span class="keyword">new</span> Singleton();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> DEFAULT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">// other instance methods</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>whenever we need to fetch the singleton, we need to synchronize no matter whether the singleton is null.</p>
<p>This version is inherently thread safe but not efficient.</p>
<p>Now we continue to fix it by reducing the locking range.<br><figure class="highlight java"><figcaption><span>reducing locking range</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton DEFAULT;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(DEFAULT == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123;</div><div class="line">                DEFAULT = <span class="keyword">new</span> Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> DEFAULT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">// other instance methods</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Race condition:</p>
<ul>
<li>when thread 1 has executed <code>if(DEFAULT == null) {</code> and then fail to acquire lock which is occupied by thread 2.</li>
<li>Thread 2 instantiates the DEFAULT and releases the lock.</li>
<li>Thread 1 acquire the lock and continue to execute, then it instantiates the DEFAULT once again and overwrites the DEFAULT reference.</li>
</ul>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/09/02/double-checked-locking-in-singleton/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/26/2016-08-26/" itemprop="url">
                  Untitled
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-26T23:38:24+08:00" content="2016-08-26">
              2016-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/26/2016-08-26/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/26/2016-08-26/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#<br>some topics worth discussing:</p>
<ul>
<li>class initialization process and thread-safe</li>
<li>class initialization and recursive initialization (cyclical dependency)<br><a href="http://www.pixelstech.net/article/1429149847-Recursive-class-initialization-in-Java" target="_blank" rel="external">http://www.pixelstech.net/article/1429149847-Recursive-class-initialization-in-Java</a></li>
<li>final semantic in concurrency</li>
<li>write barrier</li>
<li>safepoint</li>
<li>TLAB</li>
<li>oop, klass, KlassKlass</li>
<li>JMM</li>
</ul>
<p><a href="https://blogs.oracle.com/jonthecollector/category/Java" target="_blank" rel="external">https://blogs.oracle.com/jonthecollector/category/Java</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/23/thread-interrupt-and-cancelable-mechanism/" itemprop="url">
                  thread interrupt and cancelable mechanism
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-23T10:25:25+08:00" content="2016-08-23">
              2016-08-23
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/23/thread-interrupt-and-cancelable-mechanism/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/23/thread-interrupt-and-cancelable-mechanism/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>To begin with, I issue some questions:</p>
<ul>
<li>what does <code>Thread#interrupt()</code> do?</li>
<li>what is the difference between <code>Thread#isInterrupted()</code> and <code>Thread.interrupted</code>?</li>
<li>do I have to respond to interruption event?</li>
<li>when an <code>InterruptedException</code> is thrown?</li>
<li>how should I handle the caught <code>InterruptedException</code>?</li>
<li>how do I implement a cancelable mechanism for my task by polling interruption event?</li>
<li>apart from <code>wait()</code>, <code>sleep()</code>, <code>join()</code>, are there other scenarios throwing <code>InterruptedException</code>?</li>
<li>can we implement the similar interruption handling ways as <code>wait()</code> or like?</li>
<li>can <code>LockSupport#park()</code> respond to interruption and throw <code>InterruptedException</code>?</li>
<li>is interruption event underrated? do we need to especially consider responding interruption when we write multi-thread code?</li>
</ul>
<h1 id="thread-interruption-APIs"><a href="#thread-interruption-APIs" class="headerlink" title="thread interruption APIs"></a>thread interruption APIs</h1><p>Now there are two thread t and u.</p>
<p>Thread interruption is a collaboration mechanism which is NOT peremptory. Thread t can interrupt thread u, and the result depends on whether thread u responds this interruption.</p>
<p>A thread has an interruption status. <code>Thread#interrupt()</code> just set this status.<br>This status can be checked by invoke <code>Thread#isInterrupted()</code>. And <code>Thread.interrupted()</code> is just a shortcut of getting the interruption status of current thread and then clearing this status.</p>
<p>Additionally, in the following scenarios, the interrupt status will be clear with throwing InterruptedException:</p>
<ul>
<li>m.wait(), then thread u will be removed from the wait set of m, after re-locking the m’s monitor, throw InterruptedException.</li>
<li>tt.join(), actually equivalent to tt.wait() until not active, same as the above.</li>
<li>sleep(), not need to reacquire any lock before throwing InterruptedException.</li>
</ul>
<p>//TODO</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/string-intern/" itemprop="url">
                  String intern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-22T21:36:25+08:00" content="2016-08-22">
              2016-08-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/22/string-intern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/string-intern/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Several-simple-code-snippets"><a href="#Several-simple-code-snippets" class="headerlink" title="Several simple code snippets"></a>Several simple code snippets</h1><figure class="highlight java"><figcaption><span>Sample1</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">char</span>[] chars = &#123;<span class="string">'h'</span>, <span class="string">'e'</span>, <span class="string">'l'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>&#125;;</div><div class="line">String str1 = <span class="keyword">new</span> String(chars);</div><div class="line">System.out.println(str1 == str1.intern());</div></pre></td></tr></table></figure>
<p>print: true</p>
<figure class="highlight java"><figcaption><span>Sample2</span></figcaption><table><tr><td class="code"><pre><div class="line">String str1 = <span class="keyword">new</span> String(<span class="string">"hello"</span>);</div><div class="line">System.out.println(str1 == str1.intern());</div></pre></td></tr></table></figure>
<p>print: false</p>
<figure class="highlight java"><figcaption><span>Sample3</span></figcaption><table><tr><td class="code"><pre><div class="line">String a = <span class="string">"hello"</span>;</div><div class="line">String b = <span class="keyword">new</span> String(<span class="string">"hello"</span>);</div><div class="line">String c = <span class="keyword">new</span> String(<span class="string">"h"</span> + <span class="string">"e"</span> + <span class="string">"l"</span> + <span class="string">"l"</span> + <span class="string">"o"</span>);</div><div class="line">String d = b.intern();</div></pre></td></tr></table></figure>
<p>How many String objects is created?<br>Answer is 3. Are you right?</p>
<h1 id="questions"><a href="#questions" class="headerlink" title="questions"></a>questions</h1><ul>
<li>when and where is the String object from string literal created, even if we don’t explicitly initialize it?</li>
<li>what happens for <code>intern()</code>?</li>
<li>how is the “pool of strings” implemented?</li>
<li>what’s the difference of two constructors between String(char[]) and String(String)?</li>
</ul>
<h1 id="constant-string-loading-and-intern"><a href="#constant-string-loading-and-intern" class="headerlink" title="constant string loading and intern"></a>constant string loading and intern</h1><p>As we know, string literal is compiled into constant pool of the class file. And the bytecode to load it is <code>ldc</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringLiteral</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringLiteral</span><span class="params">()</span> </span>&#123;</div><div class="line">        String str = <span class="string">"hello"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>will be compiled to:<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Constant pool:</div><div class="line">   #1 = Methodref          #4.#16         //  java/lang/Object.&quot;&lt;init&gt;&quot;:()V</div><div class="line">   #2 = String             #17            //  hello</div><div class="line">   #3 = Class              #18            //  StringLiteral</div><div class="line">   #4 = Class              #19            //  java/lang/Object</div><div class="line">   #5 = Utf8               &lt;init&gt;</div><div class="line">   #6 = Utf8               ()V</div><div class="line">   #7 = Utf8               Code</div><div class="line">   #8 = Utf8               LineNumberTable</div><div class="line">   #9 = Utf8               LocalVariableTable</div><div class="line">  #10 = Utf8               this</div><div class="line">  #11 = Utf8               LStringLiteral;</div><div class="line">  #12 = Utf8               str</div><div class="line">  #13 = Utf8               Ljava/lang/String;</div><div class="line">  #14 = Utf8               SourceFile</div><div class="line">  #15 = Utf8               StringLiteral.java</div><div class="line">  #16 = NameAndType        #5:#6          //  &quot;&lt;init&gt;&quot;:()V</div><div class="line">  #17 = Utf8               hello</div><div class="line">  #18 = Utf8               StringLiteral</div><div class="line">  #19 = Utf8               java/lang/Object</div><div class="line">&#123;</div><div class="line">  public StringLiteral();</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      stack=1, locals=2, args_size=1</div><div class="line">         0: aload_0</div><div class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</div><div class="line">         4: ldc           #2                  // String hello</div><div class="line">         6: astore_1</div><div class="line">         7: return</div><div class="line">      LineNumberTable:</div><div class="line">        line 5: 0</div><div class="line">        line 6: 4</div><div class="line">        line 7: 7</div><div class="line">      LocalVariableTable:</div><div class="line">        Start  Length  Slot  Name   Signature</div><div class="line">               0       8     0  this   LStringLiteral;</div><div class="line">               7       1     1   str   Ljava/lang/String;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>when <code>ldc</code> is executed, it must firstly resolve the symbol to the actual reference if not resolved.</p>
<p>NOTICE:<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">4: ldc           #2                  // String hello</div><div class="line">6: astore_1</div></pre></td></tr></table></figure></p>
<p>will find #2 in constant pool:<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#2 = String             #17            //  hello</div><div class="line">#17 = Utf8               hello</div></pre></td></tr></table></figure></p>
<p>Initially, #2 is Constant_String_info symbol, and it assoiciates with #17 which is Constant_Utf8_info (UTF-8 encoding char array).<br><figure class="highlight c++"><figcaption><span>line2111-2161 share/vm/interpreter/bytecodeInterpreter.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">CASE(<span class="number">_l</span>dc):</div><div class="line">   &#123;</div><div class="line">     u2 index;</div><div class="line">     <span class="keyword">bool</span> wide = <span class="literal">false</span>;</div><div class="line">     <span class="keyword">int</span> incr = <span class="number">2</span>; <span class="comment">// frequent case</span></div><div class="line">     <span class="keyword">if</span> (opcode == Bytecodes::<span class="number">_l</span>dc) &#123;</div><div class="line">       index = pc[<span class="number">1</span>];</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">       index = Bytes::get_Java_u2(pc+<span class="number">1</span>);</div><div class="line">       incr = <span class="number">3</span>;</div><div class="line">       wide = <span class="literal">true</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     ConstantPool* constants = METHOD-&gt;constants();</div><div class="line">     <span class="keyword">switch</span> (constants-&gt;tag_at(index).value()) &#123;</div><div class="line">     ....</div><div class="line">     </div><div class="line">     <span class="keyword">case</span> JVM_CONSTANT_String:</div><div class="line">       &#123;</div><div class="line">         oop result = constants-&gt;resolved_references()-&gt;obj_at(index);</div><div class="line">         <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</div><div class="line">           CALL_VM(InterpreterRuntime::resolve_ldc(THREAD, (Bytecodes::Code) opcode), handle_exception);</div><div class="line">           SET_STACK_OBJECT(THREAD-&gt;vm_result(), <span class="number">0</span>);</div><div class="line">           THREAD-&gt;set_vm_result(<span class="literal">NULL</span>);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">           VERIFY_OOP(result);</div><div class="line">           SET_STACK_OBJECT(result, <span class="number">0</span>);</div><div class="line">         &#125;</div><div class="line">       <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">      ....</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>when it’s JVM_CONSTANT_String, jvm first checks resolved reference in line <code>oop result = constants-&gt;resolved_references()-&gt;obj_at(index);</code>. If it is not resolved, then call <code>InterpreterRuntime::resolve_ldc(THREAD, (Bytecodes::Code) opcode)</code>.</p>
<figure class="highlight"><figcaption><span>line125-142 share/vm/interpreter/interpreterRuntime.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">IRT_ENTRY(void, InterpreterRuntime::resolve_ldc(JavaThread* thread, Bytecodes::Code bytecode)) &#123;</div><div class="line">  assert(bytecode == Bytecodes::_fast_aldc ||</div><div class="line">         bytecode == Bytecodes::_fast_aldc_w, "wrong bc");</div><div class="line">  ResourceMark rm(thread);</div><div class="line">  methodHandle m (thread, method(thread));</div><div class="line">  Bytecode_loadconstant ldc(m, bci(thread));</div><div class="line">  oop result = ldc.resolve_constant(CHECK);</div><div class="line">#ifdef ASSERT</div><div class="line">  &#123;</div><div class="line">    // The bytecode wrappers aren't GC-safe so construct a new one</div><div class="line">    Bytecode_loadconstant ldc2(m, bci(thread));</div><div class="line">    oop coop = m-&gt;constants()-&gt;resolved_references()-&gt;obj_at(ldc2.cache_index());</div><div class="line">    assert(result == coop, "expected result for assembly code");</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line">  thread-&gt;set_vm_result(result);</div><div class="line">&#125;</div><div class="line">IRT_END</div></pre></td></tr></table></figure>
<p>here, it then calls <code>Bytecode_loadconstant::resolve_constant(..)</code>.</p>
<figure class="highlight c++"><figcaption><span>line217-226 share/vm/interpreter/bytecode.cpp </span></figcaption><table><tr><td class="code"><pre><div class="line">oop Bytecode_loadconstant::resolve_constant(TRAPS) <span class="keyword">const</span> &#123;</div><div class="line">  assert(<span class="number">_</span>method.not_null(), <span class="string">"must supply method to resolve constant"</span>);</div><div class="line">  <span class="keyword">int</span> index = raw_index();</div><div class="line">  ConstantPool* constants = <span class="number">_</span>method-&gt;constants();</div><div class="line">  <span class="keyword">if</span> (has_cache_index()) &#123;</div><div class="line">    <span class="keyword">return</span> constants-&gt;resolve_cached_constant_at(index, THREAD);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> constants-&gt;resolve_constant_at(index, THREAD);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>here, no cache temporarily, it calls <code>constants-&gt;resolve_constant_at(index, THREAD)</code>.</p>
<figure class="highlight c++"><figcaption><span>line705-709 share/vm/oops/constantPool.hpp</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">// Resolve late bound constants.</span></div><div class="line"><span class="function">oop <span class="title">resolve_constant_at</span><span class="params">(<span class="keyword">int</span> index, TRAPS)</span> </span>&#123;</div><div class="line">  <span class="function">constantPoolHandle <span class="title">h_this</span><span class="params">(THREAD, <span class="keyword">this</span>)</span></span>;</div><div class="line">  <span class="keyword">return</span> resolve_constant_at_impl(h_this, index, <span class="number">_</span>no_index_sentinel, THREAD);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight"><figcaption><span>line614-718 shared/vm/oops/contantPool.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">// Called to resolve constants in the constant pool and return an oop.</div><div class="line">// Some constant pool entries cache their resolved oop. This is also</div><div class="line">// called to create oops from constants to use in arguments for invokedynamic</div><div class="line">oop ConstantPool::resolve_constant_at_impl(constantPoolHandle this_oop, int index, int cache_index, TRAPS) &#123;</div><div class="line">  oop result_oop = NULL;</div><div class="line">  Handle throw_exception;</div><div class="line"></div><div class="line">  if (cache_index == _possible_index_sentinel) &#123;</div><div class="line">    // It is possible that this constant is one which is cached in the objects.</div><div class="line">    // We'll do a linear search.  This should be OK because this usage is rare.</div><div class="line">    assert(index &gt; 0, "valid index");</div><div class="line">    cache_index = this_oop-&gt;cp_to_object_index(index);</div><div class="line">  &#125;</div><div class="line">  assert(cache_index == _no_index_sentinel || cache_index &gt;= 0, "");</div><div class="line">  assert(index == _no_index_sentinel || index &gt;= 0, "");</div><div class="line"></div><div class="line">  if (cache_index &gt;= 0) &#123;</div><div class="line">    result_oop = this_oop-&gt;resolved_references()-&gt;obj_at(cache_index);</div><div class="line">    if (result_oop != NULL) &#123;</div><div class="line">      return result_oop;</div><div class="line">      // That was easy...</div><div class="line">    &#125;</div><div class="line">    index = this_oop-&gt;object_to_cp_index(cache_index);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  jvalue prim_value;  // temp used only in a few cases below</div><div class="line"></div><div class="line">  int tag_value = this_oop-&gt;tag_at(index).value();</div><div class="line"></div><div class="line">  switch (tag_value) &#123;</div><div class="line"></div><div class="line">  ....</div><div class="line"></div><div class="line">  case JVM_CONSTANT_String:</div><div class="line">    assert(cache_index != _no_index_sentinel, "should have been set");</div><div class="line">    if (this_oop-&gt;is_pseudo_string_at(index)) &#123;</div><div class="line">      result_oop = this_oop-&gt;pseudo_string_at(index, cache_index);</div><div class="line">      break;</div><div class="line">    &#125;</div><div class="line">    result_oop = string_at_impl(this_oop, index, cache_index, CHECK_NULL);</div><div class="line">    break;</div><div class="line"></div><div class="line">  ....</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (cache_index &gt;= 0) &#123;</div><div class="line">    // Cache the oop here also.</div><div class="line">    Handle result_handle(THREAD, result_oop);</div><div class="line">    MonitorLockerEx ml(this_oop-&gt;lock());  // don't know if we really need this</div><div class="line">    oop result = this_oop-&gt;resolved_references()-&gt;obj_at(cache_index);</div><div class="line">    // Benign race condition:  resolved_references may already be filled in while we were trying to lock.</div><div class="line">    // The important thing here is that all threads pick up the same result.</div><div class="line">    // It doesn't matter which racing thread wins, as long as only one</div><div class="line">    // result is used by all threads, and all future queries.</div><div class="line">    // That result may be either a resolved constant or a failure exception.</div><div class="line">    if (result == NULL) &#123;</div><div class="line">      this_oop-&gt;resolved_references()-&gt;obj_at_put(cache_index, result_handle());</div><div class="line">      return result_handle();</div><div class="line">    &#125; else &#123;</div><div class="line">      // Return the winning thread's result.  This can be different than</div><div class="line">      // result_handle() for MethodHandles.</div><div class="line">      return result;</div><div class="line">    &#125;</div><div class="line">  &#125; else &#123;</div><div class="line">    return result_oop;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And then calls <code>string_at_impl</code>.</p>
<figure class="highlight c++"><figcaption><span>line816-825 share/vm/oops/contantPool.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">oop ConstantPool::string_at_impl(constantPoolHandle this_oop, <span class="keyword">int</span> which, <span class="keyword">int</span> obj_index, TRAPS) &#123;</div><div class="line">  <span class="comment">// If the string has already been interned, this entry will be non-null</span></div><div class="line">  oop str = this_oop-&gt;resolved_references()-&gt;obj_at(obj_index);</div><div class="line">  <span class="keyword">if</span> (str != <span class="literal">NULL</span>) <span class="keyword">return</span> str;</div><div class="line">  Symbol* sym = this_oop-&gt;unresolved_string_at(which);</div><div class="line">  str = StringTable::intern(sym, CHECK_(<span class="literal">NULL</span>));</div><div class="line">  this_oop-&gt;string_at_put(which, obj_index, str);</div><div class="line">  assert(java_lang_String::is_instance(str), <span class="string">"must be string"</span>);</div><div class="line">  <span class="keyword">return</span> str;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Finally, we find these two lines:<br><figure class="highlight c++"><table><tr><td class="code"><pre><div class="line">Symbol* sym = this_oop-&gt;unresolved_string_at(which);</div><div class="line">str = StringTable::intern(sym, CHECK_(<span class="literal">NULL</span>));</div></pre></td></tr></table></figure></p>
<p>Here sym is <code>Utf8</code> the String is associate with.</p>
<figure class="highlight c++"><figcaption><span>vm/classfile/symbolTable.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">oop StringTable::intern(Symbol* symbol, TRAPS) &#123;</div><div class="line">  <span class="keyword">if</span> (symbol == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">  <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</div><div class="line">  <span class="keyword">int</span> length;</div><div class="line">  jchar* chars = symbol-&gt;as_unicode(length);</div><div class="line">  Handle <span class="built_in">string</span>;</div><div class="line">  oop result = intern(<span class="built_in">string</span>, chars, length, CHECK_NULL);</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">oop StringTable::intern(Handle string_or_null, jchar* name,</div><div class="line">                        <span class="keyword">int</span> len, TRAPS) &#123;</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue = hash_string(name, len);</div><div class="line">  <span class="keyword">int</span> index = the_table()-&gt;hash_to_index(hashValue);</div><div class="line">  oop found_string = the_table()-&gt;lookup(index, name, len, hashValue);</div><div class="line"></div><div class="line">  <span class="comment">// Found</span></div><div class="line">  <span class="keyword">if</span> (found_string != <span class="literal">NULL</span>) <span class="keyword">return</span> found_string;</div><div class="line"></div><div class="line">  debug_only(StableMemoryChecker smc(name, len * <span class="keyword">sizeof</span>(name[<span class="number">0</span>])));</div><div class="line">  assert(!Universe::heap()-&gt;is_in_reserved(name),</div><div class="line">         <span class="string">"proposed name of symbol must be stable"</span>);</div><div class="line"></div><div class="line">  Handle <span class="built_in">string</span>;</div><div class="line">  <span class="comment">// try to reuse the string if possible</span></div><div class="line">  <span class="keyword">if</span> (!string_or_null.is_null()) &#123;</div><div class="line">    <span class="built_in">string</span> = string_or_null;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">string</span> = java_lang_String::create_from_unicode(name, len, CHECK_NULL);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Grab the StringTable_lock before getting the_table() because it could</span></div><div class="line">  <span class="comment">// change at safepoint.</span></div><div class="line">  <span class="function">MutexLocker <span class="title">ml</span><span class="params">(StringTable_lock, THREAD)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// Otherwise, add to symbol to table</span></div><div class="line">  <span class="keyword">return</span> the_table()-&gt;basic_add(index, <span class="built_in">string</span>, name, len,</div><div class="line">                                hashValue, CHECK_NULL);</div><div class="line">&#125;</div><div class="line"></div><div class="line">oop StringTable::basic_add(<span class="keyword">int</span> index_arg, Handle <span class="built_in">string</span>, jchar* name,</div><div class="line">                           <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue_arg, TRAPS) &#123;</div><div class="line"></div><div class="line">  assert(java_lang_String::equals(<span class="built_in">string</span>(), name, len),</div><div class="line">         <span class="string">"string must be properly initialized"</span>);</div><div class="line">  <span class="comment">// Cannot hit a safepoint in this function because the "this" pointer can move.</span></div><div class="line">  No_Safepoint_Verifier nsv;</div><div class="line"></div><div class="line">  <span class="comment">// Check if the symbol table has been rehashed, if so, need to recalculate</span></div><div class="line">  <span class="comment">// the hash value and index before second lookup.</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue;</div><div class="line">  <span class="keyword">int</span> index;</div><div class="line">  <span class="keyword">if</span> (use_alternate_hashcode()) &#123;</div><div class="line">    hashValue = hash_string(name, len);</div><div class="line">    index = hash_to_index(hashValue);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    hashValue = hashValue_arg;</div><div class="line">    index = index_arg;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Since look-up was done lock-free, we need to check if another</span></div><div class="line">  <span class="comment">// thread beat us in the race to insert the symbol.</span></div><div class="line"></div><div class="line">  oop test = lookup(index, name, len, hashValue); <span class="comment">// calls lookup(u1*, int)</span></div><div class="line">  <span class="keyword">if</span> (test != <span class="literal">NULL</span>) &#123;</div><div class="line">    <span class="comment">// Entry already added</span></div><div class="line">    <span class="keyword">return</span> test;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  HashtableEntry&lt;oop, mtSymbol&gt;* entry = new_entry(hashValue, <span class="built_in">string</span>());</div><div class="line">  add_entry(index, entry);</div><div class="line">  <span class="keyword">return</span> <span class="built_in">string</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Firstly, it converts the Utf8 symbol to Java char array. Then using this char array to crate a <code>String</code> object by <code>java_lang_String::create_from_unicode(name, len, CHECK_NULL);</code>. Finally, add this oop of String to the table and return its oop. Here the_table is StringTable. StringTable is just a Hashtable<oop, mtsymbol="">.</oop,></p>
<figure class="highlight c++"><figcaption><span>line185-192 shared/vm/classfile/javaClasses.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">Handle java_lang_String::create_from_unicode(jchar* unicode, <span class="keyword">int</span> length, TRAPS) &#123;</div><div class="line">  Handle h_obj = basic_create(length, CHECK_NH);</div><div class="line">  typeArrayOop buffer = value(h_obj());</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; length; index++) &#123;</div><div class="line">    buffer-&gt;char_at_put(index, unicode[index]);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> h_obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="explicitly-call-String-intern"><a href="#explicitly-call-String-intern" class="headerlink" title="explicitly call String#intern()"></a>explicitly call String#intern()</h1><p>This is the JNI method of String#intern():<br><figure class="highlight c"><figcaption><span>share/native/java/lang/String.c</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function">JNIEXPORT jobject JNICALL</span></div><div class="line"><span class="title">Java_java_lang_String_intern</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> JVM_InternString(env, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight c++"><figcaption><span>share/vm/prims/jvm.cpp</span></figcaption><table><tr><td class="code"><pre><div class="line">JVM_ENTRY(jstring, JVM_InternString(JNIEnv *env, jstring str))</div><div class="line">  JVMWrapper(<span class="string">"JVM_InternString"</span>);</div><div class="line">  JvmtiVMObjectAllocEventCollector oam;</div><div class="line">  <span class="keyword">if</span> (str == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">  oop <span class="built_in">string</span> = JNIHandles::resolve_non_null(str);</div><div class="line">  oop result = StringTable::intern(<span class="built_in">string</span>, CHECK_NULL);</div><div class="line">  <span class="keyword">return</span> (jstring) JNIHandles::make_local(env, result);</div><div class="line">JVM_END</div></pre></td></tr></table></figure>
<p>You can see: <code>oop result = StringTable::intern(string, CHECK_NULL);</code><br>It calls the same method as the above code when loading constant string.</p>
<h1 id="visualization"><a href="#visualization" class="headerlink" title="visualization"></a>visualization</h1><p>StringTable has a static field _the_table and it can be accessed directly by StringTable::the_table(); So actually this is a JVM internal data structure belonging to JVM. It is globally created in universe. It makes no sense to say it is located in the method area.</p>
<h2 id="for-Sample1"><a href="#for-Sample1" class="headerlink" title="for Sample1"></a>for Sample1</h2><p><img src="/media/string-table1.png" alt="memory layout for Sample1"></p>
<h2 id="for-Sample2"><a href="#for-Sample2" class="headerlink" title="for Sample2"></a>for Sample2</h2><p><img src="/media/string-table2.png" alt="memory layout for Sample2"></p>
<h2 id="for-Sample3"><a href="#for-Sample3" class="headerlink" title="for Sample3"></a>for Sample3</h2><p><img src="/media/string-table3.png" alt="memory layout for Sample3"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/java-array-has-length-field/" itemprop="url">
                  Java array has length field?
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-22T21:36:25+08:00" content="2016-08-22">
              2016-08-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/22/java-array-has-length-field/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/java-array-has-length-field/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Today, a coworker asked me in which part of object header the length of an array object is stored. Since in my impression, the object header is of two machine words. But a book said for array, there must be length information stored in the object header. But where?</p>
<h1 id="array-is-special"><a href="#array-is-special" class="headerlink" title="array is special"></a>array is special</h1><p>There is no “class definition” of an array (you can’t find it in any .class file), they’re a part of the language itself.</p>
<p>This is quoted from JLS:</p>
<hr>
<blockquote>
<p>10.7. Array Members</p>
<p>The members of an array type are all of the following:</p>
<p>The public final field length, which contains the number of components of the array. length may be positive or zero.<br>The public method clone, which overrides the method of the same name in class Object and throws no checked exceptions. The return type of the clone method of an array type T[] is T[].</p>
<p>A clone of a multidimensional array is shallow, which is to say that it creates only a single new array. Subarrays are shared.<br>All the members inherited from class Object; the only method of Object that is not inherited is its clone method.</p>
</blockquote>
<h1 id="length-is-a-field-of-array-class"><a href="#length-is-a-field-of-array-class" class="headerlink" title="length is a field of array class?"></a>length is a field of array class?</h1><p>No. It is not a field of an array class. You cannot reflect it from its class.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">String[] arr = &#123;<span class="string">"a"</span>, <span class="string">"b"</span>&#125;;</div><div class="line">Field field = arr.getClass().getField(<span class="string">"length"</span>);</div><div class="line">System.out.println(field.get(arr));</div></pre></td></tr></table></figure>
<p>To be disappointed, you cannot get this <code>length</code> field.<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/08/22/java-array-has-length-field/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/how-jvm-handle-method-invocation/" itemprop="url">
                  How JVM handle method invocation
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-22T14:39:25+08:00" content="2016-08-22">
              2016-08-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/22/how-jvm-handle-method-invocation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/how-jvm-handle-method-invocation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Five forms of method invocation in Java:</p>
<ul>
<li><code>invokevirtual</code></li>
<li><code>invokeinterface</code></li>
<li><code>invokestatic</code></li>
<li><code>invokespecial</code></li>
<li><code>invokedynamic</code></li>
</ul>
<h1 id="invokestatic-and-invokevirtual"><a href="#invokestatic-and-invokevirtual" class="headerlink" title="invokestatic and invokevirtual"></a>invokestatic and invokevirtual</h1><p>Of these, <code>invokestatic</code> and <code>invokevirtual</code> are easy to understand.<br><code>invokevirtual</code> is the default behaviour when we invoke an instance method.<br><code>invokestatic</code> is used to invoke the class method based on the type of the reference, not the class of the object when we invoke the static method through the instance rather than the class name.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Superclass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">interestingMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Superclass's interesting method."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subclass</span> <span class="keyword">extends</span> <span class="title">Superclass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">interestingMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Subclass's interesting method."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">        Subclass sub = <span class="keyword">new</span> Subclass();</div><div class="line">        sub.interestingMethod();</div><div class="line"></div><div class="line">        Superclass sub1 = <span class="keyword">new</span> Subclass();</div><div class="line">        sub1.interestingMethod();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>It will print:<br>Subclass’s interesting method.<br>Superclass’s interesting method.<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/08/22/how-jvm-handle-method-invocation/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/15/dynamic-proxy-revisit/" itemprop="url">
                  Dynamic Proxy revisit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-15T16:40:25+08:00" content="2016-08-15">
              2016-08-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/15/dynamic-proxy-revisit/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/15/dynamic-proxy-revisit/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Dynamic-Proxy-in-JDK"><a href="#Dynamic-Proxy-in-JDK" class="headerlink" title="Dynamic Proxy in JDK"></a>Dynamic Proxy in JDK</h1><p><code>Proxy</code> is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: <code>InvocationHandler</code>.</p>
<p><code>InvocationHandler</code> is an interface which we can apply our code into the generated proxy class. It has only one method: <code>Object invoke(Object proxy, Method method, Object[] args)</code></p>
<p>Proxy has four static methods:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces)</div><div class="line"><span class="function"><span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProxyClass</span><span class="params">(Class&lt;?&gt; cl)</span></div><div class="line"><span class="keyword">static</span> InvocationHandler <span class="title">getInvocationHandler</span><span class="params">(Object proxy)</span></span></div></pre></td></tr></table></figure></p>
<p>Now let us see how to generate a proxy class in memory. The main logic is in <code>ProxyClassFactory</code>: firstly it call the <code>ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags)</code> to generate the bytes of class file, and then it invokes the native method of Proxy <code>static native Class&lt;?&gt; defineClass0(ClassLoader loader, String name, byte[] b, int off, int len)</code> to load and resolve the bytes into a <code>Class</code>.</p>
<p>So the two static methods <code>ProxyGenerator.generateProxyClass(..)</code> and <code>Proxy.defineClass0(..)</code> are very important.</p>
<p><code>Proxy.defineClass0(..)</code> makes that we don’t need to define a ClassLoader to load a class from raw bytes. We will use it as a utility method later.</p>
<p><code>ProxyGenerator</code> has no secret since it just generates the bytecode following the class file format in the JVM specification.<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/08/15/dynamic-proxy-revisit/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/21/dbVisualizer-tips/" itemprop="url">
                  DbVisualizer Tips
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-21T18:08:25+08:00" content="2016-04-21">
              2016-04-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/21/dbVisualizer-tips/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/04/21/dbVisualizer-tips/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DbVisualizer-Tips"><a href="#DbVisualizer-Tips" class="headerlink" title="DbVisualizer Tips"></a>DbVisualizer Tips</h1><ol>
<li><p>How do we execute stored procedure?<br>use <code>@call stored_procedure_name;</code></p>
</li>
<li><p>Parameterize SQL with variables<br>Write your SQL as <code>select * from table1 where a = ${param}$</code><br>Execute it and the “Enter data for variables” window will pop up.</p>
</li>
<li><p>Parameterize SQL with markers<br>Write your SQL as <code>select * from table1 where a = :marker</code><br>Execute it and the “Enter data for markers” window will pop up.</p>
</li>
<li><p>How do we render the query result as chart?<br>In the result panel, there is a button “show as chat”, click it and there is also a setting window from where you can configure the way the data is shown.</p>
</li>
<li><p>DbVis can get the query Explain Plan.</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/04/understand-when-to-rollback/" itemprop="url">
                  Understand when to rollback
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-04T10:45:25+08:00" content="2016-03-04">
              2016-03-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/04/understand-when-to-rollback/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/04/understand-when-to-rollback/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h1><p>At first, I create a table:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"SYSTEM"</span>.<span class="string">"TEST"</span> </div><div class="line">(	</div><div class="line">  <span class="string">"ID"</span> <span class="built_in">NUMBER</span>(*,<span class="number">0</span>), </div><div class="line">  <span class="string">"NAME"</span> VARCHAR2(<span class="number">200</span> <span class="keyword">BYTE</span>), </div><div class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">"TEST_PK"</span> PRIMARY <span class="keyword">KEY</span> (<span class="string">"ID"</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>Then, create a stored procedure:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_insert (x <span class="built_in">NUMBER</span>) <span class="keyword">IS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">  <span class="comment">-- Do some inserts here.</span></div><div class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> <span class="keyword">VALUES</span> (x, <span class="string">'insert by stored procedure'</span>);</div><div class="line">  <span class="comment">-- Sometimes there might be an error.</span></div><div class="line">  IF x = 2 THEN</div><div class="line">    RAISE_APPLICATION_ERROR(-20000, 'Wooops...');</div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">EXCEPTION</div><div class="line">  WHEN OTHERS THEN</div><div class="line">    <span class="comment">--Rollback all the changes and then raise the error again.</span></div><div class="line">    <span class="keyword">ROLLBACK</span>;</div><div class="line">    RAISE;</div><div class="line"><span class="keyword">END</span> sp_insert;</div></pre></td></tr></table></figure>
<p>To understand how to handle the rollback, I wrote a test to demonstrate the rule.</p>
<p>Before each test, we insert a record with the id of 2.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// JDBC driver name and database URL</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DB_URL = <span class="string">"jdbc:oracle:thin:@10.10.10.100:1521:ENG11R2"</span>;</div><div class="line">    <span class="comment">//  Database credentials</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"system"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PASS = <span class="string">"oracle"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</div><div class="line"></div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">        PreparedStatement statement = conn.prepareStatement(<span class="string">"truncate table test"</span>);</div><div class="line">        statement.execute();</div><div class="line">        </div><div class="line">        String sql = <span class="string">"insert into test values (2, 'insert in advance')"</span>;</div><div class="line">        statement = conn.prepareStatement(sql);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@After</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</div><div class="line">        PreparedStatement statement = conn.prepareStatement(<span class="string">"select * from test"</span>);</div><div class="line">        ResultSet rs = statement.executeQuery();</div><div class="line">        <span class="keyword">while</span>(rs.next()) &#123;</div><div class="line">            System.out.printf(<span class="string">"%d | %s %n"</span>, rs.getInt(<span class="number">1</span>), rs.getString(<span class="number">2</span>));</div><div class="line">        &#125;</div><div class="line">        conn.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clientExitDueToException</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        System.out.printf(<span class="string">"-----------Now start run clientExitDueToException test -----------%n"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</div><div class="line"></div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">        String sql = <span class="string">"insert into test values (?, 'insert by clientExitDueToException')"</span>;</div><div class="line">        PreparedStatement statement = conn.prepareStatement(sql);</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">2</span>); <span class="comment">// expected throw exception here</span></div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">3</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clientIgnoreError</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        System.out.printf(<span class="string">"-----------Now start run clientIgnoreError test -----------%n"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</div><div class="line"></div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">        String sql = <span class="string">"insert into test values (?, 'insert by clientIgnoreError')"</span>;</div><div class="line">        PreparedStatement statement = conn.prepareStatement(sql);</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            statement.setInt(<span class="number">1</span>, <span class="number">2</span>);</div><div class="line">            statement.execute();</div><div class="line">        &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</div><div class="line">            <span class="comment">// silently ignore unique key violation to prevent rollback,</span></div><div class="line">            <span class="comment">// but statement-level rollback still happen implicitly</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">3</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clientNoErrorButProcedureRollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        System.out.printf(<span class="string">"-----------Now start run clientNoErrorButProcedureRollback test -----------%n"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</div><div class="line"></div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">        PreparedStatement statement = conn.prepareStatement(<span class="string">"insert into test (id, name) values (?, 'clientNoErrorButProcedureRollback')"</span>);</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        <span class="comment">// rollback within stored procedure</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PreparedStatement sp = conn.prepareCall(<span class="string">"&#123; call sp_insert(2) &#125;"</span>); <span class="comment">// 2</span></div><div class="line">            sp.execute();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            <span class="comment">// ignore the exception within the stored procedure</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        statement.setInt(<span class="number">1</span>, <span class="number">3</span>);</div><div class="line">        statement.execute();</div><div class="line"></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The results of the code:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">-----------Now start run clientExitDueToException test -----------</div><div class="line">2 | insert in advance </div><div class="line"></div><div class="line">java.sql.SQLIntegrityConstraintViolationException: ORA-00001: unique constraint (SYSTEM.TEST_PK) violated</div><div class="line"></div><div class="line"></div><div class="line">	at oracle.jdbc.driver.T4CTTIoer.processError(T4CTTIoer.java:450)</div><div class="line">	at oracle.jdbc.driver.T4CTTIoer.processError(T4CTTIoer.java:399)</div><div class="line">	at oracle.jdbc.driver.T4C8Oall.processError(T4C8Oall.java:1059)</div><div class="line">	at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:522)</div><div class="line">	at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:257)</div><div class="line">	at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:587)</div><div class="line">	at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:225)</div><div class="line">	at oracle.jdbc.driver.T4CPreparedStatement.doOall8(T4CPreparedStatement.java:53)</div><div class="line">	at oracle.jdbc.driver.T4CPreparedStatement.executeForRows(T4CPreparedStatement.java:943)</div><div class="line">	at oracle.jdbc.driver.OracleStatement.doExecuteWithTimeout(OracleStatement.java:1150)</div><div class="line">	at oracle.jdbc.driver.OraclePreparedStatement.executeInternal(OraclePreparedStatement.java:4798)</div><div class="line">	at oracle.jdbc.driver.OraclePreparedStatement.execute(OraclePreparedStatement.java:4901)</div><div class="line">	at oracle.jdbc.driver.OraclePreparedStatementWrapper.execute(OraclePreparedStatementWrapper.java:1385)</div><div class="line">	at TransactionTest.clientExitDueToException(TransactionTest.java:56)</div><div class="line">	</div><div class="line">	</div><div class="line">-----------Now start run clientIgnoreError test -----------</div><div class="line">2 | insert in advance </div><div class="line">1 | insert by clientIgnoreError </div><div class="line">3 | insert by clientIgnoreError </div><div class="line"></div><div class="line">-----------Now start run clientNoErrorButProcedureRollback test -----------</div><div class="line">2 | insert in advance </div><div class="line">3 | clientNoErrorButProcedureRollback</div></pre></td></tr></table></figure>
<h1 id="Case-1"><a href="#Case-1" class="headerlink" title="Case 1"></a>Case 1</h1><p>The java code didn’t catch the <code>SQLException</code>, so the jvm will exit before the commit line. </p>
<p>For this case, the equivalent script the database received is like this:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'insert by clientExitDueToException'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'insert by clientExitDueToException'</span>); </div><div class="line"><span class="comment">-- the above statement will be rollbacked implicitly due to unique key violation</span></div></pre></td></tr></table></figure>
<p>Because the database think the client exited, it rollback the transaction.</p>
<h1 id="Case-2"><a href="#Case-2" class="headerlink" title="Case 2"></a>Case 2</h1><p>The java code caught the exception and silently supressed it, the code can run to the commit line. So the transaction is committed normally. </p>
<p>For this case, the equivalent script the database received is like this:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'insert by clientIgnoreError'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'insert by clientIgnoreError'</span>); </div><div class="line"><span class="comment">-- the above statement will be rollbacked implicitly due to unique key violation</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">'insert by clientIgnoreError'</span>;</div><div class="line"><span class="keyword">COMMIT</span>;</div></pre></td></tr></table></figure>
<p>Although the transaction committed, the second statement will be rollbacked. This demonstrated the support of statement-level rollback.</p>
<h1 id="Case-3"><a href="#Case-3" class="headerlink" title="Case 3"></a>Case 3</h1><p>The java code caught the exception and silently supressed it, the code can run to the commit line. So the transaction is committed normally. </p>
<p>But in the stored procedure, it rollbacked the transaction. So it caused the records before the error statement to rollback.</p>
<p>For this case, the equivalent script the database received is like this:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'insert by clientNoErrorButProcedureRollback'</span>);</div><div class="line"><span class="comment">-- the above statement will be rollbacked due to the rollback statement within the procedure</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'insert by clientNoErrorButProcedureRollback'</span>); </div><div class="line"><span class="comment">-- the above statement will be rollbacked implicitly due to unique key violation</span></div><div class="line"><span class="keyword">ROLLBACK</span>;</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TEST</span> <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">'insert by clientNoErrorButProcedureRollback'</span></div><div class="line"><span class="keyword">COMMIT</span>;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/01/oracle-statement-level-rollback/" itemprop="url">
                  Oracle Statement-Level ROLLBACK
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-01T10:45:25+08:00" content="2016-03-01">
              2016-03-01
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/01/oracle-statement-level-rollback/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/01/oracle-statement-level-rollback/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Oracle Statement-Level ROLLBACK (undo of a transaction)</p>
<h1 id="Purpose"><a href="#Purpose" class="headerlink" title="Purpose"></a>Purpose</h1><p>Use the ROLLBACK statement to <a href="http://gerardnico.com/wiki/database/oracle/undo" target="_blank" rel="external">undo</a> work done in the current <a href="http://gerardnico.com/wiki/database/oracle/transaction" target="_blank" rel="external">transaction</a> or to manually undo the work done by an in-doubt distributed transaction.</p>
<h1 id="Articles-Related"><a href="#Articles-Related" class="headerlink" title="Articles Related"></a>Articles Related</h1><p><a href="http://gerardnico.com/wiki/database/oracle/deadlock" target="_blank" rel="external">Oracle Database - Deadlock</a><br><a href="http://gerardnico.com/wiki/database/oracle/distributed_transaction" target="_blank" rel="external">Oracle Database - Distributed Transactions</a><br><a href="http://gerardnico.com/wiki/database/oracle/lock" target="_blank" rel="external">Oracle Database - Locks</a><br><a href="http://gerardnico.com/wiki/database/oracle/row_lock" target="_blank" rel="external">Oracle Database - Row Locks (TX)</a><br><a href="http://gerardnico.com/wiki/database/oracle/tablespace" target="_blank" rel="external">Oracle Database - TableSpace</a><br><a href="http://gerardnico.com/wiki/database/oracle/transaction" target="_blank" rel="external">Oracle Database - Transactions</a><br><a href="http://gerardnico.com/wiki/database/oracle/undo" target="_blank" rel="external">Oracle Database - UNDO (Rollback Segment)</a><br><a href="http://gerardnico.com/wiki/plsql/autonomous_transaction" target="_blank" rel="external">PL/SQL - Autonomous Transactions (Pragma)</a></p>
<h1 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h1><h2 id="Implicit"><a href="#Implicit" class="headerlink" title="Implicit"></a>Implicit</h2><p>An implicit ROLLBACK occurs when the session (or program) abnormally terminates.</p>
<h2 id="Explicit"><a href="#Explicit" class="headerlink" title="Explicit"></a>Explicit</h2><p>An explicit commit occurs when the ROLLBACK statement is executed.</p>
<h1 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h1><p>Rollback to savepoint<br>ROLLBACK [WORK] TO SAVEPOINT;<br>If the savepoint is unknown, Oracle will display a warning but the transaction can continue.</p>
<p>Rollback. Rollback the whole transaction ignoring the savepoints.<br>ROLLBACK</p>
<h1 id="Statement-Level-Rollback"><a href="#Statement-Level-Rollback" class="headerlink" title="Statement-Level Rollback"></a>Statement-Level Rollback</h1><p>Oracle Database supports statement-level atomicity, which means that a SQL statement is an atomic unit of work and either completely succeeds or completely fails.</p>
<p>A successful statement is different from a committed transaction. A single SQL statement executes successfully if the database parses and runs it without error as an atomic unit, as when all rows are changed in a multirow update.</p>
<p>If a SQL statement causes an error during execution, then it is not successful and so all effects of the statement are rolled back. This operation is a statement-level rollback. This operation has the following characteristics:</p>
<p>A SQL statement that does not succeed causes the loss only of work it would have performed itself.</p>
<p>The unsuccessful statement does not cause the loss of any work that preceded it in the current transaction. For example, if the execution of the second UPDATE statement in Figure 10-1 causes an error and is rolled back, then the work performed by the first UPDATE statement is not rolled back. The first UPDATE statement can be committed or rolled back explicitly by the user.</p>
<p>The effect of the rollback is as if the statement had never been run.<br>Any side effects of an atomic statement, for example, triggers invoked upon execution of the statement, are considered part of the atomic statement. Either all work generated as part of the atomic statement succeeds or none does.</p>
<p>An example of an error causing a statement-level rollback is an attempt to insert a duplicate primary key. Single SQL statements involved in a deadlock, which is competition for the same data, can also cause a statement-level rollback. However, errors discovered during SQL statement parsing, such as a syntax error, have not yet been run and so do not cause a statement-level rollback.</p>
<h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><figure class="highlight"><table><tr><td class="code"><pre><div class="line">gerardnico@orcl&gt;CREATE TABLE big_table AS SELECT * FROM all_objects WHERE 1=0;</div><div class="line"> </div><div class="line">TABLE created.</div><div class="line"> </div><div class="line">gerardnico@orcl&gt;SELECT COUNT(*) FROM big_table;</div><div class="line"> </div><div class="line">  COUNT(*)</div><div class="line">----------</div><div class="line">         0</div><div class="line"> </div><div class="line">gerardnico@orcl&gt;INSERT INTO big_table SELECT * FROM all_objects</div><div class="line"> </div><div class="line">66651 rows created.</div><div class="line">gerardnico@orcl&gt;SELECT COUNT(*) FROM big_table;</div><div class="line"> </div><div class="line">  COUNT(*)</div><div class="line">----------</div><div class="line">     66651</div><div class="line"> </div><div class="line">gerardnico@orcl&gt;ROLLBACK;</div><div class="line"> </div><div class="line">ROLLBACK complete.</div><div class="line"> </div><div class="line">gerardnico@orcl&gt;SELECT COUNT(*) FROM big_table;</div><div class="line"> </div><div class="line">  COUNT(*)</div><div class="line">----------</div><div class="line">         0</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://download.oracle.com/docs/cd/B28359_01/server.111/b28286/statements_9021.htm#SQLRF01610" target="_blank" rel="external">Rollback</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/16/java-security-2nd-notes-1/" itemprop="url">
                  Java Security 2nd - notes 1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-02-16T16:45:25+08:00" content="2016-02-16">
              2016-02-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/16/java-security-2nd-notes-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/02/16/java-security-2nd-notes-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="security-manager-vs-access-controller"><a href="#security-manager-vs-access-controller" class="headerlink" title="security manager vs. access controller"></a>security manager vs. access controller</h2><p>Historically, before the access controller existed, the security manager relied on its internal logic to determine the security policy that should be in effect, and changing the security policy required changing the security manager itself. Starting with Java 2, the security manager defers these decisions to the access controller. Since the security policy enforced by the access controller can be specified by using policy files, this allows a much more flexible mechanism for determining policies.</p>
<p>Java applications (at least by default) have no security manager while Java applets (again, by default) have a very strict security manager.</p>
<p>Specifying the <code>−Djava.security.manager</code> JVM option to install a security manager. But by default the security manager is installed programatically by the appletviewer and the Java Plug-in.</p>
<p>How do APIs use <code>SecurityManager</code> to check the allowance of an operation?</p>
<p>Take the <code>FileInputStream</code> class as an example:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">    SecurityManager security = System.getSecurityManager(  );</div><div class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</div><div class="line">        security.checkRead(name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        open(name);         <span class="comment">// open() is a private method of this class</span></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(name);</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>System</code> has two static methods to get and set security manager.</p>
<ul>
<li><code>public static SecurityManager getSecurityManager()</code></li>
<li><code>public static void setSecurityManager(SecurityManager sm)</code></li>
</ul>
<p>A single security manager per virtual machine.</p>
<h2 id="The-Access-Controller"><a href="#The-Access-Controller" class="headerlink" title="The Access Controller"></a>The Access Controller</h2><p>//TODO</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://qph.is.quoracdn.net/main-thumb-27403014-200-azcnfpakpayhgojvmueqcfjeyufbjpcx.jpeg"
               alt="Richard Yang" />
          <p class="site-author-name" itemprop="name">Richard Yang</p>
          <p class="site-description motion-element" itemprop="description">Nothing seek, nothing find</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">132</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://linkedin.com/in/richdyang" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://github.com/richdyang" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github-alt"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://bitbucket.org/richdyang" target="_blank" title="Bitbucket">
                  
                    <i class="fa fa-fw fa-bitbucket"></i>
                  
                  Bitbucket
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" title="Stackoverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                  Stackoverflow
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://twitter.com/richdyang" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard Yang</span>
</div>

<!--div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div-->

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'richyang';
      var disqus_identifier = 'index.html';
      var disqus_title = '';

      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script>
  




  
  

  

  

  
  

  
  
  
  <link rel="stylesheet" href="/vendors/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/vendors/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



</body>
</html>
