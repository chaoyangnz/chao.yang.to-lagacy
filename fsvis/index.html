<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <!-- <link type="text/css" rel="stylesheet" href="style.css"/> -->
    <style type="text/css">

circle.node {
  cursor: pointer;
  /* stroke: #000; */
  stroke-width: .5px;
}

line.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

.tooltip {
    border: 1px solid #ccc;
    font-size: .9em;
    padding: .3em;
    background: #000;
    opacity: .6;
    color: #fff;
    border-radius: 5px;
}

.filter_button {
    /* border: 1px solid #ccc; */
    display: inline-block;
    cursor: pointer;
    padding: 5px;
    color: #ffffff;
    text-align: center;
    width: 70px;
    margin-right: 10px;
}

</style>
</head>
<body style="background: #eee">
    <div id="chart" width="1280" height="700">
            <div class="tooltip" style="position: absolute; z-index: 10; visibility: hidden;">
                <div id="tt-name"></div>
                <div id="tt-size"></div>
                <div id="tt-path"></div>
                <div id="tt-ctime"></div>
                <div id="tt-mtime"></div>
                <div id="tt-stsize"></div>
            </div>
    </div>
    <div style="margin-left: 150px">
        <a class="filter_button" onclick="filter('')" style="background: #000000">All</a>
        <a class="filter_button" onclick="filter('js')" style="background: #663300">Javascript</a>
        <a class="filter_button" onclick="filter('ts')" style="background: #ff9933">Typescript</a>
        <a class="filter_button" onclick="filter('html')" style="background: #cccc00">HTML</a>
        <a class="filter_button" onclick="filter('css')" style="background: #66cc33">CSS</a>
        <a class="filter_button" onclick="filter('scss')" style="background: #99cc99">SCSS</a>
        <a class="filter_button" onclick="filter('java')" style="background: #cc3300">Java</a>
        <a class="filter_button" onclick="filter('xml')" style="background: #009999">XML</a>
        <a class="filter_button" onclick="filter('go')" style="background: #6699cc">Go</a>
        <a class="filter_button" onclick="filter('sh')" style="background: #666633">Shell</a>
        <a class="filter_button" onclick="filter('py')" style="background: #9999cc">Python</a>
    </div>
<script type="text/javascript" src="https://d3js.org/d3.v2.min.js"></script>
<script type="text/javascript" src="d3/d3.geom.js"></script>
<script type="text/javascript" src="d3/d3.layout.js"></script>
<script type="text/javascript" src="d3/d3.fisheye.js"></script>
<script type="text/javascript">

var colors_map = {
    'directory': '#c6dbef',
    'js': "#663300",
    'ts': "#ff9933",
    'html': "#cccc00",
    'css': "#66cc33",
    'scss': "#99cc99",
    'java': "#cc3300",
    'xml': "#009999",
    'go': "#6699cc",
    'sh': "#666633",
    'py': "#9999cc"
}

var width = 1280,
    height = 700,
    node,
    link,
    root;

var force = d3.layout.force()
    .on("tick", tick)
    .charge(function(d) { return d._children ? -d.size / 300 : -100; })
    .linkDistance(function(d) { return d.target._children ? 80 : 30; })
    .size([width, height - 160]);

var fisheye = d3.fisheye.circular()
    .radius(200)
    .distortion(2); 

var svg = d3.select("#chart").append("svg:svg")
    .attr("width", width)
    .attr("height", height);

var tooltip = d3.select("#chart").select('.tooltip')

d3.json("fs.json", function(json) {
  root = json;
  root.fixed = true;
  root.x = width / 2;
  root.y = height / 2 - 80;
  update();

  svg.on("mousemove", function() {
    fisheye.focus(d3.mouse(this));

    node.each(function(d) { d.fisheye = fisheye(d); })
        .attr("cx", function(d) { return d.fisheye.x; })
        .attr("cy", function(d) { return d.fisheye.y; })
        .attr("r", function(d) { return (d.children ? 4.5 : Math.sqrt(d.size) / 2) * d.fisheye.z })

    link.attr("x1", function(d) { return d.source.fisheye.x; })
        .attr("y1", function(d) { return d.source.fisheye.y; })
        .attr("x2", function(d) { return d.target.fisheye.x; })
        .attr("y2", function(d) { return d.target.fisheye.y; });
  });
});

function filter(type) {
    node.style('fill', function(d) {
        return type == '' || d.type == type ? colors_map[d.type] : '#ffffff'
    })
}

function update() {
  var nodes = flatten(root),
      links = d3.layout.tree().links(nodes);

  // Restart the force layout.
  force
      .nodes(nodes)
      .links(links)
      .start();

  // Update the links…
  link = svg.selectAll("line.link")
      .data(links, function(d) { return d.target.id; });

  // Enter any new links.
  link.enter().insert("svg:line", ".node")
      .attr("class", "link")
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  // Exit any old links.
  link.exit().remove();

  // Update the nodes…
  node = svg.selectAll("circle.node")
      .data(nodes, function(d) { return d.id; })
      .style("fill", color)
      .style("stroke", strokeColor);

  node.transition()
      .attr("r", function(d) { return d.children ? 4.5 : Math.sqrt(d.size) / 2; });

  // Enter any new nodes.
  node.enter().append("svg:circle")
      .attr("class", "node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", function(d) { return d.children ? 4.5 : Math.sqrt(d.size) / 2; })
      .style("fill", color)
      .style("stroke", strokeColor)
      .on("click", click)
      .on("mouseover", function (d) { 
        tooltip.select("#tt-name").text(d.name)
        tooltip.select("#tt-path").text(d.path)
        tooltip.select("#tt-size").text(d.size + " lines")
        tooltip.select("#tt-ctime").text("created at " + d.ctime)
        tooltip.select("#tt-mtime").text("created at " + d.mtime)
        tooltip.select("#tt-stsize").text(d.st_size + " bytes")
        return tooltip.style("visibility", "visible");
      })
      .on("mousemove", function () {
        return tooltip.style("top", (d3.event.pageY - 20) + "px").style("left", (d3.event.pageX + 20) + "px");
      })
      .on("mouseout", function () {
        return tooltip.style("visibility", "hidden");
      })
      .call(force.drag);

  // Exit any old nodes.
  node.exit().remove();
}

function tick() {
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });


}



// Color leaf nodes orange, and packages white or blue.
function color(d) {
    //   return d._children ? "#3182bd" : d.children ? "#c6dbef" : "#fd8d3c";
    if(d._children) {
        return "#666666"
    }
    if(d.children) {
        return "#c6dbef"
    }

    for(var type in colors_map) {
        if(type == d.type) {
            return colors_map[type]
        }
    }

    return "#000000"
}

function strokeColor(d) {
    if(d._childrend || d.children) {
        return "#000000"
    } else {
        return "#cccccc"
    }
}

// Toggle children on click.
function click(d) {
  if (d.children) {
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  update();
}

// Returns a list of all nodes under the root.
function flatten(root) {
  var nodes = [], i = 0;

  function recurse(node) {
    if (node.children) node.size = node.children.reduce(function(p, v) { return p + recurse(v); }, 0);
    if (!node.id) node.id = ++i;
    nodes.push(node);
    return node.size;
  }

  root.size = recurse(root);
  return nodes;
}

    </script>
  </body>
</html>
