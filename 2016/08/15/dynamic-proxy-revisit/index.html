<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Richard Yang, Java Developer, Senior software engineer" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Dynamic Proxy in JDKProxy is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: Invocatio">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic Proxy revisit">
<meta property="og:url" content="https://richyang.me/2016/08/15/dynamic-proxy-revisit/index.html">
<meta property="og:site_name" content="Richard Yang">
<meta property="og:description" content="Dynamic Proxy in JDKProxy is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: Invocatio">
<meta property="og:updated_time" content="2016-09-02T16:49:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dynamic Proxy revisit">
<meta name="twitter:description" content="Dynamic Proxy in JDKProxy is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: Invocatio">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    },
    algolia: {
      applicationID: 'X0H1P7HDKY',
      apiKey: 'ddc0af00a6e07c9b1be9f4da4cf5b9d9',
      indexName: 'richyang.me',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>




  <title> Dynamic Proxy revisit | Richard Yang </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <!--span class="logo-line-before"><i></i></span-->
      <span class="site-title">Richard Yang</span>
      <!--span class="logo-line-after"><i></i></span-->
    </a>
  </div>
  <p class="site-subtitle">Full-stack software engineer mainly focusing on Java-based technologies and web front-end</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-books">
          <a href="https://www.gitbook.com/@richdyang" rel="section">
            
            Books
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-showcase">
          <a href="/showcase" rel="section">
            
            Showcase
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-resume">
          <a href="http://linkedin.com/in/richdyang" rel="section">
            
            Résumé
          </a>
        </li>
        
      
        
        
      
        
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            About
          </a>
        </li>
        
      
        
        
      
        
        
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
            <i class="menu-item-icon fa fa-search fa-lg"></i>Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>

<div class="social-links" style="float: right; padding-left: 50px; margin-right: 10px">
      
        
          <span class="links-of-author-item">
            <a href="http://linkedin.com/in/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-linkedin"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://github.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-github-alt"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://bitbucket.org/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-bitbucket"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://twitter.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-twitter"></i>
                </span>
                 
              
            </a>
          </span>
        
      
  </div>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Dynamic Proxy revisit
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-15T20:40:25+12:00" content="2016-08-15">
              2016-08-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/15/dynamic-proxy-revisit/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/15/dynamic-proxy-revisit/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Dynamic-Proxy-in-JDK"><a href="#Dynamic-Proxy-in-JDK" class="headerlink" title="Dynamic Proxy in JDK"></a>Dynamic Proxy in JDK</h1><p><code>Proxy</code> is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: <code>InvocationHandler</code>.</p>
<p><code>InvocationHandler</code> is an interface which we can apply our code into the generated proxy class. It has only one method: <code>Object invoke(Object proxy, Method method, Object[] args)</code></p>
<p>Proxy has four static methods:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces)</div><div class="line"><span class="function"><span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProxyClass</span><span class="params">(Class&lt;?&gt; cl)</span></div><div class="line"><span class="keyword">static</span> InvocationHandler <span class="title">getInvocationHandler</span><span class="params">(Object proxy)</span></div></pre></td></tr></table></figure></p>
<p>Now let us see how to generate a proxy class in memory. The main logic is in <code>ProxyClassFactory</code>: firstly it call the <code>ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags)</code> to generate the bytes of class file, and then it invokes the native method of Proxy <code>static native Class&lt;?&gt; defineClass0(ClassLoader loader, String name, byte[] b, int off, int len)</code> to load and resolve the bytes into a <code>Class</code>.</p>
<p>So the two static methods <code>ProxyGenerator.generateProxyClass(..)</code> and <code>Proxy.defineClass0(..)</code> are very important.</p>
<p><code>Proxy.defineClass0(..)</code> makes that we don’t need to define a ClassLoader to load a class from raw bytes. We will use it as a utility method later.</p>
<p><code>ProxyGenerator</code> has no secret since it just generates the bytecode following the class file format in the JVM specification.<br><a id="more"></a><br><figure class="highlight java"><figcaption><span>https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/sun/misc/ProxyGenerator.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> sun.misc;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.DataOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Array;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.LinkedList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.ListIterator;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> sun.security.action.GetBooleanAction;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ProxyGenerator contains the code to generate a dynamic proxy class</div><div class="line"> * for the java.lang.reflect.Proxy API.</div><div class="line"> *</div><div class="line"> * The external interfaces to ProxyGenerator is the static</div><div class="line"> * "generateProxyClass" method.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span>      Peter Jones</div><div class="line"> * <span class="doctag">@since</span>       1.3</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyGenerator</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * In the comments below, "JVMS" refers to The Java Virtual Machine</div><div class="line">     * Specification Second Edition and "JLS" refers to the original</div><div class="line">     * version of The Java Language Specification, unless otherwise</div><div class="line">     * specified.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/* generate 1.5-era class file version */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLASSFILE_MAJOR_VERSION = <span class="number">49</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLASSFILE_MINOR_VERSION = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * beginning of constants copied from</div><div class="line">     * sun.tools.java.RuntimeConstants (which no longer exists):</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/* constant pool tags */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_UTF8              = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_UNICODE           = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_INTEGER           = <span class="number">3</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_FLOAT             = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_LONG              = <span class="number">5</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_DOUBLE            = <span class="number">6</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_CLASS             = <span class="number">7</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_STRING            = <span class="number">8</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_FIELD             = <span class="number">9</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_METHOD            = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_INTERFACEMETHOD   = <span class="number">11</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_NAMEANDTYPE       = <span class="number">12</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* access and modifier flags */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_PUBLIC                 = <span class="number">0x00000001</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_PRIVATE                = <span class="number">0x00000002</span>;</div><div class="line"><span class="comment">//  private static final int ACC_PROTECTED              = 0x00000004;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_STATIC                 = <span class="number">0x00000008</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_FINAL                  = <span class="number">0x00000010</span>;</div><div class="line"><span class="comment">//  private static final int ACC_SYNCHRONIZED           = 0x00000020;</span></div><div class="line"><span class="comment">//  private static final int ACC_VOLATILE               = 0x00000040;</span></div><div class="line"><span class="comment">//  private static final int ACC_TRANSIENT              = 0x00000080;</span></div><div class="line"><span class="comment">//  private static final int ACC_NATIVE                 = 0x00000100;</span></div><div class="line"><span class="comment">//  private static final int ACC_INTERFACE              = 0x00000200;</span></div><div class="line"><span class="comment">//  private static final int ACC_ABSTRACT               = 0x00000400;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_SUPER                  = <span class="number">0x00000020</span>;</div><div class="line"><span class="comment">//  private static final int ACC_STRICT                 = 0x00000800;</span></div><div class="line"></div><div class="line">    <span class="comment">/* opcodes */</span></div><div class="line"><span class="comment">//  private static final int opc_nop                    = 0;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aconst_null            = <span class="number">1</span>;</div><div class="line"><span class="comment">//  private static final int opc_iconst_m1              = 2;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iconst_0               = <span class="number">3</span>;</div><div class="line"><span class="comment">//  private static final int opc_iconst_1               = 4;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_2               = 5;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_3               = 6;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_4               = 7;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_5               = 8;</span></div><div class="line"><span class="comment">//  private static final int opc_lconst_0               = 9;</span></div><div class="line"><span class="comment">//  private static final int opc_lconst_1               = 10;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_0               = 11;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_1               = 12;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_2               = 13;</span></div><div class="line"><span class="comment">//  private static final int opc_dconst_0               = 14;</span></div><div class="line"><span class="comment">//  private static final int opc_dconst_1               = 15;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_bipush                 = <span class="number">16</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_sipush                 = <span class="number">17</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ldc                    = <span class="number">18</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ldc_w                  = <span class="number">19</span>;</div><div class="line"><span class="comment">//  private static final int opc_ldc2_w                 = 20;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iload                  = <span class="number">21</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lload                  = <span class="number">22</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_fload                  = <span class="number">23</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dload                  = <span class="number">24</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aload                  = <span class="number">25</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iload_0                = <span class="number">26</span>;</div><div class="line"><span class="comment">//  private static final int opc_iload_1                = 27;</span></div><div class="line"><span class="comment">//  private static final int opc_iload_2                = 28;</span></div><div class="line"><span class="comment">//  private static final int opc_iload_3                = 29;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lload_0                = <span class="number">30</span>;</div><div class="line"><span class="comment">//  private static final int opc_lload_1                = 31;</span></div><div class="line"><span class="comment">//  private static final int opc_lload_2                = 32;</span></div><div class="line"><span class="comment">//  private static final int opc_lload_3                = 33;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_fload_0                = <span class="number">34</span>;</div><div class="line"><span class="comment">//  private static final int opc_fload_1                = 35;</span></div><div class="line"><span class="comment">//  private static final int opc_fload_2                = 36;</span></div><div class="line"><span class="comment">//  private static final int opc_fload_3                = 37;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dload_0                = <span class="number">38</span>;</div><div class="line"><span class="comment">//  private static final int opc_dload_1                = 39;</span></div><div class="line"><span class="comment">//  private static final int opc_dload_2                = 40;</span></div><div class="line"><span class="comment">//  private static final int opc_dload_3                = 41;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aload_0                = <span class="number">42</span>;</div><div class="line"><span class="comment">//  private static final int opc_aload_1                = 43;</span></div><div class="line"><span class="comment">//  private static final int opc_aload_2                = 44;</span></div><div class="line"><span class="comment">//  private static final int opc_aload_3                = 45;</span></div><div class="line"><span class="comment">//  private static final int opc_iaload                 = 46;</span></div><div class="line"><span class="comment">//  private static final int opc_laload                 = 47;</span></div><div class="line"><span class="comment">//  private static final int opc_faload                 = 48;</span></div><div class="line"><span class="comment">//  private static final int opc_daload                 = 49;</span></div><div class="line"><span class="comment">//  private static final int opc_aaload                 = 50;</span></div><div class="line"><span class="comment">//  private static final int opc_baload                 = 51;</span></div><div class="line"><span class="comment">//  private static final int opc_caload                 = 52;</span></div><div class="line"><span class="comment">//  private static final int opc_saload                 = 53;</span></div><div class="line"><span class="comment">//  private static final int opc_istore                 = 54;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore                 = 55;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore                 = 56;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore                 = 57;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_astore                 = <span class="number">58</span>;</div><div class="line"><span class="comment">//  private static final int opc_istore_0               = 59;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_1               = 60;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_2               = 61;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_3               = 62;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_0               = 63;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_1               = 64;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_2               = 65;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_3               = 66;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_0               = 67;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_1               = 68;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_2               = 69;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_3               = 70;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_0               = 71;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_1               = 72;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_2               = 73;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_3               = 74;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_astore_0               = <span class="number">75</span>;</div><div class="line"><span class="comment">//  private static final int opc_astore_1               = 76;</span></div><div class="line"><span class="comment">//  private static final int opc_astore_2               = 77;</span></div><div class="line"><span class="comment">//  private static final int opc_astore_3               = 78;</span></div><div class="line"><span class="comment">//  private static final int opc_iastore                = 79;</span></div><div class="line"><span class="comment">//  private static final int opc_lastore                = 80;</span></div><div class="line"><span class="comment">//  private static final int opc_fastore                = 81;</span></div><div class="line"><span class="comment">//  private static final int opc_dastore                = 82;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aastore                = <span class="number">83</span>;</div><div class="line"><span class="comment">//  private static final int opc_bastore                = 84;</span></div><div class="line"><span class="comment">//  private static final int opc_castore                = 85;</span></div><div class="line"><span class="comment">//  private static final int opc_sastore                = 86;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_pop                    = <span class="number">87</span>;</div><div class="line"><span class="comment">//  private static final int opc_pop2                   = 88;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dup                    = <span class="number">89</span>;</div><div class="line"><span class="comment">//  private static final int opc_dup_x1                 = 90;</span></div><div class="line"><span class="comment">//  private static final int opc_dup_x2                 = 91;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2                   = 92;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2_x1                = 93;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2_x2                = 94;</span></div><div class="line"><span class="comment">//  private static final int opc_swap                   = 95;</span></div><div class="line"><span class="comment">//  private static final int opc_iadd                   = 96;</span></div><div class="line"><span class="comment">//  private static final int opc_ladd                   = 97;</span></div><div class="line"><span class="comment">//  private static final int opc_fadd                   = 98;</span></div><div class="line"><span class="comment">//  private static final int opc_dadd                   = 99;</span></div><div class="line"><span class="comment">//  private static final int opc_isub                   = 100;</span></div><div class="line"><span class="comment">//  private static final int opc_lsub                   = 101;</span></div><div class="line"><span class="comment">//  private static final int opc_fsub                   = 102;</span></div><div class="line"><span class="comment">//  private static final int opc_dsub                   = 103;</span></div><div class="line"><span class="comment">//  private static final int opc_imul                   = 104;</span></div><div class="line"><span class="comment">//  private static final int opc_lmul                   = 105;</span></div><div class="line"><span class="comment">//  private static final int opc_fmul                   = 106;</span></div><div class="line"><span class="comment">//  private static final int opc_dmul                   = 107;</span></div><div class="line"><span class="comment">//  private static final int opc_idiv                   = 108;</span></div><div class="line"><span class="comment">//  private static final int opc_ldiv                   = 109;</span></div><div class="line"><span class="comment">//  private static final int opc_fdiv                   = 110;</span></div><div class="line"><span class="comment">//  private static final int opc_ddiv                   = 111;</span></div><div class="line"><span class="comment">//  private static final int opc_irem                   = 112;</span></div><div class="line"><span class="comment">//  private static final int opc_lrem                   = 113;</span></div><div class="line"><span class="comment">//  private static final int opc_frem                   = 114;</span></div><div class="line"><span class="comment">//  private static final int opc_drem                   = 115;</span></div><div class="line"><span class="comment">//  private static final int opc_ineg                   = 116;</span></div><div class="line"><span class="comment">//  private static final int opc_lneg                   = 117;</span></div><div class="line"><span class="comment">//  private static final int opc_fneg                   = 118;</span></div><div class="line"><span class="comment">//  private static final int opc_dneg                   = 119;</span></div><div class="line"><span class="comment">//  private static final int opc_ishl                   = 120;</span></div><div class="line"><span class="comment">//  private static final int opc_lshl                   = 121;</span></div><div class="line"><span class="comment">//  private static final int opc_ishr                   = 122;</span></div><div class="line"><span class="comment">//  private static final int opc_lshr                   = 123;</span></div><div class="line"><span class="comment">//  private static final int opc_iushr                  = 124;</span></div><div class="line"><span class="comment">//  private static final int opc_lushr                  = 125;</span></div><div class="line"><span class="comment">//  private static final int opc_iand                   = 126;</span></div><div class="line"><span class="comment">//  private static final int opc_land                   = 127;</span></div><div class="line"><span class="comment">//  private static final int opc_ior                    = 128;</span></div><div class="line"><span class="comment">//  private static final int opc_lor                    = 129;</span></div><div class="line"><span class="comment">//  private static final int opc_ixor                   = 130;</span></div><div class="line"><span class="comment">//  private static final int opc_lxor                   = 131;</span></div><div class="line"><span class="comment">//  private static final int opc_iinc                   = 132;</span></div><div class="line"><span class="comment">//  private static final int opc_i2l                    = 133;</span></div><div class="line"><span class="comment">//  private static final int opc_i2f                    = 134;</span></div><div class="line"><span class="comment">//  private static final int opc_i2d                    = 135;</span></div><div class="line"><span class="comment">//  private static final int opc_l2i                    = 136;</span></div><div class="line"><span class="comment">//  private static final int opc_l2f                    = 137;</span></div><div class="line"><span class="comment">//  private static final int opc_l2d                    = 138;</span></div><div class="line"><span class="comment">//  private static final int opc_f2i                    = 139;</span></div><div class="line"><span class="comment">//  private static final int opc_f2l                    = 140;</span></div><div class="line"><span class="comment">//  private static final int opc_f2d                    = 141;</span></div><div class="line"><span class="comment">//  private static final int opc_d2i                    = 142;</span></div><div class="line"><span class="comment">//  private static final int opc_d2l                    = 143;</span></div><div class="line"><span class="comment">//  private static final int opc_d2f                    = 144;</span></div><div class="line"><span class="comment">//  private static final int opc_i2b                    = 145;</span></div><div class="line"><span class="comment">//  private static final int opc_i2c                    = 146;</span></div><div class="line"><span class="comment">//  private static final int opc_i2s                    = 147;</span></div><div class="line"><span class="comment">//  private static final int opc_lcmp                   = 148;</span></div><div class="line"><span class="comment">//  private static final int opc_fcmpl                  = 149;</span></div><div class="line"><span class="comment">//  private static final int opc_fcmpg                  = 150;</span></div><div class="line"><span class="comment">//  private static final int opc_dcmpl                  = 151;</span></div><div class="line"><span class="comment">//  private static final int opc_dcmpg                  = 152;</span></div><div class="line"><span class="comment">//  private static final int opc_ifeq                   = 153;</span></div><div class="line"><span class="comment">//  private static final int opc_ifne                   = 154;</span></div><div class="line"><span class="comment">//  private static final int opc_iflt                   = 155;</span></div><div class="line"><span class="comment">//  private static final int opc_ifge                   = 156;</span></div><div class="line"><span class="comment">//  private static final int opc_ifgt                   = 157;</span></div><div class="line"><span class="comment">//  private static final int opc_ifle                   = 158;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpeq              = 159;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpne              = 160;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmplt              = 161;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpge              = 162;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpgt              = 163;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmple              = 164;</span></div><div class="line"><span class="comment">//  private static final int opc_if_acmpeq              = 165;</span></div><div class="line"><span class="comment">//  private static final int opc_if_acmpne              = 166;</span></div><div class="line"><span class="comment">//  private static final int opc_goto                   = 167;</span></div><div class="line"><span class="comment">//  private static final int opc_jsr                    = 168;</span></div><div class="line"><span class="comment">//  private static final int opc_ret                    = 169;</span></div><div class="line"><span class="comment">//  private static final int opc_tableswitch            = 170;</span></div><div class="line"><span class="comment">//  private static final int opc_lookupswitch           = 171;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ireturn                = <span class="number">172</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lreturn                = <span class="number">173</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_freturn                = <span class="number">174</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dreturn                = <span class="number">175</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_areturn                = <span class="number">176</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_return                 = <span class="number">177</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_getstatic              = <span class="number">178</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_putstatic              = <span class="number">179</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_getfield               = <span class="number">180</span>;</div><div class="line"><span class="comment">//  private static final int opc_putfield               = 181;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokevirtual          = <span class="number">182</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokespecial          = <span class="number">183</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokestatic           = <span class="number">184</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokeinterface        = <span class="number">185</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_new                    = <span class="number">187</span>;</div><div class="line"><span class="comment">//  private static final int opc_newarray               = 188;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_anewarray              = <span class="number">189</span>;</div><div class="line"><span class="comment">//  private static final int opc_arraylength            = 190;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_athrow                 = <span class="number">191</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_checkcast              = <span class="number">192</span>;</div><div class="line"><span class="comment">//  private static final int opc_instanceof             = 193;</span></div><div class="line"><span class="comment">//  private static final int opc_monitorenter           = 194;</span></div><div class="line"><span class="comment">//  private static final int opc_monitorexit            = 195;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_wide                   = <span class="number">196</span>;</div><div class="line"><span class="comment">//  private static final int opc_multianewarray         = 197;</span></div><div class="line"><span class="comment">//  private static final int opc_ifnull                 = 198;</span></div><div class="line"><span class="comment">//  private static final int opc_ifnonnull              = 199;</span></div><div class="line"><span class="comment">//  private static final int opc_goto_w                 = 200;</span></div><div class="line"><span class="comment">//  private static final int opc_jsr_w                  = 201;</span></div><div class="line"></div><div class="line">    <span class="comment">// end of constants copied from sun.tools.java.RuntimeConstants</span></div><div class="line"></div><div class="line">    <span class="comment">/** name of the superclass of proxy classes */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String superclassName = <span class="string">"java/lang/reflect/Proxy"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** name of field for storing a proxy instance's invocation handler */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String handlerFieldName = <span class="string">"h"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** debugging flag for saving generated class files */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">boolean</span> saveGeneratedFiles =</div><div class="line">        java.security.AccessController.doPrivileged(</div><div class="line">            <span class="keyword">new</span> GetBooleanAction(</div><div class="line">                <span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>)).booleanValue();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate a proxy class given a name and a list of proxy interfaces.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String name,</div><div class="line">                                            Class[] interfaces)</div><div class="line">    &#123;</div><div class="line">        ProxyGenerator gen = <span class="keyword">new</span> ProxyGenerator(name, interfaces);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] classFile = gen.generateClassFile();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saveGeneratedFiles) &#123;</div><div class="line">            java.security.AccessController.doPrivileged(</div><div class="line">            <span class="keyword">new</span> java.security.PrivilegedAction&lt;Void&gt;() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        FileOutputStream file =</div><div class="line">                            <span class="keyword">new</span> FileOutputStream(dotToSlash(name) + <span class="string">".class"</span>);</div><div class="line">                        file.write(classFile);</div><div class="line">                        file.close();</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</div><div class="line">                            <span class="string">"I/O exception saving generated file: "</span> + e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> classFile;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* preloaded Method objects for methods in java.lang.Object */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method hashCodeMethod;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method equalsMethod;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method toStringMethod;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            hashCodeMethod = Object.class.getMethod(<span class="string">"hashCode"</span>);</div><div class="line">            equalsMethod =</div><div class="line">                Object.class.getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[] &#123; Object.class &#125;);</div><div class="line">            toStringMethod = Object.class.getMethod(<span class="string">"toString"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(e.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** name of proxy class */</span></div><div class="line">    <span class="keyword">private</span> String className;</div><div class="line"></div><div class="line">    <span class="comment">/** proxy interfaces */</span></div><div class="line">    <span class="keyword">private</span> Class[] interfaces;</div><div class="line"></div><div class="line">    <span class="comment">/** constant pool of class being generated */</span></div><div class="line">    <span class="keyword">private</span> ConstantPool cp = <span class="keyword">new</span> ConstantPool();</div><div class="line"></div><div class="line">    <span class="comment">/** FieldInfo struct for each field of generated class */</span></div><div class="line">    <span class="keyword">private</span> List&lt;FieldInfo&gt; fields = <span class="keyword">new</span> ArrayList&lt;FieldInfo&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** MethodInfo struct for each method of generated class */</span></div><div class="line">    <span class="keyword">private</span> List&lt;MethodInfo&gt; methods = <span class="keyword">new</span> ArrayList&lt;MethodInfo&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * maps method signature string to list of ProxyMethod objects for</div><div class="line">     * proxy methods with that signature</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;ProxyMethod&gt;&gt; proxyMethods =</div><div class="line">        <span class="keyword">new</span> HashMap&lt;String,List&lt;ProxyMethod&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** count of ProxyMethod objects added to proxyMethods */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyMethodCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a ProxyGenerator to generate a proxy class with the</div><div class="line">     * specified name and for the given interfaces.</div><div class="line">     *</div><div class="line">     * A ProxyGenerator object contains the state for the ongoing</div><div class="line">     * generation of a particular proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ProxyGenerator</span><span class="params">(String className, Class[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.className = className;</div><div class="line">        <span class="keyword">this</span>.interfaces = interfaces;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate a class file for the proxy class.  This method drives the</div><div class="line">     * class file generation process.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] generateClassFile() &#123;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 1: Assemble ProxyMethod objects for all methods to</div><div class="line">         * generate proxy dispatching code for.</div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Record that proxy methods are needed for the hashCode, equals,</div><div class="line">         * and toString methods of java.lang.Object.  This is done before</div><div class="line">         * the methods from the proxy interfaces so that the methods from</div><div class="line">         * java.lang.Object take precedence over duplicate methods in the</div><div class="line">         * proxy interfaces.</div><div class="line">         */</div><div class="line">        addProxyMethod(hashCodeMethod, Object.class);</div><div class="line">        addProxyMethod(equalsMethod, Object.class);</div><div class="line">        addProxyMethod(toStringMethod, Object.class);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Now record all of the methods from the proxy interfaces, giving</div><div class="line">         * earlier interfaces precedence over later ones with duplicate</div><div class="line">         * methods.</div><div class="line">         */</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">            Method[] methods = interfaces[i].getMethods();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; methods.length; j++) &#123;</div><div class="line">                addProxyMethod(methods[j], interfaces[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * For each set of proxy methods with the same signature,</div><div class="line">         * verify that the methods' return types are compatible.</div><div class="line">         */</div><div class="line">        <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">            checkReturnTypes(sigmethods);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 2: Assemble FieldInfo and MethodInfo structs for all of</div><div class="line">         * fields and methods in the class we are generating.</div><div class="line">         */</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            methods.add(generateConstructor());</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">                <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line"></div><div class="line">                    <span class="comment">// add static field for method's Method object</span></div><div class="line">                    fields.add(<span class="keyword">new</span> FieldInfo(pm.methodFieldName,</div><div class="line">                        <span class="string">"Ljava/lang/reflect/Method;"</span>,</div><div class="line">                         ACC_PRIVATE | ACC_STATIC));</div><div class="line"></div><div class="line">                    <span class="comment">// generate code for proxy method and add it</span></div><div class="line">                    methods.add(pm.generateMethod());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            methods.add(generateStaticInitializer());</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (methods.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"method limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (fields.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"field limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 3: Write the final class file.</div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Make sure that constant pool indexes are reserved for the</div><div class="line">         * following items before starting to write the final class file.</div><div class="line">         */</div><div class="line">        cp.getClass(dotToSlash(className));</div><div class="line">        cp.getClass(superclassName);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">            cp.getClass(dotToSlash(interfaces[i].getName()));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Disallow new constant pool additions beyond this point, since</div><div class="line">         * we are about to write the final constant pool table.</div><div class="line">         */</div><div class="line">        cp.setReadOnly();</div><div class="line"></div><div class="line">        ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        DataOutputStream dout = <span class="keyword">new</span> DataOutputStream(bout);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "ClassFile" structure.</div><div class="line">             * See JVMS section 4.1.</div><div class="line">             */</div><div class="line">                                        <span class="comment">// u4 magic;</span></div><div class="line">            dout.writeInt(<span class="number">0xCAFEBABE</span>);</div><div class="line">                                        <span class="comment">// u2 minor_version;</span></div><div class="line">            dout.writeShort(CLASSFILE_MINOR_VERSION);</div><div class="line">                                        <span class="comment">// u2 major_version;</span></div><div class="line">            dout.writeShort(CLASSFILE_MAJOR_VERSION);</div><div class="line"></div><div class="line">            cp.write(dout);             <span class="comment">// (write constant pool)</span></div><div class="line"></div><div class="line">                                        <span class="comment">// u2 access_flags;</span></div><div class="line">            dout.writeShort(ACC_PUBLIC | ACC_FINAL | ACC_SUPER);</div><div class="line">                                        <span class="comment">// u2 this_class;</span></div><div class="line">            dout.writeShort(cp.getClass(dotToSlash(className)));</div><div class="line">                                        <span class="comment">// u2 super_class;</span></div><div class="line">            dout.writeShort(cp.getClass(superclassName));</div><div class="line"></div><div class="line">                                        <span class="comment">// u2 interfaces_count;</span></div><div class="line">            dout.writeShort(interfaces.length);</div><div class="line">                                        <span class="comment">// u2 interfaces[interfaces_count];</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">                dout.writeShort(cp.getClass(</div><div class="line">                    dotToSlash(interfaces[i].getName())));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">                                        <span class="comment">// u2 fields_count;</span></div><div class="line">            dout.writeShort(fields.size());</div><div class="line">                                        <span class="comment">// field_info fields[fields_count];</span></div><div class="line">            <span class="keyword">for</span> (FieldInfo f : fields) &#123;</div><div class="line">                f.write(dout);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">                                        <span class="comment">// u2 methods_count;</span></div><div class="line">            dout.writeShort(methods.size());</div><div class="line">                                        <span class="comment">// method_info methods[methods_count];</span></div><div class="line">            <span class="keyword">for</span> (MethodInfo m : methods) &#123;</div><div class="line">                m.write(dout);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">                                         <span class="comment">// u2 attributes_count;</span></div><div class="line">            dout.writeShort(<span class="number">0</span>); <span class="comment">// (no ClassFile attributes for proxy classes)</span></div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> bout.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add another method to be proxied, either by creating a new</div><div class="line">     * ProxyMethod object or augmenting an old one for a duplicate</div><div class="line">     * method.</div><div class="line">     *</div><div class="line">     * "fromClass" indicates the proxy interface that the method was</div><div class="line">     * found through, which may be different from (a subinterface of)</div><div class="line">     * the method's "declaring class".  Note that the first Method</div><div class="line">     * object passed for a given name and descriptor identifies the</div><div class="line">     * Method object (and thus the declaring class) that will be</div><div class="line">     * passed to the invocation handler's "invoke" method for a given</div><div class="line">     * set of duplicate methods.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addProxyMethod</span><span class="params">(Method m, Class fromClass)</span> </span>&#123;</div><div class="line">        String name = m.getName();</div><div class="line">        Class[] parameterTypes = m.getParameterTypes();</div><div class="line">        Class returnType = m.getReturnType();</div><div class="line">        Class[] exceptionTypes = m.getExceptionTypes();</div><div class="line"></div><div class="line">        String sig = name + getParameterDescriptors(parameterTypes);</div><div class="line">        List&lt;ProxyMethod&gt; sigmethods = proxyMethods.get(sig);</div><div class="line">        <span class="keyword">if</span> (sigmethods != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line">                <span class="keyword">if</span> (returnType == pm.returnType) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Found a match: reduce exception types to the</div><div class="line">                     * greatest set of exceptions that can thrown</div><div class="line">                     * compatibly with the throws clauses of both</div><div class="line">                     * overridden methods.</div><div class="line">                     */</div><div class="line">                    List&lt;Class&lt;?&gt;&gt; legalExceptions = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</div><div class="line">                    collectCompatibleTypes(</div><div class="line">                        exceptionTypes, pm.exceptionTypes, legalExceptions);</div><div class="line">                    collectCompatibleTypes(</div><div class="line">                        pm.exceptionTypes, exceptionTypes, legalExceptions);</div><div class="line">                    pm.exceptionTypes = <span class="keyword">new</span> Class[legalExceptions.size()];</div><div class="line">                    pm.exceptionTypes =</div><div class="line">                        legalExceptions.toArray(pm.exceptionTypes);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sigmethods = <span class="keyword">new</span> ArrayList&lt;ProxyMethod&gt;(<span class="number">3</span>);</div><div class="line">            proxyMethods.put(sig, sigmethods);</div><div class="line">        &#125;</div><div class="line">        sigmethods.add(<span class="keyword">new</span> ProxyMethod(name, parameterTypes, returnType,</div><div class="line">                                       exceptionTypes, fromClass));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * For a given set of proxy methods with the same signature, check</div><div class="line">     * that their return types are compatible according to the Proxy</div><div class="line">     * specification.</div><div class="line">     *</div><div class="line">     * Specifically, if there is more than one such method, then all</div><div class="line">     * of the return types must be reference types, and there must be</div><div class="line">     * one return type that is assignable to each of the rest of them.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkReturnTypes</span><span class="params">(List&lt;ProxyMethod&gt; methods)</span> </span>&#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * If there is only one method with a given signature, there</div><div class="line">         * cannot be a conflict.  This is the only case in which a</div><div class="line">         * primitive (or void) return type is allowed.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (methods.size() &lt; <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * List of return types that are not yet known to be</div><div class="line">         * assignable from ("covered" by) any of the others.</div><div class="line">         */</div><div class="line">        LinkedList&lt;Class&lt;?&gt;&gt; uncoveredReturnTypes = <span class="keyword">new</span> LinkedList&lt;Class&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    nextNewReturnType:</div><div class="line">        <span class="keyword">for</span> (ProxyMethod pm : methods) &#123;</div><div class="line">            Class&lt;?&gt; newReturnType = pm.returnType;</div><div class="line">            <span class="keyword">if</span> (newReturnType.isPrimitive()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"methods with same signature "</span> +</div><div class="line">                    getFriendlyMethodSignature(pm.methodName,</div><div class="line">                                               pm.parameterTypes) +</div><div class="line">                    <span class="string">" but incompatible return types: "</span> +</div><div class="line">                    newReturnType.getName() + <span class="string">" and others"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> added = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Compare the new return type to the existing uncovered</div><div class="line">             * return types.</div><div class="line">             */</div><div class="line">            ListIterator&lt;Class&lt;?&gt;&gt; liter = uncoveredReturnTypes.listIterator();</div><div class="line">            <span class="keyword">while</span> (liter.hasNext()) &#123;</div><div class="line">                Class&lt;?&gt; uncoveredReturnType = liter.next();</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If an existing uncovered return type is assignable</div><div class="line">                 * to this new one, then we can forget the new one.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (newReturnType.isAssignableFrom(uncoveredReturnType)) &#123;</div><div class="line">                    <span class="keyword">assert</span> !added;</div><div class="line">                    <span class="keyword">continue</span> nextNewReturnType;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If the new return type is assignable to an existing</div><div class="line">                 * uncovered one, then should replace the existing one</div><div class="line">                 * with the new one (or just forget the existing one,</div><div class="line">                 * if the new one has already be put in the list).</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (uncoveredReturnType.isAssignableFrom(newReturnType)) &#123;</div><div class="line">                    <span class="comment">// (we can assume that each return type is unique)</span></div><div class="line">                    <span class="keyword">if</span> (!added) &#123;</div><div class="line">                        liter.set(newReturnType);</div><div class="line">                        added = <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        liter.remove();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * If we got through the list of existing uncovered return</div><div class="line">             * types without an assignability relationship, then add</div><div class="line">             * the new return type to the list of uncovered ones.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (!added) &#123;</div><div class="line">                uncoveredReturnTypes.add(newReturnType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * We shouldn't end up with more than one return type that is</div><div class="line">         * not assignable from any of the others.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (uncoveredReturnTypes.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            ProxyMethod pm = methods.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                <span class="string">"methods with same signature "</span> +</div><div class="line">                getFriendlyMethodSignature(pm.methodName, pm.parameterTypes) +</div><div class="line">                <span class="string">" but incompatible return types: "</span> + uncoveredReturnTypes);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A FieldInfo object contains information about a particular field</div><div class="line">     * in the class being generated.  The class mirrors the data items of</div><div class="line">     * the "field_info" structure of the class file format (see JVMS 4.5).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> accessFlags;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> String descriptor;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FieldInfo</span><span class="params">(String name, String descriptor, <span class="keyword">int</span> accessFlags)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.descriptor = descriptor;</div><div class="line">            <span class="keyword">this</span>.accessFlags = accessFlags;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Make sure that constant pool indexes are reserved for the</div><div class="line">             * following items before starting to write the final class file.</div><div class="line">             */</div><div class="line">            cp.getUtf8(name);</div><div class="line">            cp.getUtf8(descriptor);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "field_info" structure.</div><div class="line">             * See JVMS section 4.5.</div><div class="line">             */</div><div class="line">                                        <span class="comment">// u2 access_flags;</span></div><div class="line">            out.writeShort(accessFlags);</div><div class="line">                                        <span class="comment">// u2 name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(name));</div><div class="line">                                        <span class="comment">// u2 descriptor_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(descriptor));</div><div class="line">                                        <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">0</span>);  <span class="comment">// (no field_info attributes for proxy classes)</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An ExceptionTableEntry object holds values for the data items of</div><div class="line">     * an entry in the "exception_table" item of the "Code" attribute of</div><div class="line">     * "method_info" structures (see JVMS 4.7.3).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionTableEntry</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> startPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> endPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> handlerPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> catchType;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExceptionTableEntry</span><span class="params">(<span class="keyword">short</span> startPc, <span class="keyword">short</span> endPc,</span></span></div><div class="line">                                   <span class="keyword">short</span> handlerPc, <span class="keyword">short</span> catchType)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.startPc = startPc;</div><div class="line">            <span class="keyword">this</span>.endPc = endPc;</div><div class="line">            <span class="keyword">this</span>.handlerPc = handlerPc;</div><div class="line">            <span class="keyword">this</span>.catchType = catchType;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A MethodInfo object contains information about a particular method</div><div class="line">     * in the class being generated.  This class mirrors the data items of</div><div class="line">     * the "method_info" structure of the class file format (see JVMS 4.6).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> accessFlags;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> String descriptor;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> maxStack;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> maxLocals;</div><div class="line">        <span class="keyword">public</span> ByteArrayOutputStream code = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        <span class="keyword">public</span> List&lt;ExceptionTableEntry&gt; exceptionTable =</div><div class="line">            <span class="keyword">new</span> ArrayList&lt;ExceptionTableEntry&gt;();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span>[] declaredExceptions;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MethodInfo</span><span class="params">(String name, String descriptor, <span class="keyword">int</span> accessFlags)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.descriptor = descriptor;</div><div class="line">            <span class="keyword">this</span>.accessFlags = accessFlags;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Make sure that constant pool indexes are reserved for the</div><div class="line">             * following items before starting to write the final class file.</div><div class="line">             */</div><div class="line">            cp.getUtf8(name);</div><div class="line">            cp.getUtf8(descriptor);</div><div class="line">            cp.getUtf8(<span class="string">"Code"</span>);</div><div class="line">            cp.getUtf8(<span class="string">"Exceptions"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "method_info" structure.</div><div class="line">             * See JVMS section 4.6.</div><div class="line">             */</div><div class="line">                                        <span class="comment">// u2 access_flags;</span></div><div class="line">            out.writeShort(accessFlags);</div><div class="line">                                        <span class="comment">// u2 name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(name));</div><div class="line">                                        <span class="comment">// u2 descriptor_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(descriptor));</div><div class="line">                                        <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">2</span>);  <span class="comment">// (two method_info attributes:)</span></div><div class="line"></div><div class="line">            <span class="comment">// Write "Code" attribute. See JVMS section 4.7.3.</span></div><div class="line"></div><div class="line">                                        <span class="comment">// u2 attribute_name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(<span class="string">"Code"</span>));</div><div class="line">                                        <span class="comment">// u4 attribute_length;</span></div><div class="line">            out.writeInt(<span class="number">12</span> + code.size() + <span class="number">8</span> * exceptionTable.size());</div><div class="line">                                        <span class="comment">// u2 max_stack;</span></div><div class="line">            out.writeShort(maxStack);</div><div class="line">                                        <span class="comment">// u2 max_locals;</span></div><div class="line">            out.writeShort(maxLocals);</div><div class="line">                                        <span class="comment">// u2 code_length;</span></div><div class="line">            out.writeInt(code.size());</div><div class="line">                                        <span class="comment">// u1 code[code_length];</span></div><div class="line">            code.writeTo(out);</div><div class="line">                                        <span class="comment">// u2 exception_table_length;</span></div><div class="line">            out.writeShort(exceptionTable.size());</div><div class="line">            <span class="keyword">for</span> (ExceptionTableEntry e : exceptionTable) &#123;</div><div class="line">                                        <span class="comment">// u2 start_pc;</span></div><div class="line">                out.writeShort(e.startPc);</div><div class="line">                                        <span class="comment">// u2 end_pc;</span></div><div class="line">                out.writeShort(e.endPc);</div><div class="line">                                        <span class="comment">// u2 handler_pc;</span></div><div class="line">                out.writeShort(e.handlerPc);</div><div class="line">                                        <span class="comment">// u2 catch_type;</span></div><div class="line">                out.writeShort(e.catchType);</div><div class="line">            &#125;</div><div class="line">                                        <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="comment">// write "Exceptions" attribute.  See JVMS section 4.7.4.</span></div><div class="line"></div><div class="line">                                        <span class="comment">// u2 attribute_name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(<span class="string">"Exceptions"</span>));</div><div class="line">                                        <span class="comment">// u4 attributes_length;</span></div><div class="line">            out.writeInt(<span class="number">2</span> + <span class="number">2</span> * declaredExceptions.length);</div><div class="line">                                        <span class="comment">// u2 number_of_exceptions;</span></div><div class="line">            out.writeShort(declaredExceptions.length);</div><div class="line">                        <span class="comment">// u2 exception_index_table[number_of_exceptions];</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; declaredExceptions.length; i++) &#123;</div><div class="line">                out.writeShort(declaredExceptions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A ProxyMethod object represents a proxy method in the proxy class</div><div class="line">     * being generated: a method whose implementation will encode and</div><div class="line">     * dispatch invocations to the proxy instance's invocation handler.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyMethod</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> String methodName;</div><div class="line">        <span class="keyword">public</span> Class[] parameterTypes;</div><div class="line">        <span class="keyword">public</span> Class returnType;</div><div class="line">        <span class="keyword">public</span> Class[] exceptionTypes;</div><div class="line">        <span class="keyword">public</span> Class fromClass;</div><div class="line">        <span class="keyword">public</span> String methodFieldName;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ProxyMethod</span><span class="params">(String methodName, Class[] parameterTypes,</span></span></div><div class="line">                            Class returnType, Class[] exceptionTypes,</div><div class="line">                            Class fromClass)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.methodName = methodName;</div><div class="line">            <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">            <span class="keyword">this</span>.returnType = returnType;</div><div class="line">            <span class="keyword">this</span>.exceptionTypes = exceptionTypes;</div><div class="line">            <span class="keyword">this</span>.fromClass = fromClass;</div><div class="line">            <span class="keyword">this</span>.methodFieldName = <span class="string">"m"</span> + proxyMethodCount++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Return a MethodInfo object for this method, including generating</div><div class="line">         * the code and exception table entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateMethod</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            String desc = getMethodDescriptor(parameterTypes, returnType);</div><div class="line">            MethodInfo minfo = <span class="keyword">new</span> MethodInfo(methodName, desc,</div><div class="line">                ACC_PUBLIC | ACC_FINAL);</div><div class="line"></div><div class="line">            <span class="keyword">int</span>[] parameterSlot = <span class="keyword">new</span> <span class="keyword">int</span>[parameterTypes.length];</div><div class="line">            <span class="keyword">int</span> nextSlot = <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterSlot.length; i++) &#123;</div><div class="line">                parameterSlot[i] = nextSlot;</div><div class="line">                nextSlot += getWordsPerType(parameterTypes[i]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> localSlot0 = nextSlot;</div><div class="line">            <span class="keyword">short</span> pc, tryBegin = <span class="number">0</span>, tryEnd;</div><div class="line"></div><div class="line">            DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">            code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_getfield);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                superclassName,</div><div class="line">                handlerFieldName, <span class="string">"Ljava/lang/reflect/InvocationHandler;"</span>));</div><div class="line"></div><div class="line">            code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_getstatic);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                dotToSlash(className),</div><div class="line">                methodFieldName, <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parameterTypes.length &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                code_ipush(parameterTypes.length, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_anewarray);</div><div class="line">                out.writeShort(cp.getClass(<span class="string">"java/lang/Object"</span>));</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line"></div><div class="line">                    out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                    code_ipush(i, out);</div><div class="line"></div><div class="line">                    codeWrapArgument(parameterTypes[i], parameterSlot[i], out);</div><div class="line"></div><div class="line">                    out.writeByte(opc_aastore);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_aconst_null);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            out.writeByte(opc_invokeinterface);</div><div class="line">            out.writeShort(cp.getInterfaceMethodRef(</div><div class="line">                <span class="string">"java/lang/reflect/InvocationHandler"</span>,</div><div class="line">                <span class="string">"invoke"</span>,</div><div class="line">                <span class="string">"(Ljava/lang/Object;Ljava/lang/reflect/Method;"</span> +</div><div class="line">                    <span class="string">"[Ljava/lang/Object;)Ljava/lang/Object;"</span>));</div><div class="line">            out.writeByte(<span class="number">4</span>);</div><div class="line">            out.writeByte(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_pop);</div><div class="line"></div><div class="line">                out.writeByte(opc_return);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                codeUnwrapReturnValue(returnType, out);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            tryEnd = pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">            List&lt;Class&lt;?&gt;&gt; catchList = computeUniqueCatchList(exceptionTypes);</div><div class="line">            <span class="keyword">if</span> (catchList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (Class&lt;?&gt; ex : catchList) &#123;</div><div class="line">                    minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                        tryBegin, tryEnd, pc,</div><div class="line">                        cp.getClass(dotToSlash(ex.getName()))));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">                pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">                minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                    tryBegin, tryEnd, pc, cp.getClass(<span class="string">"java/lang/Throwable"</span>)));</div><div class="line"></div><div class="line">                code_astore(localSlot0, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_new);</div><div class="line">                out.writeShort(cp.getClass(</div><div class="line">                    <span class="string">"java/lang/reflect/UndeclaredThrowableException"</span>));</div><div class="line"></div><div class="line">                out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                code_aload(localSlot0, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_invokespecial);</div><div class="line"></div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                    <span class="string">"java/lang/reflect/UndeclaredThrowableException"</span>,</div><div class="line">                    <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/Throwable;)V"</span>));</div><div class="line"></div><div class="line">                out.writeByte(opc_athrow);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (minfo.code.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"code size limit exceeded"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            minfo.maxStack = <span class="number">10</span>;</div><div class="line">            minfo.maxLocals = (<span class="keyword">short</span>) (localSlot0 + <span class="number">1</span>);</div><div class="line">            minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[exceptionTypes.length];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptionTypes.length; i++) &#123;</div><div class="line">                minfo.declaredExceptions[i] = cp.getClass(</div><div class="line">                    dotToSlash(exceptionTypes[i].getName()));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> minfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for wrapping an argument of the given type</div><div class="line">         * whose value can be found at the specified local variable</div><div class="line">         * index, in order for it to be passed (as an Object) to the</div><div class="line">         * invocation handler's "invoke" method.  The code is written</div><div class="line">         * to the supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeWrapArgument</span><span class="params">(Class type, <span class="keyword">int</span> slot,</span></span></div><div class="line">                                      DataOutputStream out)</div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">                PrimitiveTypeInfo prim = PrimitiveTypeInfo.get(type);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (type == <span class="keyword">int</span>.class ||</div><div class="line">                    type == <span class="keyword">boolean</span>.class ||</div><div class="line">                    type == <span class="keyword">byte</span>.class ||</div><div class="line">                    type == <span class="keyword">char</span>.class ||</div><div class="line">                    type == <span class="keyword">short</span>.class)</div><div class="line">                &#123;</div><div class="line">                    code_iload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">long</span>.class) &#123;</div><div class="line">                    code_lload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">float</span>.class) &#123;</div><div class="line">                    code_fload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">double</span>.class) &#123;</div><div class="line">                    code_dload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_invokestatic);</div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                    prim.wrapperClassName,</div><div class="line">                    <span class="string">"valueOf"</span>, prim.wrapperValueOfDesc));</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                code_aload(slot, out);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for unwrapping a return value of the given</div><div class="line">         * type from the invocation handler's "invoke" method (as type</div><div class="line">         * Object) to its correct type.  The code is written to the</div><div class="line">         * supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeUnwrapReturnValue</span><span class="params">(Class type, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">                PrimitiveTypeInfo prim = PrimitiveTypeInfo.get(type);</div><div class="line"></div><div class="line">                out.writeByte(opc_checkcast);</div><div class="line">                out.writeShort(cp.getClass(prim.wrapperClassName));</div><div class="line"></div><div class="line">                out.writeByte(opc_invokevirtual);</div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                    prim.wrapperClassName,</div><div class="line">                    prim.unwrapMethodName, prim.unwrapMethodDesc));</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (type == <span class="keyword">int</span>.class ||</div><div class="line">                    type == <span class="keyword">boolean</span>.class ||</div><div class="line">                    type == <span class="keyword">byte</span>.class ||</div><div class="line">                    type == <span class="keyword">char</span>.class ||</div><div class="line">                    type == <span class="keyword">short</span>.class)</div><div class="line">                &#123;</div><div class="line">                    out.writeByte(opc_ireturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">long</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_lreturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">float</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_freturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">double</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_dreturn);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_checkcast);</div><div class="line">                out.writeShort(cp.getClass(dotToSlash(type.getName())));</div><div class="line"></div><div class="line">                out.writeByte(opc_areturn);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for initializing the static field that stores</div><div class="line">         * the Method object for this proxy method.  The code is written</div><div class="line">         * to the supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeFieldInitialization</span><span class="params">(DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            codeClassForName(fromClass, out);</div><div class="line"></div><div class="line">            code_ldc(cp.getString(methodName), out);</div><div class="line"></div><div class="line">            code_ipush(parameterTypes.length, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_anewarray);</div><div class="line">            out.writeShort(cp.getClass(<span class="string">"java/lang/Class"</span>));</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                code_ipush(i, out);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (parameterTypes[i].isPrimitive()) &#123;</div><div class="line">                    PrimitiveTypeInfo prim =</div><div class="line">                        PrimitiveTypeInfo.get(parameterTypes[i]);</div><div class="line"></div><div class="line">                    out.writeByte(opc_getstatic);</div><div class="line">                    out.writeShort(cp.getFieldRef(</div><div class="line">                        prim.wrapperClassName, <span class="string">"TYPE"</span>, <span class="string">"Ljava/lang/Class;"</span>));</div><div class="line"></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    codeClassForName(parameterTypes[i], out);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_aastore);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            out.writeByte(opc_invokevirtual);</div><div class="line">            out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/Class"</span>,</div><div class="line">                <span class="string">"getMethod"</span>,</div><div class="line">                <span class="string">"(Ljava/lang/String;[Ljava/lang/Class;)"</span> +</div><div class="line">                <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line"></div><div class="line">            out.writeByte(opc_putstatic);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                dotToSlash(className),</div><div class="line">                methodFieldName, <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate the constructor method for the proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateConstructor</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        MethodInfo minfo = <span class="keyword">new</span> MethodInfo(</div><div class="line">            <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/reflect/InvocationHandler;)V"</span>,</div><div class="line">            ACC_PUBLIC);</div><div class="line"></div><div class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">        code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">        code_aload(<span class="number">1</span>, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            superclassName,</div><div class="line">            <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/reflect/InvocationHandler;)V"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_return);</div><div class="line"></div><div class="line">        minfo.maxStack = <span class="number">10</span>;</div><div class="line">        minfo.maxLocals = <span class="number">2</span>;</div><div class="line">        minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate the static initializer method for the proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateStaticInitializer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        MethodInfo minfo = <span class="keyword">new</span> MethodInfo(</div><div class="line">            <span class="string">"&lt;clinit&gt;"</span>, <span class="string">"()V"</span>, ACC_STATIC);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> localSlot0 = <span class="number">1</span>;</div><div class="line">        <span class="keyword">short</span> pc, tryBegin = <span class="number">0</span>, tryEnd;</div><div class="line"></div><div class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">            <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line">                pm.codeFieldInitialization(out);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        out.writeByte(opc_return);</div><div class="line"></div><div class="line">        tryEnd = pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">        minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">            tryBegin, tryEnd, pc,</div><div class="line">            cp.getClass(<span class="string">"java/lang/NoSuchMethodException"</span>)));</div><div class="line"></div><div class="line">        code_astore(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_new);</div><div class="line">        out.writeShort(cp.getClass(<span class="string">"java/lang/NoSuchMethodError"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_dup);</div><div class="line"></div><div class="line">        code_aload(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokevirtual);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            <span class="string">"java/lang/Throwable"</span>, <span class="string">"getMessage"</span>, <span class="string">"()Ljava/lang/String;"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            <span class="string">"java/lang/NoSuchMethodError"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/String;)V"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">        pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">        minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">            tryBegin, tryEnd, pc,</div><div class="line">            cp.getClass(<span class="string">"java/lang/ClassNotFoundException"</span>)));</div><div class="line"></div><div class="line">        code_astore(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_new);</div><div class="line">        out.writeShort(cp.getClass(<span class="string">"java/lang/NoClassDefFoundError"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_dup);</div><div class="line"></div><div class="line">        code_aload(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokevirtual);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            <span class="string">"java/lang/Throwable"</span>, <span class="string">"getMessage"</span>, <span class="string">"()Ljava/lang/String;"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            <span class="string">"java/lang/NoClassDefFoundError"</span>,</div><div class="line">            <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/String;)V"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (minfo.code.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"code size limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        minfo.maxStack = <span class="number">10</span>;</div><div class="line">        minfo.maxLocals = (<span class="keyword">short</span>) (localSlot0 + <span class="number">1</span>);</div><div class="line">        minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * =============== Code Generation Utility Methods ===============</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * The following methods generate code for the load or store operation</div><div class="line">     * indicated by their name for the given local variable.  The code is</div><div class="line">     * written to the supplied stream.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_iload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_iload, opc_iload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_lload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_lload, opc_lload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_fload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_fload, opc_fload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_dload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_dload, opc_dload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_aload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_aload, opc_aload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//  private void code_istore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_istore, opc_istore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_lstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_lstore, opc_lstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_fstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_fstore, opc_fstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_dstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_dstore, opc_dstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_astore</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_astore, opc_astore_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code for a load or store instruction for the given local</div><div class="line">     * variable.  The code is written to the supplied stream.</div><div class="line">     *</div><div class="line">     * "opcode" indicates the opcode form of the desired load or store</div><div class="line">     * instruction that takes an explicit local variable index, and</div><div class="line">     * "opcode_0" indicates the corresponding form of the instruction</div><div class="line">     * with the implicit index 0.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeLocalLoadStore</span><span class="params">(<span class="keyword">int</span> lvar, <span class="keyword">int</span> opcode, <span class="keyword">int</span> opcode_0,</span></span></div><div class="line">                                    DataOutputStream out)</div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">assert</span> lvar &gt;= <span class="number">0</span> &amp;&amp; lvar &lt;= <span class="number">0xFFFF</span>;</div><div class="line">        <span class="keyword">if</span> (lvar &lt;= <span class="number">3</span>) &#123;</div><div class="line">            out.writeByte(opcode_0 + lvar);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lvar &lt;= <span class="number">0xFF</span>) &#123;</div><div class="line">            out.writeByte(opcode);</div><div class="line">            out.writeByte(lvar &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Use the "wide" instruction modifier for local variable</div><div class="line">             * indexes that do not fit into an unsigned byte.</div><div class="line">             */</div><div class="line">            out.writeByte(opc_wide);</div><div class="line">            out.writeByte(opcode);</div><div class="line">            out.writeShort(lvar &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code for an "ldc" instruction for the given constant pool</div><div class="line">     * index (the "ldc_w" instruction is used if the index does not fit</div><div class="line">     * into an unsigned byte).  The code is written to the supplied stream.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_ldc</span><span class="params">(<span class="keyword">int</span> index, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt;= <span class="number">0xFFFF</span>;</div><div class="line">        <span class="keyword">if</span> (index &lt;= <span class="number">0xFF</span>) &#123;</div><div class="line">            out.writeByte(opc_ldc);</div><div class="line">            out.writeByte(index &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out.writeByte(opc_ldc_w);</div><div class="line">            out.writeShort(index &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code to push a constant integer value on to the operand</div><div class="line">     * stack, using the "iconst_&lt;i&gt;", "bipush", or "sipush" instructions</div><div class="line">     * depending on the size of the value.  The code is written to the</div><div class="line">     * supplied stream.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_ipush</span><span class="params">(<span class="keyword">int</span> value, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (value &gt;= -<span class="number">1</span> &amp;&amp; value &lt;= <span class="number">5</span>) &#123;</div><div class="line">            out.writeByte(opc_iconst_0 + value);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= Byte.MIN_VALUE &amp;&amp; value &lt;= Byte.MAX_VALUE) &#123;</div><div class="line">            out.writeByte(opc_bipush);</div><div class="line">            out.writeByte(value &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= Short.MIN_VALUE &amp;&amp; value &lt;= Short.MAX_VALUE) &#123;</div><div class="line">            out.writeByte(opc_sipush);</div><div class="line">            out.writeShort(value &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code to invoke the Class.forName with the name of the given</div><div class="line">     * class to get its Class object at runtime.  The code is written to</div><div class="line">     * the supplied stream.  Note that the code generated by this method</div><div class="line">     * may caused the checked ClassNotFoundException to be thrown.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeClassForName</span><span class="params">(Class cl, DataOutputStream out)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        code_ldc(cp.getString(cl.getName()), out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokestatic);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">            <span class="string">"java/lang/Class"</span>,</div><div class="line">            <span class="string">"forName"</span>, <span class="string">"(Ljava/lang/String;)Ljava/lang/Class;"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * ==================== General Utility Methods ====================</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Convert a fully qualified class name that uses '.' as the package</div><div class="line">     * separator, the external representation used by the Java language</div><div class="line">     * and APIs, to a fully qualified class name that uses '/' as the</div><div class="line">     * package separator, the representation used in the class file</div><div class="line">     * format (see JVMS section 4.2).</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">dotToSlash</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the "method descriptor" string for a method with the given</div><div class="line">     * parameter types and return type.  See JVMS section 4.3.3.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getMethodDescriptor</span><span class="params">(Class[] parameterTypes,</span></span></div><div class="line">                                              Class returnType)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> getParameterDescriptors(parameterTypes) +</div><div class="line">            ((returnType == <span class="keyword">void</span>.class) ? <span class="string">"V"</span> : getFieldType(returnType));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the list of "parameter descriptor" strings enclosed in</div><div class="line">     * parentheses corresponding to the given parameter types (in other</div><div class="line">     * words, a method descriptor without a return descriptor).  This</div><div class="line">     * string is useful for constructing string keys for methods without</div><div class="line">     * regard to their return type.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getParameterDescriptors</span><span class="params">(Class[] parameterTypes)</span> </span>&#123;</div><div class="line">        StringBuilder desc = <span class="keyword">new</span> StringBuilder(<span class="string">"("</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            desc.append(getFieldType(parameterTypes[i]));</div><div class="line">        &#125;</div><div class="line">        desc.append(<span class="string">')'</span>);</div><div class="line">        <span class="keyword">return</span> desc.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the "field type" string for the given type, appropriate for</div><div class="line">     * a field descriptor, a parameter descriptor, or a return descriptor</div><div class="line">     * other than "void".  See JVMS section 4.3.2.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFieldType</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">            <span class="keyword">return</span> PrimitiveTypeInfo.get(type).baseTypeString;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.isArray()) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * According to JLS 20.3.2, the getName() method on Class does</div><div class="line">             * return the VM type descriptor format for array classes (only);</div><div class="line">             * using that should be quicker than the otherwise obvious code:</div><div class="line">             *</div><div class="line">             *     return "[" + getTypeDescriptor(type.getComponentType());</div><div class="line">             */</div><div class="line">            <span class="keyword">return</span> type.getName().replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"L"</span> + dotToSlash(type.getName()) + <span class="string">";"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a human-readable string representing the signature of a</div><div class="line">     * method with the given name and parameter types.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFriendlyMethodSignature</span><span class="params">(String name,</span></span></div><div class="line">                                                     Class[] parameterTypes)</div><div class="line">    &#123;</div><div class="line">        StringBuilder sig = <span class="keyword">new</span> StringBuilder(name);</div><div class="line">        sig.append(<span class="string">'('</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line">                sig.append(<span class="string">','</span>);</div><div class="line">            &#125;</div><div class="line">            Class parameterType = parameterTypes[i];</div><div class="line">            <span class="keyword">int</span> dimensions = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (parameterType.isArray()) &#123;</div><div class="line">                parameterType = parameterType.getComponentType();</div><div class="line">                dimensions++;</div><div class="line">            &#125;</div><div class="line">            sig.append(parameterType.getName());</div><div class="line">            <span class="keyword">while</span> (dimensions-- &gt; <span class="number">0</span>) &#123;</div><div class="line">                sig.append(<span class="string">"[]"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        sig.append(<span class="string">')'</span>);</div><div class="line">        <span class="keyword">return</span> sig.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the number of abstract "words", or consecutive local variable</div><div class="line">     * indexes, required to contain a value of the given type.  See JVMS</div><div class="line">     * section 3.6.1.</div><div class="line">     *</div><div class="line">     * Note that the original version of the JVMS contained a definition of</div><div class="line">     * this abstract notion of a "word" in section 3.4, but that definition</div><div class="line">     * was removed for the second edition.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getWordsPerType</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (type == <span class="keyword">long</span>.class || type == <span class="keyword">double</span>.class) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add to the given list all of the types in the "from" array that</div><div class="line">     * are not already contained in the list and are assignable to at</div><div class="line">     * least one of the types in the "with" array.</div><div class="line">     *</div><div class="line">     * This method is useful for computing the greatest common set of</div><div class="line">     * declared exceptions from duplicate methods inherited from</div><div class="line">     * different interfaces.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">collectCompatibleTypes</span><span class="params">(Class&lt;?&gt;[] from,</span></span></div><div class="line">                                               Class&lt;?&gt;[] with,</div><div class="line">                                               List&lt;Class&lt;?&gt;&gt; list)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; from.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!list.contains(from[i])) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; with.length; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (with[j].isAssignableFrom(from[i])) &#123;</div><div class="line">                        list.add(from[i]);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Given the exceptions declared in the throws clause of a proxy method,</div><div class="line">     * compute the exceptions that need to be caught from the invocation</div><div class="line">     * handler's invoke method and rethrown intact in the method's</div><div class="line">     * implementation before catching other Throwables and wrapping them</div><div class="line">     * in UndeclaredThrowableExceptions.</div><div class="line">     *</div><div class="line">     * The exceptions to be caught are returned in a List object.  Each</div><div class="line">     * exception in the returned list is guaranteed to not be a subclass of</div><div class="line">     * any of the other exceptions in the list, so the catch blocks for</div><div class="line">     * these exceptions may be generated in any order relative to each other.</div><div class="line">     *</div><div class="line">     * Error and RuntimeException are each always contained by the returned</div><div class="line">     * list (if none of their superclasses are contained), since those</div><div class="line">     * unchecked exceptions should always be rethrown intact, and thus their</div><div class="line">     * subclasses will never appear in the returned list.</div><div class="line">     *</div><div class="line">     * The returned List will be empty if java.lang.Throwable is in the</div><div class="line">     * given list of declared exceptions, indicating that no exceptions</div><div class="line">     * need to be caught.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&lt;?&gt;&gt; computeUniqueCatchList(Class&lt;?&gt;[] exceptions) &#123;</div><div class="line">        List&lt;Class&lt;?&gt;&gt; uniqueList = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</div><div class="line">                                                <span class="comment">// unique exceptions to catch</span></div><div class="line"></div><div class="line">        uniqueList.add(Error.class);            <span class="comment">// always catch/rethrow these</span></div><div class="line">        uniqueList.add(RuntimeException.class);</div><div class="line"></div><div class="line">    nextException:</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptions.length; i++) &#123;</div><div class="line">            Class&lt;?&gt; ex = exceptions[i];</div><div class="line">            <span class="keyword">if</span> (ex.isAssignableFrom(Throwable.class)) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If Throwable is declared to be thrown by the proxy method,</div><div class="line">                 * then no catch blocks are necessary, because the invoke</div><div class="line">                 * can, at most, throw Throwable anyway.</div><div class="line">                 */</div><div class="line">                uniqueList.clear();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Throwable.class.isAssignableFrom(ex)) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Ignore types that cannot be thrown by the invoke method.</div><div class="line">                 */</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Compare this exception against the current list of</div><div class="line">             * exceptions that need to be caught:</div><div class="line">             */</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; uniqueList.size();) &#123;</div><div class="line">                Class&lt;?&gt; ex2 = uniqueList.get(j);</div><div class="line">                <span class="keyword">if</span> (ex2.isAssignableFrom(ex)) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * if a superclass of this exception is already on</div><div class="line">                     * the list to catch, then ignore this one and continue;</div><div class="line">                     */</div><div class="line">                    <span class="keyword">continue</span> nextException;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex.isAssignableFrom(ex2)) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * if a subclass of this exception is on the list</div><div class="line">                     * to catch, then remove it;</div><div class="line">                     */</div><div class="line">                    uniqueList.remove(j);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    j++;        <span class="comment">// else continue comparing.</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// This exception is unique (so far): add it to the list to catch.</span></div><div class="line">            uniqueList.add(ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> uniqueList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A PrimitiveTypeInfo object contains assorted information about</div><div class="line">     * a primitive type in its public fields.  The struct for a particular</div><div class="line">     * primitive type can be obtained using the static "get" method.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimitiveTypeInfo</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/** "base type" used in various descriptors (see JVMS section 4.3.2) */</span></div><div class="line">        <span class="keyword">public</span> String baseTypeString;</div><div class="line"></div><div class="line">        <span class="comment">/** name of corresponding wrapper class */</span></div><div class="line">        <span class="keyword">public</span> String wrapperClassName;</div><div class="line"></div><div class="line">        <span class="comment">/** method descriptor for wrapper class "valueOf" factory method */</span></div><div class="line">        <span class="keyword">public</span> String wrapperValueOfDesc;</div><div class="line"></div><div class="line">        <span class="comment">/** name of wrapper class method for retrieving primitive value */</span></div><div class="line">        <span class="keyword">public</span> String unwrapMethodName;</div><div class="line"></div><div class="line">        <span class="comment">/** descriptor of same method */</span></div><div class="line">        <span class="keyword">public</span> String unwrapMethodDesc;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class,PrimitiveTypeInfo&gt; table =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;Class,PrimitiveTypeInfo&gt;();</div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            add(<span class="keyword">byte</span>.class, Byte.class);</div><div class="line">            add(<span class="keyword">char</span>.class, Character.class);</div><div class="line">            add(<span class="keyword">double</span>.class, Double.class);</div><div class="line">            add(<span class="keyword">float</span>.class, Float.class);</div><div class="line">            add(<span class="keyword">int</span>.class, Integer.class);</div><div class="line">            add(<span class="keyword">long</span>.class, Long.class);</div><div class="line">            add(<span class="keyword">short</span>.class, Short.class);</div><div class="line">            add(<span class="keyword">boolean</span>.class, Boolean.class);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Class primitiveClass, Class wrapperClass)</span> </span>&#123;</div><div class="line">            table.put(primitiveClass,</div><div class="line">                      <span class="keyword">new</span> PrimitiveTypeInfo(primitiveClass, wrapperClass));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">PrimitiveTypeInfo</span><span class="params">(Class primitiveClass, Class wrapperClass)</span> </span>&#123;</div><div class="line">            <span class="keyword">assert</span> primitiveClass.isPrimitive();</div><div class="line"></div><div class="line">            baseTypeString =</div><div class="line">                Array.newInstance(primitiveClass, <span class="number">0</span>)</div><div class="line">                .getClass().getName().substring(<span class="number">1</span>);</div><div class="line">            wrapperClassName = dotToSlash(wrapperClass.getName());</div><div class="line">            wrapperValueOfDesc =</div><div class="line">                <span class="string">"("</span> + baseTypeString + <span class="string">")L"</span> + wrapperClassName + <span class="string">";"</span>;</div><div class="line">            unwrapMethodName = primitiveClass.getName() + <span class="string">"Value"</span>;</div><div class="line">            unwrapMethodDesc = <span class="string">"()"</span> + baseTypeString;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PrimitiveTypeInfo <span class="title">get</span><span class="params">(Class cl)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> table.get(cl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A ConstantPool object represents the constant pool of a class file</div><div class="line">     * being generated.  This representation of a constant pool is designed</div><div class="line">     * specifically for use by ProxyGenerator; in particular, it assumes</div><div class="line">     * that constant pool entries will not need to be resorted (for example,</div><div class="line">     * by their type, as the Java compiler does), so that the final index</div><div class="line">     * value can be assigned and used when an entry is first created.</div><div class="line">     *</div><div class="line">     * Note that new entries cannot be created after the constant pool has</div><div class="line">     * been written to a class file.  To prevent such logic errors, a</div><div class="line">     * ConstantPool instance can be marked "read only", so that further</div><div class="line">     * attempts to add new entries will fail with a runtime exception.</div><div class="line">     *</div><div class="line">     * See JVMS section 4.4 for more information about the constant pool</div><div class="line">     * of a class file.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantPool</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * list of constant pool entries, in constant pool index order.</div><div class="line">         *</div><div class="line">         * This list is used when writing the constant pool to a stream</div><div class="line">         * and for assigning the next index value.  Note that element 0</div><div class="line">         * of this list corresponds to constant pool index 1.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> List&lt;Entry&gt; pool = <span class="keyword">new</span> ArrayList&lt;Entry&gt;(<span class="number">32</span>);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * maps constant pool data of all types to constant pool indexes.</div><div class="line">         *</div><div class="line">         * This map is used to look up the index of an existing entry for</div><div class="line">         * values of all types.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> Map&lt;Object,Short&gt; map = <span class="keyword">new</span> HashMap&lt;Object,Short&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line">        <span class="comment">/** true if no new constant pool entries may be added */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> readOnly = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Utf8 entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getUtf8</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> getValue(s);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Integer entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getInteger</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getValue(<span class="keyword">new</span> Integer(i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Float entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getFloat</span><span class="params">(<span class="keyword">float</span> f)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getValue(<span class="keyword">new</span> Float(f));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Class entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> utf8Index = getUtf8(name);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_CLASS, utf8Index));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_String entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getString</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> utf8Index = getUtf8(s);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_STRING, utf8Index));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_FieldRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getFieldRef</span><span class="params">(String className,</span></span></div><div class="line">                                 String name, String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_FIELD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_MethodRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getMethodRef</span><span class="params">(String className,</span></span></div><div class="line">                                  String name, String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_METHOD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_InterfaceMethodRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getInterfaceMethodRef</span><span class="params">(String className, String name,</span></span></div><div class="line">                                           String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_INTERFACEMETHOD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_NameAndType entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getNameAndType</span><span class="params">(String name, String descriptor)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> nameIndex = getUtf8(name);</div><div class="line">            <span class="keyword">short</span> descriptorIndex = getUtf8(descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                CONSTANT_NAMEANDTYPE, nameIndex, descriptorIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Set this ConstantPool instance to be "read only".</div><div class="line">         *</div><div class="line">         * After this method has been called, further requests to get</div><div class="line">         * an index for a non-existent entry will cause an InternalError</div><div class="line">         * to be thrown instead of creating of the entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadOnly</span><span class="params">()</span> </span>&#123;</div><div class="line">            readOnly = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Write this constant pool to a stream as part of</div><div class="line">         * the class file format.</div><div class="line">         *</div><div class="line">         * This consists of writing the "constant_pool_count" and</div><div class="line">         * "constant_pool[]" items of the "ClassFile" structure, as</div><div class="line">         * described in JVMS section 4.1.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            DataOutputStream dataOut = <span class="keyword">new</span> DataOutputStream(out);</div><div class="line"></div><div class="line">            <span class="comment">// constant_pool_count: number of entries plus one</span></div><div class="line">            dataOut.writeShort(pool.size() + <span class="number">1</span>);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (Entry e : pool) &#123;</div><div class="line">                e.write(dataOut);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Add a new constant pool entry and return its index.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">addEntry</span><span class="params">(Entry entry)</span> </span>&#123;</div><div class="line">            pool.add(entry);</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Note that this way of determining the index of the</div><div class="line">             * added entry is wrong if this pool supports</div><div class="line">             * CONSTANT_Long or CONSTANT_Double entries.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (pool.size() &gt;= <span class="number">65535</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"constant pool size limit exceeded"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">short</span>) pool.size();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for an entry of a type that contains</div><div class="line">         * a direct value.  The type of the given object determines the</div><div class="line">         * type of the desired entry as follows:</div><div class="line">         *</div><div class="line">         *      java.lang.String        CONSTANT_Utf8</div><div class="line">         *      java.lang.Integer       CONSTANT_Integer</div><div class="line">         *      java.lang.Float         CONSTANT_Float</div><div class="line">         *      java.lang.Long          CONSTANT_Long</div><div class="line">         *      java.lang.Double        CONSTANT_DOUBLE</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">getValue</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">            Short index = map.get(key);</div><div class="line">            <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> index.shortValue();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (readOnly) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</div><div class="line">                        <span class="string">"late constant pool addition: "</span> + key);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">short</span> i = addEntry(<span class="keyword">new</span> ValueEntry(key));</div><div class="line">                map.put(key, <span class="keyword">new</span> Short(i));</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for an entry of a type that contains</div><div class="line">         * references to other constant pool entries.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">getIndirect</span><span class="params">(IndirectEntry e)</span> </span>&#123;</div><div class="line">            Short index = map.get(e);</div><div class="line">            <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> index.shortValue();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (readOnly) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"late constant pool addition"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">short</span> i = addEntry(e);</div><div class="line">                map.put(e, <span class="keyword">new</span> Short(i));</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Entry is the abstact superclass of all constant pool entry types</div><div class="line">         * that can be stored in the "pool" list; its purpose is to define a</div><div class="line">         * common method for writing constant pool entries to a class file.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span></span></div><div class="line">                <span class="keyword">throws</span> IOException;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ValueEntry represents a constant pool entry of a type that</div><div class="line">         * contains a direct value (see the comments for the "getValue"</div><div class="line">         * method for a list of such types).</div><div class="line">         *</div><div class="line">         * ValueEntry objects are not used as keys for their entries in the</div><div class="line">         * Map "map", so no useful hashCode or equals methods are defined.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueEntry</span> <span class="keyword">extends</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="keyword">private</span> Object value;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">ValueEntry</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.value = value;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</div><div class="line">                    out.writeByte(CONSTANT_UTF8);</div><div class="line">                    out.writeUTF((String) value);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</div><div class="line">                    out.writeByte(CONSTANT_INTEGER);</div><div class="line">                    out.writeInt(((Integer) value).intValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Float) &#123;</div><div class="line">                    out.writeByte(CONSTANT_FLOAT);</div><div class="line">                    out.writeFloat(((Float) value).floatValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Long) &#123;</div><div class="line">                    out.writeByte(CONSTANT_LONG);</div><div class="line">                    out.writeLong(((Long) value).longValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double) &#123;</div><div class="line">                    out.writeDouble(CONSTANT_DOUBLE);</div><div class="line">                    out.writeDouble(((Double) value).doubleValue());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"bogus value entry: "</span> + value);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * IndirectEntry represents a constant pool entry of a type that</div><div class="line">         * references other constant pool entries, i.e., the following types:</div><div class="line">         *</div><div class="line">         *      CONSTANT_Class, CONSTANT_String, CONSTANT_Fieldref,</div><div class="line">         *      CONSTANT_Methodref, CONSTANT_InterfaceMethodref, and</div><div class="line">         *      CONSTANT_NameAndType.</div><div class="line">         *</div><div class="line">         * Each of these entry types contains either one or two indexes of</div><div class="line">         * other constant pool entries.</div><div class="line">         *</div><div class="line">         * IndirectEntry objects are used as the keys for their entries in</div><div class="line">         * the Map "map", so the hashCode and equals methods are overridden</div><div class="line">         * to allow matching.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IndirectEntry</span> <span class="keyword">extends</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">int</span> tag;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">short</span> index0;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">short</span> index1;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Construct an IndirectEntry for a constant pool entry type</div><div class="line">             * that contains one index of another entry.</div><div class="line">             */</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IndirectEntry</span><span class="params">(<span class="keyword">int</span> tag, <span class="keyword">short</span> index)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.tag = tag;</div><div class="line">                <span class="keyword">this</span>.index0 = index;</div><div class="line">                <span class="keyword">this</span>.index1 = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Construct an IndirectEntry for a constant pool entry type</div><div class="line">             * that contains two indexes for other entries.</div><div class="line">             */</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IndirectEntry</span><span class="params">(<span class="keyword">int</span> tag, <span class="keyword">short</span> index0, <span class="keyword">short</span> index1)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.tag = tag;</div><div class="line">                <span class="keyword">this</span>.index0 = index0;</div><div class="line">                <span class="keyword">this</span>.index1 = index1;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                out.writeByte(tag);</div><div class="line">                out.writeShort(index0);</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If this entry type contains two indexes, write</div><div class="line">                 * out the second, too.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (tag == CONSTANT_FIELD ||</div><div class="line">                    tag == CONSTANT_METHOD ||</div><div class="line">                    tag == CONSTANT_INTERFACEMETHOD ||</div><div class="line">                    tag == CONSTANT_NAMEANDTYPE)</div><div class="line">                &#123;</div><div class="line">                    out.writeShort(index1);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> tag + index0 + index1;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> IndirectEntry) &#123;</div><div class="line">                    IndirectEntry other = (IndirectEntry) obj;</div><div class="line">                    <span class="keyword">if</span> (tag == other.tag &amp;&amp;</div><div class="line">                        index0 == other.index0 &amp;&amp; index1 == other.index1)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>To have an intuitive understanding of the generated class file, we turn on the option of <strong>saveGeneratedFiles</strong>.</p>
<figure class="highlight java"><figcaption><span>Target.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">```java TargetProxyInvocationHandler.java</div><div class="line"><span class="keyword">package</span> dynamicproxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"foo"</span>.equals(method.getName())) &#123;</div><div class="line">            System.out.println(<span class="string">"foo invoked"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>Main.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.getProperties().put(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>,<span class="string">"true"</span>);</div><div class="line">        Target b = (Target) Proxy.newProxyInstance(Target.class.getClassLoader(), <span class="keyword">new</span> Class[] &#123;Target.class&#125;, <span class="keyword">new</span> TargetProxyInvocationHandler());</div><div class="line">        System.out.println(b.getClass().toString());</div><div class="line">        b.foo();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And now we can find the generated Proxy class file:<br><figure class="highlight java"><figcaption><span>Proxy.class</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sun.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> dynamicproxy.Target;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</div><div class="line">	 <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.Object"</span>)&#125;);</div><div class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">            m3 = Class.forName(<span class="string">"dynamicproxy.Target"</span>).getMethod(<span class="string">"foo"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</div><div class="line">        <span class="keyword">super</span>(var1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>)).intValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;)).booleanValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Implement-Dynamic-Proxy-supporting-Class"><a href="#Implement-Dynamic-Proxy-supporting-Class" class="headerlink" title="Implement Dynamic Proxy supporting Class"></a>Implement Dynamic Proxy supporting Class</h1><p>A restriction of the Proxy provided by JDK is that we can only get a proxy for an interface rather than a class.</p>
<p>But can we implement this feature on our own?</p>
<p>Obviously, we need to modify ProxyGenerator to control the generation of the final class as our expectation.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy.supportclass;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.DataOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Array;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.LinkedList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.ListIterator;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> sun.security.action.GetBooleanAction;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ProxyGeneratorEx contains the code to generate a dynamic proxy class</div><div class="line"> * for any class.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyGeneratorEx</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * In the comments below, "JVMS" refers to The Java Virtual Machine</div><div class="line">     * Specification Second Edition and "JLS" refers to the original</div><div class="line">     * version of The Java Language Specification, unless otherwise</div><div class="line">     * specified.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/* generate 1.5-era class file version */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLASSFILE_MAJOR_VERSION = <span class="number">49</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLASSFILE_MINOR_VERSION = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * beginning of constants copied from</div><div class="line">     * sun.tools.java.RuntimeConstants (which no longer exists):</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/* constant pool tags */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_UTF8              = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_UNICODE           = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_INTEGER           = <span class="number">3</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_FLOAT             = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_LONG              = <span class="number">5</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_DOUBLE            = <span class="number">6</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_CLASS             = <span class="number">7</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_STRING            = <span class="number">8</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_FIELD             = <span class="number">9</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_METHOD            = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_INTERFACEMETHOD   = <span class="number">11</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONSTANT_NAMEANDTYPE       = <span class="number">12</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* access and modifier flags */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_PUBLIC                 = <span class="number">0x00000001</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_PRIVATE                = <span class="number">0x00000002</span>;</div><div class="line">    <span class="comment">//  private static final int ACC_PROTECTED              = 0x00000004;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_STATIC                 = <span class="number">0x00000008</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_FINAL                  = <span class="number">0x00000010</span>;</div><div class="line">    <span class="comment">//  private static final int ACC_SYNCHRONIZED           = 0x00000020;</span></div><div class="line"><span class="comment">//  private static final int ACC_VOLATILE               = 0x00000040;</span></div><div class="line"><span class="comment">//  private static final int ACC_TRANSIENT              = 0x00000080;</span></div><div class="line"><span class="comment">//  private static final int ACC_NATIVE                 = 0x00000100;</span></div><div class="line"><span class="comment">//  private static final int ACC_INTERFACE              = 0x00000200;</span></div><div class="line"><span class="comment">//  private static final int ACC_ABSTRACT               = 0x00000400;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACC_SUPER                  = <span class="number">0x00000020</span>;</div><div class="line"><span class="comment">//  private static final int ACC_STRICT                 = 0x00000800;</span></div><div class="line"></div><div class="line">    <span class="comment">/* opcodes */</span></div><div class="line"><span class="comment">//  private static final int opc_nop                    = 0;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aconst_null            = <span class="number">1</span>;</div><div class="line">    <span class="comment">//  private static final int opc_iconst_m1              = 2;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iconst_0               = <span class="number">3</span>;</div><div class="line">    <span class="comment">//  private static final int opc_iconst_1               = 4;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_2               = 5;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_3               = 6;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_4               = 7;</span></div><div class="line"><span class="comment">//  private static final int opc_iconst_5               = 8;</span></div><div class="line"><span class="comment">//  private static final int opc_lconst_0               = 9;</span></div><div class="line"><span class="comment">//  private static final int opc_lconst_1               = 10;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_0               = 11;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_1               = 12;</span></div><div class="line"><span class="comment">//  private static final int opc_fconst_2               = 13;</span></div><div class="line"><span class="comment">//  private static final int opc_dconst_0               = 14;</span></div><div class="line"><span class="comment">//  private static final int opc_dconst_1               = 15;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_bipush                 = <span class="number">16</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_sipush                 = <span class="number">17</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ldc                    = <span class="number">18</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ldc_w                  = <span class="number">19</span>;</div><div class="line">    <span class="comment">//  private static final int opc_ldc2_w                 = 20;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iload                  = <span class="number">21</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lload                  = <span class="number">22</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_fload                  = <span class="number">23</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dload                  = <span class="number">24</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aload                  = <span class="number">25</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_iload_0                = <span class="number">26</span>;</div><div class="line">    <span class="comment">//  private static final int opc_iload_1                = 27;</span></div><div class="line"><span class="comment">//  private static final int opc_iload_2                = 28;</span></div><div class="line"><span class="comment">//  private static final int opc_iload_3                = 29;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lload_0                = <span class="number">30</span>;</div><div class="line">    <span class="comment">//  private static final int opc_lload_1                = 31;</span></div><div class="line"><span class="comment">//  private static final int opc_lload_2                = 32;</span></div><div class="line"><span class="comment">//  private static final int opc_lload_3                = 33;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_fload_0                = <span class="number">34</span>;</div><div class="line">    <span class="comment">//  private static final int opc_fload_1                = 35;</span></div><div class="line"><span class="comment">//  private static final int opc_fload_2                = 36;</span></div><div class="line"><span class="comment">//  private static final int opc_fload_3                = 37;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dload_0                = <span class="number">38</span>;</div><div class="line">    <span class="comment">//  private static final int opc_dload_1                = 39;</span></div><div class="line"><span class="comment">//  private static final int opc_dload_2                = 40;</span></div><div class="line"><span class="comment">//  private static final int opc_dload_3                = 41;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aload_0                = <span class="number">42</span>;</div><div class="line">    <span class="comment">//  private static final int opc_aload_1                = 43;</span></div><div class="line"><span class="comment">//  private static final int opc_aload_2                = 44;</span></div><div class="line"><span class="comment">//  private static final int opc_aload_3                = 45;</span></div><div class="line"><span class="comment">//  private static final int opc_iaload                 = 46;</span></div><div class="line"><span class="comment">//  private static final int opc_laload                 = 47;</span></div><div class="line"><span class="comment">//  private static final int opc_faload                 = 48;</span></div><div class="line"><span class="comment">//  private static final int opc_daload                 = 49;</span></div><div class="line"><span class="comment">//  private static final int opc_aaload                 = 50;</span></div><div class="line"><span class="comment">//  private static final int opc_baload                 = 51;</span></div><div class="line"><span class="comment">//  private static final int opc_caload                 = 52;</span></div><div class="line"><span class="comment">//  private static final int opc_saload                 = 53;</span></div><div class="line"><span class="comment">//  private static final int opc_istore                 = 54;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore                 = 55;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore                 = 56;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore                 = 57;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_astore                 = <span class="number">58</span>;</div><div class="line">    <span class="comment">//  private static final int opc_istore_0               = 59;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_1               = 60;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_2               = 61;</span></div><div class="line"><span class="comment">//  private static final int opc_istore_3               = 62;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_0               = 63;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_1               = 64;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_2               = 65;</span></div><div class="line"><span class="comment">//  private static final int opc_lstore_3               = 66;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_0               = 67;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_1               = 68;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_2               = 69;</span></div><div class="line"><span class="comment">//  private static final int opc_fstore_3               = 70;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_0               = 71;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_1               = 72;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_2               = 73;</span></div><div class="line"><span class="comment">//  private static final int opc_dstore_3               = 74;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_astore_0               = <span class="number">75</span>;</div><div class="line">    <span class="comment">//  private static final int opc_astore_1               = 76;</span></div><div class="line"><span class="comment">//  private static final int opc_astore_2               = 77;</span></div><div class="line"><span class="comment">//  private static final int opc_astore_3               = 78;</span></div><div class="line"><span class="comment">//  private static final int opc_iastore                = 79;</span></div><div class="line"><span class="comment">//  private static final int opc_lastore                = 80;</span></div><div class="line"><span class="comment">//  private static final int opc_fastore                = 81;</span></div><div class="line"><span class="comment">//  private static final int opc_dastore                = 82;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_aastore                = <span class="number">83</span>;</div><div class="line">    <span class="comment">//  private static final int opc_bastore                = 84;</span></div><div class="line"><span class="comment">//  private static final int opc_castore                = 85;</span></div><div class="line"><span class="comment">//  private static final int opc_sastore                = 86;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_pop                    = <span class="number">87</span>;</div><div class="line">    <span class="comment">//  private static final int opc_pop2                   = 88;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dup                    = <span class="number">89</span>;</div><div class="line">    <span class="comment">//  private static final int opc_dup_x1                 = 90;</span></div><div class="line"><span class="comment">//  private static final int opc_dup_x2                 = 91;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2                   = 92;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2_x1                = 93;</span></div><div class="line"><span class="comment">//  private static final int opc_dup2_x2                = 94;</span></div><div class="line"><span class="comment">//  private static final int opc_swap                   = 95;</span></div><div class="line"><span class="comment">//  private static final int opc_iadd                   = 96;</span></div><div class="line"><span class="comment">//  private static final int opc_ladd                   = 97;</span></div><div class="line"><span class="comment">//  private static final int opc_fadd                   = 98;</span></div><div class="line"><span class="comment">//  private static final int opc_dadd                   = 99;</span></div><div class="line"><span class="comment">//  private static final int opc_isub                   = 100;</span></div><div class="line"><span class="comment">//  private static final int opc_lsub                   = 101;</span></div><div class="line"><span class="comment">//  private static final int opc_fsub                   = 102;</span></div><div class="line"><span class="comment">//  private static final int opc_dsub                   = 103;</span></div><div class="line"><span class="comment">//  private static final int opc_imul                   = 104;</span></div><div class="line"><span class="comment">//  private static final int opc_lmul                   = 105;</span></div><div class="line"><span class="comment">//  private static final int opc_fmul                   = 106;</span></div><div class="line"><span class="comment">//  private static final int opc_dmul                   = 107;</span></div><div class="line"><span class="comment">//  private static final int opc_idiv                   = 108;</span></div><div class="line"><span class="comment">//  private static final int opc_ldiv                   = 109;</span></div><div class="line"><span class="comment">//  private static final int opc_fdiv                   = 110;</span></div><div class="line"><span class="comment">//  private static final int opc_ddiv                   = 111;</span></div><div class="line"><span class="comment">//  private static final int opc_irem                   = 112;</span></div><div class="line"><span class="comment">//  private static final int opc_lrem                   = 113;</span></div><div class="line"><span class="comment">//  private static final int opc_frem                   = 114;</span></div><div class="line"><span class="comment">//  private static final int opc_drem                   = 115;</span></div><div class="line"><span class="comment">//  private static final int opc_ineg                   = 116;</span></div><div class="line"><span class="comment">//  private static final int opc_lneg                   = 117;</span></div><div class="line"><span class="comment">//  private static final int opc_fneg                   = 118;</span></div><div class="line"><span class="comment">//  private static final int opc_dneg                   = 119;</span></div><div class="line"><span class="comment">//  private static final int opc_ishl                   = 120;</span></div><div class="line"><span class="comment">//  private static final int opc_lshl                   = 121;</span></div><div class="line"><span class="comment">//  private static final int opc_ishr                   = 122;</span></div><div class="line"><span class="comment">//  private static final int opc_lshr                   = 123;</span></div><div class="line"><span class="comment">//  private static final int opc_iushr                  = 124;</span></div><div class="line"><span class="comment">//  private static final int opc_lushr                  = 125;</span></div><div class="line"><span class="comment">//  private static final int opc_iand                   = 126;</span></div><div class="line"><span class="comment">//  private static final int opc_land                   = 127;</span></div><div class="line"><span class="comment">//  private static final int opc_ior                    = 128;</span></div><div class="line"><span class="comment">//  private static final int opc_lor                    = 129;</span></div><div class="line"><span class="comment">//  private static final int opc_ixor                   = 130;</span></div><div class="line"><span class="comment">//  private static final int opc_lxor                   = 131;</span></div><div class="line"><span class="comment">//  private static final int opc_iinc                   = 132;</span></div><div class="line"><span class="comment">//  private static final int opc_i2l                    = 133;</span></div><div class="line"><span class="comment">//  private static final int opc_i2f                    = 134;</span></div><div class="line"><span class="comment">//  private static final int opc_i2d                    = 135;</span></div><div class="line"><span class="comment">//  private static final int opc_l2i                    = 136;</span></div><div class="line"><span class="comment">//  private static final int opc_l2f                    = 137;</span></div><div class="line"><span class="comment">//  private static final int opc_l2d                    = 138;</span></div><div class="line"><span class="comment">//  private static final int opc_f2i                    = 139;</span></div><div class="line"><span class="comment">//  private static final int opc_f2l                    = 140;</span></div><div class="line"><span class="comment">//  private static final int opc_f2d                    = 141;</span></div><div class="line"><span class="comment">//  private static final int opc_d2i                    = 142;</span></div><div class="line"><span class="comment">//  private static final int opc_d2l                    = 143;</span></div><div class="line"><span class="comment">//  private static final int opc_d2f                    = 144;</span></div><div class="line"><span class="comment">//  private static final int opc_i2b                    = 145;</span></div><div class="line"><span class="comment">//  private static final int opc_i2c                    = 146;</span></div><div class="line"><span class="comment">//  private static final int opc_i2s                    = 147;</span></div><div class="line"><span class="comment">//  private static final int opc_lcmp                   = 148;</span></div><div class="line"><span class="comment">//  private static final int opc_fcmpl                  = 149;</span></div><div class="line"><span class="comment">//  private static final int opc_fcmpg                  = 150;</span></div><div class="line"><span class="comment">//  private static final int opc_dcmpl                  = 151;</span></div><div class="line"><span class="comment">//  private static final int opc_dcmpg                  = 152;</span></div><div class="line"><span class="comment">//  private static final int opc_ifeq                   = 153;</span></div><div class="line"><span class="comment">//  private static final int opc_ifne                   = 154;</span></div><div class="line"><span class="comment">//  private static final int opc_iflt                   = 155;</span></div><div class="line"><span class="comment">//  private static final int opc_ifge                   = 156;</span></div><div class="line"><span class="comment">//  private static final int opc_ifgt                   = 157;</span></div><div class="line"><span class="comment">//  private static final int opc_ifle                   = 158;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpeq              = 159;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpne              = 160;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmplt              = 161;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpge              = 162;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmpgt              = 163;</span></div><div class="line"><span class="comment">//  private static final int opc_if_icmple              = 164;</span></div><div class="line"><span class="comment">//  private static final int opc_if_acmpeq              = 165;</span></div><div class="line"><span class="comment">//  private static final int opc_if_acmpne              = 166;</span></div><div class="line"><span class="comment">//  private static final int opc_goto                   = 167;</span></div><div class="line"><span class="comment">//  private static final int opc_jsr                    = 168;</span></div><div class="line"><span class="comment">//  private static final int opc_ret                    = 169;</span></div><div class="line"><span class="comment">//  private static final int opc_tableswitch            = 170;</span></div><div class="line"><span class="comment">//  private static final int opc_lookupswitch           = 171;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_ireturn                = <span class="number">172</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_lreturn                = <span class="number">173</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_freturn                = <span class="number">174</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_dreturn                = <span class="number">175</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_areturn                = <span class="number">176</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_return                 = <span class="number">177</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_getstatic              = <span class="number">178</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_putstatic              = <span class="number">179</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_getfield               = <span class="number">180</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_putfield               = <span class="number">181</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokevirtual          = <span class="number">182</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokespecial          = <span class="number">183</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokestatic           = <span class="number">184</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_invokeinterface        = <span class="number">185</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_new                    = <span class="number">187</span>;</div><div class="line">    <span class="comment">//  private static final int opc_newarray               = 188;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_anewarray              = <span class="number">189</span>;</div><div class="line">    <span class="comment">//  private static final int opc_arraylength            = 190;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_athrow                 = <span class="number">191</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_checkcast              = <span class="number">192</span>;</div><div class="line">    <span class="comment">//  private static final int opc_instanceof             = 193;</span></div><div class="line"><span class="comment">//  private static final int opc_monitorenter           = 194;</span></div><div class="line"><span class="comment">//  private static final int opc_monitorexit            = 195;</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> opc_wide                   = <span class="number">196</span>;</div><div class="line"><span class="comment">//  private static final int opc_multianewarray         = 197;</span></div><div class="line"><span class="comment">//  private static final int opc_ifnull                 = 198;</span></div><div class="line"><span class="comment">//  private static final int opc_ifnonnull              = 199;</span></div><div class="line"><span class="comment">//  private static final int opc_goto_w                 = 200;</span></div><div class="line"><span class="comment">//  private static final int opc_jsr_w                  = 201;</span></div><div class="line"></div><div class="line">    <span class="comment">// end of constants copied from sun.tools.java.RuntimeConstants</span></div><div class="line"></div><div class="line">    <span class="comment">/** name of the superclass of proxy classes */</span></div><div class="line">    <span class="keyword">private</span> String superclassName;</div><div class="line"></div><div class="line">    <span class="comment">/** name of field for storing a proxy instance's invocation handler */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String handlerFieldName = <span class="string">"h"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** debugging flag for saving generated class files */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">boolean</span> saveGeneratedFiles =</div><div class="line">            java.security.AccessController.doPrivileged(</div><div class="line">                    <span class="keyword">new</span> GetBooleanAction(</div><div class="line">                            <span class="string">"sun.misc.ProxyGeneratorEx.saveGeneratedFiles"</span>)).booleanValue();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate a proxy class given a name and a list of proxy interfaces.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String name, Class superclass,</div><div class="line">                                            Class[] interfaces)</div><div class="line">    &#123;</div><div class="line">        ProxyGeneratorEx gen = <span class="keyword">new</span> ProxyGeneratorEx(name, superclass, interfaces);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] classFile = gen.generateClassFile();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saveGeneratedFiles) &#123;</div><div class="line">            java.security.AccessController.doPrivileged(</div><div class="line">                    <span class="keyword">new</span> java.security.PrivilegedAction&lt;Void&gt;() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                FileOutputStream file =</div><div class="line">                                        <span class="keyword">new</span> FileOutputStream(dotToSlash(name) + <span class="string">".class"</span>);</div><div class="line">                                file.write(classFile);</div><div class="line">                                file.close();</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</div><div class="line">                                        <span class="string">"I/O exception saving generated file: "</span> + e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> classFile;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* preloaded Method objects for methods in java.lang.Object */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method hashCodeMethod;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method equalsMethod;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method toStringMethod;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            hashCodeMethod = Object.class.getMethod(<span class="string">"hashCode"</span>);</div><div class="line">            equalsMethod =</div><div class="line">                    Object.class.getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[] &#123; Object.class &#125;);</div><div class="line">            toStringMethod = Object.class.getMethod(<span class="string">"toString"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(e.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** name of proxy class */</span></div><div class="line">    <span class="keyword">private</span> String className;</div><div class="line"></div><div class="line">    <span class="comment">/** proxy interfaces */</span></div><div class="line">    <span class="keyword">private</span> Class[] interfaces;</div><div class="line"></div><div class="line">    <span class="comment">/** constant pool of class being generated */</span></div><div class="line">    <span class="keyword">private</span> ConstantPool cp = <span class="keyword">new</span> ConstantPool();</div><div class="line"></div><div class="line">    <span class="comment">/** FieldInfo struct for each field of generated class */</span></div><div class="line">    <span class="keyword">private</span> List&lt;FieldInfo&gt; fields = <span class="keyword">new</span> ArrayList&lt;FieldInfo&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** MethodInfo struct for each method of generated class */</span></div><div class="line">    <span class="keyword">private</span> List&lt;MethodInfo&gt; methods = <span class="keyword">new</span> ArrayList&lt;MethodInfo&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * maps method signature string to list of ProxyMethod objects for</div><div class="line">     * proxy methods with that signature</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;ProxyMethod&gt;&gt; proxyMethods =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;String,List&lt;ProxyMethod&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** count of ProxyMethod objects added to proxyMethods */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyMethodCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Class superclass;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a ProxyGeneratorEx to generate a proxy class with the</div><div class="line">     * specified name and for the given interfaces.</div><div class="line">     *</div><div class="line">     * A ProxyGeneratorEx object contains the state for the ongoing</div><div class="line">     * generation of a particular proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ProxyGeneratorEx</span><span class="params">(String className, Class supperclass, Class[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.className = className;</div><div class="line">        <span class="keyword">this</span>.superclassName = dotToSlash(supperclass.getName());</div><div class="line">        <span class="keyword">this</span>.superclass = supperclass;</div><div class="line">        <span class="keyword">this</span>.interfaces = interfaces;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate a class file for the proxy class.  This method drives the</div><div class="line">     * class file generation process.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] generateClassFile() &#123;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 1: Assemble ProxyMethod objects for all methods to</div><div class="line">         * generate proxy dispatching code for.</div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Record that proxy methods are needed for the hashCode, equals,</div><div class="line">         * and toString methods of java.lang.Object.  This is done before</div><div class="line">         * the methods from the proxy interfaces so that the methods from</div><div class="line">         * java.lang.Object take precedence over duplicate methods in the</div><div class="line">         * proxy interfaces.</div><div class="line">         */</div><div class="line">        addProxyMethod(hashCodeMethod, Object.class);</div><div class="line">        addProxyMethod(equalsMethod, Object.class);</div><div class="line">        addProxyMethod(toStringMethod, Object.class);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Now record all of the methods from the proxy interfaces, giving</div><div class="line">         * earlier interfaces precedence over later ones with duplicate</div><div class="line">         * methods.</div><div class="line">         */</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">            Method[] methods = interfaces[i].getMethods();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; methods.length; j++) &#123;</div><div class="line">                addProxyMethod(methods[j], interfaces[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Now record all of the methods from the proxy superclass</span></div><div class="line">        Method[] superclassMethods = superclass.getDeclaredMethods();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; superclassMethods.length; j++) &#123;</div><div class="line">            addProxyMethod(superclassMethods[j], superclass);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * For each set of proxy methods with the same signature,</div><div class="line">         * verify that the methods' return types are compatible.</div><div class="line">         */</div><div class="line">        <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">            checkReturnTypes(sigmethods);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 2: Assemble FieldInfo and MethodInfo structs for all of</div><div class="line">         * fields and methods in the class we are generating.</div><div class="line">         */</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            methods.add(generateConstructor());</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">                <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line"></div><div class="line">                    <span class="comment">// add static field for method's Method object</span></div><div class="line">                    fields.add(<span class="keyword">new</span> FieldInfo(pm.methodFieldName,</div><div class="line">                            <span class="string">"Ljava/lang/reflect/Method;"</span>,</div><div class="line">                            ACC_PRIVATE | ACC_STATIC));</div><div class="line"></div><div class="line">                    <span class="comment">// generate code for proxy method and add it</span></div><div class="line">                    methods.add(pm.generateMethod());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// add field: InvocationHandler</span></div><div class="line">            fields.add(<span class="keyword">new</span> FieldInfo(handlerFieldName,</div><div class="line">                    <span class="string">"Ljava/lang/reflect/InvocationHandler;"</span>,</div><div class="line">                    ACC_PRIVATE));</div><div class="line"></div><div class="line">            methods.add(generateStaticInitializer());</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (methods.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"method limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (fields.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"field limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* ============================================================</span></div><div class="line">         * Step 3: Write the final class file.</div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Make sure that constant pool indexes are reserved for the</div><div class="line">         * following items before starting to write the final class file.</div><div class="line">         */</div><div class="line">        cp.getClass(dotToSlash(className));</div><div class="line">        cp.getClass(superclassName);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">            cp.getClass(dotToSlash(interfaces[i].getName()));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Disallow new constant pool additions beyond this point, since</div><div class="line">         * we are about to write the final constant pool table.</div><div class="line">         */</div><div class="line">        cp.setReadOnly();</div><div class="line"></div><div class="line">        ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        DataOutputStream dout = <span class="keyword">new</span> DataOutputStream(bout);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "ClassFile" structure.</div><div class="line">             * See JVMS section 4.1.</div><div class="line">             */</div><div class="line">            <span class="comment">// u4 magic;</span></div><div class="line">            dout.writeInt(<span class="number">0xCAFEBABE</span>);</div><div class="line">            <span class="comment">// u2 minor_version;</span></div><div class="line">            dout.writeShort(CLASSFILE_MINOR_VERSION);</div><div class="line">            <span class="comment">// u2 major_version;</span></div><div class="line">            dout.writeShort(CLASSFILE_MAJOR_VERSION);</div><div class="line"></div><div class="line">            cp.write(dout);             <span class="comment">// (write constant pool)</span></div><div class="line"></div><div class="line">            <span class="comment">// u2 access_flags;</span></div><div class="line">            dout.writeShort(ACC_PUBLIC | ACC_FINAL | ACC_SUPER);</div><div class="line">            <span class="comment">// u2 this_class;</span></div><div class="line">            dout.writeShort(cp.getClass(dotToSlash(className)));</div><div class="line">            <span class="comment">// u2 super_class;</span></div><div class="line">            dout.writeShort(cp.getClass(superclassName));</div><div class="line"></div><div class="line">            <span class="comment">// u2 interfaces_count;</span></div><div class="line">            dout.writeShort(interfaces.length);</div><div class="line">            <span class="comment">// u2 interfaces[interfaces_count];</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</div><div class="line">                dout.writeShort(cp.getClass(</div><div class="line">                        dotToSlash(interfaces[i].getName())));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// u2 fields_count;</span></div><div class="line">            dout.writeShort(fields.size());</div><div class="line">            <span class="comment">// field_info fields[fields_count];</span></div><div class="line">            <span class="keyword">for</span> (FieldInfo f : fields) &#123;</div><div class="line">                f.write(dout);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// u2 methods_count;</span></div><div class="line">            dout.writeShort(methods.size());</div><div class="line">            <span class="comment">// method_info methods[methods_count];</span></div><div class="line">            <span class="keyword">for</span> (MethodInfo m : methods) &#123;</div><div class="line">                m.write(dout);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// u2 attributes_count;</span></div><div class="line">            dout.writeShort(<span class="number">0</span>); <span class="comment">// (no ClassFile attributes for proxy classes)</span></div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> bout.toByteArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add another method to be proxied, either by creating a new</div><div class="line">     * ProxyMethod object or augmenting an old one for a duplicate</div><div class="line">     * method.</div><div class="line">     *</div><div class="line">     * "fromClass" indicates the proxy interface that the method was</div><div class="line">     * found through, which may be different from (a subinterface of)</div><div class="line">     * the method's "declaring class".  Note that the first Method</div><div class="line">     * object passed for a given name and descriptor identifies the</div><div class="line">     * Method object (and thus the declaring class) that will be</div><div class="line">     * passed to the invocation handler's "invoke" method for a given</div><div class="line">     * set of duplicate methods.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addProxyMethod</span><span class="params">(Method m, Class fromClass)</span> </span>&#123;</div><div class="line">        String name = m.getName();</div><div class="line">        Class[] parameterTypes = m.getParameterTypes();</div><div class="line">        Class returnType = m.getReturnType();</div><div class="line">        Class[] exceptionTypes = m.getExceptionTypes();</div><div class="line"></div><div class="line">        String sig = name + getParameterDescriptors(parameterTypes);</div><div class="line">        List&lt;ProxyMethod&gt; sigmethods = proxyMethods.get(sig);</div><div class="line">        <span class="keyword">if</span> (sigmethods != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line">                <span class="keyword">if</span> (returnType == pm.returnType) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Found a match: reduce exception types to the</div><div class="line">                     * greatest set of exceptions that can thrown</div><div class="line">                     * compatibly with the throws clauses of both</div><div class="line">                     * overridden methods.</div><div class="line">                     */</div><div class="line">                    List&lt;Class&lt;?&gt;&gt; legalExceptions = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</div><div class="line">                    collectCompatibleTypes(</div><div class="line">                            exceptionTypes, pm.exceptionTypes, legalExceptions);</div><div class="line">                    collectCompatibleTypes(</div><div class="line">                            pm.exceptionTypes, exceptionTypes, legalExceptions);</div><div class="line">                    pm.exceptionTypes = <span class="keyword">new</span> Class[legalExceptions.size()];</div><div class="line">                    pm.exceptionTypes =</div><div class="line">                            legalExceptions.toArray(pm.exceptionTypes);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sigmethods = <span class="keyword">new</span> ArrayList&lt;ProxyMethod&gt;(<span class="number">3</span>);</div><div class="line">            proxyMethods.put(sig, sigmethods);</div><div class="line">        &#125;</div><div class="line">        sigmethods.add(<span class="keyword">new</span> ProxyMethod(name, parameterTypes, returnType,</div><div class="line">                exceptionTypes, fromClass));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * For a given set of proxy methods with the same signature, check</div><div class="line">     * that their return types are compatible according to the Proxy</div><div class="line">     * specification.</div><div class="line">     *</div><div class="line">     * Specifically, if there is more than one such method, then all</div><div class="line">     * of the return types must be reference types, and there must be</div><div class="line">     * one return type that is assignable to each of the rest of them.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkReturnTypes</span><span class="params">(List&lt;ProxyMethod&gt; methods)</span> </span>&#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * If there is only one method with a given signature, there</div><div class="line">         * cannot be a conflict.  This is the only case in which a</div><div class="line">         * primitive (or void) return type is allowed.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (methods.size() &lt; <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * List of return types that are not yet known to be</div><div class="line">         * assignable from ("covered" by) any of the others.</div><div class="line">         */</div><div class="line">        LinkedList&lt;Class&lt;?&gt;&gt; uncoveredReturnTypes = <span class="keyword">new</span> LinkedList&lt;Class&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">        nextNewReturnType:</div><div class="line">        <span class="keyword">for</span> (ProxyMethod pm : methods) &#123;</div><div class="line">            Class&lt;?&gt; newReturnType = pm.returnType;</div><div class="line">            <span class="keyword">if</span> (newReturnType.isPrimitive()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                        <span class="string">"methods with same signature "</span> +</div><div class="line">                                getFriendlyMethodSignature(pm.methodName,</div><div class="line">                                        pm.parameterTypes) +</div><div class="line">                                <span class="string">" but incompatible return types: "</span> +</div><div class="line">                                newReturnType.getName() + <span class="string">" and others"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> added = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Compare the new return type to the existing uncovered</div><div class="line">             * return types.</div><div class="line">             */</div><div class="line">            ListIterator&lt;Class&lt;?&gt;&gt; liter = uncoveredReturnTypes.listIterator();</div><div class="line">            <span class="keyword">while</span> (liter.hasNext()) &#123;</div><div class="line">                Class&lt;?&gt; uncoveredReturnType = liter.next();</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If an existing uncovered return type is assignable</div><div class="line">                 * to this new one, then we can forget the new one.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (newReturnType.isAssignableFrom(uncoveredReturnType)) &#123;</div><div class="line">                    <span class="keyword">assert</span> !added;</div><div class="line">                    <span class="keyword">continue</span> nextNewReturnType;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If the new return type is assignable to an existing</div><div class="line">                 * uncovered one, then should replace the existing one</div><div class="line">                 * with the new one (or just forget the existing one,</div><div class="line">                 * if the new one has already be put in the list).</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (uncoveredReturnType.isAssignableFrom(newReturnType)) &#123;</div><div class="line">                    <span class="comment">// (we can assume that each return type is unique)</span></div><div class="line">                    <span class="keyword">if</span> (!added) &#123;</div><div class="line">                        liter.set(newReturnType);</div><div class="line">                        added = <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        liter.remove();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * If we got through the list of existing uncovered return</div><div class="line">             * types without an assignability relationship, then add</div><div class="line">             * the new return type to the list of uncovered ones.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (!added) &#123;</div><div class="line">                uncoveredReturnTypes.add(newReturnType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * We shouldn't end up with more than one return type that is</div><div class="line">         * not assignable from any of the others.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (uncoveredReturnTypes.size() &gt; <span class="number">1</span>) &#123;</div><div class="line">            ProxyMethod pm = methods.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"methods with same signature "</span> +</div><div class="line">                            getFriendlyMethodSignature(pm.methodName, pm.parameterTypes) +</div><div class="line">                            <span class="string">" but incompatible return types: "</span> + uncoveredReturnTypes);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A FieldInfo object contains information about a particular field</div><div class="line">     * in the class being generated.  The class mirrors the data items of</div><div class="line">     * the "field_info" structure of the class file format (see JVMS 4.5).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> accessFlags;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> String descriptor;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FieldInfo</span><span class="params">(String name, String descriptor, <span class="keyword">int</span> accessFlags)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.descriptor = descriptor;</div><div class="line">            <span class="keyword">this</span>.accessFlags = accessFlags;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Make sure that constant pool indexes are reserved for the</div><div class="line">             * following items before starting to write the final class file.</div><div class="line">             */</div><div class="line">            cp.getUtf8(name);</div><div class="line">            cp.getUtf8(descriptor);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "field_info" structure.</div><div class="line">             * See JVMS section 4.5.</div><div class="line">             */</div><div class="line">            <span class="comment">// u2 access_flags;</span></div><div class="line">            out.writeShort(accessFlags);</div><div class="line">            <span class="comment">// u2 name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(name));</div><div class="line">            <span class="comment">// u2 descriptor_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(descriptor));</div><div class="line">            <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">0</span>);  <span class="comment">// (no field_info attributes for proxy classes)</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An ExceptionTableEntry object holds values for the data items of</div><div class="line">     * an entry in the "exception_table" item of the "Code" attribute of</div><div class="line">     * "method_info" structures (see JVMS 4.7.3).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionTableEntry</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> startPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> endPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> handlerPc;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> catchType;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExceptionTableEntry</span><span class="params">(<span class="keyword">short</span> startPc, <span class="keyword">short</span> endPc,</span></span></div><div class="line">                                   <span class="keyword">short</span> handlerPc, <span class="keyword">short</span> catchType)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.startPc = startPc;</div><div class="line">            <span class="keyword">this</span>.endPc = endPc;</div><div class="line">            <span class="keyword">this</span>.handlerPc = handlerPc;</div><div class="line">            <span class="keyword">this</span>.catchType = catchType;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A MethodInfo object contains information about a particular method</div><div class="line">     * in the class being generated.  This class mirrors the data items of</div><div class="line">     * the "method_info" structure of the class file format (see JVMS 4.6).</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> accessFlags;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> String descriptor;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> maxStack;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span> maxLocals;</div><div class="line">        <span class="keyword">public</span> ByteArrayOutputStream code = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        <span class="keyword">public</span> List&lt;ExceptionTableEntry&gt; exceptionTable =</div><div class="line">                <span class="keyword">new</span> ArrayList&lt;ExceptionTableEntry&gt;();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">short</span>[] declaredExceptions;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MethodInfo</span><span class="params">(String name, String descriptor, <span class="keyword">int</span> accessFlags)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.descriptor = descriptor;</div><div class="line">            <span class="keyword">this</span>.accessFlags = accessFlags;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Make sure that constant pool indexes are reserved for the</div><div class="line">             * following items before starting to write the final class file.</div><div class="line">             */</div><div class="line">            cp.getUtf8(name);</div><div class="line">            cp.getUtf8(descriptor);</div><div class="line">            cp.getUtf8(<span class="string">"Code"</span>);</div><div class="line">            cp.getUtf8(<span class="string">"Exceptions"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Write all the items of the "method_info" structure.</div><div class="line">             * See JVMS section 4.6.</div><div class="line">             */</div><div class="line">            <span class="comment">// u2 access_flags;</span></div><div class="line">            out.writeShort(accessFlags);</div><div class="line">            <span class="comment">// u2 name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(name));</div><div class="line">            <span class="comment">// u2 descriptor_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(descriptor));</div><div class="line">            <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">2</span>);  <span class="comment">// (two method_info attributes:)</span></div><div class="line"></div><div class="line">            <span class="comment">// Write "Code" attribute. See JVMS section 4.7.3.</span></div><div class="line"></div><div class="line">            <span class="comment">// u2 attribute_name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(<span class="string">"Code"</span>));</div><div class="line">            <span class="comment">// u4 attribute_length;</span></div><div class="line">            out.writeInt(<span class="number">12</span> + code.size() + <span class="number">8</span> * exceptionTable.size());</div><div class="line">            <span class="comment">// u2 max_stack;</span></div><div class="line">            out.writeShort(maxStack);</div><div class="line">            <span class="comment">// u2 max_locals;</span></div><div class="line">            out.writeShort(maxLocals);</div><div class="line">            <span class="comment">// u2 code_length;</span></div><div class="line">            out.writeInt(code.size());</div><div class="line">            <span class="comment">// u1 code[code_length];</span></div><div class="line">            code.writeTo(out);</div><div class="line">            <span class="comment">// u2 exception_table_length;</span></div><div class="line">            out.writeShort(exceptionTable.size());</div><div class="line">            <span class="keyword">for</span> (ExceptionTableEntry e : exceptionTable) &#123;</div><div class="line">                <span class="comment">// u2 start_pc;</span></div><div class="line">                out.writeShort(e.startPc);</div><div class="line">                <span class="comment">// u2 end_pc;</span></div><div class="line">                out.writeShort(e.endPc);</div><div class="line">                <span class="comment">// u2 handler_pc;</span></div><div class="line">                out.writeShort(e.handlerPc);</div><div class="line">                <span class="comment">// u2 catch_type;</span></div><div class="line">                out.writeShort(e.catchType);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// u2 attributes_count;</span></div><div class="line">            out.writeShort(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="comment">// write "Exceptions" attribute.  See JVMS section 4.7.4.</span></div><div class="line"></div><div class="line">            <span class="comment">// u2 attribute_name_index;</span></div><div class="line">            out.writeShort(cp.getUtf8(<span class="string">"Exceptions"</span>));</div><div class="line">            <span class="comment">// u4 attributes_length;</span></div><div class="line">            out.writeInt(<span class="number">2</span> + <span class="number">2</span> * declaredExceptions.length);</div><div class="line">            <span class="comment">// u2 number_of_exceptions;</span></div><div class="line">            out.writeShort(declaredExceptions.length);</div><div class="line">            <span class="comment">// u2 exception_index_table[number_of_exceptions];</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; declaredExceptions.length; i++) &#123;</div><div class="line">                out.writeShort(declaredExceptions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A ProxyMethod object represents a proxy method in the proxy class</div><div class="line">     * being generated: a method whose implementation will encode and</div><div class="line">     * dispatch invocations to the proxy instance's invocation handler.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyMethod</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> String methodName;</div><div class="line">        <span class="keyword">public</span> Class[] parameterTypes;</div><div class="line">        <span class="keyword">public</span> Class returnType;</div><div class="line">        <span class="keyword">public</span> Class[] exceptionTypes;</div><div class="line">        <span class="keyword">public</span> Class fromClass;</div><div class="line">        <span class="keyword">public</span> String methodFieldName;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ProxyMethod</span><span class="params">(String methodName, Class[] parameterTypes,</span></span></div><div class="line">                            Class returnType, Class[] exceptionTypes,</div><div class="line">                            Class fromClass)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.methodName = methodName;</div><div class="line">            <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">            <span class="keyword">this</span>.returnType = returnType;</div><div class="line">            <span class="keyword">this</span>.exceptionTypes = exceptionTypes;</div><div class="line">            <span class="keyword">this</span>.fromClass = fromClass;</div><div class="line">            <span class="keyword">this</span>.methodFieldName = <span class="string">"m"</span> + proxyMethodCount++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Return a MethodInfo object for this method, including generating</div><div class="line">         * the code and exception table entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateMethod</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            String desc = getMethodDescriptor(parameterTypes, returnType);</div><div class="line">            MethodInfo minfo = <span class="keyword">new</span> MethodInfo(methodName, desc,</div><div class="line">                    ACC_PUBLIC | ACC_FINAL);</div><div class="line"></div><div class="line">            <span class="keyword">int</span>[] parameterSlot = <span class="keyword">new</span> <span class="keyword">int</span>[parameterTypes.length];</div><div class="line">            <span class="keyword">int</span> nextSlot = <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterSlot.length; i++) &#123;</div><div class="line">                parameterSlot[i] = nextSlot;</div><div class="line">                nextSlot += getWordsPerType(parameterTypes[i]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> localSlot0 = nextSlot;</div><div class="line">            <span class="keyword">short</span> pc, tryBegin = <span class="number">0</span>, tryEnd;</div><div class="line"></div><div class="line">            DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">            code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_getfield);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                    className,</div><div class="line">                    handlerFieldName, <span class="string">"Ljava/lang/reflect/InvocationHandler;"</span>));</div><div class="line"></div><div class="line">            code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_getstatic);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                    dotToSlash(className),</div><div class="line">                    methodFieldName, <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parameterTypes.length &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                code_ipush(parameterTypes.length, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_anewarray);</div><div class="line">                out.writeShort(cp.getClass(<span class="string">"java/lang/Object"</span>));</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line"></div><div class="line">                    out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                    code_ipush(i, out);</div><div class="line"></div><div class="line">                    codeWrapArgument(parameterTypes[i], parameterSlot[i], out);</div><div class="line"></div><div class="line">                    out.writeByte(opc_aastore);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_aconst_null);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            out.writeByte(opc_invokeinterface);</div><div class="line">            out.writeShort(cp.getInterfaceMethodRef(</div><div class="line">                    <span class="string">"java/lang/reflect/InvocationHandler"</span>,</div><div class="line">                    <span class="string">"invoke"</span>,</div><div class="line">                    <span class="string">"(Ljava/lang/Object;Ljava/lang/reflect/Method;"</span> +</div><div class="line">                            <span class="string">"[Ljava/lang/Object;)Ljava/lang/Object;"</span>));</div><div class="line">            out.writeByte(<span class="number">4</span>);</div><div class="line">            out.writeByte(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_pop);</div><div class="line"></div><div class="line">                out.writeByte(opc_return);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                codeUnwrapReturnValue(returnType, out);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            tryEnd = pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">            List&lt;Class&lt;?&gt;&gt; catchList = computeUniqueCatchList(exceptionTypes);</div><div class="line">            <span class="keyword">if</span> (catchList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (Class&lt;?&gt; ex : catchList) &#123;</div><div class="line">                    minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                            tryBegin, tryEnd, pc,</div><div class="line">                            cp.getClass(dotToSlash(ex.getName()))));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">                pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">                minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                        tryBegin, tryEnd, pc, cp.getClass(<span class="string">"java/lang/Throwable"</span>)));</div><div class="line"></div><div class="line">                code_astore(localSlot0, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_new);</div><div class="line">                out.writeShort(cp.getClass(</div><div class="line">                        <span class="string">"java/lang/reflect/UndeclaredThrowableException"</span>));</div><div class="line"></div><div class="line">                out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                code_aload(localSlot0, out);</div><div class="line"></div><div class="line">                out.writeByte(opc_invokespecial);</div><div class="line"></div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                        <span class="string">"java/lang/reflect/UndeclaredThrowableException"</span>,</div><div class="line">                        <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/Throwable;)V"</span>));</div><div class="line"></div><div class="line">                out.writeByte(opc_athrow);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (minfo.code.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"code size limit exceeded"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            minfo.maxStack = <span class="number">10</span>;</div><div class="line">            minfo.maxLocals = (<span class="keyword">short</span>) (localSlot0 + <span class="number">1</span>);</div><div class="line">            minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[exceptionTypes.length];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptionTypes.length; i++) &#123;</div><div class="line">                minfo.declaredExceptions[i] = cp.getClass(</div><div class="line">                        dotToSlash(exceptionTypes[i].getName()));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> minfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for wrapping an argument of the given type</div><div class="line">         * whose value can be found at the specified local variable</div><div class="line">         * index, in order for it to be passed (as an Object) to the</div><div class="line">         * invocation handler's "invoke" method.  The code is written</div><div class="line">         * to the supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeWrapArgument</span><span class="params">(Class type, <span class="keyword">int</span> slot,</span></span></div><div class="line">                                      DataOutputStream out)</div><div class="line">                <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">                PrimitiveTypeInfo prim = PrimitiveTypeInfo.get(type);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (type == <span class="keyword">int</span>.class ||</div><div class="line">                        type == <span class="keyword">boolean</span>.class ||</div><div class="line">                        type == <span class="keyword">byte</span>.class ||</div><div class="line">                        type == <span class="keyword">char</span>.class ||</div><div class="line">                        type == <span class="keyword">short</span>.class)</div><div class="line">                &#123;</div><div class="line">                    code_iload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">long</span>.class) &#123;</div><div class="line">                    code_lload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">float</span>.class) &#123;</div><div class="line">                    code_fload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">double</span>.class) &#123;</div><div class="line">                    code_dload(slot, out);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_invokestatic);</div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                        prim.wrapperClassName,</div><div class="line">                        <span class="string">"valueOf"</span>, prim.wrapperValueOfDesc));</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                code_aload(slot, out);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for unwrapping a return value of the given</div><div class="line">         * type from the invocation handler's "invoke" method (as type</div><div class="line">         * Object) to its correct type.  The code is written to the</div><div class="line">         * supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeUnwrapReturnValue</span><span class="params">(Class type, DataOutputStream out)</span></span></div><div class="line">                <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">                PrimitiveTypeInfo prim = PrimitiveTypeInfo.get(type);</div><div class="line"></div><div class="line">                out.writeByte(opc_checkcast);</div><div class="line">                out.writeShort(cp.getClass(prim.wrapperClassName));</div><div class="line"></div><div class="line">                out.writeByte(opc_invokevirtual);</div><div class="line">                out.writeShort(cp.getMethodRef(</div><div class="line">                        prim.wrapperClassName,</div><div class="line">                        prim.unwrapMethodName, prim.unwrapMethodDesc));</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (type == <span class="keyword">int</span>.class ||</div><div class="line">                        type == <span class="keyword">boolean</span>.class ||</div><div class="line">                        type == <span class="keyword">byte</span>.class ||</div><div class="line">                        type == <span class="keyword">char</span>.class ||</div><div class="line">                        type == <span class="keyword">short</span>.class)</div><div class="line">                &#123;</div><div class="line">                    out.writeByte(opc_ireturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">long</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_lreturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">float</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_freturn);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="keyword">double</span>.class) &#123;</div><div class="line">                    out.writeByte(opc_dreturn);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_checkcast);</div><div class="line">                out.writeShort(cp.getClass(dotToSlash(type.getName())));</div><div class="line"></div><div class="line">                out.writeByte(opc_areturn);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Generate code for initializing the static field that stores</div><div class="line">         * the Method object for this proxy method.  The code is written</div><div class="line">         * to the supplied stream.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeFieldInitialization</span><span class="params">(DataOutputStream out)</span></span></div><div class="line">                <span class="keyword">throws</span> IOException</div><div class="line">        &#123;</div><div class="line">            codeClassForName(fromClass, out);</div><div class="line"></div><div class="line">            code_ldc(cp.getString(methodName), out);</div><div class="line"></div><div class="line">            code_ipush(parameterTypes.length, out);</div><div class="line"></div><div class="line">            out.writeByte(opc_anewarray);</div><div class="line">            out.writeShort(cp.getClass(<span class="string">"java/lang/Class"</span>));</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line"></div><div class="line">                out.writeByte(opc_dup);</div><div class="line"></div><div class="line">                code_ipush(i, out);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (parameterTypes[i].isPrimitive()) &#123;</div><div class="line">                    PrimitiveTypeInfo prim =</div><div class="line">                            PrimitiveTypeInfo.get(parameterTypes[i]);</div><div class="line"></div><div class="line">                    out.writeByte(opc_getstatic);</div><div class="line">                    out.writeShort(cp.getFieldRef(</div><div class="line">                            prim.wrapperClassName, <span class="string">"TYPE"</span>, <span class="string">"Ljava/lang/Class;"</span>));</div><div class="line"></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    codeClassForName(parameterTypes[i], out);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                out.writeByte(opc_aastore);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            out.writeByte(opc_invokevirtual);</div><div class="line">            out.writeShort(cp.getMethodRef(</div><div class="line">                    <span class="string">"java/lang/Class"</span>,</div><div class="line">                    <span class="string">"getMethod"</span>,</div><div class="line">                    <span class="string">"(Ljava/lang/String;[Ljava/lang/Class;)"</span> +</div><div class="line">                            <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line"></div><div class="line">            out.writeByte(opc_putstatic);</div><div class="line">            out.writeShort(cp.getFieldRef(</div><div class="line">                    dotToSlash(className),</div><div class="line">                    methodFieldName, <span class="string">"Ljava/lang/reflect/Method;"</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate the constructor method for the proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateConstructor</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        MethodInfo minfo = <span class="keyword">new</span> MethodInfo(</div><div class="line">                <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/reflect/InvocationHandler;)V"</span>,</div><div class="line">                ACC_PUBLIC);</div><div class="line"></div><div class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">        code_aload(<span class="number">0</span>, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                superclassName,</div><div class="line">                <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>));</div><div class="line"></div><div class="line">        code_aload(<span class="number">0</span>, out);</div><div class="line">        code_aload(<span class="number">1</span>, out);</div><div class="line"></div><div class="line">        <span class="comment">// write field h</span></div><div class="line">        out.writeByte(opc_putfield);</div><div class="line">        out.writeShort(cp.getFieldRef(className, handlerFieldName, <span class="string">"Ljava/lang/reflect/InvocationHandler;"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_return);</div><div class="line"></div><div class="line">        minfo.maxStack = <span class="number">10</span>;</div><div class="line">        minfo.maxLocals = <span class="number">2</span>;</div><div class="line">        minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate the static initializer method for the proxy class.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> MethodInfo <span class="title">generateStaticInitializer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        MethodInfo minfo = <span class="keyword">new</span> MethodInfo(</div><div class="line">                <span class="string">"&lt;clinit&gt;"</span>, <span class="string">"()V"</span>, ACC_STATIC);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> localSlot0 = <span class="number">1</span>;</div><div class="line">        <span class="keyword">short</span> pc, tryBegin = <span class="number">0</span>, tryEnd;</div><div class="line"></div><div class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(minfo.code);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (List&lt;ProxyMethod&gt; sigmethods : proxyMethods.values()) &#123;</div><div class="line">            <span class="keyword">for</span> (ProxyMethod pm : sigmethods) &#123;</div><div class="line">                pm.codeFieldInitialization(out);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        out.writeByte(opc_return);</div><div class="line"></div><div class="line">        tryEnd = pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">        minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                tryBegin, tryEnd, pc,</div><div class="line">                cp.getClass(<span class="string">"java/lang/NoSuchMethodException"</span>)));</div><div class="line"></div><div class="line">        code_astore(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_new);</div><div class="line">        out.writeShort(cp.getClass(<span class="string">"java/lang/NoSuchMethodError"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_dup);</div><div class="line"></div><div class="line">        code_aload(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokevirtual);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/Throwable"</span>, <span class="string">"getMessage"</span>, <span class="string">"()Ljava/lang/String;"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/NoSuchMethodError"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/String;)V"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">        pc = (<span class="keyword">short</span>) minfo.code.size();</div><div class="line"></div><div class="line">        minfo.exceptionTable.add(<span class="keyword">new</span> ExceptionTableEntry(</div><div class="line">                tryBegin, tryEnd, pc,</div><div class="line">                cp.getClass(<span class="string">"java/lang/ClassNotFoundException"</span>)));</div><div class="line"></div><div class="line">        code_astore(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_new);</div><div class="line">        out.writeShort(cp.getClass(<span class="string">"java/lang/NoClassDefFoundError"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_dup);</div><div class="line"></div><div class="line">        code_aload(localSlot0, out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokevirtual);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/Throwable"</span>, <span class="string">"getMessage"</span>, <span class="string">"()Ljava/lang/String;"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_invokespecial);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/NoClassDefFoundError"</span>,</div><div class="line">                <span class="string">"&lt;init&gt;"</span>, <span class="string">"(Ljava/lang/String;)V"</span>));</div><div class="line"></div><div class="line">        out.writeByte(opc_athrow);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (minfo.code.size() &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"code size limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        minfo.maxStack = <span class="number">10</span>;</div><div class="line">        minfo.maxLocals = (<span class="keyword">short</span>) (localSlot0 + <span class="number">1</span>);</div><div class="line">        minfo.declaredExceptions = <span class="keyword">new</span> <span class="keyword">short</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> minfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * =============== Code Generation Utility Methods ===============</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * The following methods generate code for the load or store operation</div><div class="line">     * indicated by their name for the given local variable.  The code is</div><div class="line">     * written to the supplied stream.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_iload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_iload, opc_iload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_lload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_lload, opc_lload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_fload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_fload, opc_fload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_dload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_dload, opc_dload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_aload</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_aload, opc_aload_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//  private void code_istore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_istore, opc_istore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_lstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_lstore, opc_lstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_fstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_fstore, opc_fstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line"><span class="comment">//  private void code_dstore(int lvar, DataOutputStream out)</span></div><div class="line"><span class="comment">//      throws IOException</span></div><div class="line"><span class="comment">//  &#123;</span></div><div class="line"><span class="comment">//      codeLocalLoadStore(lvar, opc_dstore, opc_dstore_0, out);</span></div><div class="line"><span class="comment">//  &#125;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_astore</span><span class="params">(<span class="keyword">int</span> lvar, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        codeLocalLoadStore(lvar, opc_astore, opc_astore_0, out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code for a load or store instruction for the given local</div><div class="line">     * variable.  The code is written to the supplied stream.</div><div class="line">     *</div><div class="line">     * "opcode" indicates the opcode form of the desired load or store</div><div class="line">     * instruction that takes an explicit local variable index, and</div><div class="line">     * "opcode_0" indicates the corresponding form of the instruction</div><div class="line">     * with the implicit index 0.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeLocalLoadStore</span><span class="params">(<span class="keyword">int</span> lvar, <span class="keyword">int</span> opcode, <span class="keyword">int</span> opcode_0,</span></span></div><div class="line">                                    DataOutputStream out)</div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">assert</span> lvar &gt;= <span class="number">0</span> &amp;&amp; lvar &lt;= <span class="number">0xFFFF</span>;</div><div class="line">        <span class="keyword">if</span> (lvar &lt;= <span class="number">3</span>) &#123;</div><div class="line">            out.writeByte(opcode_0 + lvar);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lvar &lt;= <span class="number">0xFF</span>) &#123;</div><div class="line">            out.writeByte(opcode);</div><div class="line">            out.writeByte(lvar &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Use the "wide" instruction modifier for local variable</div><div class="line">             * indexes that do not fit into an unsigned byte.</div><div class="line">             */</div><div class="line">            out.writeByte(opc_wide);</div><div class="line">            out.writeByte(opcode);</div><div class="line">            out.writeShort(lvar &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code for an "ldc" instruction for the given constant pool</div><div class="line">     * index (the "ldc_w" instruction is used if the index does not fit</div><div class="line">     * into an unsigned byte).  The code is written to the supplied stream.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_ldc</span><span class="params">(<span class="keyword">int</span> index, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">assert</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt;= <span class="number">0xFFFF</span>;</div><div class="line">        <span class="keyword">if</span> (index &lt;= <span class="number">0xFF</span>) &#123;</div><div class="line">            out.writeByte(opc_ldc);</div><div class="line">            out.writeByte(index &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            out.writeByte(opc_ldc_w);</div><div class="line">            out.writeShort(index &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code to push a constant integer value on to the operand</div><div class="line">     * stack, using the "iconst_&lt;i&gt;", "bipush", or "sipush" instructions</div><div class="line">     * depending on the size of the value.  The code is written to the</div><div class="line">     * supplied stream.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">code_ipush</span><span class="params">(<span class="keyword">int</span> value, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (value &gt;= -<span class="number">1</span> &amp;&amp; value &lt;= <span class="number">5</span>) &#123;</div><div class="line">            out.writeByte(opc_iconst_0 + value);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= Byte.MIN_VALUE &amp;&amp; value &lt;= Byte.MAX_VALUE) &#123;</div><div class="line">            out.writeByte(opc_bipush);</div><div class="line">            out.writeByte(value &amp; <span class="number">0xFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= Short.MIN_VALUE &amp;&amp; value &lt;= Short.MAX_VALUE) &#123;</div><div class="line">            out.writeByte(opc_sipush);</div><div class="line">            out.writeShort(value &amp; <span class="number">0xFFFF</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Generate code to invoke the Class.forName with the name of the given</div><div class="line">     * class to get its Class object at runtime.  The code is written to</div><div class="line">     * the supplied stream.  Note that the code generated by this method</div><div class="line">     * may caused the checked ClassNotFoundException to be thrown.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">codeClassForName</span><span class="params">(Class cl, DataOutputStream out)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        code_ldc(cp.getString(cl.getName()), out);</div><div class="line"></div><div class="line">        out.writeByte(opc_invokestatic);</div><div class="line">        out.writeShort(cp.getMethodRef(</div><div class="line">                <span class="string">"java/lang/Class"</span>,</div><div class="line">                <span class="string">"forName"</span>, <span class="string">"(Ljava/lang/String;)Ljava/lang/Class;"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * ==================== General Utility Methods ====================</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Convert a fully qualified class name that uses '.' as the package</div><div class="line">     * separator, the external representation used by the Java language</div><div class="line">     * and APIs, to a fully qualified class name that uses '/' as the</div><div class="line">     * package separator, the representation used in the class file</div><div class="line">     * format (see JVMS section 4.2).</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">dotToSlash</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the "method descriptor" string for a method with the given</div><div class="line">     * parameter types and return type.  See JVMS section 4.3.3.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getMethodDescriptor</span><span class="params">(Class[] parameterTypes,</span></span></div><div class="line">                                              Class returnType)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> getParameterDescriptors(parameterTypes) +</div><div class="line">                ((returnType == <span class="keyword">void</span>.class) ? <span class="string">"V"</span> : getFieldType(returnType));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the list of "parameter descriptor" strings enclosed in</div><div class="line">     * parentheses corresponding to the given parameter types (in other</div><div class="line">     * words, a method descriptor without a return descriptor).  This</div><div class="line">     * string is useful for constructing string keys for methods without</div><div class="line">     * regard to their return type.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getParameterDescriptors</span><span class="params">(Class[] parameterTypes)</span> </span>&#123;</div><div class="line">        StringBuilder desc = <span class="keyword">new</span> StringBuilder(<span class="string">"("</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            desc.append(getFieldType(parameterTypes[i]));</div><div class="line">        &#125;</div><div class="line">        desc.append(<span class="string">')'</span>);</div><div class="line">        <span class="keyword">return</span> desc.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the "field type" string for the given type, appropriate for</div><div class="line">     * a field descriptor, a parameter descriptor, or a return descriptor</div><div class="line">     * other than "void".  See JVMS section 4.3.2.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFieldType</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (type.isPrimitive()) &#123;</div><div class="line">            <span class="keyword">return</span> PrimitiveTypeInfo.get(type).baseTypeString;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.isArray()) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * According to JLS 20.3.2, the getName() method on Class does</div><div class="line">             * return the VM type descriptor format for array classes (only);</div><div class="line">             * using that should be quicker than the otherwise obvious code:</div><div class="line">             *</div><div class="line">             *     return "[" + getTypeDescriptor(type.getComponentType());</div><div class="line">             */</div><div class="line">            <span class="keyword">return</span> type.getName().replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"L"</span> + dotToSlash(type.getName()) + <span class="string">";"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a human-readable string representing the signature of a</div><div class="line">     * method with the given name and parameter types.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFriendlyMethodSignature</span><span class="params">(String name,</span></span></div><div class="line">                                                     Class[] parameterTypes)</div><div class="line">    &#123;</div><div class="line">        StringBuilder sig = <span class="keyword">new</span> StringBuilder(name);</div><div class="line">        sig.append(<span class="string">'('</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line">                sig.append(<span class="string">','</span>);</div><div class="line">            &#125;</div><div class="line">            Class parameterType = parameterTypes[i];</div><div class="line">            <span class="keyword">int</span> dimensions = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (parameterType.isArray()) &#123;</div><div class="line">                parameterType = parameterType.getComponentType();</div><div class="line">                dimensions++;</div><div class="line">            &#125;</div><div class="line">            sig.append(parameterType.getName());</div><div class="line">            <span class="keyword">while</span> (dimensions-- &gt; <span class="number">0</span>) &#123;</div><div class="line">                sig.append(<span class="string">"[]"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        sig.append(<span class="string">')'</span>);</div><div class="line">        <span class="keyword">return</span> sig.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the number of abstract "words", or consecutive local variable</div><div class="line">     * indexes, required to contain a value of the given type.  See JVMS</div><div class="line">     * section 3.6.1.</div><div class="line">     *</div><div class="line">     * Note that the original version of the JVMS contained a definition of</div><div class="line">     * this abstract notion of a "word" in section 3.4, but that definition</div><div class="line">     * was removed for the second edition.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getWordsPerType</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (type == <span class="keyword">long</span>.class || type == <span class="keyword">double</span>.class) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add to the given list all of the types in the "from" array that</div><div class="line">     * are not already contained in the list and are assignable to at</div><div class="line">     * least one of the types in the "with" array.</div><div class="line">     *</div><div class="line">     * This method is useful for computing the greatest common set of</div><div class="line">     * declared exceptions from duplicate methods inherited from</div><div class="line">     * different interfaces.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">collectCompatibleTypes</span><span class="params">(Class&lt;?&gt;[] from,</span></span></div><div class="line">                                               Class&lt;?&gt;[] with,</div><div class="line">                                               List&lt;Class&lt;?&gt;&gt; list)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; from.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!list.contains(from[i])) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; with.length; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (with[j].isAssignableFrom(from[i])) &#123;</div><div class="line">                        list.add(from[i]);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Given the exceptions declared in the throws clause of a proxy method,</div><div class="line">     * compute the exceptions that need to be caught from the invocation</div><div class="line">     * handler's invoke method and rethrown intact in the method's</div><div class="line">     * implementation before catching other Throwables and wrapping them</div><div class="line">     * in UndeclaredThrowableExceptions.</div><div class="line">     *</div><div class="line">     * The exceptions to be caught are returned in a List object.  Each</div><div class="line">     * exception in the returned list is guaranteed to not be a subclass of</div><div class="line">     * any of the other exceptions in the list, so the catch blocks for</div><div class="line">     * these exceptions may be generated in any order relative to each other.</div><div class="line">     *</div><div class="line">     * Error and RuntimeException are each always contained by the returned</div><div class="line">     * list (if none of their superclasses are contained), since those</div><div class="line">     * unchecked exceptions should always be rethrown intact, and thus their</div><div class="line">     * subclasses will never appear in the returned list.</div><div class="line">     *</div><div class="line">     * The returned List will be empty if java.lang.Throwable is in the</div><div class="line">     * given list of declared exceptions, indicating that no exceptions</div><div class="line">     * need to be caught.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&lt;?&gt;&gt; computeUniqueCatchList(Class&lt;?&gt;[] exceptions) &#123;</div><div class="line">        List&lt;Class&lt;?&gt;&gt; uniqueList = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="comment">// unique exceptions to catch</span></div><div class="line"></div><div class="line">        uniqueList.add(Error.class);            <span class="comment">// always catch/rethrow these</span></div><div class="line">        uniqueList.add(RuntimeException.class);</div><div class="line"></div><div class="line">        nextException:</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptions.length; i++) &#123;</div><div class="line">            Class&lt;?&gt; ex = exceptions[i];</div><div class="line">            <span class="keyword">if</span> (ex.isAssignableFrom(Throwable.class)) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If Throwable is declared to be thrown by the proxy method,</div><div class="line">                 * then no catch blocks are necessary, because the invoke</div><div class="line">                 * can, at most, throw Throwable anyway.</div><div class="line">                 */</div><div class="line">                uniqueList.clear();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Throwable.class.isAssignableFrom(ex)) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Ignore types that cannot be thrown by the invoke method.</div><div class="line">                 */</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Compare this exception against the current list of</div><div class="line">             * exceptions that need to be caught:</div><div class="line">             */</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; uniqueList.size();) &#123;</div><div class="line">                Class&lt;?&gt; ex2 = uniqueList.get(j);</div><div class="line">                <span class="keyword">if</span> (ex2.isAssignableFrom(ex)) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * if a superclass of this exception is already on</div><div class="line">                     * the list to catch, then ignore this one and continue;</div><div class="line">                     */</div><div class="line">                    <span class="keyword">continue</span> nextException;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex.isAssignableFrom(ex2)) &#123;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * if a subclass of this exception is on the list</div><div class="line">                     * to catch, then remove it;</div><div class="line">                     */</div><div class="line">                    uniqueList.remove(j);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    j++;        <span class="comment">// else continue comparing.</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// This exception is unique (so far): add it to the list to catch.</span></div><div class="line">            uniqueList.add(ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> uniqueList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A PrimitiveTypeInfo object contains assorted information about</div><div class="line">     * a primitive type in its public fields.  The struct for a particular</div><div class="line">     * primitive type can be obtained using the static "get" method.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimitiveTypeInfo</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/** "base type" used in various descriptors (see JVMS section 4.3.2) */</span></div><div class="line">        <span class="keyword">public</span> String baseTypeString;</div><div class="line"></div><div class="line">        <span class="comment">/** name of corresponding wrapper class */</span></div><div class="line">        <span class="keyword">public</span> String wrapperClassName;</div><div class="line"></div><div class="line">        <span class="comment">/** method descriptor for wrapper class "valueOf" factory method */</span></div><div class="line">        <span class="keyword">public</span> String wrapperValueOfDesc;</div><div class="line"></div><div class="line">        <span class="comment">/** name of wrapper class method for retrieving primitive value */</span></div><div class="line">        <span class="keyword">public</span> String unwrapMethodName;</div><div class="line"></div><div class="line">        <span class="comment">/** descriptor of same method */</span></div><div class="line">        <span class="keyword">public</span> String unwrapMethodDesc;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class,PrimitiveTypeInfo&gt; table =</div><div class="line">                <span class="keyword">new</span> HashMap&lt;Class,PrimitiveTypeInfo&gt;();</div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            add(<span class="keyword">byte</span>.class, Byte.class);</div><div class="line">            add(<span class="keyword">char</span>.class, Character.class);</div><div class="line">            add(<span class="keyword">double</span>.class, Double.class);</div><div class="line">            add(<span class="keyword">float</span>.class, Float.class);</div><div class="line">            add(<span class="keyword">int</span>.class, Integer.class);</div><div class="line">            add(<span class="keyword">long</span>.class, Long.class);</div><div class="line">            add(<span class="keyword">short</span>.class, Short.class);</div><div class="line">            add(<span class="keyword">boolean</span>.class, Boolean.class);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Class primitiveClass, Class wrapperClass)</span> </span>&#123;</div><div class="line">            table.put(primitiveClass,</div><div class="line">                    <span class="keyword">new</span> PrimitiveTypeInfo(primitiveClass, wrapperClass));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">PrimitiveTypeInfo</span><span class="params">(Class primitiveClass, Class wrapperClass)</span> </span>&#123;</div><div class="line">            <span class="keyword">assert</span> primitiveClass.isPrimitive();</div><div class="line"></div><div class="line">            baseTypeString =</div><div class="line">                    Array.newInstance(primitiveClass, <span class="number">0</span>)</div><div class="line">                            .getClass().getName().substring(<span class="number">1</span>);</div><div class="line">            wrapperClassName = dotToSlash(wrapperClass.getName());</div><div class="line">            wrapperValueOfDesc =</div><div class="line">                    <span class="string">"("</span> + baseTypeString + <span class="string">")L"</span> + wrapperClassName + <span class="string">";"</span>;</div><div class="line">            unwrapMethodName = primitiveClass.getName() + <span class="string">"Value"</span>;</div><div class="line">            unwrapMethodDesc = <span class="string">"()"</span> + baseTypeString;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PrimitiveTypeInfo <span class="title">get</span><span class="params">(Class cl)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> table.get(cl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A ConstantPool object represents the constant pool of a class file</div><div class="line">     * being generated.  This representation of a constant pool is designed</div><div class="line">     * specifically for use by ProxyGeneratorEx; in particular, it assumes</div><div class="line">     * that constant pool entries will not need to be resorted (for example,</div><div class="line">     * by their type, as the Java compiler does), so that the final index</div><div class="line">     * value can be assigned and used when an entry is first created.</div><div class="line">     *</div><div class="line">     * Note that new entries cannot be created after the constant pool has</div><div class="line">     * been written to a class file.  To prevent such logic errors, a</div><div class="line">     * ConstantPool instance can be marked "read only", so that further</div><div class="line">     * attempts to add new entries will fail with a runtime exception.</div><div class="line">     *</div><div class="line">     * See JVMS section 4.4 for more information about the constant pool</div><div class="line">     * of a class file.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantPool</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * list of constant pool entries, in constant pool index order.</div><div class="line">         *</div><div class="line">         * This list is used when writing the constant pool to a stream</div><div class="line">         * and for assigning the next index value.  Note that element 0</div><div class="line">         * of this list corresponds to constant pool index 1.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> List&lt;Entry&gt; pool = <span class="keyword">new</span> ArrayList&lt;Entry&gt;(<span class="number">32</span>);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * maps constant pool data of all types to constant pool indexes.</div><div class="line">         *</div><div class="line">         * This map is used to look up the index of an existing entry for</div><div class="line">         * values of all types.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> Map&lt;Object,Short&gt; map = <span class="keyword">new</span> HashMap&lt;Object,Short&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line">        <span class="comment">/** true if no new constant pool entries may be added */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> readOnly = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Utf8 entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getUtf8</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> getValue(s);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Integer entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getInteger</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getValue(<span class="keyword">new</span> Integer(i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Float entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getFloat</span><span class="params">(<span class="keyword">float</span> f)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getValue(<span class="keyword">new</span> Float(f));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_Class entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> utf8Index = getUtf8(name);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_CLASS, utf8Index));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_String entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getString</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> utf8Index = getUtf8(s);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_STRING, utf8Index));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_FieldRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getFieldRef</span><span class="params">(String className,</span></span></div><div class="line">                                 String name, String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_FIELD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_MethodRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getMethodRef</span><span class="params">(String className,</span></span></div><div class="line">                                  String name, String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_METHOD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_InterfaceMethodRef entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getInterfaceMethodRef</span><span class="params">(String className, String name,</span></span></div><div class="line">                                           String descriptor)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">short</span> classIndex = getClass(className);</div><div class="line">            <span class="keyword">short</span> nameAndTypeIndex = getNameAndType(name, descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_INTERFACEMETHOD, classIndex, nameAndTypeIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for a CONSTANT_NameAndType entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getNameAndType</span><span class="params">(String name, String descriptor)</span> </span>&#123;</div><div class="line">            <span class="keyword">short</span> nameIndex = getUtf8(name);</div><div class="line">            <span class="keyword">short</span> descriptorIndex = getUtf8(descriptor);</div><div class="line">            <span class="keyword">return</span> getIndirect(<span class="keyword">new</span> IndirectEntry(</div><div class="line">                    CONSTANT_NAMEANDTYPE, nameIndex, descriptorIndex));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Set this ConstantPool instance to be "read only".</div><div class="line">         *</div><div class="line">         * After this method has been called, further requests to get</div><div class="line">         * an index for a non-existent entry will cause an InternalError</div><div class="line">         * to be thrown instead of creating of the entry.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadOnly</span><span class="params">()</span> </span>&#123;</div><div class="line">            readOnly = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Write this constant pool to a stream as part of</div><div class="line">         * the class file format.</div><div class="line">         *</div><div class="line">         * This consists of writing the "constant_pool_count" and</div><div class="line">         * "constant_pool[]" items of the "ClassFile" structure, as</div><div class="line">         * described in JVMS section 4.1.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            DataOutputStream dataOut = <span class="keyword">new</span> DataOutputStream(out);</div><div class="line"></div><div class="line">            <span class="comment">// constant_pool_count: number of entries plus one</span></div><div class="line">            dataOut.writeShort(pool.size() + <span class="number">1</span>);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (Entry e : pool) &#123;</div><div class="line">                e.write(dataOut);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Add a new constant pool entry and return its index.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">addEntry</span><span class="params">(Entry entry)</span> </span>&#123;</div><div class="line">            pool.add(entry);</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Note that this way of determining the index of the</div><div class="line">             * added entry is wrong if this pool supports</div><div class="line">             * CONSTANT_Long or CONSTANT_Double entries.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (pool.size() &gt;= <span class="number">65535</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                        <span class="string">"constant pool size limit exceeded"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">short</span>) pool.size();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for an entry of a type that contains</div><div class="line">         * a direct value.  The type of the given object determines the</div><div class="line">         * type of the desired entry as follows:</div><div class="line">         *</div><div class="line">         *      java.lang.String        CONSTANT_Utf8</div><div class="line">         *      java.lang.Integer       CONSTANT_Integer</div><div class="line">         *      java.lang.Float         CONSTANT_Float</div><div class="line">         *      java.lang.Long          CONSTANT_Long</div><div class="line">         *      java.lang.Double        CONSTANT_DOUBLE</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">getValue</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">            Short index = map.get(key);</div><div class="line">            <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> index.shortValue();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (readOnly) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</div><div class="line">                            <span class="string">"late constant pool addition: "</span> + key);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">short</span> i = addEntry(<span class="keyword">new</span> ValueEntry(key));</div><div class="line">                map.put(key, <span class="keyword">new</span> Short(i));</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get or assign the index for an entry of a type that contains</div><div class="line">         * references to other constant pool entries.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">getIndirect</span><span class="params">(IndirectEntry e)</span> </span>&#123;</div><div class="line">            Short index = map.get(e);</div><div class="line">            <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> index.shortValue();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (readOnly) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"late constant pool addition"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">short</span> i = addEntry(e);</div><div class="line">                map.put(e, <span class="keyword">new</span> Short(i));</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Entry is the abstact superclass of all constant pool entry types</div><div class="line">         * that can be stored in the "pool" list; its purpose is to define a</div><div class="line">         * common method for writing constant pool entries to a class file.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span></span></div><div class="line">                    <span class="keyword">throws</span> IOException;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ValueEntry represents a constant pool entry of a type that</div><div class="line">         * contains a direct value (see the comments for the "getValue"</div><div class="line">         * method for a list of such types).</div><div class="line">         *</div><div class="line">         * ValueEntry objects are not used as keys for their entries in the</div><div class="line">         * Map "map", so no useful hashCode or equals methods are defined.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueEntry</span> <span class="keyword">extends</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="keyword">private</span> Object value;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">ValueEntry</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.value = value;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</div><div class="line">                    out.writeByte(CONSTANT_UTF8);</div><div class="line">                    out.writeUTF((String) value);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</div><div class="line">                    out.writeByte(CONSTANT_INTEGER);</div><div class="line">                    out.writeInt(((Integer) value).intValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Float) &#123;</div><div class="line">                    out.writeByte(CONSTANT_FLOAT);</div><div class="line">                    out.writeFloat(((Float) value).floatValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Long) &#123;</div><div class="line">                    out.writeByte(CONSTANT_LONG);</div><div class="line">                    out.writeLong(((Long) value).longValue());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double) &#123;</div><div class="line">                    out.writeDouble(CONSTANT_DOUBLE);</div><div class="line">                    out.writeDouble(((Double) value).doubleValue());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"bogus value entry: "</span> + value);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * IndirectEntry represents a constant pool entry of a type that</div><div class="line">         * references other constant pool entries, i.e., the following types:</div><div class="line">         *</div><div class="line">         *      CONSTANT_Class, CONSTANT_String, CONSTANT_Fieldref,</div><div class="line">         *      CONSTANT_Methodref, CONSTANT_InterfaceMethodref, and</div><div class="line">         *      CONSTANT_NameAndType.</div><div class="line">         *</div><div class="line">         * Each of these entry types contains either one or two indexes of</div><div class="line">         * other constant pool entries.</div><div class="line">         *</div><div class="line">         * IndirectEntry objects are used as the keys for their entries in</div><div class="line">         * the Map "map", so the hashCode and equals methods are overridden</div><div class="line">         * to allow matching.</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IndirectEntry</span> <span class="keyword">extends</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">int</span> tag;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">short</span> index0;</div><div class="line">            <span class="keyword">private</span> <span class="keyword">short</span> index1;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Construct an IndirectEntry for a constant pool entry type</div><div class="line">             * that contains one index of another entry.</div><div class="line">             */</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IndirectEntry</span><span class="params">(<span class="keyword">int</span> tag, <span class="keyword">short</span> index)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.tag = tag;</div><div class="line">                <span class="keyword">this</span>.index0 = index;</div><div class="line">                <span class="keyword">this</span>.index1 = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Construct an IndirectEntry for a constant pool entry type</div><div class="line">             * that contains two indexes for other entries.</div><div class="line">             */</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IndirectEntry</span><span class="params">(<span class="keyword">int</span> tag, <span class="keyword">short</span> index0, <span class="keyword">short</span> index1)</span> </span>&#123;</div><div class="line">                <span class="keyword">this</span>.tag = tag;</div><div class="line">                <span class="keyword">this</span>.index0 = index0;</div><div class="line">                <span class="keyword">this</span>.index1 = index1;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                out.writeByte(tag);</div><div class="line">                out.writeShort(index0);</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If this entry type contains two indexes, write</div><div class="line">                 * out the second, too.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (tag == CONSTANT_FIELD ||</div><div class="line">                        tag == CONSTANT_METHOD ||</div><div class="line">                        tag == CONSTANT_INTERFACEMETHOD ||</div><div class="line">                        tag == CONSTANT_NAMEANDTYPE)</div><div class="line">                &#123;</div><div class="line">                    out.writeShort(index1);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> tag + index0 + index1;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> IndirectEntry) &#123;</div><div class="line">                    IndirectEntry other = (IndirectEntry) obj;</div><div class="line">                    <span class="keyword">if</span> (tag == other.tag &amp;&amp;</div><div class="line">                            index0 == other.index0 &amp;&amp; index1 == other.index1)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And this is the modified <code>Proxy</code> which I name <code>ProxyEx</code>:</p>
<figure class="highlight java"><figcaption><span>ProxyEx.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy.supportclass;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyEx</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt; superclass, Class&lt;?&gt;... interfaces) &#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes = ProxyGeneratorEx.generateProxyClass(superclass.getSimpleName() + <span class="string">"$"</span>, superclass, interfaces);</div><div class="line">        <span class="keyword">return</span> defineClass0(loader, <span class="string">"$Dog"</span>, bytes, <span class="number">0</span>, bytes.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">TODO:</span> no class cache support and no class name generation</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> loader</div><div class="line">     * <span class="doctag">@param</span> superclass</div><div class="line">     * <span class="doctag">@param</span> interfaces</div><div class="line">     * <span class="doctag">@param</span> h</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt; superclass, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span> </span>&#123;</div><div class="line">        Class&lt;?&gt; proxyClass = getProxyClass(loader, superclass, interfaces);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Constructor constructor = proxyClass.getConstructor(InvocationHandler.class);</div><div class="line">            constructor.setAccessible(<span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> constructor.newInstance(h);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; defineClass0(ClassLoader loader, String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len) &#123;</div><div class="line">        Class proxyClass = Proxy.class;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Method defineClass0Method = proxyClass.getDeclaredMethod(<span class="string">"defineClass0"</span>, ClassLoader.class, String.class, <span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</div><div class="line">            defineClass0Method.setAccessible(<span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> (Class&lt;?&gt;) defineClass0Method.invoke(<span class="keyword">null</span>, loader, name, b, off, len);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now let’s get a try with our dynamic proxy.</p>
<figure class="highlight java"><figcaption><span>Dog.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy.supportclass;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>DogInvocationHandler.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy.supportclass;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DogInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"bark"</span>.equals(method.getName())) &#123;</div><div class="line">            System.out.println(<span class="string">"dog barked"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>Main.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> dynamicproxy.supportclass;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.getProperties().put(<span class="string">"sun.misc.ProxyGeneratorEx.saveGeneratedFiles"</span>,<span class="string">"true"</span>);</div><div class="line"></div><div class="line"><span class="comment">//        Class aClass = ProxyEx.getProxyClass(A.class.getClassLoader(), A.class, new Class[]&#123;&#125;);</span></div><div class="line">        Dog dog = (Dog) ProxyEx.newProxyInstance(Dog.class.getClassLoader(), Dog.class, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> DogInvocationHandler());</div><div class="line">        dog.bark();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here you should see the console will print “dog barked”.</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/04/21/dbVisualizer-tips/" rel="next" title="DbVisualizer Tips">
                <i class="fa fa-chevron-left"></i> DbVisualizer Tips
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/22/how-jvm-handle-method-invocation/" rel="prev" title="How JVM handle method invocation">
                How JVM handle method invocation <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://qph.is.quoracdn.net/main-thumb-27403014-200-azcnfpakpayhgojvmueqcfjeyufbjpcx.jpeg"
               alt="Richard Yang" />
          <p class="site-author-name" itemprop="name">Richard Yang</p>
          <p class="site-description motion-element" itemprop="description">Nothing seek, nothing find</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">133</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://linkedin.com/in/richdyang" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://github.com/richdyang" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github-alt"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://bitbucket.org/richdyang" target="_blank" title="Bitbucket">
                  
                    <i class="fa fa-fw fa-bitbucket"></i>
                  
                  Bitbucket
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" title="Stackoverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                  Stackoverflow
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://twitter.com/richdyang" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Dynamic-Proxy-in-JDK"><span class="nav-number">1.</span> <span class="nav-text">Dynamic Proxy in JDK</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Implement-Dynamic-Proxy-supporting-Class"><span class="nav-number">2.</span> <span class="nav-text">Implement Dynamic Proxy supporting Class</span></a></li></ol></div>
            

          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard Yang</span>
</div>

<!--div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div-->

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'richyang';
      var disqus_identifier = '2016/08/15/dynamic-proxy-revisit/';
      var disqus_title = 'Dynamic Proxy revisit';

      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        run_disqus_script('embed.js');
      

    </script>
  




  
  

  

  

  
  

  
  
  
  <link rel="stylesheet" href="/vendors/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/vendors/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



</body>
</html>
