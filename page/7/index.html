<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Richard Yang, Java Developer, Senior software engineer" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Nothing seek, nothing find">
<meta property="og:type" content="website">
<meta property="og:title" content="Richard Yang">
<meta property="og:url" content="https://richyang.me/page/7/index.html">
<meta property="og:site_name" content="Richard Yang">
<meta property="og:description" content="Nothing seek, nothing find">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Richard Yang">
<meta name="twitter:description" content="Nothing seek, nothing find">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    },
    algolia: {
      applicationID: 'X0H1P7HDKY',
      apiKey: 'ddc0af00a6e07c9b1be9f4da4cf5b9d9',
      indexName: 'richyang.me',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>




  <title> Richard Yang </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <!--span class="logo-line-before"><i></i></span-->
      <span class="site-title">Richard Yang</span>
      <!--span class="logo-line-after"><i></i></span-->
    </a>
  </div>
  <p class="site-subtitle">Full-stack software engineer mainly focusing on Java-based technologies and web front-end</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-books">
          <a href="https://www.gitbook.com/@richdyang" rel="section">
            
            Books
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-showcase">
          <a href="/showcase" rel="section">
            
            Showcase
          </a>
        </li>
        
      
        
        
        <li class="menu-item menu-item-resume">
          <a href="http://linkedin.com/in/richdyang" rel="section">
            
            Résumé
          </a>
        </li>
        
      
        
        
      
        
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            About
          </a>
        </li>
        
      
        
        
      
        
        
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
            <i class="menu-item-icon fa fa-search fa-lg"></i>Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>

<div class="social-links" style="float: right; padding-left: 50px; margin-right: 10px">
      
        
          <span class="links-of-author-item">
            <a href="http://linkedin.com/in/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-linkedin"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://github.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-github-alt"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://bitbucket.org/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-bitbucket"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i>
                </span>
                 
              
            </a>
          </span>
        
          <span class="links-of-author-item">
            <a href="http://twitter.com/richdyang" target="_blank" style="border-bottom: none">
              
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-stack-1x fa-inverse fa-twitter"></i>
                </span>
                 
              
            </a>
          </span>
        
      
  </div>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/19/immutable-objects/" itemprop="url">
                  Immutable objects
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-19T16:54:45+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/Best-Pricatice/" itemprop="url" rel="index">
                    <span itemprop="name">Best Pricatice</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/19/immutable-objects/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/19/immutable-objects/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>An <a href="http://en.wikipedia.org/wiki/Immutable_object" title="immutable class" target="_blank" rel="external">immutable class</a> is one whose state can not be changed once created. There are certain guidelines to create an class immutable. In this post, we will revisit these guidelines.</p>
<h3 id="Benefits-of-making-a-class-immutable"><a href="#Benefits-of-making-a-class-immutable" class="headerlink" title="Benefits of making a class immutable"></a>Benefits of making a class immutable</h3><p>Lets first identify benefits of making a class immutable. Immutable classes are</p>
<ol>
<li>are simple to construct, test, and use</li>
<li>are automatically thread-safe and have no synchronization issues</li>
<li>do not need a copy constructor</li>
<li>do not need an implementation of clone</li>
<li>allow <a href="http://howtodoinjava.com/2012/10/09/working-with-hashcode-and-equals-methods-in-java/" title="Working with hashCode and equals methods in java" target="_blank" rel="external">hashCode</a> to use lazy initialization, and to cache its return value</li>
<li>do not need to be copied defensively when used as a field</li>
<li>make good <a href="http://howtodoinjava.com/2012/10/09/how-hashmap-works-in-java/" title="How hashmap works in java" target="_blank" rel="external">Map keys and Set elements</a> (these objects must not change state while in the collection)</li>
<li>have their class invariant established once upon construction, and it never needs to be checked again</li>
<li>always have “<strong>failure atomicity</strong>” (a term used by Joshua Bloch) : if an immutable object throws an exception, it’s never left in an undesirable or indeterminate state</li>
</ol>
<h3 id="Guidelines-to-make-a-class-immutable"><a href="#Guidelines-to-make-a-class-immutable" class="headerlink" title="Guidelines to make a class immutable"></a>Guidelines to make a class immutable</h3><p>Java documentation itself has some guidelines identified <a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/imstrat.html" title="immutable classes" target="_blank" rel="external">in this link</a>. We will understand what they mean actually:</p>
<p><strong>1) Don’t provide “setter” methods — methods that modify fields or objects referred to by fields.</strong></p>
<p>This principle says that for all mutable properties in your class, do not provide setter methods. Setter methods are meant to change the state of object and this is what we want to prevent here.</p>
<p><strong>2) Make all fields final and private</strong></p>
<p>This is another way to increase immutability. Fields declared private will not be accessible outside the class and making them final will ensure the even accidentally you can not change them.</p>
<p><strong>3) Don’t allow subclasses to override methods</strong></p>
<p>The simplest way to do this is to declare the class as <strong><em>final</em></strong>. Final classes in java can not be overridden.</p>
<p><strong>4) Special attention when having mutable instance variables</strong></p>
<p>Always remember that your instance variables will be either <strong>mutable or immutable</strong>. Identify them and <strong>return new objects with copied content for all mutable objects</strong>. Immutable variables can be returned safely without extra effort.</p>
<p>A more sophisticated approach is to make the constructor <strong><em>private</em></strong> and construct instances in <strong>factory methods</strong>.</p>
<p>A central idea of these rules is that you must ensure all the<strong> accessible objects in the object graph</strong> are immutable.</p>
<p>&nbsp;</p>
<p>Built-in library has many immutable classes:</p>
<ul>
<li>String</li>
<li>Primitive wraper classes: Byte, Character, Short, Integer, Long, Float, Double</li>
</ul>
<h3 id="Collections-unmodifiableList-like-ISN’T-immutable"><a href="#Collections-unmodifiableList-like-ISN’T-immutable" class="headerlink" title="Collections.unmodifiableList(..) like ISN’T immutable"></a>Collections.unmodifiableList(..) like ISN’T immutable</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImmutableTest</span> </span>&#123;</div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUnmodifiedCollectionImmutable</span><span class="params">()</span></span>&#123;                                                                                                                                                                                                                                    </div><div class="line">        List&amp;lt;String&amp;gt; list=<span class="keyword">new</span> ArrayList&amp;lt;String&amp;gt;();                                                                               </div><div class="line">        list.add(<span class="string">"a"</span>);                                                                                                           </div><div class="line">        list.add(<span class="string">"b"</span>);                                                                                                           </div><div class="line">        list.add(<span class="string">"c"</span>);</div><div class="line"></div><div class="line">        System.out.println(list);</div><div class="line"></div><div class="line">        List&amp;lt;String&amp;gt; unmodifiableList=Collections.unmodifiableList(list); </div><div class="line"></div><div class="line">        System.out.println(unmodifiableList);</div><div class="line"></div><div class="line">        List&amp;lt;String&amp;gt; unmodifiableList1=Collections.unmodifiableList(Arrays.asList(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>)); </div><div class="line">        System.out.println(unmodifiableList1);</div><div class="line"></div><div class="line">        String temp=unmodifiableList.get(<span class="number">1</span>);</div><div class="line">        System.out.println(<span class="string">"unmodifiableList [0]："</span>+temp);</div><div class="line"></div><div class="line">        list.add(<span class="string">"baby"</span>);</div><div class="line">        System.out.println(<span class="string">"list add a item after list:"</span>+list);</div><div class="line">        System.out.println(<span class="string">"list add a item after unmodifiableList:"</span>+unmodifiableList);</div><div class="line"></div><div class="line">        unmodifiableList1.add(<span class="string">"bb"</span>);</div><div class="line">        System.out.println(<span class="string">"unmodifiableList add a item after list:"</span>+unmodifiableList1);</div><div class="line"></div><div class="line">        unmodifiableList.add(<span class="string">"cc"</span>);</div><div class="line">        System.out.println(<span class="string">"unmodifiableList add a item after list:"</span>+unmodifiableList);        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Output:<br>[a, b, c]<br>[a, b, c]<br>[a, b, c]<br>unmodifiableList [0]：b<br>list add a item after list:[a, b, c, baby]<br>list add a item after unmodifiableList1:[a, b, c, baby]</p>
<p>From the above example, you can see unmodifiableList is not immutable. It will change if the underlying List is changed.</p>
<p>So the correct usage of unmodified List is like:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">List list = Collections.unmodifiableList(Arrays.asList(<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>);</div></pre></td></tr></table></figure></p>
<p>or<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">List list = <span class="keyword">new</span> ArrayList();</div><div class="line">list.add(<span class="string">"1"</span>);</div><div class="line">list.add(<span class="number">2</span>);</div><div class="line">list.add(<span class="string">"333"</span>);</div><div class="line">list = Collections.unmodifiableList(list);</div></pre></td></tr></table></figure></p>
<p>Never expose the underlying list reference to anything, so the best way is passing an argument and initialization in place.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/19/stringsubstring-implementation/" itemprop="url">
                  String#substring(..) implementation
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-19T15:22:01+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/19/stringsubstring-implementation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/19/stringsubstring-implementation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I heard that in new version of JDK (&gt;JDK7u5), substring implementation is changed.</p>
<p>In the past, substring() don’t copy the specified character string but share the inherent character array reference with the original String. In this case, String substring can result in retaining more memory than you might expect. As such it’s not a memory leak as this memory can be recovered normally (potential memory leak).</p>
<p>But note <em><strong>this behaviour has changed as of Java 7u6.</strong></em></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/19/why-two-date-classes-java-util-date-and-java-sql-date/" itemprop="url">
                  Why two Date classes: java.util.Date and java.sql.Date?
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-19T14:35:54+08:00" content="2015-03-19">
              2015-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/19/why-two-date-classes-java-util-date-and-java-sql-date/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/19/why-two-date-classes-java-util-date-and-java-sql-date/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>A java.util.Date represents date and time of day, a java.sql.Date only represents a date. The complement of java.sql.Date is java.sql.Time, which only represents a time of day.<br>The java.sql.Date is a subclass (an extension) of java.util.Date. So, what changed in java.sql.Date:</p>
<p>– toString() generates a different string representation: yyyy-mm-dd<br>– a static valueOf(String) methods to create a Date from a String with above representation<br>– the getters and setter for hours, minutes and seconds are deprecated</p>
<p>The java.sql.Date class is used with JDBC and it was intended to not have a time part, that is, hours, minutes, seconds, and milliseconds should be zero… but this is not enforced by the class.</p>
<p>You can still use its setTime(long) method to set the date in the form of millisecond time value.</p>
<p>java.sql.Time is similar to java.sql.Date and inherited to java.util.Date.</p>
<p>java.sql.Timestamp can represent date and time together, just like java.util.Date</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/18/autoboxing-and-valueof/" itemprop="url">
                  auto-boxing and valueOf(..)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-17T19:20:41+08:00" content="2015-03-17">
              2015-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/18/autoboxing-and-valueof/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/18/autoboxing-and-valueof/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Autoboxing uses <code>Integer.valueOf(int)</code>,which internally caches Integer objects for small integers (by default -128 to 127, but the max value can be configured with the “java.lang.Integer.IntegerCache.high” property.</p>
<p>Double is the same by using Double.valueOf(..)</p>
<p>So the following two lines are equivalent.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line">Integer i = <span class="number">12</span>;</div><div class="line">Integer i = Integer.valueOf(<span class="number">12</span>);</div></pre></td></tr></table></figure>
<p>If you don’t believe it, you can decompile the .class file to see what the compiler does.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/float-numbers/" itemprop="url">
                  Float numbers
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-17T14:38:15+08:00" content="2015-03-17">
              2015-03-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/17/float-numbers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/17/float-numbers/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/equals-and-hashcode-contract/" itemprop="url">
                  equals() / hashCode() contract, Comparable contract
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-16T19:13:32+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/17/equals-and-hashcode-contract/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/17/equals-and-hashcode-contract/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Although Java encourage and support to maintain contract by interface, but there are some implicit contracts that should be noticed when you are implementing some special functions.</p>
<h3 id="What-is-equals-and-hashCode-contract"><a href="#What-is-equals-and-hashCode-contract" class="headerlink" title="What is equals and hashCode contract?"></a>What is equals and hashCode contract?</h3><blockquote>
<p><strong>The interface contract for <code>Object</code> requires that if two objects are equal according to <code>equals()</code>, then they must have the same <code>hashCode()</code>value.</strong></p>
<p>1. If two objects are equal, then they must have the same hash code.</p>
<p>2. If two objects have the same hashcode, they may or may not be equal.</p>
</blockquote>
<h4 id="Why-override-equals-and-hashCode"><a href="#Why-override-equals-and-hashCode" class="headerlink" title="Why override equals() and hashCode()?"></a>Why override equals() and hashCode()?</h4><p>The <code>hashCode()</code> method exists purely for efficiency. The Java platform architects anticipated the importance of hash-based collection classes – such as <code>Hashtable</code>, <code>HashMap</code>, and <code>HashSet</code> – in typical Java applications, and comparing against many objects with <code>equals()</code> can be computationally expensive. Having every Java object support <code>hashCode()</code> allows for efficient storage and retrieval using hash-based collections.</p>
<hr>
<p>For the class as <strong>key</strong> of HashMap or HashSet(which is inner implemented by HashMap and the entry with a dummy value), it must rewrite the hashCode() and equals() methods.</p>
<p><img src="/media/java-hashcode-650x3691.jpeg" alt="java-hashcode-650x369"></p>
<p>Some developers rewrite the equals() methods but don’t rewrite the hashCode() method, it will be error prone. The following is <strong>a common mistake</strong>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokenEqualsHashCode</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testEuals</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeObject a = <span class="keyword">new</span> SomeObject(<span class="number">1</span>,&amp;quot;<span class="number">1</span>&amp;quot;);</div><div class="line">        SomeObject b = <span class="keyword">new</span> SomeObject(<span class="number">2</span>, &amp;quot;<span class="number">1</span>&amp;quot;);</div><div class="line"></div><div class="line">        System.out.println(a.hashCode());</div><div class="line">        System.out.println(b.hashCode());</div><div class="line"></div><div class="line">        System.out.println(b.equals(a));</div><div class="line"></div><div class="line">        Map&amp;lt;SomeObject, String&amp;gt; map = <span class="keyword">new</span> HashMap&amp;lt;SomeObject, String&amp;gt;(<span class="number">10</span>);</div><div class="line">        map.put(a, &amp;quot;<span class="number">1</span>&amp;quot;);</div><div class="line">        map.put(b, &amp;quot;<span class="number">2</span>&amp;quot;);</div><div class="line"></div><div class="line">		System.out.println(map.get(<span class="keyword">new</span> SomeObject(<span class="number">1</span>, &amp;quot;<span class="number">1</span>&amp;quot;)));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeObject</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> a;</div><div class="line">    String b;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SomeObject</span><span class="params">(<span class="keyword">int</span> a, String b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.a = a;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        SomeObject that = (SomeObject) o;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!b.equals(that.b)) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3790865<br>26759037<br>true<br>null</p>
<p>You can see, although the two objects as key are equal, but it cannot get the expected effect.</p>
<p>Actually, the two entries are stored in the hash map, but it cannot be retrieved by the equal object.</p>
<h4 id="How-to-design-a-good-key-for-HashMap"><a href="#How-to-design-a-good-key-for-HashMap" class="headerlink" title="How to design a good key for HashMap"></a>How to design a good key for HashMap</h4><p>The very basic need for designing a good key is that “<em><strong>we should be able to retrieve the value object back from the map without failure</strong></em>“, otherwise no matter how fancy data structure you build, it will be of no use.</p>
<p>For this basic reasoning, key objects are suggested to be IMMUTABLE. IMMUTABILITY allows you to get same hash code every time, for a key object.</p>
<p>But remember that <strong>immutability is recommended and not mandatory</strong>.</p>
<p>An example is always better for demonstration, right? Then lets have one.</p>
<p>In this example, I have created an account class with only two fields for simplicity. I have overridden the hash code and equals method such that it uses only account number to verify the uniqueness of Account object. All other possible attributes of Account class can be changed on runtime.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> accountNumber;</div><div class="line">    <span class="keyword">private</span> String holderName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> accountNumber)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.accountNumber = accountNumber;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHolderName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> holderName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHolderName</span><span class="params">(String holderName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.holderName = holderName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAccountNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> accountNumber;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Depends only on account number</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</div><div class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</div><div class="line">        result = prime * result + accountNumber;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Compare only account numbers</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (getClass() != obj.getClass())</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Account other = (Account) obj;</div><div class="line">        <span class="keyword">if</span> (accountNumber != other.accountNumber)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Output:</p>
<p>A_ONE<br>A_TWO<br>A_ONE</p>
<h3 id="What-is-Comparable-contract"><a href="#What-is-Comparable-contract" class="headerlink" title="What is Comparable contract?"></a>What is Comparable contract?</h3><p>Basically, Comparable contract is related to sorting or ordering.</p>
<p>So to do the following things, you must implement Comparable:</p>
<ul>
<li>calling <tt><a href="http://docs.oracle.com/javase/7/docs/api/java/util/Collections.html" target="_blank" rel="external">Collections</a>.sort</tt> and <tt>Collections.binarySearch</tt></li>
<li>calling <tt><a href="http://docs.oracle.com/javase/7/docs/api/java/util/Arrays.html" target="_blank" rel="external">Arrays</a>.sort</tt> and <tt>Arrays.binarySearch</tt></li>
<li>using objects as keys in a <tt><a href="http://docs.oracle.com/javase/7/docs/api/java/util/TreeMap.html" target="_blank" rel="external">TreeMap</a></tt></li>
<li>using objects as elements in a <tt><a href="http://docs.oracle.com/javase/7/docs/api/java/util/TreeSet.html" target="_blank" rel="external">TreeSet</a></tt><br>It’s not hard to notice that these are all related to ordering.</li>
</ul>
<p>Compare the various types of fields as follows:</p>
<ul>
<li>numeric primitive : use <tt>&lt;</tt> and <tt>&gt;</tt>. There is an exception to this rule: <tt>float</tt> and <tt>double</tt> primitives should be compared using Float.<a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Float.html#compare(float,%20float" target="_blank" rel="external">compare(float, float)</a>) and Double.<a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Double.html#compare(double,%20double" target="_blank" rel="external">compare(double, double)</a>). This avoids problems associated with special border values.</li>
<li><tt>boolean</tt> primitive :  use tests of the form <tt>(x &amp;&amp; !y)</tt></li>
<li>All primitive wrapper classes implement <tt>Comparable</tt></li>
<li><tt>Object</tt> : use <tt>compareTo</tt>. (Note that possibly-null fields present a problem : while <tt>x.equals(null)</tt> returns <tt>false</tt>, <tt>x.compareTo(null)</tt> will always throw a <tt>NullPointerException</tt>)</li>
<li>type-safe enumeration : use <tt>compareTo</tt>, like any <tt>Object</tt></li>
<li>collection or array : <tt>Comparable</tt> does not seem to be intended for these kinds of fields. For example, <tt>List</tt>, <tt>Map</tt> and <tt>Set</tt> do not implement <tt>Comparable</tt>. As well, some collections have no definite order of iteration, so doing an element-by-element comparison cannot be meaningful in those cases.<br>If the task is to perform a sort of items which are stored in a relational database, then it is usually much preferred to let the database perform the sort using the ORDER BY clause, rather than in code.</li>
</ul>
<p>An alternative to implementing <tt>Comparable</tt> is passing <strong><tt><a href="http://docs.oracle.com/javase/7/docs/api/java/util/Comparator.html" target="_blank" rel="external">Comparator</a></tt></strong> objects as parameters. Be aware that if a <tt>Comparator</tt> compares only one of several significant fields, then the <tt>Comparator</tt> is very likely not consistent with <tt>equals</tt>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/character-encoding-and-charset-in-java/" itemprop="url">
                  Character encoding and charset in Java
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-16T19:08:24+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/17/character-encoding-and-charset-in-java/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/17/character-encoding-and-charset-in-java/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h1><p>At the beginning, we need to distinguish some key concepts.</p>
<h2 id="character"><a href="#character" class="headerlink" title="character"></a>character</h2><p>Character (aka. abstract character) is a textual representation of character.</p>
<h2 id="glyph"><a href="#glyph" class="headerlink" title="glyph"></a>glyph</h2><p>glyph is the particular images representing a character or part of a character. Glyphs for the same character may have very different shapes</p>
<h2 id="abstract-character-repertoire-ACR"><a href="#abstract-character-repertoire-ACR" class="headerlink" title="abstract character repertoire (ACR)"></a>abstract character repertoire (ACR)</h2><p>A <em>character repertoire</em> is the full set of unordered abstract characters that a system supports.</p>
<h2 id="coded-character-set-CCS"><a href="#coded-character-set-CCS" class="headerlink" title="coded character set (CCS)"></a>coded character set (CCS)</h2><p>A <em>coded character set</em> (CCS) specifies how to represent a repertoire of characters using a number of (typically non-negative) integer values called <span style="color: #ffffff; font-size: 20px; background-color: #000000;">code points</span>.</p>
<p>A complete set of characters and corresponding integers is a <em>coded character set</em>.</p>
<p>Multiple coded character sets may share the same repertoire.</p>
<h2 id="character-encoding-form-CEF"><a href="#character-encoding-form-CEF" class="headerlink" title="character encoding form (CEF)"></a><em>character encoding form</em> (CEF)</h2><p>A <em>character encoding form</em> (CEF) specifies the conversion of a coded character set’s integer codes into a set of limited-size integer <em>code values</em> that facilitate storage in a system that represents numbers in binary form using a fixed number of bits.</p>
<p>This is what a CEF accommodates: it defines a way of mapping a <em>single</em> code <em>point to a sequences of octets.</em></p>
<h2 id="character-encoding-scheme-CES"><a href="#character-encoding-scheme-CES" class="headerlink" title="character encoding scheme (CES)"></a>character encoding scheme (CES)</h2><p>a <em>character encoding scheme</em> (CES) specifies how the fixed-size integer code values should be mapped into an octet sequence suitable for saving on an octet-based file system or transmitting over an octet-based network.</p>
<table>
<thead>
<tr>
<th>Character encoding</th>
<th>Code unit width</th>
</tr>
</thead>
<tbody>
<tr>
<td>US-ASCII</td>
<td>7</td>
</tr>
<tr>
<td>UTF-8</td>
<td>8</td>
</tr>
<tr>
<td>EBCDIC</td>
<td>8</td>
</tr>
<tr>
<td>UTF-16</td>
<td>16</td>
</tr>
<tr>
<td>UTF-32</td>
<td>32</td>
</tr>
</tbody>
</table>
<p>Notice: although UTF-8 use the eight-unit <em>code unit</em>, but it doesn’t necessarily mean that each character is encoded as a single code unit. Actually, a character can be encoded as one or more than one <em>code units</em> in UTF-8.</p>
<p>For code unit including more thant 8 bits(byte), there is a problem named as <a href="http://en.wikipedia.org/wiki/Endianness" title="Endianness" target="_blank" rel="external">endian</a> (byte order). BE is big-endian, while LE is little-endian.</p>
<h1 id="Java-internal-string-representation"><a href="#Java-internal-string-representation" class="headerlink" title="Java internal string representation"></a>Java internal string representation</h1><p>Java uses UTF-16BE encoding as its internal representation.</p>
<blockquote>
<p>UTF-16 developed from an earlier fixed-width 16-bit encoding known as <strong>UCS-2</strong> (for 2-byte Universal Character Set) once it became clear that a fixed-width 2-byte encoding could not encode enough characters to be truly universal.</p>
<p>The encoding is <a href="http://en.wikipedia.org/wiki/Variable-width_encoding" title="Variable-width encoding" target="_blank" rel="external">variable-length</a>, as <a href="http://en.wikipedia.org/wiki/Code_point" title="Code point" target="_blank" rel="external">code points</a> are encoded with one or two 16-bit <em>code units</em>.<br>So, in Java:</p>
</blockquote>
<ul>
<li>a <em>code point</em> is a 32-bit <code>int</code> data type, where the lower 21 bits represent a valid code point value and the upper 11 bits are 0. (thus no negative code point)</li>
<li>a <em>code unit</em> is a 16-bit <code>char</code> value.<br>To express a Unicode character, the hexadecimal value is prefixed with the string U+.</li>
</ul>
<table>
<thead>
<tr>
<th>Character</th>
<th>Unicode Code Point</th>
<th>Glyph</th>
</tr>
</thead>
<tbody>
<tr>
<td>Latin A</td>
<td>U+0041</td>
<td><img src="https://docs.oracle.com/javase/tutorial/figures/i18n/000041.gif" alt="The Latin character A"></td>
</tr>
<tr>
<td>Latin sharp S</td>
<td>U+00DF</td>
<td><img src="https://docs.oracle.com/javase/tutorial/figures/i18n/0000df.gif" alt="The Latin small letter sharp S"></td>
</tr>
<tr>
<td>Han for East</td>
<td>U+6771</td>
<td><img src="https://docs.oracle.com/javase/tutorial/figures/i18n/006771.gif" alt="The Han character for east, eastern or eastward"></td>
</tr>
<tr>
<td>Deseret, LONG I</td>
<td>U+10400</td>
<td><img src="https://docs.oracle.com/javase/tutorial/figures/i18n/006771.gif" alt="The Han character for east, eastern or eastward"></td>
</tr>
</tbody>
</table>
<p>Characters that are in the range U+10000 to U+10FFFF are called supplementary characters. The set of characters from U+0000 to U+FFFF are sometimes referred to as the <em>Basic Multilingual Plane (BMP)</em>.</p>
<blockquote>
<p>U+10FFFF is the current upper limit of unicode defined code points.<br>Obviously, supplementary characters cannot be represented by a 16-bit <code>char.</code></p>
</blockquote>
<p>To support supplementary characters without changing the char primitive data type and causing incompatibility with previous Java programs, supplementary characters are defined by a pair of code point values that are called <em>surrogates</em>. The first code point is from the <em>high surrogates</em> range of <code>U+D800</code> to <code>U+DBFF</code>, and the second code point is from the <em>low surrogates</em> range of <code>U+DC00</code> to <code>U+DFFF</code>. You can simply think surogates ranges are the blocks reserved in BMP.</p>
<p><strong>Therefore, a unicode character can be represented by one <code>char</code> (BMP), or a surrogate pair (2 elements array of <code>char</code>).</strong></p>
<p>Until now, you shold be able to answer these questions:</p>
<ul>
<li>can any unicode character be represented by a Java char? No</li>
<li>how do we initialize a char exceeding BMP with char literals? No</li>
</ul>
<p>Simply, char ≠ unicode character</p>
<p><img src="/media/Character_encoding_and_charset_in_Java___Richard_Yang.png" alt="Character_encoding_and_charset_in_Java___Richard_Yang"><br>The table above shows some of the interesting things we have to look out for.</p>
<ol>
<li><p>Stored characters can take up an inconsistent number of bytes.<br>A UTF-8 encoded character might take between one (LATIN_CAPITAL_LETTER_A) and four (MATHEMATICAL_FRAKTUR_CAPITAL_G) bytes.<a href="http://en.wikipedia.org/wiki/Variable-width_encoding" target="_blank" rel="external">Variable width encoding</a> has implications for reading into and decoding from byte arrays.</p>
</li>
<li><p>Not all code points can be stored in a <code>char</code>.<br>The MATHEMATICAL_FRAKTUR_CAPITAL_G example lies in the supplementary range of characters and cannot be stored in 16 bits. It must be represented by two sequential <code>char</code> values, neither of which is meaningful by itself. The <a href="http://java.sun.com/javase/6/docs/api/java/lang/Character.html" target="_blank" rel="external">Character</a> class provides methods for working with 32-bit code points.</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Unicode code point to char array</span></div><div class="line"><span class="keyword">char</span>[] math_fraktur_cap_g = Character.toChars(<span class="number">0x1D50A</span>);</div></pre></td></tr></table></figure>
<ol>
<li>The relationship between the grapheme visible to the user and the code point type may not be 1:1.</li>
</ol>
<p>This can be seen in the combining character sequences (the e-acute example). As the Devenagari example shows, combining sequences can get quite complex.</p>
<p><img src="/media/java-utf-16be.png" alt="java-utf-16be"></p>
<h1 id="Character-and-String-API"><a href="#Character-and-String-API" class="headerlink" title="Character and String API"></a>Character and String API</h1><p><img src="/media/character-api.png" alt="character-api"></p>
<p><img src="/media/string-api.png" alt="string-api"></p>
<h2 id="How-long-is-a-string"><a href="#How-long-is-a-string" class="headerlink" title="How long is a string?"></a>How long is a string?</h2><ul>
<li><a href="http://java.sun.com/javase/6/docs/api/java/lang/String.html#length(" target="_blank" rel="external">String.length()</a>) returns the number of <code>char</code>s in the String. That’s also the number of code units.</li>
<li><a href="http://java.sun.com/javase/6/docs/api/java/lang/String.html#codePointCount(int,%20int" target="_blank" rel="external">String.codePointCount(int, int)</a>) returns the number of Unicode <strong>code points</strong> in the String.</li>
<li><a href="http://java.sun.com/javase/6/docs/api/java/text/BreakIterator.html#getCharacterInstance(java.util.Locale" target="_blank" rel="external">BreakIterator.getCharacterInstance()</a>) can be used to count the number of <strong>graphemes</strong> in a String.</li>
</ul>
<p><img src="/media/how-long-string.png" alt=""></p>
<h1 id="Play-with-charsets-and-encodings-in-Java"><a href="#Play-with-charsets-and-encodings-in-Java" class="headerlink" title="Play with charsets and encodings in Java"></a>Play with charsets and encodings in Java</h1><p>Here, the name of charset is misleading, actually it is defined as the combination of one or more coded character sets and a character-encoding scheme. If you are a serious programmer, you should read the Javadoc of class <code>Charset</code>.</p>
<p>Many non-unicode charsets are subsets of unicode, while others use completely different mapping between a character and its code point.</p>
<h2 id="Charset-CharsetEncoder-CharsetDecoder"><a href="#Charset-CharsetEncoder-CharsetDecoder" class="headerlink" title="Charset, CharsetEncoder/CharsetDecoder"></a>Charset, CharsetEncoder/CharsetDecoder</h2><p>Java provides a Charset class representing supported charset, by which we can encode Java string into bytes or decode bytes into Java String.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Charset.defaultCharset(); <span class="comment">// underlying OS encoding, you can modified it by System.setProperty("file.encoding", "your encoding here")</span></div></pre></td></tr></table></figure>
<blockquote>
<p>The “file.encoding” property is not required by the J2SE platform specification; it’s an internal detail of Sun’s implementations and should not be examined or modified by user code. It’s also intended to be read-only; it’s technically impossible to support the setting of this property to arbitrary values on the command line or at any other time during program execution.<br>Charset can get the CharsetEncoder and CharsetDecoder, by which you can control the entire encoding/decoding process.</p>
</blockquote>
<p>Charset.encode(..) and Charset.decode(..) are just the shortcut methods of using CharsetEncoder and CharsetDecoder.</p>
<p>Any place where you need to do byte-character conversion, you should specify the charset explicitly.</p>
<p>Some cases:</p>
<ul>
<li>String.getBytes()</li>
<li>Stream</li>
<li>file I/O</li>
</ul>
<h2 id="BOM-Byte-Order-Marker"><a href="#BOM-Byte-Order-Marker" class="headerlink" title="BOM (Byte Order Marker)"></a>BOM (Byte Order Marker)</h2><p>The code point for BOM is U+FEFF.</p>
<table>
<thead>
<tr>
<th>Charset</th>
<th>BOM byte sequence</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTF-8 ef</td>
<td>bb bf</td>
</tr>
<tr>
<td>UTF-16BE</td>
<td>fe ff</td>
</tr>
<tr>
<td>UTF-16LE</td>
<td>ff fe</td>
</tr>
<tr>
<td>UTF-32BE</td>
<td>00 00 fe ff</td>
</tr>
<tr>
<td>UTF-32LE</td>
<td>ff fe 00 00</td>
</tr>
</tbody>
</table>
<p><strong>Some encodings will automatically emit byte order marks on encode and read them on decode.</strong></p>
<p>let’s test which charset insert BOM automatically:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBOM</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Encode this to get bytes</span></div><div class="line">        <span class="keyword">final</span> String bomChar = <span class="string">"\u0041"</span>;</div><div class="line">        <span class="comment">// Unicode encodings</span></div><div class="line">        String[] unicodeEncodings = &#123;<span class="string">"UTF-16"</span>, <span class="string">"UTF-8"</span>, <span class="string">"UTF-16BE"</span>, <span class="string">"UTF-16LE"</span>, <span class="string">"UTF-32BE"</span>, <span class="string">"UTF-32LE"</span>&#125;;</div><div class="line">        <span class="comment">// Print the byte order marks</span></div><div class="line">        <span class="keyword">for</span> (String encName : unicodeEncodings) &#123;</div><div class="line">            Charset charset = Charset.forName(encName);</div><div class="line">            <span class="keyword">byte</span>[] byteOrderMark = bomChar.getBytes(charset);</div><div class="line">            System.out.format(<span class="string">"%10s encoding: "</span>, charset.toString());</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">byte</span> b : byteOrderMark) &#123;</div><div class="line">                System.out.format(<span class="string">"%02x "</span>, b);</div><div class="line">            &#125;</div><div class="line">            System.out.println();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>Output:<br>UTF-16 encoding: fe ff 00 41<br>UTF-8 encoding: 41<br>UTF-16BE encoding: 00 41<br>UTF-16LE encoding: 41 00<br>UTF-32BE encoding: 00 00 00 41<br>UTF-32LE encoding: 41 00 00 00</p>
<p>You can see, UTF-16 encoding scheme inserts the UTF-16BE BOM automatically, while others don’t.</p>
<p>UTF-16 is also called <em>UTF-16BE with BOM</em>.</p>
<h2 id="pitfalls-of-encoding-and-decoding-data-corruption"><a href="#pitfalls-of-encoding-and-decoding-data-corruption" class="headerlink" title="pitfalls of encoding and decoding - data corruption"></a>pitfalls of encoding and decoding - data corruption</h2><p>When decoding not on one go, the character may become corrupted as two halves.</p>
<p>When encoding incrementally, some problems may happen: the <code>UTF-16</code> encoding scheme used adds a byte order mark to encoded data. Every time a string is written, another BOM is added, littering the content with unwanted data. When the data is decoded, extra characters end up in the text. All text would need to be concatenated and encoded in one go.</p>
<h1 id="environments-and-boundaries-JVM-interacts-with"><a href="#environments-and-boundaries-JVM-interacts-with" class="headerlink" title="environments and boundaries JVM interacts with"></a>environments and boundaries JVM interacts with</h1><p>If all your code is just running in JVM, you are OK. Once your JVM starts to interact with outer environment through I/O or network, that’s the boundary place that character en/decoding will happen.</p>
<h2 id="OS-locale"><a href="#OS-locale" class="headerlink" title="OS locale"></a>OS locale</h2><p>A <strong>locale</strong> is a set of parameters that defines the user’s language, country and any special variant preferences that the user wants to see in their user interface. Usually a locale identifier consists of at least a language identifier and a region identifier.</p>
<p>In Unix, Linux or like, the locale identifier is defined in this format: <tt>[language[_territory][.codeset][@modifier]]</tt></p>
<p>The locale settings usually include the following display (output) format settings:</p>
<ul>
<li>Number format setting</li>
<li>Character classification, case conversion settings</li>
<li>Date-time format setting</li>
<li>String <a href="http://en.wikipedia.org/wiki/Collation" title="Collation" target="_blank" rel="external">collation</a> setting</li>
<li>Currency format setting</li>
<li>Paper size setting</li>
<li>other minor settings …<br>In Windows, ……</li>
</ul>
<p>//TODO</p>
<h2 id="File-encoding"><a href="#File-encoding" class="headerlink" title="File encoding"></a>File encoding</h2><p>We say file encoding meas its content’s encoding (if it’s a text file) or it’s regarded as a storage of binary bytes.</p>
<p>Actually, file has no knowledge about its content encoding. Some tools can guess the encoding.</p>
<p>When you store the file in an encoding, and then open to show or interpret it in another encoding, I’m sure you’ll be frustrated with the <a href="http://en.wikipedia.org/wiki/Mojibake" target="_blank" rel="external">Mojibake</a>.</p>
<h2 id="HTML-charset-with-meta"><a href="#HTML-charset-with-meta" class="headerlink" title="HTML charset with meta"></a>HTML charset with meta</h2><p>There are two ways to specify the charset using HTML meta tag:</p>
<ul>
<li><meta charset="“utf-8”"></li>
<li><meta http-equiv="“Content-Type”" content="“text/html;" charset="utf-8”"><br>These two are equivalent.</li>
</ul>
<h2 id="HTTP-charset-with-Content-Type"><a href="#HTTP-charset-with-Content-Type" class="headerlink" title="HTTP charset with Content-Type"></a>HTTP charset with Content-Type</h2><p>HTTP header Content-Type can be set as “text/html; charset=UTF-8”. This is an indicator for browsers. It tells browsers to render or interpret this response context as UTF-8 HTML text.</p>
<h2 id="Servlet-JSP"><a href="#Servlet-JSP" class="headerlink" title="Servlet/JSP"></a>Servlet/JSP</h2><p>You tell the browser what encoding you are using, and you also need your server to produce the response of that encoding, whatever static html file, dynamic JSP or in-memory response stream.</p>
<p>JSP uses the directive:<br><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">pageEncoding</span>=<span class="string">"GBK"</span> %&gt;</span></div></pre></td></tr></table></figure></p>
<p>This means that this file is edited and stored using GBK encoding, but the server resonse as UTF-8 encoding.</p>
<p>So the pageEncoding attribute is for JVM to read the JSP source file content when run-time compiling.</p>
<p><img src="/media/jsp-directive-encoding.png" alt="jsp-directive-encoding"></p>
<p>For input data, you can use</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div></pre></td></tr></table></figure>
<h2 id="database-codepage-collation"><a href="#database-codepage-collation" class="headerlink" title="database codepage/collation"></a>database codepage/collation</h2><h1 id="Some-useful-sites"><a href="#Some-useful-sites" class="headerlink" title="Some useful sites"></a>Some useful sites</h1><p><a href="https://codepoints.net" target="_blank" rel="external">https://codepoints.net</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/17/finally-execution-in-try-catch-finnally-blocks/" itemprop="url">
                  finally execution in try-catch-finnally blocks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-16T19:02:01+08:00" content="2015-03-16">
              2015-03-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Basics/" itemprop="url" rel="index">
                    <span itemprop="name">Basics</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/17/finally-execution-in-try-catch-finnally-blocks/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/17/finally-execution-in-try-catch-finnally-blocks/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>The finally block will always execute, except for System.exit() is called first, or the thread has terminated or the JVM crashes. Anything that is returned in the finally block will actually <strong><em>override</em></strong> any exception or returned value that is inside the try/catch block.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Finally</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//exception-free code, try-catch-finally blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try block throws exception, try-catch blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario2</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="comment">//return i;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try-catch blocks throw exception, try-catch-finally blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario3</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try block throws exception, try-catch-finally blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario4</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try-catch blocks throw exception, try-catch blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario5</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="comment">//return i;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try-catch-finally blocks throw exception, try-catch-finally blocks all have returns</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario6</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>/<span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="keyword">return</span> i/<span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try and catch both fine; finally throws exception</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario7</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="keyword">return</span> i/<span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//try and catch both fine; finally doesn't have any return</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">scenario8</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">try</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">100</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">catch</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">200</span>;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125; <span class="keyword">finally</span>&#123;</div><div class="line">            System.out.println(&amp;quot;Inside <span class="keyword">finally</span> block of testMethod!&amp;quot;);</div><div class="line">            i = <span class="number">300</span>;</div><div class="line">            <span class="comment">//return i;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPlayWithFinally</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(&amp;quot;\n-----------Senrio1------------------&amp;quot;);</div><div class="line">        System.out.println(&amp;quot;Return value: &amp;quot; + scenario1());</div><div class="line"></div><div class="line">        System.out.println(&amp;quot;\n-----------Senrio2------------------&amp;quot;);</div><div class="line">        System.out.println(&amp;quot;Return value: &amp;quot; + scenario2());</div><div class="line"></div><div class="line">        System.out.println(&amp;quot;\n-----------Senrio3------------------&amp;quot;);</div><div class="line">        System.out.println(&amp;quot;Return value: &amp;quot; + scenario3());</div><div class="line"></div><div class="line">        System.out.println(&amp;quot;\n-----------Senrio4------------------&amp;quot;);</div><div class="line">        System.out.println(&amp;quot;Return value: &amp;quot; + scenario4());</div><div class="line"></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;\n-----------Senrio5------------------&amp;quot;);</span></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;Return value: &amp;quot; + scenario5());</span></div><div class="line"></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;\n-----------Senrio6------------------&amp;quot;);</span></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;Return value: &amp;quot; + scenario6());</span></div><div class="line"></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;\n-----------Senrio7------------------&amp;quot;);</span></div><div class="line"><span class="comment">//        System.out.println(&amp;quot;Return value: &amp;quot; + scenario7());</span></div><div class="line"></div><div class="line">        System.out.println(&amp;quot;\n-----------Senrio8------------------&amp;quot;);</div><div class="line">        System.out.println(&amp;quot;Return value: &amp;quot; + scenario8());</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>/*<br>———–Senrio1——————<br>Inside try block of testMethod!<br>Inside finally block of testMethod!<br>Return value: 300</p>
<p>———–Senrio2——————<br>Inside try block of testMethod!<br>Inside catch block of testMethod!<br>Inside finally block of testMethod!<br>Return value: 200</p>
<p>———–Senrio3——————<br>Inside try block of testMethod!<br>Inside catch block of testMethod!<br>Inside finally block of testMethod!<br>Return value: 300</p>
<p>———–Senrio4——————<br>Inside try block of testMethod!<br>Inside catch block of testMethod!<br>Inside finally block of testMethod!<br>Return value: 300</p>
<p>———–Senrio5——————<br>Inside try block of testMethod!<br>Inside catch block of testMethod!<br>Inside finally block of testMethod!</p>
<p>java.lang.ArithmeticException: / by zero</p>
<p>———–Senrio6——————<br>Inside try block of testMethod!<br>Inside catch block of testMethod!<br>Inside finally block of testMethod!</p>
<p>java.lang.ArithmeticException: / by zero</p>
<p>———–Senrio7——————<br>Inside try block of testMethod!<br>Inside finally block of testMethod!</p>
<p>java.lang.ArithmeticException: / by zero</p>
<p>———–Senrio8——————<br>Inside try block of testMethod!<br>Inside finally block of testMethod!<br>Return value: 100<br>*/</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/15/apache-maven-2/" itemprop="url">
                  Apache Maven 2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-14T21:57:13+08:00" content="2015-03-14">
              2015-03-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Building-Testing-amp-CI/" itemprop="url" rel="index">
                    <span itemprop="name">Building, Testing &amp; CI</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/15/apache-maven-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/15/apache-maven-2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Although I have some experience about Maven 2, this is a simple summary.</p>
<blockquote>
<p><span style="color: #000080;">Maven  /ˈm<span style="color: #008000;">eɪ</span>v_ə_n/</span></p>
</blockquote>
<h3 id="Artifact-Vector"><a href="#Artifact-Vector" class="headerlink" title="Artifact Vector"></a>Artifact Vector</h3><blockquote>
<p>groupid:artifactid:packaging:version:scope<br>such as:<br>org.springframework:spring:jar:2.5.6:compile</p>
<p>org.mockito:mockito-core:jar:4.7:test<br>Maven provides the following standard scope:</p>
<table style="height: 291px;" border="1" width="745"><br><tbody><br><tr><br><td><em>Scope</em></td><br><td><em>Description</em></td><br></tr><br><tr><br><td>compile</td><br><td>Needed for compilation, included in packages.</td><br></tr><br><tr><br><td>test</td><br><td>Needed for unit tests, not included in packages.</td><br></tr><br><tr><br><td>provided</td><br><td>Needed for compilation, but provided at runtime by the runtime container.</td><br></tr><br><tr><br><td>system</td><br><td>Needed for compilation, given as absolute path on disk, and not included in<br>packages.</td><br></tr><br><tr><br><td>import</td><br><td>An inline inclusion of a POM-type artifact facilitating dependency-declaring<br>POM snippets.</td><br></tr><br></tbody><br></table>

</blockquote>
<h3 id="Lifecycles-Phases-Plugins-Goals"><a href="#Lifecycles-Phases-Plugins-Goals" class="headerlink" title="Lifecycles, Phases, Plugins, Goals"></a>Lifecycles, Phases, Plugins, Goals</h3><p><img src="/media/maven-lifecycle.png" alt="maven-lifecycle"><br><strong>Lifecycles</strong> represent a well-recognized flw of steps (Phases) used in software assembly.<br>Each step in a lifecycle flow is called a <strong>phase</strong>. Zero or more plugin goals are bound to a phase.<br>A <strong>plugin</strong> is a logical grouping and distribution (often a single JAR) of related goals, such as JARing.<br>A <strong>goal</strong>, the most granular step in Maven, is a single executable task within a plugin. For example, discrete goals in the jar plugin include packaging the jar (jar:jar), signing the jar (jar:sign), and verifying the signature (jar:sign-verify).</p>
<h3 id="Built-in-lifecycles"><a href="#Built-in-lifecycles" class="headerlink" title="Built-in lifecycles"></a>Built-in lifecycles</h3><p>Maven provides 3 built-in lifecycles: clean, default, site.</p>
<p>The following lists all build phases and its default goals bound to them.</p>
<p><strong>Clean Lifecycle</strong></p>
<table class="bodyTable" border="1"><br><tbody><br><tr><br><td align="left"><strong><span style="color: #333333;">Phrase</span></strong></td><br><td align="left"><strong><span style="color: #333333;">Default goal bindings</span></strong></td><br><td align="left"><strong><span style="color: #333333;">Phase description</span></strong></td><br></tr><br><tr><br><td align="left"><tt>pre-clean</tt></td><br><td align="left"></td><br><td align="left">executes processes needed prior to the actual project cleaning</td><br></tr><br><tr><br><td align="left"><tt>clean</tt></td><br><td align="left">maven-clean-plugin:clean</td><br><td align="left">remove all files generated by the previous build</td><br></tr><br><tr><br><td align="left"><tt>post-clean</tt></td><br><td align="left"></td><br><td align="left">executes processes needed to finalize the project cleaning</td><br></tr><br></tbody><br></table><br><strong>Default Lifecycle</strong><br><table style="font-size: 0.8em;" border="1"><br><tbody><br><tr><br><td rowspan="2" align="left"><strong><span style="color: #333333;">Phase</span></strong></td><br><td style="text-align: center;" colspan="4" align="left"><strong><span style="color: #333333;">Default goal bindings</span></strong></td><br><td rowspan="2" align="left"><strong><span style="color: #333333;">Phase description</span></strong></td><br></tr><br><tr><br><td align="left"><strong>packaging ejb/ejb3/jar/par/rar/war</strong></td><br><td align="left"><strong>packaging ear</strong></td><br><td align="left"><strong>packaging maven-plugin</strong></td><br><td align="left"><strong>packing pom</strong></td><br></tr><br><tr><br><td align="left"><tt>validate</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">validate the project is correct and all necessary information is available.</td><br></tr><br><tr><br><td align="left"><tt>initialize</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">initialize build state, e.g. set properties or create directories.</td><br></tr><br><tr><br><td align="left"><tt>generate-sources</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">generate any source code for inclusion in compilation.</td><br></tr><br><tr><br><td align="left"><tt>process-sources</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">process the source code, for example to filter any values.</td><br></tr><br><tr><br><td align="left"><tt>generate-resources</tt></td><br><td align="left"></td><br><td align="left">maven-ear-plugin:generate-application-xml</td><br><td align="left">maven-plugin-plugin:descriptor</td><br><td align="left"></td><br><td align="left">generate resources for inclusion in the package.</td><br></tr><br><tr><br><td align="left"><tt>process-resources</tt></td><br><td align="left">maven-resources-plugin:resources</td><br><td align="left">maven-resources-plugin:resources</td><br><td align="left">maven-resources-plugin:resources</td><br><td align="left"></td><br><td align="left">copy and process the resources into the destination directory, ready for packaging.</td><br></tr><br><tr><br><td align="left"><tt>compile</tt></td><br><td align="left">maven-compiler-plugin:compile</td><br><td align="left"></td><br><td align="left">maven-compiler-plugin:compile</td><br><td align="left"></td><br><td align="left">compile the source code of the project.</td><br></tr><br><tr><br><td align="left"><tt>process-classes</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">post-process the generated files from compilation, for example to do bytecode enhancement on Java classes.</td><br></tr><br><tr><br><td align="left"><tt>generate-test-sources</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">generate any test source code for inclusion in compilation.</td><br></tr><br><tr><br><td align="left"><tt>process-test-sources</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">process the test source code, for example to filter any values.</td><br></tr><br><tr><br><td align="left"><tt>generate-test-resources</tt></td><br><td align="left">maven-resources-plugin:testResources</td><br><td align="left"></td><br><td align="left">maven-resources-plugin:testResources</td><br><td align="left"></td><br><td align="left">create resources for testing.</td><br></tr><br><tr><br><td align="left"><tt>process-test-resources</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">copy and process the resources into the test destination directory.</td><br></tr><br><tr><br><td align="left"><tt>test-compile</tt></td><br><td align="left">maven-compiler-plugin:testCompile</td><br><td align="left"></td><br><td align="left">maven-compiler-plugin:testCompile</td><br><td align="left"></td><br><td align="left">compile the test source code into the test destination directory</td><br></tr><br><tr><br><td align="left"><tt>process-test-classes</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">post-process the generated files from test compilation, for example to do bytecode enhancement on Java classes. For Maven 2.0.5 and above.</td><br></tr><br><tr><br><td align="left"><tt>test</tt></td><br><td align="left">maven-surefire-plugin:test</td><br><td align="left"></td><br><td align="left">maven-surefire-plugin:test</td><br><td align="left"></td><br><td align="left">run tests using a suitable unit testing framework. These tests should not require the code be packaged or deployed.</td><br></tr><br><tr><br><td align="left"><tt>prepare-package</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">perform any operations necessary to prepare a package before the actual packaging. This often results in an unpacked, processed version of the package. (Maven 2.1 and above)</td><br></tr><br><tr><br><td align="left"><tt>package</tt></td><br><td align="left">maven-ejb-plugin:ejb /<br>maven-ejb3-plugin:ejb3 /<br>maven-jar-plugin:jar /<br>maven-par-plugin:par /<br>maven-rar-plugin:rar /<br>maven-war-plugin:war</td><br><td align="left">maven-ear-plugin:ear</td><br><td align="left">maven-jar-plugin:jar<br>maven-plugin-plugin:addPluginArtifact<br>Metadata</td><br><td align="left">maven-site-plugin:attach-descriptor</td><br><td align="left">take the compiled code and package it in its distributable format, such as a JAR.</td><br></tr><br><tr><br><td align="left"><tt>pre-integration-test</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">perform actions required before integration tests are executed. This may involve things such as setting up the required environment.</td><br></tr><br><tr><br><td align="left"><tt>integration-test</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">process and deploy the package if necessary into an environment where integration tests can be run.</td><br></tr><br><tr><br><td align="left"><tt>post-integration-test</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">perform actions required after integration tests have been executed. This may including cleaning up the environment.</td><br></tr><br><tr><br><td align="left"><tt>verify</tt></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left"></td><br><td align="left">run any checks to verify the package is valid and meets quality criteria.</td><br></tr><br><tr><br><td align="left"><tt>install</tt></td><br><td align="left">maven-install-plugin:install</td><br><td align="left">maven-install-plugin:install</td><br><td align="left">maven-install-plugin:install</td><br><td align="left">maven-install-plugin:install</td><br><td align="left">install the package into the local repository, for use as a dependency in other projects locally.</td><br></tr><br><tr><br><td align="left"><tt>deploy</tt></td><br><td align="left">maven-deploy-plugin:deploy</td><br><td align="left">maven-deploy-plugin:deploy</td><br><td align="left">maven-deploy-plugin:deploy</td><br><td align="left">maven-deploy-plugin:deploy</td><br><td align="left">done in an integration or release environment, copies the final package to the remote repository for sharing with other developers and projects.</td><br></tr><br></tbody><br></table><br><strong>Site Lifecycle</strong><br><table class="bodyTable" border="1"><br><tbody><br><tr class="a"><br><td align="left"><span style="color: #333333;"><strong>Phase</strong></span></td><br><td align="left"><span style="color: #333333;"><strong>Default goal bindings</strong></span></td><br><td align="left"><span style="color: #333333;"><strong>Phase description</strong></span></td><br></tr><br><tr class="a"><br><td align="left">pre-site</td><br><td align="left"></td><br><td align="left">executes processes needed prior to the actual project site generation</td><br></tr><br><tr class="b"><br><td align="left">site</td><br><td align="left">maven-site-plugin:site</td><br><td align="left">generates the project’s site documentation</td><br></tr><br><tr class="a"><br><td align="left">post-site</td><br><td align="left"></td><br><td align="left">executes processes needed to finalize the site generation, and to prepare for site deployment</td><br></tr><br><tr class="b"><br><td align="left">site-deploy</td><br><td align="left">maven-site-plugin:deploy</td><br><td align="left">deploys the generated site documentation to the specified web server</td><br></tr><br></tbody><br></table>

<h3 id="Project-packaging"><a href="#Project-packaging" class="headerlink" title="Project packaging"></a>Project packaging</h3><p>we set the packaging for your project via the equally named POM element <tt>&lt;packaging&gt;</tt>. Some of the valid packaging values are <tt>jar</tt>, <tt>war</tt>, <tt>ear</tt> and <tt>pom</tt>. If no packaging value has been specified, it will default to <tt>jar</tt>.</p>
<h3 id="Phase-and-goal-binding"><a href="#Phase-and-goal-binding" class="headerlink" title="Phase and goal binding"></a>Phase and goal binding</h3><p>A goal may be bound to zero or more build phases. A goal not bound to any build phase could be executed outside of the build lifecycle by direct invocation.</p>
<p>Moreover, if a goal is bound to one or more build phases, that goal will be called in all those phases.</p>
<p>Furthermore, a build phase can also have zero or more goals bound to it. If a build phase has no goals bound to it, that build phase will not execute.</p>
<p>Usually, plugin bind its goals on default phases. That’s defined on plugin jar’s MATE-INF/maven/plugin.xml.</p>
<p>Let’s see the plugin.xml of maven-compiler-plugin.jar:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&amp;lt;plugin&amp;gt;</div><div class="line">  &amp;lt;mojos&amp;gt;</div><div class="line">    &amp;lt;mojo&amp;gt;</div><div class="line">      &amp;lt;goal&amp;gt;compile&amp;lt;/goal&amp;gt;</div><div class="line">      ....</div><div class="line">      &amp;lt;phase&amp;gt;compile&amp;lt;/phase&amp;gt;</div><div class="line">      ....</div><div class="line">    &amp;lt;/mojo&amp;gt;</div><div class="line">    &amp;lt;mojo&amp;gt;</div><div class="line">      &amp;lt;goal&amp;gt;help&amp;lt;/goal&amp;gt;</div><div class="line">      ....</div><div class="line">    &amp;lt;/mojo&amp;gt;</div><div class="line">    &amp;lt;mojo&amp;gt;</div><div class="line">      &amp;lt;goal&amp;gt;testCompile&amp;lt;/goal&amp;gt;</div><div class="line">      ....</div><div class="line">      &amp;lt;phase&amp;gt;test-compile&amp;lt;/phase&amp;gt;</div><div class="line">      ....</div><div class="line">    &amp;lt;/mojo&amp;gt;</div><div class="line">  &amp;lt;/mojos&amp;gt;</div><div class="line">&amp;lt;/plugin&amp;gt;</div></pre></td></tr></table></figure></p>
<p>maven-compiler-plugin defines 3 goals, and “compile” and “testCompiler” goals have the default phase, but “help” goal not.</p>
<p>&nbsp;</p>
<p>But a goal can be bound on different phases which can be reconfigured by plugin configuration section.<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">...</div><div class="line"> &amp;lt;plugin&amp;gt;</div><div class="line">   &amp;lt;groupId&amp;gt;com.mycompany.example&amp;lt;/groupId&amp;gt;</div><div class="line">   &amp;lt;artifactId&amp;gt;display-maven-plugin&amp;lt;/artifactId&amp;gt;</div><div class="line">   &amp;lt;version&amp;gt;<span class="number">1.0</span>&amp;lt;/version&amp;gt;</div><div class="line">   &amp;lt;executions&amp;gt;</div><div class="line">     &amp;lt;execution&amp;gt;</div><div class="line">       &amp;lt;phase&amp;gt;process-test-resources&amp;lt;/phase&amp;gt;</div><div class="line">       &amp;lt;goals&amp;gt;</div><div class="line">         &amp;lt;goal&amp;gt;time&amp;lt;/goal&amp;gt;</div><div class="line">       &amp;lt;/goals&amp;gt;</div><div class="line">     &amp;lt;/execution&amp;gt;</div><div class="line">     &amp;lt;execution&amp;gt;</div><div class="line">       &amp;lt;phase&amp;gt;process-resources&amp;lt;/phase&amp;gt;</div><div class="line">       &amp;lt;goals&amp;gt;</div><div class="line">         &amp;lt;goal&amp;gt;anotherGoal&amp;lt;/goal&amp;gt;</div><div class="line">         &amp;lt;goal&amp;gt;anotherGoalAgain&amp;lt;/goal&amp;gt;</div><div class="line">       &amp;lt;/goals&amp;gt;</div><div class="line">     &amp;lt;/execution&amp;gt;</div><div class="line">   &amp;lt;/executions&amp;gt;</div><div class="line"> &amp;lt;/plugin&amp;gt;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h4 id="Default-goal"><a href="#Default-goal" class="headerlink" title="Default goal"></a>Default goal</h4><p>The default goal codifis the author’s intended usage of the build script. Only one goal or lifecycle can be set as the<br>default.<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&amp;lt;project&amp;gt;</div><div class="line"> [...]</div><div class="line"> &amp;lt;build&amp;gt;</div><div class="line"> &amp;lt;defaultGoal&amp;gt;install&amp;lt;/defaultGoal&amp;gt;</div><div class="line"> &amp;lt;/build&amp;gt;</div><div class="line"> [...]</div><div class="line">&amp;lt;/project&amp;gt;</div></pre></td></tr></table></figure></p>
<h3 id="Execute-a-Phase-or-Goal"><a href="#Execute-a-Phase-or-Goal" class="headerlink" title="Execute a Phase or Goal"></a>Execute a Phase or Goal</h3><p>If you ask Maven to run a specific goal, then only that goal is run.</p>
<p>For org.apache.maven:maven-<em>*</em>-plugin, you can run it using the plugin-prefix for short.</p>
<blockquote>
<p>mvn &lt;plugin-prefix&gt;:&lt;goal&gt;<br>or</p>
</blockquote>
<p>For your customized plugins, run it:</p>
<blockquote>
<p>mvn &lt;plugin-group-id&gt;:&lt;plugin-artifact-id&gt;[:&lt;plugin-version&gt;]:&lt;goal&gt;<br>For example:<br>mvn compiler:compile  jar:jar<br>This example runs two plugin goals: compilation of code, then JARing the result, skipping over any intermediate steps.</p>
</blockquote>
<p>mvn &lt;phase-name&gt;</p>
<p>Conversely, if you ask Maven to execute a phase, all phases and bound plugin goals up to that point in the lifecycle are also executed. This example requests the deploy lifecycle phase, which will also execute the verifiation, compilation, testing and packaging phases.</p>
<blockquote>
<p>mvn deploy</p>
</blockquote>
<h3 id="Profiles"><a href="#Profiles" class="headerlink" title="Profiles"></a>Profiles</h3><p>Profies are a means to conditionally turn on portions of Maven confiuration, including plugins, pathing and confiuration.<br>The most common uses of profies are for Windows/Unix platform-specifi variations and build-time customization of JAR dependencies based on the use of a specifi Weblogic, Websphere or JBoss J2EE vendor.<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&amp;lt;project&amp;gt;</div><div class="line"> ...</div><div class="line"> &amp;lt;profiles&amp;gt;</div><div class="line"> &amp;lt;profile&amp;gt;</div><div class="line"> &amp;lt;id&amp;gt;YourProfile&amp;lt;/id&amp;gt;</div><div class="line"> ...settings, build, plugins etc...</div><div class="line"> &amp;lt;dependencies&amp;gt;</div><div class="line"> &amp;lt;dependency&amp;gt;</div><div class="line"> &amp;lt;groupId&amp;gt;com.yourcompany&amp;lt;/groupId&amp;gt;</div><div class="line"> &amp;lt;artifactId&amp;gt;yourlib&amp;lt;/artifactId&amp;gt;</div><div class="line"> &amp;lt;/dependency&amp;gt;</div><div class="line"> &amp;lt;dependencies&amp;gt;</div><div class="line"> &amp;lt;/profile&amp;gt;</div><div class="line"> &amp;lt;/profiles&amp;gt;</div><div class="line"> ...</div><div class="line">&amp;lt;/project&amp;gt;</div></pre></td></tr></table></figure></p>
<h4 id="Profile-activation"><a href="#Profile-activation" class="headerlink" title="Profile activation"></a>Profile activation</h4><p>Profiles can be activated manually from the command line or through an activation rule (OS, fie existence, Maven version, etc.).</p>
<p>Profiles are primarily additive, so best practices suggest leaving most off by default, and activating based on specific conditions.</p>
<p><em><strong>Manual Profie Activation</strong></em></p>
<blockquote>
<p>mvn –P YourProfie<br><em><strong>Automatic Profie Activation</strong></em><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&amp;lt;project&amp;gt;</div><div class="line"> ...</div><div class="line"> &amp;lt;profiles&amp;gt;</div><div class="line"> &amp;lt;profile&amp;gt;</div><div class="line"> &amp;lt;id&amp;gt;YourProfile&amp;lt;/id&amp;gt;</div><div class="line"> ...settings, build, etc...</div><div class="line"> &amp;lt;activation&amp;gt;</div><div class="line"> &amp;lt;os&amp;gt;</div><div class="line"> &amp;lt;name&amp;gt;Windows XP&amp;lt;/name&amp;gt;</div><div class="line"> &amp;lt;family&amp;gt;Windows&amp;lt;/family&amp;gt;</div><div class="line"> &amp;lt;arch&amp;gt;x86&amp;lt;/arch&amp;gt;</div><div class="line"> &amp;lt;version&amp;gt;<span class="number">5.1</span>.2600&amp;lt;/version&amp;gt;</div><div class="line"> &amp;lt;/os&amp;gt;</div><div class="line"> &amp;lt;fie&amp;gt;</div><div class="line"> &amp;lt;missing&amp;gt;somefolder/somefie.txt&amp;lt;/missing&amp;gt;</div><div class="line"> &amp;lt;/fie&amp;gt;</div><div class="line"> &amp;lt;/activation&amp;gt;</div><div class="line"> &amp;lt;/profile&amp;gt;</div><div class="line"> &amp;lt;/profiles&amp;gt;</div><div class="line"> ...</div><div class="line">&amp;lt;/project&amp;gt;</div></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/13/core-java-concurrency/" itemprop="url">
                  Core Java Concurrency
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-13T04:59:28+08:00" content="2015-03-13">
              2015-03-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Multithreading/" itemprop="url" rel="index">
                    <span itemprop="name">Multithreading</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/13/core-java-concurrency/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/13/core-java-concurrency/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="A-birdview-of-core-java-concurrency"><a href="#A-birdview-of-core-java-concurrency" class="headerlink" title="A birdview of core java concurrency"></a>A birdview of core java concurrency</h3><p><img src="/media/core-java-concurrency.png" alt="core-java-concurrency"></p>
<h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h3><div><img src="/media/table1.png" alt="table1"></div>

<h3 id="Procting-shared-data"><a href="#Procting-shared-data" class="headerlink" title="Procting shared data"></a>Procting shared data</h3><div>Java provides Lock-based concurrency control machanism. Locking <strong><span style="text-decoration: underline;">establishes the orderings</span></strong> needed to satisfy the Java Memory Model and <strong><span style="text-decoration: underline;">guarantee the visibility</span></strong> of changes to other threads.</div><br><div><br><br>#### Synchronized<br><br><div><br><br>Every object instance has a monitor that can be locked by one thread at a time. The _synchronized _keyword can be specifid on a method or in block form to lock the monitor. Modifying a field while synchronized on an object guarantees that subsequent reads from any other thread synchronized on the same object will see the updated value. It is important to note that writes outside synchronization or synchronized on a different object than the read are not necessarily ever visible to other threads.<br><div>The <em>synchronized</em> keyword can be specified on a method or in block form on a particular object instance. If specified on a non-static method, the <em>this</em> reference is used as the instance. In a synchronized static method, the Class defining the method is used as the instance.</div>

<h4 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h4><div>The java.util.concurrent.locks package has a standard Lock interface. The ReentrantLock implementation duplicates the functionality of the synchronized keyword but also provides additional functionality such as obtaining information about the state of the lock, non-blocking tryLock(), and interruptible locking.</div><br><div></div><br><div>Example of using a explicit ReentrantLock instance:</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ++value;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div>

<h4 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h4><div>The java.util.concurrent.locks package also contains a ReadWriteLock interface (and ReentrantReadWriteLock implementation) which is defined by a pair of locks for reading and writing, typically allowing multiple concurrent readers but only one writer. Example of using an explicit ReentrantReadWriteLock to allow multiple concurrent readers:</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">statistic</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.writeLock().lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            value++;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.writeLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">current</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.readLock().lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> value;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.readLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div>

<h4 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h4><div>The volatile modifier can be used to mark a field and indicate that changes to that field must be seen by all subsequent reads by other threads, regardless of synchronization. Thus, volatile provides visibility just like synchronization but scoped only to each read or write of the field. Before Java SE 5, the implementation of volatile was inconsitent between JVM implementations and architectures and could not be relied upon. The Java Memory Model now explicitly defines volatile’s behavior.</div><br><div></div><br><div>An example of using volatile as a signaling flag:</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="title">implments</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopProcessing</span><span class="params">()</span> </span>&#123;</div><div class="line">        stop = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span>(!stop) &#123;</div><div class="line">            <span class="comment">//.. do processing</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div><br><div>Hot Tip: Marking an array as volatile does not make entries in the array volatile! In this case volatile applies only to the array reference itself. Instead, use a class like AtomicIntegerArray to create an array with volatile-like entries.</div>

<h4 id="Atomic-classes"><a href="#Atomic-classes" class="headerlink" title="Atomic classes"></a>Atomic classes</h4><div>One shorcoming of volatile is that while it provides visibility guarantees, you cannot both check and update a volatile field in a single atomic call. The java.util.concurrent.atomic package contains a set of classes that support atomic compound actions on a single value in a lock-free manner similar to volatile.</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> AtomicInteger value = <span class="keyword">new</span> AtomicInteger();</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value.incrementAndGet();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>Atomic classes are provided for booleans, integers, longs and object references as well as arrays of integers, longs, and object references.<br><br></div><br><div></div>

<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h4><div>One way to contain data within a thread and make locking unnecessary is to use ThreadLocal storage. Conceptually a ThreadLocal acts as if there is a variable with its own version in every Thread. ThreadLocals are commonly used for stashing per-Thread values like the “current transaction” or other resources. Also, they are used to maintain per-thread counters, statistics, or ID generators.</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&amp;lt;Transaction&amp;gt; currentTransaction = <span class="keyword">new</span> ThreadLocal&amp;lt;Transaction&amp;gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Transaction <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NullTransactin();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">currentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">        Transaction current = currentTransaction.get();</div><div class="line">        <span class="keyword">if</span>(current.isNull()) &#123;</div><div class="line">            current = <span class="keyword">new</span> TransactionImpl();</div><div class="line">            currentTransaction.put(current);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> current;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div>

<h3 id="Concurrent-collections"><a href="#Concurrent-collections" class="headerlink" title="Concurrent collections"></a>Concurrent collections</h3><div>A key technique for properly protecting shared data is to encapsulate the synchronization mechanism with the calss holding the data.</div><br><div>You can regard all plain objects as containers of its fields(data), but to get them thread-safe, you have to implement them one by one cautiously and seriously.</div><br><div>Collections are the container facilities Java provides for holding data and we use nearly everywhere.</div><br><div>This technique makes it impossible to improperly access the data as all usage must conform to the synchronization protocol. The java.util.concurrent package holds many data structures designed for concurrent use. Generally, the use of these data structures yields far better performance than using a synchronized wrapper around an unsynchronized collection.</div><br><div></div>

<h4 id="Concurrent-lists-and-sets"><a href="#Concurrent-lists-and-sets" class="headerlink" title="Concurrent lists and sets"></a>Concurrent lists and sets</h4><div> <img src="/media/table-concurrent-lists-sets.png" alt="table-concurrent-lists-sets"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/5a59455f-283a-4866-8f6b-3dc0c08f7c6a.png" alt=""></div>

<h4 id="Concurrent-maps"><a href="#Concurrent-maps" class="headerlink" title="Concurrent maps"></a>Concurrent maps</h4><div>The java.util.concurrent package contains an extension to the Map interface called ConcurrentMap, which provides some extra methods described in following table. All of these methods perform a set of actions in the scope of a single atomic action. Performing this set of actions outside the map would introduce race conditions due to making multiple (non-atomic) calls on the map.</div><br><div></div><br><div><img src="/media/table-concurrent-map-methods.png" alt="table-concurrent-map-methods"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/289ebe3f-9f50-4c78-bff7-2d9f1fbc287a.png" alt=""></div><br><div>There are two ConcurrentMap implementations available as shown in following table.</div><br><div><img src="/media/table-concurrent-map.png" alt="table-concurrent-map"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/5a4f4218-f143-409f-a1c0-98c707b9dcaa.png" alt=""></div><br></div>

<h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h4><div>Queues act as pipes between “producers” and “consumers”.Items are put in one end of the pipe and emerge from the other end of the pipe in the same “fist-in fist-out” (FIFO) order.<br>The Queue interface was added to java.util in Java SE 5 and while it can be used in single-threaded scenarios, it is primarily used with multiple producers or one or more consumers, all writing and reading from the same queue.<br>The BlockingQueue interface is in java.util.concurrent and extends Queue to provide additional choices of how to handle the scenario where a queue may be full (when a producer adds an item) or empty (when a consumer reads or removes an item).<br>In these cases, BlockingQueue provides methods that either block forever or block for a specifid time period, waiting for the condition to change due to the actions of another thread.<br>The following table demonstrates the Queue and BlockingQueue methods in terms of key operations and the strategy for dealing with these special conditions.</div><br><div><img src="/media/table-concurrent-queue-methods.png" alt="table-concurrent-queue-methods"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/b374c6dd-f4ae-4fe3-96fb-80233b3e1299.png" alt=""></div><br><div>Several Queue implementations are provided by the JDK and their relationships are discribed in the following table.</div><br><img src="/media/table-concurrent-queue.png" alt="table-concurrent-queue"><br><br>#### Deques<br><br><div>A double-ended queue or Deque (pronounced “deck”) was added in Java SE 6. Deques support not just adding from one end and removing from the other but adding and removing items from both ends. Similarly to BlockingQueue, there is a<br>BlockingDeque interface that provides methods for blocking and timeout in the case of special conditions. Table 7 shows the Deque and BlockingDeque methods. Because Deque extends Queue and BlockingDeque extends lockingQueue, all of those methods are also available for use.<br><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/307ab1f8-64da-4916-a6a7-ef6b431af845.png" alt=""><img src="/media/table-concurrent-deu-methods.png" alt="table-concurrent-deu-methods"></div><br><div>One special use case for a Deque is when add, remove, and examine operations all take place on only one end of the pipe. This special case is just a stack (fist-in-last-out retrieval order). The Deque interface actually provides methods that use the terminology of a stack: push() , pop() , and peek() . These methods map to addFirst() , removeFirst() , and peekFirst() methods in the Deque interface and allow you to use any Deque implementation as a stack. Table 8 describes the Deque and BlockingDeque implementations in the JDK. Note that Deque extends Queue and BlockingDeque extends BlockingQueue.</div><br><div><br><div><img src="/media/table-concurrent-deque.png" alt="table-concurrent-deque"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/31906fc7-031c-4660-89d5-406daac22202.png" alt=""></div>

<h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h3><p></p></div><p></p>
<div>In Java, the java.lang.Thread class is used to represent an application or JVM thread. Code is always being executed in the context of some Thread class (use Thread.currentThread() to obtain your own Thread).</div>

<h4 id="Thread-interference"><a href="#Thread-interference" class="headerlink" title="Thread interference"></a>Thread interference</h4><div>The most obvious way to communicate between threads is for one thread to directly call a method on another Thread object. Table 9 shows methods on Thread that can be used for direct interaction across threads.</div><br><div><img src="/media/table-concurrent-thread.png" alt="table-concurrent-thread"></div><br><div></div><br><div><img src="/media/thread-inference.png" alt="thread-inference"></div><br>&gt; <div>NOTE: In current Thread implementation, suspend(), resume(), stop() are all deprecated. I guess there is a principle here: <em><strong>once started until destroyed, thread SHOULD determine its own life, except that it’s willing proactively to response the external interference: interruption, or some flag-base mechanics.</strong></em></div><br>&gt;<br>&gt; <div>So sleep(), yield(), join() are all for the current thread itself instead of controlling others.</div><br><div></div><br><div>Interruptible points are some points that can be interrupted or intend to accept interruption signal.</div><br><div>There are two ways to response interruption:</div><br>1)  some methods are interruptible. These method can throw InterruptedException, such as wait(), await() of CyclicBarrier and CountdownLatch, acquire() of Semophore<br><br>2)  some plain codes intend to handle interruption signal by using Thread.interrupted() to test interruption mark.<br><div></div><br><div>In current thread, the running code can do some actions to influence the current thread by sleep() or yield().</div><br><div><img src="/media/thread-current-context.png" alt="thread-current-context"><img src="file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/159e3222-f1a3-4ba4-806e-a79d29896d45.png" alt=""></div>

<h4 id="Uncaught-exception-handling"><a href="#Uncaught-exception-handling" class="headerlink" title="Uncaught exception handling"></a>Uncaught exception handling</h4><div>Threads can specify an UncaughtExceptionHandler that will receive notifiation of any uncaught exception that cause a thread to abruptly terminate.</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Thread t = <span class="keyword">new</span> Thread(runnable);</div><div class="line">t.setUncaughtExceptionHandler(<span class="keyword">new</span> Therad.UncaughtExceptionHandler() &#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</div><div class="line">        <span class="comment">// get Logger and log uncaught exception</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">t.start();</div></pre></td></tr></table></figure><br><br></div>

<h4 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h4><div>A deadlock occurs when there is more than one thread, each waiting for a resource held by another, such that a cycle of resources and acquiring threads is formed. The most obvious kind of resource is an object monitor but any resource that causes blocking (such as wait / notify) can qualify.</div><br><div>Many recent JVMs can detect monitor deadlocks and will print deadlock information in thread dumps produced from a signal, jstack, or other thread dump tool.</div><br><div>In addition to deadlock, some other threading situations are starvation and livelock. Starvation occurs when threads hold a lock for long periods such that some threads “starve” without making progress. Livelock occurs when threads spend all of their time negotiating access to a resource or detecting and avoiding deadlock such that no thread actually makes<br>progress.<br><br>### Thread coordination<br><br></div>

<h4 id="wait-notify"><a href="#wait-notify" class="headerlink" title="wait / notify"></a>wait / notify</h4><div>The wait / notify idiom is appropriate whenever one thread needs to signal to another that a condition has been met, especially as an alternative to sleeping in a loop and polling the condition. For example, one thread might wait for a queue to contain an item to process. Another thread can signal the waiting threads when an item is added to the queue.<br>The canonical usage pattern for wait and notify is as follows:</div><br><div><br><div></div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Latch</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitTillChange</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">while</span>(! flag) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    lock.wait();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="number">0</span> &#123;</span></span></div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            flag = <span class="keyword">true</span>;</div><div class="line">            lock.notifyAll();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>Some important things to note about this code:<br><br></div><br><div>• Always call wait, notify, and notifyAll inside a synchronized lock or an IllegalMonitorStateException will be thrown.<br>• Always wait inside a loop that checks the condition being waited on – this addresses the timing issue if another thread satisfis the condition before the wait begins. Also, it protects your code from spurious wake-ups that can (and do) occur.<br>• Always ensure that you satisfy the waiting condition before calling notify or notifyAll. Failing to do so will cause a notifiation but no thread will ever be able to escape its wait loop.</div>

<h4 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h4><p></p></div><p></p>
<div>In Java SE 5, a new java.util.concurrent.locks.Condition class was added. Condition implements the wait/notify semantics in an API but with several additional features such as the ability to create multiple Conditions per Lock, interruptible waiting, access to statistics, etc. Conditions are obtained from a Lock instance as follows:</div><br><div><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LatchCondition</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition condition = lock.newCondition();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitTillChange</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span>(! flag) &#123;</div><div class="line">                condition.await();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            flag = <span class="keyword">true</span>;</div><div class="line">            condition.signalAll();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div>

<h4 id="Coordination-classes"><a href="#Coordination-classes" class="headerlink" title="Coordination classes"></a>Coordination classes</h4><div>The java.util.concurrent package contains several classes pre-built for common forms of multi-thread communication. These coordination classes cover most common scenarios where wait/notify and Condition might be used and are strongly perferred for their safety and ease of use.<br><strong>CyclicBarrier</strong><br>The CyclicBarrier is initialized with a participant count. Participants call await() and block until the count is reached, at which point an optional barrier task is executed by the last arriving thread, and all threads are released. The barrier can be reused indefiitely. Used to coordinate the start and stop of groups of threads.</div><br><div>字面意思循环挡板，通过它可以实现让一组线程等待至某个状态之后再全部同时执行。称为循环是因为当所有等待线程都被释放以后，CyclicBarrier可以被重用<br>Allows N-1 treads to wait on await() method until N-th thread calls await() method and then they resume their execution.<br><div class="separator"><img src="/media/CyclicBarrier.png" alt="CyclicBarrier"></div><br>As this illustration shows there is a barrier for 3 parties. When T1 and T2 come they wait. When T3 comes an optional TA handler is called and (after it completes?) T1,2,3 resume their work. You can reuse CyclicBarrier many times by calling reset() method.<br><br>And the code example:<br><div class="dp-highlighter"><br><div class="bar"><br><div class="tools"><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> CyclicBarrier cb = <span class="keyword">new</span> CyclicBarrier(N);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &amp;lt; N; i++) &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> idx = i;</div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"T"</span> + idx + <span class="string">": await"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                cb.await();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">                System.out.println(<span class="string">"T"</span> + idx + <span class="string">": interrupted"</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (BrokenBarrierException ex) &#123;</div><div class="line">                System.out.println(<span class="string">"T"</span> + idx + <span class="string">": broken"</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"T"</span> + idx + <span class="string">": continue"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br></div><br></div><br></div><br>Console output:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">T0: await</div><div class="line">T1: await</div><div class="line">T2: await</div><div class="line">T2: <span class="keyword">continue</span></div><div class="line">T1: <span class="keyword">continue</span></div><div class="line">T0: <span class="keyword">continue</span></div></pre></td></tr></table></figure><br><br>Lines can “jump” a little bit because threads in these examples print out information to console concurrently. So you may have slightly different results.<br><strong>CountDownLatch</strong><br>The CountDownLatch is initialized with a count. Threads may call await() to wait for the count to reach 0. Other threads (or same) may call countDown() to reduce count. Not reusable once the count has reached 0. Used to trigger an unknown set of threads once some number of actions has occurred.<br><br></div><br><div><br><br>倒计时闩, 利用它可以实现类似计数器的功能。比如有一个任务A，它要等待其他4个任务执行完毕之后才能执行，此时就可以利用CountDownLatch来实现这种功能了<br><br>Works like a counter – allows one or more threads to wait on await() method for another N threads to callcountDown() method N times (total number of calls should be N).<br><div class="separator"><img src="/media/CountdownLatch.png" alt="CountdownLatch"></div><br>As the illustration shows only T<span class="Apple-style-span">A</span> is awaiting. T<span class="Apple-style-span">1,2,3</span> call <span class="Apple-style-span">countDown()</span> and proceed their execution. When T<span class="Apple-style-span">3</span> calls<span class="Apple-style-span">countDown(),</span> T<span class="Apple-style-span">A</span> gets unlocked and can resume its work.<br><br>“HelloWorld app” for CountdownLatch:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> CountDownLatch cdl = <span class="keyword">new</span> CountDownLatch(N);</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                System.out.println(<span class="string">"awaiting..."</span>);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    cdl.await();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">                    System.out.println(<span class="string">"await has been iterrupted"</span>);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                System.out.println(<span class="string">"ready"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &amp;lt; N; i++) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> idx = i;</div><div class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    System.out.println(<span class="string">"T"</span> + idx + <span class="string">":countDown"</span>);</div><div class="line">                    cdl.countDown();</div><div class="line">                    System.out.println(<span class="string">"T"</span> + idx + <span class="string">":continue"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div></pre></td></tr></table></figure><br><br>Console output:<br><pre>awaiting…<br>T1:countDown<br>T0:countDown<br>T0:continue<br>T1:continue<br>T2:countDown<br>T2:continue<br>ready<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">It is different from CyclicBarrier:</div><div class="line">1) it cannot be reused, used only one time</div><div class="line">2) it does not block these N threads when they call countDown() method. Only thread on &lt;span class=&quot;Apple-style-span&quot;&gt;await()&lt;/span&gt; method waits.</div><div class="line"></div><div class="line">**Semaphore**</div><div class="line">A Semaphore manages a set of “permits” that can be checked out with acquire() which will block until one is available. Threads call release() to return the permit. A semaphore with one permit is equivalent to a mutual exclusion block.</div><div class="line"></div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;</div><div class="line"></div><div class="line">Maintains N permits which is shared between M threads. Each thread can acquire or release permits. If there are not enough permits thread blocks until other threads release necessary amount of permits.</div><div class="line">&lt;div class=&quot;separator&quot;&gt;![Semaphore](/media/Semaphore.png)&lt;/div&gt;</div><div class="line">Let&apos;s see what is happening on the illustration above. There are 2 permits and 4 threads. Each thread acquires/releases only 1 permit. T&lt;span class=&quot;Apple-style-span&quot;&gt;1&lt;/span&gt; and T&lt;span class=&quot;Apple-style-span&quot;&gt;2&lt;/span&gt; do this and proceed their execution without being blocked. T&lt;span class=&quot;Apple-style-span&quot;&gt;3&lt;/span&gt; and T&lt;span class=&quot;Apple-style-span&quot;&gt;4&lt;/span&gt;block and wait for permits because there are no any permits available. T&lt;span class=&quot;Apple-style-span&quot;&gt;2&lt;/span&gt; releases one permit and T&lt;span class=&quot;Apple-style-span&quot;&gt;4&lt;/span&gt; proceeds its calculations&lt;span class=&quot;Apple-style-span&quot;&gt; (T&lt;span class=&quot;Apple-style-span&quot;&gt;3&lt;/span&gt; is also might be chosen?)&lt;/span&gt;. Next T&lt;span class=&quot;Apple-style-span&quot;&gt;4&lt;/span&gt; releases its permit and T&lt;span class=&quot;Apple-style-span&quot;&gt;3&lt;/span&gt; resumes. An finally T&lt;span class=&quot;Apple-style-span&quot;&gt;1&lt;/span&gt; and T&lt;span class=&quot;Apple-style-span&quot;&gt;3&lt;/span&gt; release their permits.</div><div class="line"></div><div class="line">Simple example:</div><div class="line">``` java</div><div class="line">public static void main(String args[]) &#123;</div><div class="line">    final Semaphore sem = new Semaphore(N);</div><div class="line">    acquire(&quot;T1&quot;, sem);</div><div class="line">    acquire(&quot;T2&quot;, sem);</div><div class="line"></div><div class="line">    release(&quot;Ta&quot;, sem);</div><div class="line">    release(&quot;Tb&quot;, sem);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static void acquire(final String id, final Semaphore s)&#123;</div><div class="line">    new Thread(new Runnable() &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            System.out.println(id + &quot;: acquire&quot;);</div><div class="line">            try &#123;</div><div class="line">                s.acquire();</div><div class="line">            &#125; catch (InterruptedException ex) &#123;</div><div class="line">                System.out.println(id + &quot;: acquire|interrupted&quot;);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            System.out.println(id + &quot;: acquire|ready&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static void release(final String id, final Semaphore s)&#123;</div><div class="line">    new Thread(new Runnable() &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            System.out.println(id + &quot;: release&quot;);</div><div class="line">            s.release();</div><div class="line">            System.out.println(id + &quot;: release|ready&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>Console output:<br><pre>T2: acquire<br>T2: acquire|ready<br>Tb: release<br>T1: acquire<br>Ta: release<br>Ta: release|ready<br>Tb: release|ready<br>T1: acquire|ready<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">**Exchanger**</div><div class="line">An Exchanger waits for threads to meet at the exchange() method and swap values atomically. This is similar to using a SynchronousQueue but data values pass in both directions.</div><div class="line"></div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;&lt;/div&gt;</div><div class="line">&lt;div&gt;</div><div class="line"></div><div class="line">下面对上面说的三个辅助类进行一个总结：</div><div class="line"></div><div class="line">1）CountDownLatch和CyclicBarrier都能够实现线程之间的等待，只不过它们侧重点不同：</div><div class="line">CountDownLatch一般用于某个线程A等待若干个其他线程执行完任务之后，它才执行；</div><div class="line">而CyclicBarrier一般用于一组线程互相等待至某个状态，然后这一组线程再同时执行；</div><div class="line">另外，CountDownLatch是不能够重用的，而CyclicBarrier是可以重用的。</div><div class="line">2）Semaphore其实和锁有点类似，它一般用于控制对某组资源的访问权限。</div><div class="line"></div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">### Task execution</div><div class="line"></div><div class="line">&lt;div&gt;Many concurrent Java programs need a pool of workers executing tasks from a queue. The java.util.concurrent</div><div class="line">package provides a solid foundation for this style of work management.</div><div class="line"></div><div class="line">#### ExecutorService</div><div class="line"></div><div class="line">The Executor and more expansive ExecutorService interfaces defie the contract for a component that can execute</div><div class="line">tasks. Users of these interfaces can get a wide variety of implementation behaviors behind a common interface.</div><div class="line">The most generic Executor interface accepts jobs only in the form of Runnables:</div><div class="line">• void execute(Runnable command)</div><div class="line">The ExecutorService extends Executor to add methods that take both Runnable and Callable task and collections of tasks:</div><div class="line">• Future&amp;lt;?&amp;gt; submit(Runnable task)</div><div class="line">• Future&amp;lt;T&amp;gt; submit(Callable&amp;lt;T&amp;gt; task)</div><div class="line">• Future&amp;lt;T&amp;gt; submit(Runnable task, T result)</div><div class="line">• List&amp;lt;Future&amp;lt;T&amp;gt; invokeAll(Collection&amp;lt;? extends Callable&amp;lt;T&amp;gt;&amp;gt; tasks)</div><div class="line">• List&amp;lt;Future&amp;lt;T&amp;gt; invokeAll(Collection&amp;lt;? extends Callable&amp;lt;T&amp;gt;&amp;gt; tasks, long timeout, TimeUnit unit)</div><div class="line"></div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;• T invokeAny(Collection&amp;lt;? extends Callable&amp;lt;T&amp;gt;&amp;gt; tasks)</div><div class="line">•T invokeAny(Collection&amp;lt;? extends Callable&amp;lt;T&amp;gt;&amp;gt; tasks, long timeout, TimeUnit unit)</div><div class="line"></div><div class="line">#### Callable and Future</div><div class="line"></div><div class="line">A Callable is like the familiar Runnable but can return a result and throw an exception:</div><div class="line">• V call() throws Exception;</div><div class="line">It is common in the executor framework to submit a Callable and receive a Future. A Future is a marker representing a result that will be available at some point in the future. The Future has methods that allow you to either poll or block while waiting for the result to be ready. You can also cancel the task before or while it’s executing through methods on Future.</div><div class="line">If you need the functionality of a Future where only Runnables are supported (as in Executor), you can use FutureTask as a bridge. FutureTask implements both Future and Runnable so that you can submit the task as a Runnable and use the task itself as a Future in the caller.</div><div class="line"></div><div class="line">#### ExecutorService implementations</div><div class="line"></div><div class="line">The primary implementation of ExecutorService is ThreadPoolExecutor. This implementation class provides a</div><div class="line">wide variety of confiurable features:</div><div class="line">• Thread pool – specify “core” thread count (optionally pre-started), and max thread count</div><div class="line">• Thread factory – generate threads with custom characteristics such as a custom name</div><div class="line">• Work queue – specify the queue implementation, which must be blocking, but can be bounded or unbounded</div><div class="line">• Rejected tasks – specify the policy for tasks that cannot be accepted due to a full input queue or unavailable worker</div><div class="line">• Lifecycle hooks – overridden to extend to override key points in the lifecycle like before or after task execution</div><div class="line">• Shutdown – stop incoming tasks and wait for executing tasks to complete ScheduledThreadPoolExecutor is an extension of ThreadPoolExecutor that provides the ability to schedule tasks for completion rather than using FIFO semantics. For cases where java.util.Timer is not sophisticated enough, the ScheduledThreadPoolExecutor often provides suffiient flxibility.</div><div class="line">The Executors class contains many static methods (see Table 10) for creating prepackaged ExecutorService and</div><div class="line">ScheduledExecutorService instances that will cover a wide variety of common use cases.</div><div class="line">![](file:///C:/Users/Administrator/Documents/My%20Knowledge/temp/98fb8f57-8cfd-441a-b0be-850e7533aebe.png)[![table-concurrent-executor](/media/table-concurrent-executor.png)](/media/table-concurrent-executor.png)</div><div class="line"></div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div&gt;The following example creates a fied thread pool and submits a long-running task to it:&lt;/div&gt;</div><div class="line">&lt;div&gt;</div><div class="line">``` java</div><div class="line">int processors = Runtime.getRuntime().availableProcessor();</div><div class="line">ExecutorService excutor = Executors.newFixedThreadPool(processors);</div><div class="line">Future&amp;lt;Integer&amp;gt; futureResult = executor.submit(new Callable&amp;lt;Integer&amp;gt;() &#123;</div><div class="line">    public Integer call() &#123;</div><div class="line">        // long running computation that returns an integer</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">Integer result = futureResult.get(); //block for result</div></pre></td></tr></table></figure><br><br>In this example the call that submits the task to the executor will not block but return immediately. The last line will block on the get() call until the result is available.<br><br></pre></pre></div><br><div><br><br>ExecutorService covers almost all situations where you would previously create Thread objects or thread pools. Any time your code is constructing a Thread directly, consider whether you could accomplish the same goal with an ExecutorService  produced by one of the Executor factory methods; often this will be simpler and more flxible.<br><br>#### CompletionService<br><br>Beyond the common pattern of a pool of workers and an input queue, it is common for each task to produce a result that must be accumulated for further processing. The CompletionService interface allows a user to submit Callable and Runnable tasks but also to take or poll for results from the results queue:<br>• Future&lt;V&gt; take() – take if available<br>• Future&lt;V&gt; poll() – block until available<br>• Future&lt;V&gt; poll(long timeout, TimeUnit unit) – block until timeout ends<br>The ExecutorCompletionService is the standard implementation of CompletionService. It is constructed with an Executor that provides the input queue and worker thread pool.<br><br></div><br><div><br><br>&nbsp;<br><br><em> </em> *<br><br></div><br><div>Some thread-safe questions:</div><br><div>String  -&gt; immutable</div><br><div>StringBuffer -&gt; mutable, synchronized version</div><br><div>StringBuilder -&gt; mutable, unsynchronized version</div><br><div></div><br><div>HashMap -&gt;  unsynchronized</div><br><div>HashTable -&gt;  synchronized</div><br><div></div><br><div>ArrayList -&gt; unsynchronized</div><br><div>Vector -&gt; sysnchronized</div><br><div></div><br><div></div><br><div></div><br></div>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/04/postgresql-concurrency-with-mvcc/" itemprop="url">
                  PostgreSQL Concurrency with MVCC
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-03-04T08:12:20+08:00" content="2015-03-04">
              2015-03-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Databases/" itemprop="url" rel="index">
                    <span itemprop="name">Databases</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Databases/Transaction-Management/" itemprop="url" rel="index">
                    <span itemprop="name">Transaction Management</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/04/postgresql-concurrency-with-mvcc/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/03/04/postgresql-concurrency-with-mvcc/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><section id="table-of-contents"><a href="https://devcenter.heroku.com/articles/postgresql-concurrency#disadvantages-of-mvcc" target="_blank" rel="external">https://devcenter.heroku.com/articles/postgresql-concurrency#disadvantages-of-mvcc</a></section></p>
<h3 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h3><ul>
<li><a href="https://devcenter.heroku.com/articles/postgresql-concurrency#how-mvcc-works" target="_blank" rel="external">How MVCC works</a></li>
<li><a href="https://devcenter.heroku.com/articles/postgresql-concurrency#disadvantages-of-mvcc" target="_blank" rel="external">Disadvantages of MVCC</a><br>One of the big selling points of Postgres is how it handles concurrency. The promise is simple: reads never block writes and vice versa. Postgres achieves this via a mechanism called Multi Version Concurrency Control. This technique is not unique to Postgres: there are several databases that implement some form of MVCC including Oracle, Berkeley DB, CouchDB and <a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control#Databases_with_MVCC" target="_blank" rel="external">many more</a>. Understanding how MVCC is implemented in Postgres is important when designing highly concurrent apps on PostgreSQL. It’s actually a very elegant and simple solution to a hard problem.</li>
</ul>
<h2 id="How-MVCC-works"><a href="#How-MVCC-works" class="headerlink" title="How MVCC works"></a><a href="https://devcenter.heroku.com/articles/postgresql-concurrency#how-mvcc-works" target="_blank" rel="external">How MVCC works</a></h2><p>Every transaction in postgres gets a transaction ID called XID. This includes single one statement transactions such as an insert, update or delete, as well as explicitely wrapping a group of statements together via <code>BEGIN</code> - <code>COMMIT</code>. When a transaction starts, Postgres increments an XID and assigns it to the current transaction. Postgres also stores transaction information on every row in the system, which is used to determine whether a row is visible to the transaction or not.</p>
<p>For example, when you insert a row, postgres will store the XID in the row and call it <code>xmin</code>. Every row that has been committed and has an<code>xmin</code> that is less than the current transaction’s XID is visible to the transaction. This means that you can start a transaction and insert a row, and until that transaction <code>COMMIT</code>s that row will not be visible to other transactions. Once it commits and other transactions get created, they will be able to view the new row because they satisfy the <code>xmin &amp;lt; XID</code> condition – and the transaction that created the row has completed.</p>
<p>A similar mechanism occurs for <code>DELETE</code>s and <code>UPDATE</code>s, only in these cases Postgres stores an <code>xmax</code> value on each row in order to determine visibility. This diagram shows two concurrent transactions inserting and reading rows, and how MVCC comes into play in terms of transaction isolation.</p>
<p>For the following charts, assume the following DDL:</p>
<p><div class="CodeRay"></div></p>
<p><div class="code"></div></p>
<p><pre><span class="class">CREATE</span> <span class="type">TABLE</span> numbers (value <span class="predefined-type">int</span>);<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">![mvcc-1](/media/mvcc-1.png)</div><div class="line"></div><div class="line">While the `xmin` and `xmax` values are hidden from daily operations, you can actually just ask for them and Postgres will hapilly give them to you:</div><div class="line">&lt;div class=&quot;CodeRay&quot;&gt;</div><div class="line">&lt;div class=&quot;code&quot;&gt;</div><div class="line">&lt;pre&gt;&lt;span class=&quot;class&quot;&gt;SELECT&lt;/span&gt; *, xmin, xmax &lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; numbers;</div></pre></td></tr></table></figure></pre></p>
<p><br><br>You can also get the XID for the current transaction pretty easily:</p>
<p><div class="CodeRay"></div></p>
<p><div class="code"></div></p>
<p><pre><span class="class">SELECT</span> txid_current();<br>```<br><br><br>Neat!</pre></p>
<p>I know what you’re thinking though: what about a two transactions updating the same row at the same time? This is where transaction isolation levels come in. Postgres basically supports two models that allow you to control how this situation should be handled. The default,<code>READ COMMITTED</code>, reads the row after the inital transaction has completed and then executes the statement. It basically starts over if the row changed while it was waiting. For instance, if you issue an <code>UPDATE</code> with a <code>WHERE</code> clause, the <code>WHERE</code> clause will rerun after the initial transaction commits, and the <code>UPDATE</code> takes place if the <code>WHERE</code> clause is still satisfied. Here’s an example of two transactions modifying a row where the initial<code>UPDATE</code> causes the <code>WHERE</code> clause of the second transaction to return no rows. Therefore the second transaction does not update any rows at all:</p>
<p><img src="/media/mvcc-2.png" alt="mvcc-2"></p>
<p>If you need finer control over this behavior, you can set the transactionisolation level to <code>SERIALIZABLE</code>. With this strategy the above scenario will just fail, because it says “If the row I’m modifying has been modified by another transaction, don’t even try,” and Postgres will respond with the error message <code>ERROR: could not serialize access due to concurrent update</code>. It’s up to your app to handle that error and try again, or to give up if that’s what makes sense.</p>
<p><img src="/media/mvcc-3.png" alt="mvcc-3"></p>
<h2 id="Disadvantages-of-MVCC"><a href="#Disadvantages-of-MVCC" class="headerlink" title="Disadvantages of MVCC"></a><a href="https://devcenter.heroku.com/articles/postgresql-concurrency#disadvantages-of-mvcc" target="_blank" rel="external">Disadvantages of MVCC</a></h2><p>Now that you know how MVCC and transaction isolation actualy works, you’ve added another tool for solving the kinds of problems where a<code>SERIALIZABLE</code> isolation level comes in handy. While the advantages of MVCC are clear it also has some disadvantages.</p>
<p>Because different transactions will have visibility to a different set of rows, Postgres needs to maintain potentially obsolete records. This is why an <code>UPDATE</code> actually creates a new row and why <code>DELETE</code> doesn’t<em>really</em> remove the row: it merely marks it as deleted and sets the XID values appropriately. As transactions complete, there will be rows in the database that cannot possibly be visible to any future transactions. These are called dead rows. Another problem that comes from MVCC is that transaction IDs can only ever grow so much – they are 32 bits and can “only” support around 4 billion transactions. When the XID reaches its max, it will wraparound and start back at zero. Suddenly _all_rows appear to be in future transactions, and no new transactions would have visibility into those rows.</p>
<p>Both dead rows and the transaction XID wraparound problem are solved with <code>VACUUM</code>. This should be routine maintenance, but thankfuly Postgres comes with an auto_vacuum daemon that will run at a configurable frequency. It’s important to keep an eye on this because different deployments will have different needs when it comes to vacuum frequency. You can read more about what <code>VACUUM</code> actually does on the <a href="http://www.postgresql.org/docs/current/static/routine-vacuuming.html" target="_blank" rel="external">Postgres docs</a> and how <a href="https://devcenter.heroku.com/articles/heroku-postgres-database-tuning" target="_blank" rel="external">Heroku handles it</a>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/17/inner-thread-communication-pipedinstreampipedoutstream-vs-blockingqueue/" itemprop="url">
                  Inner thread communication: PipedInputStream/PipedOutputStream vs. BlockingQueue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-02-17T08:39:28+08:00" content="2015-02-17">
              2015-02-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Multithreading/" itemprop="url" rel="index">
                    <span itemprop="name">Multithreading</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/17/inner-thread-communication-pipedinstreampipedoutstream-vs-blockingqueue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/17/inner-thread-communication-pipedinstreampipedoutstream-vs-blockingqueue/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>There are a lot of differences between the two.</p>
<p>For starters, what kind of data do you want to transport? Complex objects will be easier to transport between threads using a Queue, rather than a Pipe. With the Pipes you would have to serialize the objects or transform them in some way to get them through the Stream, then reverse the procedure on the receiving side. With Queues you just put the object in the Queue and pull it out on the consumer.</p>
<p>Another: A <a href="http://docs.oracle.com/javase/8/docs/api/java/io/PipedInputStream.html" title="Java API" target="_blank" rel="external">PipedInputStream</a> (consumer) can only connect to a single <a href="http://docs.oracle.com/javase/8/docs/api/java/io/PipedOutputStream.html" title="Java API" target="_blank" rel="external">PipedOutputStream</a> (producer), and it wouldn’t be safe to share the <a href="http://docs.oracle.com/javase/8/docs/api/java/io/PipedOutputStream.html" title="Java API" target="_blank" rel="external">PipedOutputStream</a> with multiple threads without further synchronization. So on the consumer you would need 2 PipedInputStreams, one connecting to each producer’s <a href="http://docs.oracle.com/javase/8/docs/api/java/io/PipedOutputStream.html" title="Java API" target="_blank" rel="external">PipedOutputStream</a>. In your situation of 2 producers -&gt; 1 consumer, a thread safe Queue implementation will be easier. Both producers and the consumer can use the same Queue. But that may not be exactly what you want.</p>
<p>A Queue may be easier for the general purpose but if you have pre-written code optimized around stream communication, then perhaps the Pipe connection would be easier to implement - specifically if the data is all primitives or Strings (where PipedReader/Writer could be used).</p>
<p>Which will be faster is hard to predict. If you can get both working safely the only way to make the speed comparison would be to <a href="http://www.javaranch.com/unit-testing.jsp" title="article: evil unit testing" target="_blank" rel="external">test</a>. My guess is that the performance factor will be not be worth comparing though. Either using Streams to communicate or using Queues to collate data will be the better design decision.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/16/cross-domain-browser-requests/" itemprop="url">
                  Cross-domain Browser Requests
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-02-16T06:48:09+08:00" content="2015-02-16">
              2015-02-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Javascript/" itemprop="url" rel="index">
                    <span itemprop="name">Javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/16/cross-domain-browser-requests/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/16/cross-domain-browser-requests/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Problem-origin"><a href="#Problem-origin" class="headerlink" title="Problem origin"></a>Problem origin</h4><p>Browsers prohibit scripts in a page from one domain to request some resources from another domain.</p>
<p>Take a scenario as an example:</p>
<p>A page named 1.html from <a href="http://dev.company.com/1.html" target="_blank" rel="external">http://dev.company.com/1.html</a> has a script requesting a resource from another domain by use of url: <a href="http://sit.company.com/dosomething" target="_blank" rel="external">http://sit.company.com/dosomething</a>. This case is called <strong>Cross Domain Request</strong>. This is due to the browser’s <strong>Same-origin Policy.</strong></p>
<p>This is only limited to Javascript request like AJAX, and not limited to <span style="text-decoration: underline;">normal resource references</span>:</p>
<p>1. hypertext link by <em>&lt;a href=”…”&gt;</em></p>
<p>_2. <em>image by</em> &lt;img src=”…”&gt;_</p>
<p>_3. external <em>css stylesheet link by</em> &lt;link type=”text/css” href=”…”&gt;_</p>
<p>4. external javascript by <em>&lt;script type=”text/javascript” src=”…”&gt;</em></p>
<p>5. form action by<em> &lt;form action=”…”&gt;</em></p>
<p>6. iframe by &lt;iframe src=”…”&gt;</p>
<h4 id="How-to-resolve-this-issue"><a href="#How-to-resolve-this-issue" class="headerlink" title="How to resolve this issue"></a>How to resolve this issue</h4><h5 id="1-JSONP"><a href="#1-JSONP" class="headerlink" title="1. JSONP"></a>1. JSONP</h5><p>JSONP, aka JSON with Padding. It actually makes use of the normal external javascript reference. a HTML <code>&amp;lt;script&amp;gt;</code> element specifies for its <code>src</code> attribute a URL that returns JSON.</p>
<p><img src="/media/web-basics-jsonp.jpg" alt="web-basics-jsonp"></p>
<p>For example, in the page of url <a href="http://localhost:8080/aes-gui/simple/poc/main/sum" target="_blank" rel="external">http://localhost:8080/aes-gui/simple/poc/main/sum</a>:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&amp;lt;script type=<span class="string">"text/javascript"</span>&amp;gt;</div><div class="line"><span class="function">function <span class="title">callback_for_response</span><span class="params">(data)</span> </span>&#123;</div><div class="line"><span class="comment">// data is the response</span></div><div class="line">&#125;</div><div class="line">&amp;lt;/script&amp;gt;</div><div class="line"></div><div class="line">&amp;lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"http://DEV:8080/aes-gui/simple/poc/main/add?callback=callback_for_response"</span>&amp;gt;&amp;lt;/script&amp;gt;</div></pre></td></tr></table></figure></p>
<p>When the application on domain sit.company.com has received this request, and found the query parameter “callback”(this is a kind of contract, others also use “jsonp” or anything others), then it generates the response like this:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">callback_for_response(&#123;a: <span class="number">1</span>, b: <span class="number">2</span>, c: <span class="string">"3"</span>&#125;)</div></pre></td></tr></table></figure></p>
<p>You see, the response JSON data {a:1, b:2, c:”3”} is surrounded/padded by the passed parameter “callback_for_response”, which is the origin of JSON with Padding.</p>
<p>JSONP has a number of limitations like, it supports only GET requests and not PUT, POST, DELETE, etc and it does not also send headers across.</p>
<h5 id="2-Proxying"><a href="#2-Proxying" class="headerlink" title="2. Proxying"></a>2. Proxying</h5><p>Proxying is so simple that the client doesn’t need to know the cross domain requests. It accesses the urls all from the same domain. And the proxy server is responsible for the request to another domain.</p>
<p>In fact, it’s more like a solution of system integration.</p>
<h5 id="3-CORS-Cross-Origin-Resource-Sharing"><a href="#3-CORS-Cross-Origin-Resource-Sharing" class="headerlink" title="3. CORS (Cross Origin Resource Sharing)"></a>3. CORS (Cross Origin Resource Sharing)</h5><p><em>CORS</em> is an evolution of JSONP.</p>
<p><strong>CORS</strong> stands for Cross Origin Resource Sharing, which allows you to share GET, POST, PUT, and DELETE requests and CORS is supported by the modern browsers.The CORS make use of 2 requests.</p>
<p><strong>Request 1:</strong> “<strong>OPTIONS</strong>” request as part of the handshake to determine if cross domain is allowed by the server.</p>
<p>If server allows the request, it adds a response header - <strong>Access-Control-Allow-Origin: ‘*’</strong></p>
<p><strong>Request 2</strong>: <strong>GET</strong>, <strong>POST</strong>, <strong>PUT</strong>, or <strong>DELETE</strong> request that performs the actual operation on the server.</p>
<p><img src="/media/web-basics-CORS.jpg" alt="web-basics-CORS"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/12/get-started-with-weblogic/" itemprop="url">
                  Get started with WebLogic
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-02-12T07:43:05+08:00" content="2015-02-12">
              2015-02-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Middlewares/" itemprop="url" rel="index">
                    <span itemprop="name">Middlewares</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/12/get-started-with-weblogic/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/12/get-started-with-weblogic/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts:"></a>Concepts:</h3><p>Domain, Admin Server, Managed Server, Node Manager</p>
<p><table width="1016"></table></p>
<p><tbody></tbody></p>
<p><tr></tr></p>
<p><td style="font-weight: 400;" width="308"><strong><span style="color: #808000;">WebSphere</span></strong></td></p>
<p><td style="font-weight: 400;" width="708"><strong><span style="color: #808000;">WebLogic</span></strong></td><br></p>
<p><tr></tr></p>
<p><td style="font-weight: 400;" width="308">Profile</td></p>
<p><td style="font-weight: 400;" width="708">Domain</td><br></p>
<p><tr></tr></p>
<p><td style="font-weight: 400;" width="308">Node Agent</td></p>
<p><td style="font-weight: 400;" width="708">Node Manager</td><br></p>
<p><tr></tr></p>
<p><td></td></p>
<p><td style="font-weight: 400;" width="708">Admin Server</td><br></p>
<p><tr></tr></p>
<p><td style="font-weight: 400;" width="308">Application Server</td></p>
<p><td style="font-weight: 400;" width="708">Managed Server</td><br><br><br><br>WebSphere has standalone version and Network Deploy version (ND). In ND version, there is a central management node and another application nodes. And the node agent is a communication bridge among the management unit.</p>
<p>In WebLogic, the concepts are clearer and the management function is more intuitive.</p>
<p><img src="/media/weblogic.png" alt="weblogic"></p>
<p>&nbsp;</p>
<p>This figure is a typical plan of a WebLogic domain. In it, all the node managers, managed servers, and admin server are seperated JVM processes. It’s worth noticing that machine 3 has two managed server processes.</p>
<p>As mentioned previously, node manager is also a process running on a physical or virtualised machine called Node for responding the management tasks from admin server.</p>
<p>A managed server is managed by admin server, and is a standard J2EE application server including many services and servlet / EJB container which you can deploy your enterprise or web application into.</p>
<p>Admin server provides all sorts of management and a web admin console. In a domain, there can be only one admin server.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/10/javaee-java-transaction-jdbc-jta-jts/" itemprop="url">
                  Java Transaction - JDBC, JTA, JTS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-02-10T08:46:35+08:00" content="2015-02-10">
              2015-02-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JDBC/" itemprop="url" rel="index">
                    <span itemprop="name">JDBC</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JDBC/JTA/" itemprop="url" rel="index">
                    <span itemprop="name">JTA</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JDBC/JTA/Transaction-Management/" itemprop="url" rel="index">
                    <span itemprop="name">Transaction Management</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/10/javaee-java-transaction-jdbc-jta-jts/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/10/javaee-java-transaction-jdbc-jta-jts/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.progress.com/products/datadirect-connect/jdbc-drivers/jdbc-developer-center/jdbc-tutorials/understanding-jta---the-java-transaction-api/accessing-databases" target="_blank" rel="external">https://www.progress.com/products/datadirect-connect/jdbc-drivers/jdbc-developer-center/jdbc-tutorials/understanding-jta---the-java-transaction-api/accessing-databases</a></p>
<h3 id="Concepts-and-implementation"><a href="#Concepts-and-implementation" class="headerlink" title="Concepts and implementation"></a>Concepts and implementation</h3><h4 id="Where-these-come-from"><a href="#Where-these-come-from" class="headerlink" title="Where these come from?"></a>Where these come from?</h4><p>In transaction processing, there are several participants:</p>
<p><img src="/media/jta-jts.png" alt="jta jts"></p>
<p><strong>Resource Manager</strong>: like RDMS, JMS Providers(MQ), JCA Resources, transnational distributed systems</p>
<p>It is important to understand what constitutes a <em><strong><span class="emphasis">resource</span></strong></em>, in this context. For example, if you are using a JMS product, the JMS resource is the single running instance of the JMS product, <span class="emphasis">not</span> the individual queues and topics. Moreover, sometimes, what appears to be multiple resources might actually be a single resource, if the same underlying resource is accessed in different ways. For example, your application might access a relational database both directly (through JDBC) and indirectly (through an object-relational mapping tool like Hibernate). In this case, the same underlying transaction manager is involved, so it should be possible to enrol both of these code fragments in the same transaction.</p>
<p><strong>Resource Adapters</strong>: JDBC drivers …</p>
<p><strong>Transaction Manager</strong>: the part of an application that is responsible for coordinating transactions across one or more resources.</p>
<p>J2EE servers: EJB containers..</p>
<p>&nbsp;</p>
<p>Of these, transaction manager is the core role. Two categories of transaction manager:</p>
<p><strong>Local transaction manager</strong>:</p>
<p>a transaction manager that can coordinate transactions over a <span class="emphasis"><em>single</em></span> resource only. In this case, the implementation of the transaction manager is typically embedded in the resource itself.</p>
<p>For example, the Oracle database has a built-in transaction manager that supports demarcation operations (using SQL operations, <code>BEGIN</code>, <code>COMMIT</code>, <code>ROLLBACK</code>, or using a native Oracle API) and various levels of transaction isolation. Control over the Oracle transaction manager can be exported through JDBC, which is how Spring is able to abstract and wrap this kind of transaction manager as local transaction manager.</p>
<p>When we use resource local transaction in Java, we completely depend on database (a resource manager) to provide transaction support.</p>
<p>This is supported by JDBC API.</p>
<p>In the class Connection, there are several methods related to the resource local transaction:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">setAutoCommit(<span class="keyword">boolean</span>)</div><div class="line">commit()</div><div class="line">rollback()</div><div class="line">setTransactionIsolation()</div></pre></td></tr></table></figure></p>
<p><strong>Global transaction manager</strong>:</p>
<p>A <em>global transaction manager</em> is a transaction manager that can coordinate transactions over <span class="emphasis"><em>multiple</em></span> resources. In this case, you cannot rely on the transaction manager built into the resource itself. Instead, you require an external system, sometimes called a <em>transaction processing monitor</em> (TP monitor), that is capable of coordinating transactions across different resources.</p>
<p>So the transactions coordinated by global transaction manager are called <strong>global transaction</strong>. And the transactions related with single resource and not coordinated by global transaction manager are called <strong>local transaction</strong>.</p>
<p>&nbsp;</p>
<p>Unlike the above general concepts, in implementation and standard level of Java transaction support:</p>
<p>XA transaction is a kind of global distributed transaction which allow across multiple <em>X/Open XA resources</em>.</p>
<p>JTA support XA transaction and the related classes: UserTransaction, TransactionManager, XADataSource, XAResource, XAConnection.</p>
<p>JTA transaction manager is also a kind of global transaction manager, which usually runs in application server as a process and communicates with transaction participants during the <em>two-phase commit</em> protocol.</p>
<blockquote>
<p><strong><span style="text-decoration: underline;">XA Transaction and XA Data source</span></strong></p>
<p>The JTA allows distributed transactions across multiple <em>X/Open XA resources</em>. XA stands for <em>Extended Architecture</em> which was developed by the X/Open Group to define a transaction which uses more than one back-end data store. The XA standard describes the interface between a global <em>Transaction Manager (TM)</em> and a local resource manager. XA allows multiple resources, such as application servers, databases, caches, and message queues, to participate in the same transaction, while preserving atomicity of the transaction.</p>
<p>An XA datasource is a datasource which can participate in an XA global transaction.</p>
<p><span style="text-decoration: underline;"><strong>2-Phase Commit Protocol</strong></span></p>
<p>The Two-phase commit protocol (2PC) refers to the typical pattern of a database transaction.</p>
<div class="title">Phase 1</div>

<p>In the first phase, the transaction participants notify the transaction manager whether they are able to commit the transaction or must roll back.</p>
<p><div class="formalpara"><br>Phase 2</div></p>
<p>In the second phase, the transaction manager makes the decision about whether the overall transaction should commit or roll back. If any one of the participants cannot commit, the transaction must roll back. Otherwise, the transaction can commit. The manager directs the transactions about what to do, and they notify the manager when they have done it. At that point, the transaction is finished.<br><br>Because JTA transaction is not distributed across multiple application servers, and cannot be nested, when we need to cross multiple J2EE containers, JTS is for this purpose.</p>
</blockquote>
<p><strong><em>Java Transaction Service (JTS)</em></strong> is a mechanism for supporting Java Transaction API (JTA) transactions when participants of the transactions reside in multiple J2EE containers (application servers). In JTS transactions, the Transaction Coordinator manages interactions between transaction managers on different servers.</p>
<p>From an application standpoint, a JTS transaction behaves in the same ways as a JTA transaction. The difference is that transaction participants and datasources reside in different containers.</p>
<h4 id="How-JTA-is-supported"><a href="#How-JTA-is-supported" class="headerlink" title="How JTA is supported?"></a>How JTA is supported?</h4><p>The Java Transaction API consists of three elements: a high-level application transaction demarcation interface, a high-level transaction manager interface intended for an application server, and a standard Java mapping of the X/Open XA protocol intended for a transactional resource manager.</p>
<p><code>[javax.transaction.UserTransaction](http://docs.oracle.com/javaee/7/api/javax/transaction/UserTransaction.html)</code>, that is used by general client code such as a servlet or an EJB to manage the transactions, but it is usually acquired by JNDI reference (it should be available under <code>java:comp/UserTransaction)</code>, and is usually injected into EJB when you use Container-Managed Transaction(CMT).</p>
<p><code>[javax.transaction.TransactionManager](http://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html)</code>, that is implemented by the application server itself to begin, commit and rollback the transactions.</p>
<p><code>[javax.transaction.xa.XAResource](http://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html)</code> interface is required to implement  by each resource manager in order to be managed by the TP monitor. Each resource will have its own specific API, for instance:</p>
<ul>
<li>relational databases use JDBC (XADataSource, XAConnection are implemented by XA JDBC driver)</li>
<li>messaging services use JMS</li>
<li>generalized EIS (Enterprise Information System) resources use JCA (Java EE Connector API).<blockquote>
<p><em>If you are interested in how to implement a simple/naive transaction manager just like it’done in application server, please refer to:__<a href="http://blog.csdn.net/liu78778/article/details/4805308" target="_blank" rel="external">http://blog.csdn.net/liu78778/article/details/4805308</a></em></p>
</blockquote>
</li>
</ul>
<h4 id="How-can-we-use-them-in-traditional-J2EE-enviorment"><a href="#How-can-we-use-them-in-traditional-J2EE-enviorment" class="headerlink" title="How can we use them in traditional J2EE enviorment?"></a>How can we use them in traditional J2EE enviorment?</h4><p><span style="text-decoration: underline;"><span id="UserTransaction_support_in_JNDI" class="mw-headline">UserTransaction support in servlet :</span></span><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.transaction.*；</div><div class="line"><span class="keyword">import</span> javax.naming.*；</div><div class="line"><span class="comment">// ...</span></div><div class="line">InitialContext ctx = <span class="keyword">new</span> InitialContext()；</div><div class="line">Object txObj = ctx.lookup(<span class="string">"java:comp/UserTransaction"</span>；)；</div><div class="line">UserTransaction utx = (UserTransaction) txObj；</div><div class="line">utx.begin();</div><div class="line"><span class="comment">// ...</span></div><div class="line">DataSource ds = obtainXADataSource();</div><div class="line">Connection conn = ds.getConnection();</div><div class="line">pstmt = conn.prepareStatement(<span class="string">"UPDATE MOVIES ..."</span>);</div><div class="line">pstmt.setString(<span class="number">1</span>, <span class="string">"Spinal Tap"</span>);</div><div class="line">pstmt.executeUpdate();</div><div class="line"><span class="comment">// ...</span></div><div class="line">utx.commit();</div></pre></td></tr></table></figure></p>
<p><span style="text-decoration: underline;">UserTransaction support in EJB:<br></span><br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Stateless</span></div><div class="line"><span class="meta">@TransactionManagement</span>(BEAN)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> UserTransaction utx;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// start a transaction</span></div><div class="line">        utx.begin();</div><div class="line"></div><div class="line">        <span class="comment">// Do work</span></div><div class="line"></div><div class="line">        <span class="comment">// Commit it</span></div><div class="line">        utx.commit();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>For more details, you need to refer to the EJB transaction management(CMT).</p>
<h3 id="Spring-transaction-management-abstraction"><a href="#Spring-transaction-management-abstraction" class="headerlink" title="Spring transaction management abstraction"></a>Spring transaction management abstraction</h3><p>Spring intends to abstract these transaction management technology, and integrate them into a unified API.</p>
<p>PlatformTransactionManager is a service provider interface Spring provides. (NOTE, it’s not the subclass of javax.transaction.TransactionManager).</p>
<p>Currently, there are the following implementations:</p>
<div class="simplesect"><br><br>Table 1 summarizes the local transaction manager implementations provided by the Spring framework. These transaction managers are distinguished by the fact that they support a <span class="emphasis"><em>single resource only</em></span>.<br><br><strong>Table 1. Local Transaction Managers</strong><br><div class="table"><br><div class="table-contents"><br><table border="1" summary="Local Transaction Managers" width="100%" cellpadding="2"><colgroup> <col class="c1"> <col class="c2"></colgroup><br><thead><br><tr><br><th>Transaction Manager</th><br><th>Description</th><br></tr><br></thead><br><tbody><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/jms/connection/JmsTransactionManager.html" target="_blank" rel="external"><code>JmsTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a <span class="emphasis"><em>single</em></span> JMS resource. That is, you can connect to any number of queues or topics, but <span class="emphasis"><em>only</em></span> if they belong to the same underlying JMS messaging product instance. Moreover, you cannot enlist any other types of resource in a transaction.For example, using this transaction manager, it would <span class="emphasis"><em>not</em></span> be possible to enlist both a SonicMQ resource and an Apache ActiveMQ resource in the same transaction. But see Table 2.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/jdbc/datasource/DataSourceTransactionManager.html" target="_blank" rel="external"><code>DataSourceTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a <span class="emphasis"><em>single</em></span> JDBC database resource. That is, you can update any number of different database tables, but <span class="emphasis"><em>only</em></span> if they belong to the same underlying database instance.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/orm/hibernate3/HibernateTransactionManager.html" target="_blank" rel="external"><code>HibernateTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a <a href="http://www.hibernate.org/" target="_blank" rel="external">Hibernate</a> resource. It is not possible, however, to simultaneously enlist any other kind of resource in a transaction.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/orm/jdo/JdoTransactionManager.html" target="_blank" rel="external"><code>JdoTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a Java Data Objects (<a href="http://db.apache.org/jdo/" target="_blank" rel="external">JDO</a>) resource. It is not possible, however, to simultaneously enlist any other kind of resource in a transaction.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/orm/jpa/JpaTransactionManager.html" target="_blank" rel="external"><code>JpaTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a Java Persistence API (<a href="http://java.sun.com/javaee/technologies/persistence.jsp" target="_blank" rel="external">JPA</a>) resource. It is not possible, however, to simultaneously enlist any other kind of resource in a transaction.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/jca/cci/connection/CciLocalTransactionManager.html" target="_blank" rel="external"><code>CciLocalTransactionManager</code></a></td><br><td>A transaction manager implementation that is capable of managing a Java Connection Architecture (<a href="http://java.sun.com/j2ee/connector/" target="_blank" rel="external">JCA</a>) resource. It is not possible, however, to simultaneously enlist any other kind of resource in a transaction.</td><br></tr><br></tbody><br></table><br></div><br></div><br></div><br><div class="simplesect"><br><br><a href="https://access.redhat.com/documentation/en-US/Fuse_ESB_Enterprise/7.1/html/EIP_Transaction_Guide/files/TxnManagers-Impls.html#TxnManagers-Impls-TableGTM" title="Table 2. Global Transaction Managers" target="_blank" rel="external">Table 2</a> summarizes the global transaction manager implementations provided by the Spring framework. These transaction managers are distinguished by the fact that they can support <span class="emphasis"><em>multiple resources</em></span>.<br><br><strong>Table 2. Global Transaction Managers</strong><br><div class="table"><br><div class="table-contents"><br><table border="1" summary="Global Transaction Managers" width="100%" cellpadding="2"><colgroup> <col class="c1"> <col class="c2"></colgroup><br><thead><br><tr><br><th>Transaction Manager</th><br><th>Description</th><br></tr><br></thead><br><tbody><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/jta/JtaTransactionManager.html" target="_blank" rel="external"><code>JtaTransactionManager</code></a></td><br><td>If you require a transaction manager that is capable of enlisting more than one resource in a transaction, use the JTA transaction manager, which is capable of supporting the XA transaction API. You <span class="emphasis"><em>must</em></span> deploy your application inside either an OSGi container or a J2EE server to use this transaction manager.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/jta/OC4JJtaTransactionManager.html" target="_blank" rel="external"><code>OC4JJtaTransactionManagner</code></a></td><br><td>A specialization of the <code>JtaTransactionManager</code> to work with Oracle’s OC4J. The advantage of this implementation is that it makes Spring-driven transactions visible in OC4J’s transaction monitor</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/jta/WebLogicJtaTransactionManager.html" target="_blank" rel="external"><code>WebLogicJtaTransactionManager</code></a></td><br><td>A specialization of the <code>JtaTransactionManager</code> to work with the BEA WebLogic container. Makes certain advanced transaction features available: transaction names, per-transaction isolation levels, and proper suspension/resumption of transactions.</td><br></tr><br><tr><br><td><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/transaction/jta/WebSphereUowTransactionManager.html" target="_blank" rel="external"><code>WebSphereUowTransactionManager</code></a></td><br><td>A specialization of the <code>JtaTransactionManager</code> to work with the IBM WebSphere container. Enables proper suspension/resumption of transactions.</td><br></tr><br></tbody><br></table><br></div><br></div><br></div>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://qph.is.quoracdn.net/main-thumb-27403014-200-azcnfpakpayhgojvmueqcfjeyufbjpcx.jpeg"
               alt="Richard Yang" />
          <p class="site-author-name" itemprop="name">Richard Yang</p>
          <p class="site-description motion-element" itemprop="description">Nothing seek, nothing find</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">133</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://linkedin.com/in/richdyang" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://github.com/richdyang" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github-alt"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://bitbucket.org/richdyang" target="_blank" title="Bitbucket">
                  
                    <i class="fa fa-fw fa-bitbucket"></i>
                  
                  Bitbucket
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/4344443/richard" target="_blank" title="Stackoverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                  Stackoverflow
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://twitter.com/richdyang" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard Yang</span>
</div>

<!--div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div-->

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'richyang';
      var disqus_identifier = 'page/7/index.html';
      var disqus_title = '';

      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script>
  




  
  

  

  

  
  

  
  
  
  <link rel="stylesheet" href="/vendors/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/vendors/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



</body>
</html>
