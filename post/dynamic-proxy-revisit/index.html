<!DOCTYPE HTML>
<html lang="en-us">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Dynamic Proxy revisit - Chao Yang</title>
    <meta name="keywords" content="Java, Programming, Android, JavaScript, Angular, Kotlin, Swift, iOS, Machine Learning, Big Data">
    
    <meta property="og:title" content="Dynamic Proxy revisit">
    <meta property="og:site_name" content="Chao Yang">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Dynamic Proxy revisit - Chao Yang" />
    <meta name="description" content="A Developer in New Zealand"> 
    
    <link rel="shortcut icon" href="http://yangchao.me/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://yangchao.me/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://yangchao.me/img/apple-touch-icon.png" />
    <link href="http://yangchao.me/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://yangchao.me/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://yangchao.me/css/main.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/kotlin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/swift.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/typescript.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://yangchao.me/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Chao Yang</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Nothing seek, nothing find</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://yangchao.me/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://yangchao.me/books" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Minibooks
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://github.com/richdyang" rel="section">
              <i class="menu-item-icon fa fa-fw fa-code"></i> <br />Projects
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://yangchao.me/resume/cv.pdf" rel="section">
              <i class="menu-item-icon fa fa-fw fa-linkedin"></i> <br />Résumé
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://yangchao.me/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archive
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://yangchao.me/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> Search</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://yangchao.me/post/dynamic-proxy-revisit/" itemprop="url">
        Dynamic Proxy revisit
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">Published at:</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2016-08-15">
    2016-08-15
</time>
</span> 
      
       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">Reading:</span>
<span class="leancloud-visitors-count">16483 words ~78min</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    

<h1 id="dynamic-proxy-in-jdk">Dynamic Proxy in JDK</h1>

<p><code>Proxy</code> is a class which can get the proxy class and create the proxy instance. It has a private default constructor and a protected constructor with a contractor argument: <code>InvocationHandler</code>.</p>

<p><code>InvocationHandler</code> is an interface which we can apply our code into the generated proxy class. It has only one method: <code>Object invoke(Object proxy, Method method, Object[] args)</code></p>

<p>Proxy has four static methods:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getProxyClass</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">interfaces</span><span class="o">)</span>
<span class="kd">static</span> <span class="n">Object</span> <span class="nf">newProxyInstance</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">InvocationHandler</span> <span class="n">h</span><span class="o">)</span>
<span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isProxyClass</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">)</span>
<span class="kd">static</span> <span class="n">InvocationHandler</span> <span class="nf">getInvocationHandler</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">)</span></code></pre></div>
<p>Now let us see how to generate a proxy class in memory. The main logic is in <code>ProxyClassFactory</code>: firstly it call the <code>ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags)</code> to generate the bytes of class file, and then it invokes the native method of Proxy <code>static native Class&lt;?&gt; defineClass0(ClassLoader loader, String name, byte[] b, int off, int len)</code> to load and resolve the bytes into a <code>Class</code>.</p>

<p>So the two static methods <code>ProxyGenerator.generateProxyClass(..)</code> and <code>Proxy.defineClass0(..)</code> are very important.</p>

<p><code>Proxy.defineClass0(..)</code> makes that we don&rsquo;t need to define a ClassLoader to load a class from raw bytes. We will use it as a utility method later.</p>

<p><code>ProxyGenerator</code> has no secret since it just generates the bytecode following the class file format in the JVM specification.
<!-- more --></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/sun/misc/ProxyGenerator.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">sun.misc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Array</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ListIterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">sun.security.action.GetBooleanAction</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * ProxyGenerator contains the code to generate a dynamic proxy class
</span><span class="cm"> * for the java.lang.reflect.Proxy API.
</span><span class="cm"> *
</span><span class="cm"> * The external interfaces to ProxyGenerator is the static
</span><span class="cm"> * &#34;generateProxyClass&#34; method.
</span><span class="cm"> *
</span><span class="cm"> * @author      Peter Jones
</span><span class="cm"> * @since       1.3
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyGenerator</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * In the comments below, &#34;JVMS&#34; refers to The Java Virtual Machine
</span><span class="cm">     * Specification Second Edition and &#34;JLS&#34; refers to the original
</span><span class="cm">     * version of The Java Language Specification, unless otherwise
</span><span class="cm">     * specified.
</span><span class="cm">     */</span>

    <span class="cm">/* generate 1.5-era class file version */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CLASSFILE_MAJOR_VERSION</span> <span class="o">=</span> <span class="n">49</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CLASSFILE_MINOR_VERSION</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="cm">/*
</span><span class="cm">     * beginning of constants copied from
</span><span class="cm">     * sun.tools.java.RuntimeConstants (which no longer exists):
</span><span class="cm">     */</span>

    <span class="cm">/* constant pool tags */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_UTF8</span>              <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_UNICODE</span>           <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_INTEGER</span>           <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_FLOAT</span>             <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_LONG</span>              <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_DOUBLE</span>            <span class="o">=</span> <span class="n">6</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_CLASS</span>             <span class="o">=</span> <span class="n">7</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_STRING</span>            <span class="o">=</span> <span class="n">8</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_FIELD</span>             <span class="o">=</span> <span class="n">9</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_METHOD</span>            <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_INTERFACEMETHOD</span>   <span class="o">=</span> <span class="n">11</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_NAMEANDTYPE</span>       <span class="o">=</span> <span class="n">12</span><span class="o">;</span>

    <span class="cm">/* access and modifier flags */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_PUBLIC</span>                 <span class="o">=</span> <span class="n">0x00000001</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_PRIVATE</span>                <span class="o">=</span> <span class="n">0x00000002</span><span class="o">;</span>
<span class="c1">//  private static final int ACC_PROTECTED              = 0x00000004;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_STATIC</span>                 <span class="o">=</span> <span class="n">0x00000008</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_FINAL</span>                  <span class="o">=</span> <span class="n">0x00000010</span><span class="o">;</span>
<span class="c1">//  private static final int ACC_SYNCHRONIZED           = 0x00000020;
</span><span class="c1">//  private static final int ACC_VOLATILE               = 0x00000040;
</span><span class="c1">//  private static final int ACC_TRANSIENT              = 0x00000080;
</span><span class="c1">//  private static final int ACC_NATIVE                 = 0x00000100;
</span><span class="c1">//  private static final int ACC_INTERFACE              = 0x00000200;
</span><span class="c1">//  private static final int ACC_ABSTRACT               = 0x00000400;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_SUPER</span>                  <span class="o">=</span> <span class="n">0x00000020</span><span class="o">;</span>
<span class="c1">//  private static final int ACC_STRICT                 = 0x00000800;
</span><span class="c1"></span>
    <span class="cm">/* opcodes */</span>
<span class="c1">//  private static final int opc_nop                    = 0;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aconst_null</span>            <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="c1">//  private static final int opc_iconst_m1              = 2;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iconst_0</span>               <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
<span class="c1">//  private static final int opc_iconst_1               = 4;
</span><span class="c1">//  private static final int opc_iconst_2               = 5;
</span><span class="c1">//  private static final int opc_iconst_3               = 6;
</span><span class="c1">//  private static final int opc_iconst_4               = 7;
</span><span class="c1">//  private static final int opc_iconst_5               = 8;
</span><span class="c1">//  private static final int opc_lconst_0               = 9;
</span><span class="c1">//  private static final int opc_lconst_1               = 10;
</span><span class="c1">//  private static final int opc_fconst_0               = 11;
</span><span class="c1">//  private static final int opc_fconst_1               = 12;
</span><span class="c1">//  private static final int opc_fconst_2               = 13;
</span><span class="c1">//  private static final int opc_dconst_0               = 14;
</span><span class="c1">//  private static final int opc_dconst_1               = 15;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_bipush</span>                 <span class="o">=</span> <span class="n">16</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_sipush</span>                 <span class="o">=</span> <span class="n">17</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ldc</span>                    <span class="o">=</span> <span class="n">18</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ldc_w</span>                  <span class="o">=</span> <span class="n">19</span><span class="o">;</span>
<span class="c1">//  private static final int opc_ldc2_w                 = 20;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iload</span>                  <span class="o">=</span> <span class="n">21</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lload</span>                  <span class="o">=</span> <span class="n">22</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_fload</span>                  <span class="o">=</span> <span class="n">23</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dload</span>                  <span class="o">=</span> <span class="n">24</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aload</span>                  <span class="o">=</span> <span class="n">25</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iload_0</span>                <span class="o">=</span> <span class="n">26</span><span class="o">;</span>
<span class="c1">//  private static final int opc_iload_1                = 27;
</span><span class="c1">//  private static final int opc_iload_2                = 28;
</span><span class="c1">//  private static final int opc_iload_3                = 29;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lload_0</span>                <span class="o">=</span> <span class="n">30</span><span class="o">;</span>
<span class="c1">//  private static final int opc_lload_1                = 31;
</span><span class="c1">//  private static final int opc_lload_2                = 32;
</span><span class="c1">//  private static final int opc_lload_3                = 33;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_fload_0</span>                <span class="o">=</span> <span class="n">34</span><span class="o">;</span>
<span class="c1">//  private static final int opc_fload_1                = 35;
</span><span class="c1">//  private static final int opc_fload_2                = 36;
</span><span class="c1">//  private static final int opc_fload_3                = 37;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dload_0</span>                <span class="o">=</span> <span class="n">38</span><span class="o">;</span>
<span class="c1">//  private static final int opc_dload_1                = 39;
</span><span class="c1">//  private static final int opc_dload_2                = 40;
</span><span class="c1">//  private static final int opc_dload_3                = 41;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aload_0</span>                <span class="o">=</span> <span class="n">42</span><span class="o">;</span>
<span class="c1">//  private static final int opc_aload_1                = 43;
</span><span class="c1">//  private static final int opc_aload_2                = 44;
</span><span class="c1">//  private static final int opc_aload_3                = 45;
</span><span class="c1">//  private static final int opc_iaload                 = 46;
</span><span class="c1">//  private static final int opc_laload                 = 47;
</span><span class="c1">//  private static final int opc_faload                 = 48;
</span><span class="c1">//  private static final int opc_daload                 = 49;
</span><span class="c1">//  private static final int opc_aaload                 = 50;
</span><span class="c1">//  private static final int opc_baload                 = 51;
</span><span class="c1">//  private static final int opc_caload                 = 52;
</span><span class="c1">//  private static final int opc_saload                 = 53;
</span><span class="c1">//  private static final int opc_istore                 = 54;
</span><span class="c1">//  private static final int opc_lstore                 = 55;
</span><span class="c1">//  private static final int opc_fstore                 = 56;
</span><span class="c1">//  private static final int opc_dstore                 = 57;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_astore</span>                 <span class="o">=</span> <span class="n">58</span><span class="o">;</span>
<span class="c1">//  private static final int opc_istore_0               = 59;
</span><span class="c1">//  private static final int opc_istore_1               = 60;
</span><span class="c1">//  private static final int opc_istore_2               = 61;
</span><span class="c1">//  private static final int opc_istore_3               = 62;
</span><span class="c1">//  private static final int opc_lstore_0               = 63;
</span><span class="c1">//  private static final int opc_lstore_1               = 64;
</span><span class="c1">//  private static final int opc_lstore_2               = 65;
</span><span class="c1">//  private static final int opc_lstore_3               = 66;
</span><span class="c1">//  private static final int opc_fstore_0               = 67;
</span><span class="c1">//  private static final int opc_fstore_1               = 68;
</span><span class="c1">//  private static final int opc_fstore_2               = 69;
</span><span class="c1">//  private static final int opc_fstore_3               = 70;
</span><span class="c1">//  private static final int opc_dstore_0               = 71;
</span><span class="c1">//  private static final int opc_dstore_1               = 72;
</span><span class="c1">//  private static final int opc_dstore_2               = 73;
</span><span class="c1">//  private static final int opc_dstore_3               = 74;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_astore_0</span>               <span class="o">=</span> <span class="n">75</span><span class="o">;</span>
<span class="c1">//  private static final int opc_astore_1               = 76;
</span><span class="c1">//  private static final int opc_astore_2               = 77;
</span><span class="c1">//  private static final int opc_astore_3               = 78;
</span><span class="c1">//  private static final int opc_iastore                = 79;
</span><span class="c1">//  private static final int opc_lastore                = 80;
</span><span class="c1">//  private static final int opc_fastore                = 81;
</span><span class="c1">//  private static final int opc_dastore                = 82;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aastore</span>                <span class="o">=</span> <span class="n">83</span><span class="o">;</span>
<span class="c1">//  private static final int opc_bastore                = 84;
</span><span class="c1">//  private static final int opc_castore                = 85;
</span><span class="c1">//  private static final int opc_sastore                = 86;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_pop</span>                    <span class="o">=</span> <span class="n">87</span><span class="o">;</span>
<span class="c1">//  private static final int opc_pop2                   = 88;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dup</span>                    <span class="o">=</span> <span class="n">89</span><span class="o">;</span>
<span class="c1">//  private static final int opc_dup_x1                 = 90;
</span><span class="c1">//  private static final int opc_dup_x2                 = 91;
</span><span class="c1">//  private static final int opc_dup2                   = 92;
</span><span class="c1">//  private static final int opc_dup2_x1                = 93;
</span><span class="c1">//  private static final int opc_dup2_x2                = 94;
</span><span class="c1">//  private static final int opc_swap                   = 95;
</span><span class="c1">//  private static final int opc_iadd                   = 96;
</span><span class="c1">//  private static final int opc_ladd                   = 97;
</span><span class="c1">//  private static final int opc_fadd                   = 98;
</span><span class="c1">//  private static final int opc_dadd                   = 99;
</span><span class="c1">//  private static final int opc_isub                   = 100;
</span><span class="c1">//  private static final int opc_lsub                   = 101;
</span><span class="c1">//  private static final int opc_fsub                   = 102;
</span><span class="c1">//  private static final int opc_dsub                   = 103;
</span><span class="c1">//  private static final int opc_imul                   = 104;
</span><span class="c1">//  private static final int opc_lmul                   = 105;
</span><span class="c1">//  private static final int opc_fmul                   = 106;
</span><span class="c1">//  private static final int opc_dmul                   = 107;
</span><span class="c1">//  private static final int opc_idiv                   = 108;
</span><span class="c1">//  private static final int opc_ldiv                   = 109;
</span><span class="c1">//  private static final int opc_fdiv                   = 110;
</span><span class="c1">//  private static final int opc_ddiv                   = 111;
</span><span class="c1">//  private static final int opc_irem                   = 112;
</span><span class="c1">//  private static final int opc_lrem                   = 113;
</span><span class="c1">//  private static final int opc_frem                   = 114;
</span><span class="c1">//  private static final int opc_drem                   = 115;
</span><span class="c1">//  private static final int opc_ineg                   = 116;
</span><span class="c1">//  private static final int opc_lneg                   = 117;
</span><span class="c1">//  private static final int opc_fneg                   = 118;
</span><span class="c1">//  private static final int opc_dneg                   = 119;
</span><span class="c1">//  private static final int opc_ishl                   = 120;
</span><span class="c1">//  private static final int opc_lshl                   = 121;
</span><span class="c1">//  private static final int opc_ishr                   = 122;
</span><span class="c1">//  private static final int opc_lshr                   = 123;
</span><span class="c1">//  private static final int opc_iushr                  = 124;
</span><span class="c1">//  private static final int opc_lushr                  = 125;
</span><span class="c1">//  private static final int opc_iand                   = 126;
</span><span class="c1">//  private static final int opc_land                   = 127;
</span><span class="c1">//  private static final int opc_ior                    = 128;
</span><span class="c1">//  private static final int opc_lor                    = 129;
</span><span class="c1">//  private static final int opc_ixor                   = 130;
</span><span class="c1">//  private static final int opc_lxor                   = 131;
</span><span class="c1">//  private static final int opc_iinc                   = 132;
</span><span class="c1">//  private static final int opc_i2l                    = 133;
</span><span class="c1">//  private static final int opc_i2f                    = 134;
</span><span class="c1">//  private static final int opc_i2d                    = 135;
</span><span class="c1">//  private static final int opc_l2i                    = 136;
</span><span class="c1">//  private static final int opc_l2f                    = 137;
</span><span class="c1">//  private static final int opc_l2d                    = 138;
</span><span class="c1">//  private static final int opc_f2i                    = 139;
</span><span class="c1">//  private static final int opc_f2l                    = 140;
</span><span class="c1">//  private static final int opc_f2d                    = 141;
</span><span class="c1">//  private static final int opc_d2i                    = 142;
</span><span class="c1">//  private static final int opc_d2l                    = 143;
</span><span class="c1">//  private static final int opc_d2f                    = 144;
</span><span class="c1">//  private static final int opc_i2b                    = 145;
</span><span class="c1">//  private static final int opc_i2c                    = 146;
</span><span class="c1">//  private static final int opc_i2s                    = 147;
</span><span class="c1">//  private static final int opc_lcmp                   = 148;
</span><span class="c1">//  private static final int opc_fcmpl                  = 149;
</span><span class="c1">//  private static final int opc_fcmpg                  = 150;
</span><span class="c1">//  private static final int opc_dcmpl                  = 151;
</span><span class="c1">//  private static final int opc_dcmpg                  = 152;
</span><span class="c1">//  private static final int opc_ifeq                   = 153;
</span><span class="c1">//  private static final int opc_ifne                   = 154;
</span><span class="c1">//  private static final int opc_iflt                   = 155;
</span><span class="c1">//  private static final int opc_ifge                   = 156;
</span><span class="c1">//  private static final int opc_ifgt                   = 157;
</span><span class="c1">//  private static final int opc_ifle                   = 158;
</span><span class="c1">//  private static final int opc_if_icmpeq              = 159;
</span><span class="c1">//  private static final int opc_if_icmpne              = 160;
</span><span class="c1">//  private static final int opc_if_icmplt              = 161;
</span><span class="c1">//  private static final int opc_if_icmpge              = 162;
</span><span class="c1">//  private static final int opc_if_icmpgt              = 163;
</span><span class="c1">//  private static final int opc_if_icmple              = 164;
</span><span class="c1">//  private static final int opc_if_acmpeq              = 165;
</span><span class="c1">//  private static final int opc_if_acmpne              = 166;
</span><span class="c1">//  private static final int opc_goto                   = 167;
</span><span class="c1">//  private static final int opc_jsr                    = 168;
</span><span class="c1">//  private static final int opc_ret                    = 169;
</span><span class="c1">//  private static final int opc_tableswitch            = 170;
</span><span class="c1">//  private static final int opc_lookupswitch           = 171;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ireturn</span>                <span class="o">=</span> <span class="n">172</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lreturn</span>                <span class="o">=</span> <span class="n">173</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_freturn</span>                <span class="o">=</span> <span class="n">174</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dreturn</span>                <span class="o">=</span> <span class="n">175</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_areturn</span>                <span class="o">=</span> <span class="n">176</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_return</span>                 <span class="o">=</span> <span class="n">177</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_getstatic</span>              <span class="o">=</span> <span class="n">178</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_putstatic</span>              <span class="o">=</span> <span class="n">179</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_getfield</span>               <span class="o">=</span> <span class="n">180</span><span class="o">;</span>
<span class="c1">//  private static final int opc_putfield               = 181;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokevirtual</span>          <span class="o">=</span> <span class="n">182</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokespecial</span>          <span class="o">=</span> <span class="n">183</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokestatic</span>           <span class="o">=</span> <span class="n">184</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokeinterface</span>        <span class="o">=</span> <span class="n">185</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_new</span>                    <span class="o">=</span> <span class="n">187</span><span class="o">;</span>
<span class="c1">//  private static final int opc_newarray               = 188;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_anewarray</span>              <span class="o">=</span> <span class="n">189</span><span class="o">;</span>
<span class="c1">//  private static final int opc_arraylength            = 190;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_athrow</span>                 <span class="o">=</span> <span class="n">191</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_checkcast</span>              <span class="o">=</span> <span class="n">192</span><span class="o">;</span>
<span class="c1">//  private static final int opc_instanceof             = 193;
</span><span class="c1">//  private static final int opc_monitorenter           = 194;
</span><span class="c1">//  private static final int opc_monitorexit            = 195;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_wide</span>                   <span class="o">=</span> <span class="n">196</span><span class="o">;</span>
<span class="c1">//  private static final int opc_multianewarray         = 197;
</span><span class="c1">//  private static final int opc_ifnull                 = 198;
</span><span class="c1">//  private static final int opc_ifnonnull              = 199;
</span><span class="c1">//  private static final int opc_goto_w                 = 200;
</span><span class="c1">//  private static final int opc_jsr_w                  = 201;
</span><span class="c1"></span>
    <span class="c1">// end of constants copied from sun.tools.java.RuntimeConstants
</span><span class="c1"></span>
    <span class="cm">/** name of the superclass of proxy classes */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">superclassName</span> <span class="o">=</span> <span class="s">&#34;java/lang/reflect/Proxy&#34;</span><span class="o">;</span>

    <span class="cm">/** name of field for storing a proxy instance&#39;s invocation handler */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">handlerFieldName</span> <span class="o">=</span> <span class="s">&#34;h&#34;</span><span class="o">;</span>

    <span class="cm">/** debugging flag for saving generated class files */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">saveGeneratedFiles</span> <span class="o">=</span>
        <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">GetBooleanAction</span><span class="o">(</span>
                <span class="s">&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span><span class="o">)).</span><span class="na">booleanValue</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * Generate a proxy class given a name and a list of proxy interfaces.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateProxyClass</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                                            <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">ProxyGenerator</span> <span class="n">gen</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classFile</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="na">generateClassFile</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">saveGeneratedFiles</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="n">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">FileOutputStream</span> <span class="n">file</span> <span class="o">=</span>
                            <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">);</span>
                        <span class="n">file</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">classFile</span><span class="o">);</span>
                        <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span>
                            <span class="s">&#34;I/O exception saving generated file: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">classFile</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* preloaded Method objects for methods in java.lang.Object */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">hashCodeMethod</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">equalsMethod</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">toStringMethod</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">hashCodeMethod</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">);</span>
            <span class="n">equalsMethod</span> <span class="o">=</span>
                <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;equals&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">});</span>
            <span class="n">toStringMethod</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchMethodError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/** name of proxy class */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">className</span><span class="o">;</span>

    <span class="cm">/** proxy interfaces */</span>
    <span class="kd">private</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">;</span>

    <span class="cm">/** constant pool of class being generated */</span>
    <span class="kd">private</span> <span class="n">ConstantPool</span> <span class="n">cp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConstantPool</span><span class="o">();</span>

    <span class="cm">/** FieldInfo struct for each field of generated class */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FieldInfo</span><span class="o">&gt;</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FieldInfo</span><span class="o">&gt;();</span>

    <span class="cm">/** MethodInfo struct for each method of generated class */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MethodInfo</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">MethodInfo</span><span class="o">&gt;();</span>

    <span class="cm">/**
</span><span class="cm">     * maps method signature string to list of ProxyMethod objects for
</span><span class="cm">     * proxy methods with that signature
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;&gt;</span> <span class="n">proxyMethods</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;&gt;();</span>

    <span class="cm">/** count of ProxyMethod objects added to proxyMethods */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">proxyMethodCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Construct a ProxyGenerator to generate a proxy class with the
</span><span class="cm">     * specified name and for the given interfaces.
</span><span class="cm">     *
</span><span class="cm">     * A ProxyGenerator object contains the state for the ongoing
</span><span class="cm">     * generation of a particular proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="nf">ProxyGenerator</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">interfaces</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate a class file for the proxy class.  This method drives the
</span><span class="cm">     * class file generation process.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateClassFile</span><span class="o">()</span> <span class="o">{</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 1: Assemble ProxyMethod objects for all methods to
</span><span class="cm">         * generate proxy dispatching code for.
</span><span class="cm">         */</span>

        <span class="cm">/*
</span><span class="cm">         * Record that proxy methods are needed for the hashCode, equals,
</span><span class="cm">         * and toString methods of java.lang.Object.  This is done before
</span><span class="cm">         * the methods from the proxy interfaces so that the methods from
</span><span class="cm">         * java.lang.Object take precedence over duplicate methods in the
</span><span class="cm">         * proxy interfaces.
</span><span class="cm">         */</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">hashCodeMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">equalsMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">toStringMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="cm">/*
</span><span class="cm">         * Now record all of the methods from the proxy interfaces, giving
</span><span class="cm">         * earlier interfaces precedence over later ones with duplicate
</span><span class="cm">         * methods.
</span><span class="cm">         */</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getMethods</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">j</span><span class="o">],</span> <span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * For each set of proxy methods with the same signature,
</span><span class="cm">         * verify that the methods&#39; return types are compatible.
</span><span class="cm">         */</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">checkReturnTypes</span><span class="o">(</span><span class="n">sigmethods</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 2: Assemble FieldInfo and MethodInfo structs for all of
</span><span class="cm">         * fields and methods in the class we are generating.
</span><span class="cm">         */</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">generateConstructor</span><span class="o">());</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>

                    <span class="c1">// add static field for method&#39;s Method object
</span><span class="c1"></span>                    <span class="n">fields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">FieldInfo</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodFieldName</span><span class="o">,</span>
                        <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">,</span>
                         <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_STATIC</span><span class="o">));</span>

                    <span class="c1">// generate code for proxy method and add it
</span><span class="c1"></span>                    <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">generateMethod</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">generateStaticInitializer</span><span class="o">());</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;unexpected I/O Exception&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;method limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;field limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 3: Write the final class file.
</span><span class="cm">         */</span>

        <span class="cm">/*
</span><span class="cm">         * Make sure that constant pool indexes are reserved for the
</span><span class="cm">         * following items before starting to write the final class file.
</span><span class="cm">         */</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">));</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">superclassName</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * Disallow new constant pool additions beyond this point, since
</span><span class="cm">         * we are about to write the final constant pool table.
</span><span class="cm">         */</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">();</span>

        <span class="n">ByteArrayOutputStream</span> <span class="n">bout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">bout</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;ClassFile&#34; structure.
</span><span class="cm">             * See JVMS section 4.1.
</span><span class="cm">             */</span>
                                        <span class="c1">// u4 magic;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">0xCAFEBABE</span><span class="o">);</span>
                                        <span class="c1">// u2 minor_version;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">CLASSFILE_MINOR_VERSION</span><span class="o">);</span>
                                        <span class="c1">// u2 major_version;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">CLASSFILE_MAJOR_VERSION</span><span class="o">);</span>

            <span class="n">cp</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>             <span class="c1">// (write constant pool)
</span><span class="c1"></span>
                                        <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span> <span class="o">|</span> <span class="n">ACC_SUPER</span><span class="o">);</span>
                                        <span class="c1">// u2 this_class;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">)));</span>
                                        <span class="c1">// u2 super_class;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">superclassName</span><span class="o">));</span>

                                        <span class="c1">// u2 interfaces_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                                        <span class="c1">// u2 interfaces[interfaces_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                    <span class="n">dotToSlash</span><span class="o">(</span><span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">())));</span>
            <span class="o">}</span>

                                        <span class="c1">// u2 fields_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                                        <span class="c1">// field_info fields[fields_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">FieldInfo</span> <span class="n">f</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">f</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>
            <span class="o">}</span>

                                        <span class="c1">// u2 methods_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                                        <span class="c1">// method_info methods[methods_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">MethodInfo</span> <span class="n">m</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">m</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>
            <span class="o">}</span>

                                         <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// (no ClassFile attributes for proxy classes)
</span><span class="c1"></span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;unexpected I/O Exception&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">bout</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Add another method to be proxied, either by creating a new
</span><span class="cm">     * ProxyMethod object or augmenting an old one for a duplicate
</span><span class="cm">     * method.
</span><span class="cm">     *
</span><span class="cm">     * &#34;fromClass&#34; indicates the proxy interface that the method was
</span><span class="cm">     * found through, which may be different from (a subinterface of)
</span><span class="cm">     * the method&#39;s &#34;declaring class&#34;.  Note that the first Method
</span><span class="cm">     * object passed for a given name and descriptor identifies the
</span><span class="cm">     * Method object (and thus the declaring class) that will be
</span><span class="cm">     * passed to the invocation handler&#39;s &#34;invoke&#34; method for a given
</span><span class="cm">     * set of duplicate methods.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addProxyMethod</span><span class="o">(</span><span class="n">Method</span> <span class="n">m</span><span class="o">,</span> <span class="n">Class</span> <span class="n">fromClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">getParameterDescriptors</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">=</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sig</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sigmethods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="o">==</span> <span class="n">pm</span><span class="o">.</span><span class="na">returnType</span><span class="o">)</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * Found a match: reduce exception types to the
</span><span class="cm">                     * greatest set of exceptions that can thrown
</span><span class="cm">                     * compatibly with the throws clauses of both
</span><span class="cm">                     * overridden methods.
</span><span class="cm">                     */</span>
                    <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">legalExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
                    <span class="n">collectCompatibleTypes</span><span class="o">(</span>
                        <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">,</span> <span class="n">legalExceptions</span><span class="o">);</span>
                    <span class="n">collectCompatibleTypes</span><span class="o">(</span>
                        <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">,</span> <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">legalExceptions</span><span class="o">);</span>
                    <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">legalExceptions</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
                    <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span>
                        <span class="n">legalExceptions</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">sigmethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;(</span><span class="n">3</span><span class="o">);</span>
            <span class="n">proxyMethods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">sig</span><span class="o">,</span> <span class="n">sigmethods</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sigmethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ProxyMethod</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="n">returnType</span><span class="o">,</span>
                                       <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">fromClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * For a given set of proxy methods with the same signature, check
</span><span class="cm">     * that their return types are compatible according to the Proxy
</span><span class="cm">     * specification.
</span><span class="cm">     *
</span><span class="cm">     * Specifically, if there is more than one such method, then all
</span><span class="cm">     * of the return types must be reference types, and there must be
</span><span class="cm">     * one return type that is assignable to each of the rest of them.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkReturnTypes</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*
</span><span class="cm">         * If there is only one method with a given signature, there
</span><span class="cm">         * cannot be a conflict.  This is the only case in which a
</span><span class="cm">         * primitive (or void) return type is allowed.
</span><span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * List of return types that are not yet known to be
</span><span class="cm">         * assignable from (&#34;covered&#34; by) any of the others.
</span><span class="cm">         */</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">uncoveredReturnTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span><span class="nl">
</span><span class="nl">
</span><span class="nl">    nextNewReturnType:</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">newReturnType</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">returnType</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">newReturnType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&#34;methods with same signature &#34;</span> <span class="o">+</span>
                    <span class="n">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodName</span><span class="o">,</span>
                                               <span class="n">pm</span><span class="o">.</span><span class="na">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
                    <span class="s">&#34; but incompatible return types: &#34;</span> <span class="o">+</span>
                    <span class="n">newReturnType</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; and others&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Compare the new return type to the existing uncovered
</span><span class="cm">             * return types.
</span><span class="cm">             */</span>
            <span class="n">ListIterator</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">liter</span> <span class="o">=</span> <span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">listIterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">liter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">uncoveredReturnType</span> <span class="o">=</span> <span class="n">liter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

                <span class="cm">/*
</span><span class="cm">                 * If an existing uncovered return type is assignable
</span><span class="cm">                 * to this new one, then we can forget the new one.
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">newReturnType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">uncoveredReturnType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="o">!</span><span class="n">added</span><span class="o">;</span>
                    <span class="k">continue</span> <span class="n">nextNewReturnType</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="cm">/*
</span><span class="cm">                 * If the new return type is assignable to an existing
</span><span class="cm">                 * uncovered one, then should replace the existing one
</span><span class="cm">                 * with the new one (or just forget the existing one,
</span><span class="cm">                 * if the new one has already be put in the list).
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">uncoveredReturnType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// (we can assume that each return type is unique)
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(!</span><span class="n">added</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">liter</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">);</span>
                        <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">liter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="cm">/*
</span><span class="cm">             * If we got through the list of existing uncovered return
</span><span class="cm">             * types without an assignability relationship, then add
</span><span class="cm">             * the new return type to the list of uncovered ones.
</span><span class="cm">             */</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">added</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * We shouldn&#39;t end up with more than one return type that is
</span><span class="cm">         * not assignable from any of the others.
</span><span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                <span class="s">&#34;methods with same signature &#34;</span> <span class="o">+</span>
                <span class="n">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodName</span><span class="o">,</span> <span class="n">pm</span><span class="o">.</span><span class="na">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
                <span class="s">&#34; but incompatible return types: &#34;</span> <span class="o">+</span> <span class="n">uncoveredReturnTypes</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A FieldInfo object contains information about a particular field
</span><span class="cm">     * in the class being generated.  The class mirrors the data items of
</span><span class="cm">     * the &#34;field_info&#34; structure of the class file format (see JVMS 4.5).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">FieldInfo</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">FieldInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">accessFlags</span> <span class="o">=</span> <span class="n">accessFlags</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Make sure that constant pool indexes are reserved for the
</span><span class="cm">             * following items before starting to write the final class file.
</span><span class="cm">             */</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;field_info&#34; structure.
</span><span class="cm">             * See JVMS section 4.5.
</span><span class="cm">             */</span>
                                        <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">accessFlags</span><span class="o">);</span>
                                        <span class="c1">// u2 name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
                                        <span class="c1">// u2 descriptor_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">));</span>
                                        <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>  <span class="c1">// (no field_info attributes for proxy classes)
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * An ExceptionTableEntry object holds values for the data items of
</span><span class="cm">     * an entry in the &#34;exception_table&#34; item of the &#34;Code&#34; attribute of
</span><span class="cm">     * &#34;method_info&#34; structures (see JVMS 4.7.3).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ExceptionTableEntry</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">startPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">endPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">handlerPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">catchType</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ExceptionTableEntry</span><span class="o">(</span><span class="kt">short</span> <span class="n">startPc</span><span class="o">,</span> <span class="kt">short</span> <span class="n">endPc</span><span class="o">,</span>
                                   <span class="kt">short</span> <span class="n">handlerPc</span><span class="o">,</span> <span class="kt">short</span> <span class="n">catchType</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">startPc</span> <span class="o">=</span> <span class="n">startPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">endPc</span> <span class="o">=</span> <span class="n">endPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">handlerPc</span> <span class="o">=</span> <span class="n">handlerPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">catchType</span> <span class="o">=</span> <span class="n">catchType</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="cm">/**
</span><span class="cm">     * A MethodInfo object contains information about a particular method
</span><span class="cm">     * in the class being generated.  This class mirrors the data items of
</span><span class="cm">     * the &#34;method_info&#34; structure of the class file format (see JVMS 4.6).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">MethodInfo</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">maxStack</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">maxLocals</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">ByteArrayOutputStream</span> <span class="n">code</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ExceptionTableEntry</span><span class="o">&gt;</span> <span class="n">exceptionTable</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ExceptionTableEntry</span><span class="o">&gt;();</span>
        <span class="kd">public</span> <span class="kt">short</span><span class="o">[]</span> <span class="n">declaredExceptions</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">MethodInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">accessFlags</span> <span class="o">=</span> <span class="n">accessFlags</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Make sure that constant pool indexes are reserved for the
</span><span class="cm">             * following items before starting to write the final class file.
</span><span class="cm">             */</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Code&#34;</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Exceptions&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;method_info&#34; structure.
</span><span class="cm">             * See JVMS section 4.6.
</span><span class="cm">             */</span>
                                        <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">accessFlags</span><span class="o">);</span>
                                        <span class="c1">// u2 name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
                                        <span class="c1">// u2 descriptor_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">));</span>
                                        <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>  <span class="c1">// (two method_info attributes:)
</span><span class="c1"></span>
            <span class="c1">// Write &#34;Code&#34; attribute. See JVMS section 4.7.3.
</span><span class="c1"></span>
                                        <span class="c1">// u2 attribute_name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Code&#34;</span><span class="o">));</span>
                                        <span class="c1">// u4 attribute_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">12</span> <span class="o">+</span> <span class="n">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">8</span> <span class="o">*</span> <span class="n">exceptionTable</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                                        <span class="c1">// u2 max_stack;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">maxStack</span><span class="o">);</span>
                                        <span class="c1">// u2 max_locals;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">maxLocals</span><span class="o">);</span>
                                        <span class="c1">// u2 code_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                                        <span class="c1">// u1 code[code_length];
</span><span class="c1"></span>            <span class="n">code</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
                                        <span class="c1">// u2 exception_table_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">exceptionTable</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ExceptionTableEntry</span> <span class="n">e</span> <span class="o">:</span> <span class="n">exceptionTable</span><span class="o">)</span> <span class="o">{</span>
                                        <span class="c1">// u2 start_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">startPc</span><span class="o">);</span>
                                        <span class="c1">// u2 end_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">endPc</span><span class="o">);</span>
                                        <span class="c1">// u2 handler_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">handlerPc</span><span class="o">);</span>
                                        <span class="c1">// u2 catch_type;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">catchType</span><span class="o">);</span>
            <span class="o">}</span>
                                        <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

            <span class="c1">// write &#34;Exceptions&#34; attribute.  See JVMS section 4.7.4.
</span><span class="c1"></span>
                                        <span class="c1">// u2 attribute_name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Exceptions&#34;</span><span class="o">));</span>
                                        <span class="c1">// u4 attributes_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">2</span> <span class="o">+</span> <span class="n">2</span> <span class="o">*</span> <span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                                        <span class="c1">// u2 number_of_exceptions;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                        <span class="c1">// u2 exception_index_table[number_of_exceptions];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">declaredExceptions</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A ProxyMethod object represents a proxy method in the proxy class
</span><span class="cm">     * being generated: a method whose implementation will encode and
</span><span class="cm">     * dispatch invocations to the proxy instance&#39;s invocation handler.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ProxyMethod</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span> <span class="n">returnType</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span> <span class="n">fromClass</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">methodFieldName</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">ProxyMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                            <span class="n">Class</span> <span class="n">returnType</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span><span class="o">,</span>
                            <span class="n">Class</span> <span class="n">fromClass</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">methodName</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parameterTypes</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">returnType</span> <span class="o">=</span> <span class="n">returnType</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span> <span class="n">exceptionTypes</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fromClass</span> <span class="o">=</span> <span class="n">fromClass</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">methodFieldName</span> <span class="o">=</span> <span class="s">&#34;m&#34;</span> <span class="o">+</span> <span class="n">proxyMethodCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Return a MethodInfo object for this method, including generating
</span><span class="cm">         * the code and exception table entry.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateMethod</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">getMethodDescriptor</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">,</span> <span class="n">returnType</span><span class="o">);</span>
            <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">desc</span><span class="o">,</span>
                <span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span><span class="o">);</span>

            <span class="kt">int</span><span class="o">[]</span> <span class="n">parameterSlot</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">nextSlot</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterSlot</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">parameterSlot</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nextSlot</span><span class="o">;</span>
                <span class="n">nextSlot</span> <span class="o">+=</span> <span class="n">getWordsPerType</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">localSlot0</span> <span class="o">=</span> <span class="n">nextSlot</span><span class="o">;</span>
            <span class="kt">short</span> <span class="n">pc</span><span class="o">,</span> <span class="n">tryBegin</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">;</span>

            <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

            <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getfield</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                <span class="n">superclassName</span><span class="o">,</span>
                <span class="n">handlerFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span class="o">));</span>

            <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getstatic</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                <span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">),</span>
                <span class="n">methodFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>

                <span class="n">code_ipush</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_anewarray</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Object&#34;</span><span class="o">));</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                    <span class="n">code_ipush</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                    <span class="n">codeWrapArgument</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">parameterSlot</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">out</span><span class="o">);</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aastore</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aconst_null</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokeinterface</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getInterfaceMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/reflect/InvocationHandler&#34;</span><span class="o">,</span>
                <span class="s">&#34;invoke&#34;</span><span class="o">,</span>
                <span class="s">&#34;(Ljava/lang/Object;Ljava/lang/reflect/Method;&#34;</span> <span class="o">+</span>
                    <span class="s">&#34;[Ljava/lang/Object;)Ljava/lang/Object;&#34;</span><span class="o">));</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="o">==</span> <span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_pop</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">codeUnwrapReturnValue</span><span class="o">(</span><span class="n">returnType</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">tryEnd</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

            <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">catchList</span> <span class="o">=</span> <span class="n">computeUniqueCatchList</span><span class="o">(</span><span class="n">exceptionTypes</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">catchList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex</span> <span class="o">:</span> <span class="n">catchList</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                        <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
                        <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getName</span><span class="o">()))));</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

                <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

                <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                    <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span> <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">)));</span>

                <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                    <span class="s">&#34;java/lang/reflect/UndeclaredThrowableException&#34;</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                    <span class="s">&#34;java/lang/reflect/UndeclaredThrowableException&#34;</span><span class="o">,</span>
                    <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/Throwable;)V&#34;</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;code size limit exceeded&#34;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
            <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">localSlot0</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
            <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">exceptionTypes</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exceptionTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                    <span class="n">dotToSlash</span><span class="o">(</span><span class="n">exceptionTypes</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">()));</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for wrapping an argument of the given type
</span><span class="cm">         * whose value can be found at the specified local variable
</span><span class="cm">         * index, in order for it to be passed (as an Object) to the
</span><span class="cm">         * invocation handler&#39;s &#34;invoke&#34; method.  The code is written
</span><span class="cm">         * to the supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeWrapArgument</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="o">,</span>
                                      <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">byte</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">char</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">code_iload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_lload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_fload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_dload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokestatic</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                    <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span>
                    <span class="s">&#34;valueOf&#34;</span><span class="o">,</span> <span class="n">prim</span><span class="o">.</span><span class="na">wrapperValueOfDesc</span><span class="o">));</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">code_aload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for unwrapping a return value of the given
</span><span class="cm">         * type from the invocation handler&#39;s &#34;invoke&#34; method (as type
</span><span class="cm">         * Object) to its correct type.  The code is written to the
</span><span class="cm">         * supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeUnwrapReturnValue</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_checkcast</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                    <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span>
                    <span class="n">prim</span><span class="o">.</span><span class="na">unwrapMethodName</span><span class="o">,</span> <span class="n">prim</span><span class="o">.</span><span class="na">unwrapMethodDesc</span><span class="o">));</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">byte</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">char</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ireturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_lreturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_freturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dreturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
                <span class="o">}</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_checkcast</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">())));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_areturn</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for initializing the static field that stores
</span><span class="cm">         * the Method object for this proxy method.  The code is written
</span><span class="cm">         * to the supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeFieldInitialization</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="n">codeClassForName</span><span class="o">(</span><span class="n">fromClass</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">code_ldc</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">methodName</span><span class="o">),</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">code_ipush</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_anewarray</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Class&#34;</span><span class="o">));</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                <span class="n">code_ipush</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span>
                        <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getstatic</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                        <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span> <span class="s">&#34;TYPE&#34;</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/Class;&#34;</span><span class="o">));</span>

                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">codeClassForName</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aastore</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/Class&#34;</span><span class="o">,</span>
                <span class="s">&#34;getMethod&#34;</span><span class="o">,</span>
                <span class="s">&#34;(Ljava/lang/String;[Ljava/lang/Class;)&#34;</span> <span class="o">+</span>
                <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_putstatic</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                <span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">),</span>
                <span class="n">methodFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate the constructor method for the proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateConstructor</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span>
            <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/reflect/InvocationHandler;)V&#34;</span><span class="o">,</span>
            <span class="n">ACC_PUBLIC</span><span class="o">);</span>

        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="n">superclassName</span><span class="o">,</span>
            <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/reflect/InvocationHandler;)V&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>

        <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate the static initializer method for the proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateStaticInitializer</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span>
            <span class="s">&#34;&lt;clinit&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;()V&#34;</span><span class="o">,</span> <span class="n">ACC_STATIC</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">localSlot0</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
        <span class="kt">short</span> <span class="n">pc</span><span class="o">,</span> <span class="n">tryBegin</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">;</span>

        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pm</span><span class="o">.</span><span class="na">codeFieldInitialization</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

        <span class="n">tryEnd</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
            <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoSuchMethodException&#34;</span><span class="o">)));</span>

        <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoSuchMethodError&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">,</span> <span class="s">&#34;getMessage&#34;</span><span class="o">,</span> <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="s">&#34;java/lang/NoSuchMethodError&#34;</span><span class="o">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)V&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
            <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/ClassNotFoundException&#34;</span><span class="o">)));</span>

        <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoClassDefFoundError&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">,</span> <span class="s">&#34;getMessage&#34;</span><span class="o">,</span> <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="s">&#34;java/lang/NoClassDefFoundError&#34;</span><span class="o">,</span>
            <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)V&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;code size limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">localSlot0</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>

        <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/*
</span><span class="cm">     * =============== Code Generation Utility Methods ===============
</span><span class="cm">     */</span>

    <span class="cm">/*
</span><span class="cm">     * The following methods generate code for the load or store operation
</span><span class="cm">     * indicated by their name for the given local variable.  The code is
</span><span class="cm">     * written to the supplied stream.
</span><span class="cm">     */</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_iload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_iload</span><span class="o">,</span> <span class="n">opc_iload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_lload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_lload</span><span class="o">,</span> <span class="n">opc_lload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_fload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_fload</span><span class="o">,</span> <span class="n">opc_fload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_dload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_dload</span><span class="o">,</span> <span class="n">opc_dload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_aload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_aload</span><span class="o">,</span> <span class="n">opc_aload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

<span class="c1">//  private void code_istore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_istore, opc_istore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_lstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_lstore, opc_lstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_fstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_fstore, opc_fstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_dstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_dstore, opc_dstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_astore</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_astore</span><span class="o">,</span> <span class="n">opc_astore_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code for a load or store instruction for the given local
</span><span class="cm">     * variable.  The code is written to the supplied stream.
</span><span class="cm">     *
</span><span class="cm">     * &#34;opcode&#34; indicates the opcode form of the desired load or store
</span><span class="cm">     * instruction that takes an explicit local variable index, and
</span><span class="cm">     * &#34;opcode_0&#34; indicates the corresponding form of the instruction
</span><span class="cm">     * with the implicit index 0.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeLocalLoadStore</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="kt">int</span> <span class="n">opcode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">opcode_0</span><span class="o">,</span>
                                    <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">assert</span> <span class="n">lvar</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">0xFFFF</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode_0</span> <span class="o">+</span> <span class="n">lvar</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">0xFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">lvar</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Use the &#34;wide&#34; instruction modifier for local variable
</span><span class="cm">             * indexes that do not fit into an unsigned byte.
</span><span class="cm">             */</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_wide</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">lvar</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code for an &#34;ldc&#34; instruction for the given constant pool
</span><span class="cm">     * index (the &#34;ldc_w&#34; instruction is used if the index does not fit
</span><span class="cm">     * into an unsigned byte).  The code is written to the supplied stream.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_ldc</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">assert</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">0xFFFF</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">0xFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ldc</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ldc_w</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code to push a constant integer value on to the operand
</span><span class="cm">     * stack, using the &#34;iconst_&lt;i&gt;&#34;, &#34;bipush&#34;, or &#34;sipush&#34; instructions
</span><span class="cm">     * depending on the size of the value.  The code is written to the
</span><span class="cm">     * supplied stream.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_ipush</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_iconst_0</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MIN_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_bipush</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">Short</span><span class="o">.</span><span class="na">MIN_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">Short</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_sipush</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code to invoke the Class.forName with the name of the given
</span><span class="cm">     * class to get its Class object at runtime.  The code is written to
</span><span class="cm">     * the supplied stream.  Note that the code generated by this method
</span><span class="cm">     * may caused the checked ClassNotFoundException to be thrown.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeClassForName</span><span class="o">(</span><span class="n">Class</span> <span class="n">cl</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">code_ldc</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">cl</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokestatic</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
            <span class="s">&#34;java/lang/Class&#34;</span><span class="o">,</span>
            <span class="s">&#34;forName&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)Ljava/lang/Class;&#34;</span><span class="o">));</span>
    <span class="o">}</span>


    <span class="cm">/*
</span><span class="cm">     * ==================== General Utility Methods ====================
</span><span class="cm">     */</span>

    <span class="cm">/**
</span><span class="cm">     * Convert a fully qualified class name that uses &#39;.&#39; as the package
</span><span class="cm">     * separator, the external representation used by the Java language
</span><span class="cm">     * and APIs, to a fully qualified class name that uses &#39;/&#39; as the
</span><span class="cm">     * package separator, the representation used in the class file
</span><span class="cm">     * format (see JVMS section 4.2).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">dotToSlash</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the &#34;method descriptor&#34; string for a method with the given
</span><span class="cm">     * parameter types and return type.  See JVMS section 4.3.3.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getMethodDescriptor</span><span class="o">(</span><span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                                              <span class="n">Class</span> <span class="n">returnType</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">getParameterDescriptors</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
            <span class="o">((</span><span class="n">returnType</span> <span class="o">==</span> <span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">?</span> <span class="s">&#34;V&#34;</span> <span class="o">:</span> <span class="n">getFieldType</span><span class="o">(</span><span class="n">returnType</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the list of &#34;parameter descriptor&#34; strings enclosed in
</span><span class="cm">     * parentheses corresponding to the given parameter types (in other
</span><span class="cm">     * words, a method descriptor without a return descriptor).  This
</span><span class="cm">     * string is useful for constructing string keys for methods without
</span><span class="cm">     * regard to their return type.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getParameterDescriptors</span><span class="o">(</span><span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&#34;(&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">desc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">getFieldType</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]));</span>
        <span class="o">}</span>
        <span class="n">desc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">desc</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the &#34;field type&#34; string for the given type, appropriate for
</span><span class="cm">     * a field descriptor, a parameter descriptor, or a return descriptor
</span><span class="cm">     * other than &#34;void&#34;.  See JVMS section 4.3.2.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFieldType</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">baseTypeString</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * According to JLS 20.3.2, the getName() method on Class does
</span><span class="cm">             * return the VM type descriptor format for array classes (only);
</span><span class="cm">             * using that should be quicker than the otherwise obvious code:
</span><span class="cm">             *
</span><span class="cm">             *     return &#34;[&#34; + getTypeDescriptor(type.getComponentType());
</span><span class="cm">             */</span>
            <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&#34;L&#34;</span> <span class="o">+</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span> <span class="o">+</span> <span class="s">&#34;;&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Returns a human-readable string representing the signature of a
</span><span class="cm">     * method with the given name and parameter types.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                                                     <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;(&#39;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Class</span> <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">dimensions</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">();</span>
                <span class="n">dimensions</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">dimensions</span><span class="o">--</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;[]&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sig</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the number of abstract &#34;words&#34;, or consecutive local variable
</span><span class="cm">     * indexes, required to contain a value of the given type.  See JVMS
</span><span class="cm">     * section 3.6.1.
</span><span class="cm">     *
</span><span class="cm">     * Note that the original version of the JVMS contained a definition of
</span><span class="cm">     * this abstract notion of a &#34;word&#34; in section 3.4, but that definition
</span><span class="cm">     * was removed for the second edition.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getWordsPerType</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Add to the given list all of the types in the &#34;from&#34; array that
</span><span class="cm">     * are not already contained in the list and are assignable to at
</span><span class="cm">     * least one of the types in the &#34;with&#34; array.
</span><span class="cm">     *
</span><span class="cm">     * This method is useful for computing the greatest common set of
</span><span class="cm">     * declared exceptions from duplicate methods inherited from
</span><span class="cm">     * different interfaces.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">collectCompatibleTypes</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">from</span><span class="o">,</span>
                                               <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">with</span><span class="o">,</span>
                                               <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">list</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">from</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">list</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">with</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">with</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Given the exceptions declared in the throws clause of a proxy method,
</span><span class="cm">     * compute the exceptions that need to be caught from the invocation
</span><span class="cm">     * handler&#39;s invoke method and rethrown intact in the method&#39;s
</span><span class="cm">     * implementation before catching other Throwables and wrapping them
</span><span class="cm">     * in UndeclaredThrowableExceptions.
</span><span class="cm">     *
</span><span class="cm">     * The exceptions to be caught are returned in a List object.  Each
</span><span class="cm">     * exception in the returned list is guaranteed to not be a subclass of
</span><span class="cm">     * any of the other exceptions in the list, so the catch blocks for
</span><span class="cm">     * these exceptions may be generated in any order relative to each other.
</span><span class="cm">     *
</span><span class="cm">     * Error and RuntimeException are each always contained by the returned
</span><span class="cm">     * list (if none of their superclasses are contained), since those
</span><span class="cm">     * unchecked exceptions should always be rethrown intact, and thus their
</span><span class="cm">     * subclasses will never appear in the returned list.
</span><span class="cm">     *
</span><span class="cm">     * The returned List will be empty if java.lang.Throwable is in the
</span><span class="cm">     * given list of declared exceptions, indicating that no exceptions
</span><span class="cm">     * need to be caught.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">computeUniqueCatchList</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">exceptions</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">uniqueList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
                                                <span class="c1">// unique exceptions to catch
</span><span class="c1"></span>
        <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Error</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>            <span class="c1">// always catch/rethrow these
</span><span class="c1"></span>        <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="nl">
</span><span class="nl">
</span><span class="nl">    nextException:</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exceptions</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">Throwable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="cm">/*
</span><span class="cm">                 * If Throwable is declared to be thrown by the proxy method,
</span><span class="cm">                 * then no catch blocks are necessary, because the invoke
</span><span class="cm">                 * can, at most, throw Throwable anyway.
</span><span class="cm">                 */</span>
                <span class="n">uniqueList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">Throwable</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex</span><span class="o">))</span> <span class="o">{</span>
                <span class="cm">/*
</span><span class="cm">                 * Ignore types that cannot be thrown by the invoke method.
</span><span class="cm">                 */</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="cm">/*
</span><span class="cm">             * Compare this exception against the current list of
</span><span class="cm">             * exceptions that need to be caught:
</span><span class="cm">             */</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">uniqueList</span><span class="o">.</span><span class="na">size</span><span class="o">();)</span> <span class="o">{</span>
                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex2</span> <span class="o">=</span> <span class="n">uniqueList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ex2</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex</span><span class="o">))</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * if a superclass of this exception is already on
</span><span class="cm">                     * the list to catch, then ignore this one and continue;
</span><span class="cm">                     */</span>
                    <span class="k">continue</span> <span class="n">nextException</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex2</span><span class="o">))</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * if a subclass of this exception is on the list
</span><span class="cm">                     * to catch, then remove it;
</span><span class="cm">                     */</span>
                    <span class="n">uniqueList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">j</span><span class="o">++;</span>        <span class="c1">// else continue comparing.
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// This exception is unique (so far): add it to the list to catch.
</span><span class="c1"></span>            <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">uniqueList</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A PrimitiveTypeInfo object contains assorted information about
</span><span class="cm">     * a primitive type in its public fields.  The struct for a particular
</span><span class="cm">     * primitive type can be obtained using the static &#34;get&#34; method.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PrimitiveTypeInfo</span> <span class="o">{</span>

        <span class="cm">/** &#34;base type&#34; used in various descriptors (see JVMS section 4.3.2) */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">baseTypeString</span><span class="o">;</span>

        <span class="cm">/** name of corresponding wrapper class */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">wrapperClassName</span><span class="o">;</span>

        <span class="cm">/** method descriptor for wrapper class &#34;valueOf&#34; factory method */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">wrapperValueOfDesc</span><span class="o">;</span>

        <span class="cm">/** name of wrapper class method for retrieving primitive value */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">unwrapMethodName</span><span class="o">;</span>

        <span class="cm">/** descriptor of same method */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">unwrapMethodDesc</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span><span class="n">PrimitiveTypeInfo</span><span class="o">&gt;</span> <span class="n">table</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span><span class="n">PrimitiveTypeInfo</span><span class="o">&gt;();</span>
        <span class="kd">static</span> <span class="o">{</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">byte</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">char</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Character</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Double</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Float</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Class</span> <span class="n">primitiveClass</span><span class="o">,</span> <span class="n">Class</span> <span class="n">wrapperClass</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">table</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span>
                      <span class="k">new</span> <span class="n">PrimitiveTypeInfo</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span> <span class="n">wrapperClass</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nf">PrimitiveTypeInfo</span><span class="o">(</span><span class="n">Class</span> <span class="n">primitiveClass</span><span class="o">,</span> <span class="n">Class</span> <span class="n">wrapperClass</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">assert</span> <span class="n">primitiveClass</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">();</span>

            <span class="n">baseTypeString</span> <span class="o">=</span>
                <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span> <span class="n">0</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
            <span class="n">wrapperClassName</span> <span class="o">=</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">wrapperClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">wrapperValueOfDesc</span> <span class="o">=</span>
                <span class="s">&#34;(&#34;</span> <span class="o">+</span> <span class="n">baseTypeString</span> <span class="o">+</span> <span class="s">&#34;)L&#34;</span> <span class="o">+</span> <span class="n">wrapperClassName</span> <span class="o">+</span> <span class="s">&#34;;&#34;</span><span class="o">;</span>
            <span class="n">unwrapMethodName</span> <span class="o">=</span> <span class="n">primitiveClass</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;Value&#34;</span><span class="o">;</span>
            <span class="n">unwrapMethodDesc</span> <span class="o">=</span> <span class="s">&#34;()&#34;</span> <span class="o">+</span> <span class="n">baseTypeString</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">PrimitiveTypeInfo</span> <span class="nf">get</span><span class="o">(</span><span class="n">Class</span> <span class="n">cl</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**
</span><span class="cm">     * A ConstantPool object represents the constant pool of a class file
</span><span class="cm">     * being generated.  This representation of a constant pool is designed
</span><span class="cm">     * specifically for use by ProxyGenerator; in particular, it assumes
</span><span class="cm">     * that constant pool entries will not need to be resorted (for example,
</span><span class="cm">     * by their type, as the Java compiler does), so that the final index
</span><span class="cm">     * value can be assigned and used when an entry is first created.
</span><span class="cm">     *
</span><span class="cm">     * Note that new entries cannot be created after the constant pool has
</span><span class="cm">     * been written to a class file.  To prevent such logic errors, a
</span><span class="cm">     * ConstantPool instance can be marked &#34;read only&#34;, so that further
</span><span class="cm">     * attempts to add new entries will fail with a runtime exception.
</span><span class="cm">     *
</span><span class="cm">     * See JVMS section 4.4 for more information about the constant pool
</span><span class="cm">     * of a class file.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConstantPool</span> <span class="o">{</span>

        <span class="cm">/**
</span><span class="cm">         * list of constant pool entries, in constant pool index order.
</span><span class="cm">         *
</span><span class="cm">         * This list is used when writing the constant pool to a stream
</span><span class="cm">         * and for assigning the next index value.  Note that element 0
</span><span class="cm">         * of this list corresponds to constant pool index 1.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;(</span><span class="n">32</span><span class="o">);</span>

        <span class="cm">/**
</span><span class="cm">         * maps constant pool data of all types to constant pool indexes.
</span><span class="cm">         *
</span><span class="cm">         * This map is used to look up the index of an existing entry for
</span><span class="cm">         * values of all types.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Short</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Short</span><span class="o">&gt;(</span><span class="n">16</span><span class="o">);</span>

        <span class="cm">/** true if no new constant pool entries may be added */</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">readOnly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Utf8 entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getUtf8</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Integer entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getInteger</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Float entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getFloat</span><span class="o">(</span><span class="kt">float</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Float</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Class entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">utf8Index</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_CLASS</span><span class="o">,</span> <span class="n">utf8Index</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_String entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getString</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">utf8Index</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_STRING</span><span class="o">,</span> <span class="n">utf8Index</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_FieldRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getFieldRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span>
                                 <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_FIELD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_MethodRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getMethodRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span>
                                  <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_METHOD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_InterfaceMethodRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getInterfaceMethodRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                                           <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_INTERFACEMETHOD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_NameAndType entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getNameAndType</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">nameIndex</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">descriptorIndex</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                <span class="n">CONSTANT_NAMEANDTYPE</span><span class="o">,</span> <span class="n">nameIndex</span><span class="o">,</span> <span class="n">descriptorIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Set this ConstantPool instance to be &#34;read only&#34;.
</span><span class="cm">         *
</span><span class="cm">         * After this method has been called, further requests to get
</span><span class="cm">         * an index for a non-existent entry will cause an InternalError
</span><span class="cm">         * to be thrown instead of creating of the entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReadOnly</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Write this constant pool to a stream as part of
</span><span class="cm">         * the class file format.
</span><span class="cm">         *
</span><span class="cm">         * This consists of writing the &#34;constant_pool_count&#34; and
</span><span class="cm">         * &#34;constant_pool[]&#34; items of the &#34;ClassFile&#34; structure, as
</span><span class="cm">         * described in JVMS section 4.1.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">DataOutputStream</span> <span class="n">dataOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

            <span class="c1">// constant_pool_count: number of entries plus one
</span><span class="c1"></span>            <span class="n">dataOut</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span> <span class="n">e</span> <span class="o">:</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dataOut</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Add a new constant pool entry and return its index.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">addEntry</span><span class="o">(</span><span class="n">Entry</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pool</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
            <span class="cm">/*
</span><span class="cm">             * Note that this way of determining the index of the
</span><span class="cm">             * added entry is wrong if this pool supports
</span><span class="cm">             * CONSTANT_Long or CONSTANT_Double entries.
</span><span class="cm">             */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&#34;constant pool size limit exceeded&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for an entry of a type that contains
</span><span class="cm">         * a direct value.  The type of the given object determines the
</span><span class="cm">         * type of the desired entry as follows:
</span><span class="cm">         *
</span><span class="cm">         *      java.lang.String        CONSTANT_Utf8
</span><span class="cm">         *      java.lang.Integer       CONSTANT_Integer
</span><span class="cm">         *      java.lang.Float         CONSTANT_Float
</span><span class="cm">         *      java.lang.Long          CONSTANT_Long
</span><span class="cm">         *      java.lang.Double        CONSTANT_DOUBLE
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Short</span> <span class="n">index</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="na">shortValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">readOnly</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span>
                        <span class="s">&#34;late constant pool addition: &#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="n">addEntry</span><span class="o">(</span><span class="k">new</span> <span class="n">ValueEntry</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="n">Short</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for an entry of a type that contains
</span><span class="cm">         * references to other constant pool entries.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">getIndirect</span><span class="o">(</span><span class="n">IndirectEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Short</span> <span class="n">index</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="na">shortValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">readOnly</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;late constant pool addition&#34;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="n">addEntry</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="k">new</span> <span class="n">Short</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Entry is the abstact superclass of all constant pool entry types
</span><span class="cm">         * that can be stored in the &#34;pool&#34; list; its purpose is to define a
</span><span class="cm">         * common method for writing constant pool entries to a class file.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * ValueEntry represents a constant pool entry of a type that
</span><span class="cm">         * contains a direct value (see the comments for the &#34;getValue&#34;
</span><span class="cm">         * method for a list of such types).
</span><span class="cm">         *
</span><span class="cm">         * ValueEntry objects are not used as keys for their entries in the
</span><span class="cm">         * Map &#34;map&#34;, so no useful hashCode or equals methods are defined.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ValueEntry</span> <span class="kd">extends</span> <span class="n">Entry</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">ValueEntry</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_UTF8</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Integer</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_INTEGER</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Float</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_FLOAT</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeFloat</span><span class="o">(((</span><span class="n">Float</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">floatValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Long</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_LONG</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(((</span><span class="n">Long</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">longValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Double</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(</span><span class="n">CONSTANT_DOUBLE</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(((</span><span class="n">Double</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;bogus value entry: &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * IndirectEntry represents a constant pool entry of a type that
</span><span class="cm">         * references other constant pool entries, i.e., the following types:
</span><span class="cm">         *
</span><span class="cm">         *      CONSTANT_Class, CONSTANT_String, CONSTANT_Fieldref,
</span><span class="cm">         *      CONSTANT_Methodref, CONSTANT_InterfaceMethodref, and
</span><span class="cm">         *      CONSTANT_NameAndType.
</span><span class="cm">         *
</span><span class="cm">         * Each of these entry types contains either one or two indexes of
</span><span class="cm">         * other constant pool entries.
</span><span class="cm">         *
</span><span class="cm">         * IndirectEntry objects are used as the keys for their entries in
</span><span class="cm">         * the Map &#34;map&#34;, so the hashCode and equals methods are overridden
</span><span class="cm">         * to allow matching.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IndirectEntry</span> <span class="kd">extends</span> <span class="n">Entry</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kt">int</span> <span class="n">tag</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">short</span> <span class="n">index0</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">short</span> <span class="n">index1</span><span class="o">;</span>

            <span class="cm">/**
</span><span class="cm">             * Construct an IndirectEntry for a constant pool entry type
</span><span class="cm">             * that contains one index of another entry.
</span><span class="cm">             */</span>
            <span class="kd">public</span> <span class="nf">IndirectEntry</span><span class="o">(</span><span class="kt">int</span> <span class="n">tag</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index0</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index1</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="cm">/**
</span><span class="cm">             * Construct an IndirectEntry for a constant pool entry type
</span><span class="cm">             * that contains two indexes for other entries.
</span><span class="cm">             */</span>
            <span class="kd">public</span> <span class="nf">IndirectEntry</span><span class="o">(</span><span class="kt">int</span> <span class="n">tag</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index0</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index0</span> <span class="o">=</span> <span class="n">index0</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">tag</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index0</span><span class="o">);</span>
                <span class="cm">/*
</span><span class="cm">                 * If this entry type contains two indexes, write
</span><span class="cm">                 * out the second, too.
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_FIELD</span> <span class="o">||</span>
                    <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_METHOD</span> <span class="o">||</span>
                    <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_INTERFACEMETHOD</span> <span class="o">||</span>
                    <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_NAMEANDTYPE</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">index0</span> <span class="o">+</span> <span class="n">index1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">IndirectEntry</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">IndirectEntry</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">IndirectEntry</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">tag</span> <span class="o">&amp;&amp;</span>
                        <span class="n">index0</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">index0</span> <span class="o">&amp;&amp;</span> <span class="n">index1</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">index1</span><span class="o">)</span>
                    <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>To have an intuitive understanding of the generated class file, we turn on the option of <strong>saveGeneratedFiles</strong>.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Target.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Target</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">foo</span><span class="o">();</span>
<span class="o">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// TargetProxyInvocationHandler.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TargetProxyInvocationHandler</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="s">&#34;foo&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;foo invoked&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Main.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span><span class="o">,</span><span class="s">&#34;true&#34;</span><span class="o">);</span>
        <span class="n">Target</span> <span class="n">b</span> <span class="o">=</span> <span class="o">(</span><span class="n">Target</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">TargetProxyInvocationHandler</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">b</span><span class="o">.</span><span class="na">foo</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>And now we can find the generated Proxy class file:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Proxy.class
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">com.sun.proxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dynamicproxy.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.UndeclaredThrowableException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">$Proxy0</span> <span class="kd">extends</span> <span class="n">Proxy</span> <span class="kd">implements</span> <span class="n">Target</span> <span class="o">{</span>
	 <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">m0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">m1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">m2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">m3</span><span class="o">;</span>
    
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">m0</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;equals&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">)});</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
            <span class="n">m3</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;dynamicproxy.Target&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;foo&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchMethodError</span><span class="o">(</span><span class="n">var2</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoClassDefFoundError</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">$Proxy0</span><span class="o">(</span><span class="n">InvocationHandler</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">Integer</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m0</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">)).</span><span class="na">intValue</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">Boolean</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m1</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">})).</span><span class="na">booleanValue</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var3</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m3</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h1 id="implement-dynamic-proxy-supporting-class">Implement Dynamic Proxy supporting Class</h1>

<p>A restriction of the Proxy provided by JDK is that we can only get a proxy for an interface rather than a class.</p>

<p>But can we implement this feature on our own?</p>

<p>Obviously, we need to modify ProxyGenerator to control the generation of the final class as our expectation.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">dynamicproxy.supportclass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Array</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ListIterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">sun.security.action.GetBooleanAction</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * ProxyGeneratorEx contains the code to generate a dynamic proxy class
</span><span class="cm"> * for any class.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyGeneratorEx</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * In the comments below, &#34;JVMS&#34; refers to The Java Virtual Machine
</span><span class="cm">     * Specification Second Edition and &#34;JLS&#34; refers to the original
</span><span class="cm">     * version of The Java Language Specification, unless otherwise
</span><span class="cm">     * specified.
</span><span class="cm">     */</span>

    <span class="cm">/* generate 1.5-era class file version */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CLASSFILE_MAJOR_VERSION</span> <span class="o">=</span> <span class="n">49</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CLASSFILE_MINOR_VERSION</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="cm">/*
</span><span class="cm">     * beginning of constants copied from
</span><span class="cm">     * sun.tools.java.RuntimeConstants (which no longer exists):
</span><span class="cm">     */</span>

    <span class="cm">/* constant pool tags */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_UTF8</span>              <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_UNICODE</span>           <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_INTEGER</span>           <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_FLOAT</span>             <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_LONG</span>              <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_DOUBLE</span>            <span class="o">=</span> <span class="n">6</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_CLASS</span>             <span class="o">=</span> <span class="n">7</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_STRING</span>            <span class="o">=</span> <span class="n">8</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_FIELD</span>             <span class="o">=</span> <span class="n">9</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_METHOD</span>            <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_INTERFACEMETHOD</span>   <span class="o">=</span> <span class="n">11</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CONSTANT_NAMEANDTYPE</span>       <span class="o">=</span> <span class="n">12</span><span class="o">;</span>

    <span class="cm">/* access and modifier flags */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_PUBLIC</span>                 <span class="o">=</span> <span class="n">0x00000001</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_PRIVATE</span>                <span class="o">=</span> <span class="n">0x00000002</span><span class="o">;</span>
    <span class="c1">//  private static final int ACC_PROTECTED              = 0x00000004;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_STATIC</span>                 <span class="o">=</span> <span class="n">0x00000008</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_FINAL</span>                  <span class="o">=</span> <span class="n">0x00000010</span><span class="o">;</span>
    <span class="c1">//  private static final int ACC_SYNCHRONIZED           = 0x00000020;
</span><span class="c1">//  private static final int ACC_VOLATILE               = 0x00000040;
</span><span class="c1">//  private static final int ACC_TRANSIENT              = 0x00000080;
</span><span class="c1">//  private static final int ACC_NATIVE                 = 0x00000100;
</span><span class="c1">//  private static final int ACC_INTERFACE              = 0x00000200;
</span><span class="c1">//  private static final int ACC_ABSTRACT               = 0x00000400;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ACC_SUPER</span>                  <span class="o">=</span> <span class="n">0x00000020</span><span class="o">;</span>
<span class="c1">//  private static final int ACC_STRICT                 = 0x00000800;
</span><span class="c1"></span>
    <span class="cm">/* opcodes */</span>
<span class="c1">//  private static final int opc_nop                    = 0;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aconst_null</span>            <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_iconst_m1              = 2;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iconst_0</span>               <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_iconst_1               = 4;
</span><span class="c1">//  private static final int opc_iconst_2               = 5;
</span><span class="c1">//  private static final int opc_iconst_3               = 6;
</span><span class="c1">//  private static final int opc_iconst_4               = 7;
</span><span class="c1">//  private static final int opc_iconst_5               = 8;
</span><span class="c1">//  private static final int opc_lconst_0               = 9;
</span><span class="c1">//  private static final int opc_lconst_1               = 10;
</span><span class="c1">//  private static final int opc_fconst_0               = 11;
</span><span class="c1">//  private static final int opc_fconst_1               = 12;
</span><span class="c1">//  private static final int opc_fconst_2               = 13;
</span><span class="c1">//  private static final int opc_dconst_0               = 14;
</span><span class="c1">//  private static final int opc_dconst_1               = 15;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_bipush</span>                 <span class="o">=</span> <span class="n">16</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_sipush</span>                 <span class="o">=</span> <span class="n">17</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ldc</span>                    <span class="o">=</span> <span class="n">18</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ldc_w</span>                  <span class="o">=</span> <span class="n">19</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_ldc2_w                 = 20;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iload</span>                  <span class="o">=</span> <span class="n">21</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lload</span>                  <span class="o">=</span> <span class="n">22</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_fload</span>                  <span class="o">=</span> <span class="n">23</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dload</span>                  <span class="o">=</span> <span class="n">24</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aload</span>                  <span class="o">=</span> <span class="n">25</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_iload_0</span>                <span class="o">=</span> <span class="n">26</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_iload_1                = 27;
</span><span class="c1">//  private static final int opc_iload_2                = 28;
</span><span class="c1">//  private static final int opc_iload_3                = 29;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lload_0</span>                <span class="o">=</span> <span class="n">30</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_lload_1                = 31;
</span><span class="c1">//  private static final int opc_lload_2                = 32;
</span><span class="c1">//  private static final int opc_lload_3                = 33;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_fload_0</span>                <span class="o">=</span> <span class="n">34</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_fload_1                = 35;
</span><span class="c1">//  private static final int opc_fload_2                = 36;
</span><span class="c1">//  private static final int opc_fload_3                = 37;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dload_0</span>                <span class="o">=</span> <span class="n">38</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_dload_1                = 39;
</span><span class="c1">//  private static final int opc_dload_2                = 40;
</span><span class="c1">//  private static final int opc_dload_3                = 41;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aload_0</span>                <span class="o">=</span> <span class="n">42</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_aload_1                = 43;
</span><span class="c1">//  private static final int opc_aload_2                = 44;
</span><span class="c1">//  private static final int opc_aload_3                = 45;
</span><span class="c1">//  private static final int opc_iaload                 = 46;
</span><span class="c1">//  private static final int opc_laload                 = 47;
</span><span class="c1">//  private static final int opc_faload                 = 48;
</span><span class="c1">//  private static final int opc_daload                 = 49;
</span><span class="c1">//  private static final int opc_aaload                 = 50;
</span><span class="c1">//  private static final int opc_baload                 = 51;
</span><span class="c1">//  private static final int opc_caload                 = 52;
</span><span class="c1">//  private static final int opc_saload                 = 53;
</span><span class="c1">//  private static final int opc_istore                 = 54;
</span><span class="c1">//  private static final int opc_lstore                 = 55;
</span><span class="c1">//  private static final int opc_fstore                 = 56;
</span><span class="c1">//  private static final int opc_dstore                 = 57;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_astore</span>                 <span class="o">=</span> <span class="n">58</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_istore_0               = 59;
</span><span class="c1">//  private static final int opc_istore_1               = 60;
</span><span class="c1">//  private static final int opc_istore_2               = 61;
</span><span class="c1">//  private static final int opc_istore_3               = 62;
</span><span class="c1">//  private static final int opc_lstore_0               = 63;
</span><span class="c1">//  private static final int opc_lstore_1               = 64;
</span><span class="c1">//  private static final int opc_lstore_2               = 65;
</span><span class="c1">//  private static final int opc_lstore_3               = 66;
</span><span class="c1">//  private static final int opc_fstore_0               = 67;
</span><span class="c1">//  private static final int opc_fstore_1               = 68;
</span><span class="c1">//  private static final int opc_fstore_2               = 69;
</span><span class="c1">//  private static final int opc_fstore_3               = 70;
</span><span class="c1">//  private static final int opc_dstore_0               = 71;
</span><span class="c1">//  private static final int opc_dstore_1               = 72;
</span><span class="c1">//  private static final int opc_dstore_2               = 73;
</span><span class="c1">//  private static final int opc_dstore_3               = 74;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_astore_0</span>               <span class="o">=</span> <span class="n">75</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_astore_1               = 76;
</span><span class="c1">//  private static final int opc_astore_2               = 77;
</span><span class="c1">//  private static final int opc_astore_3               = 78;
</span><span class="c1">//  private static final int opc_iastore                = 79;
</span><span class="c1">//  private static final int opc_lastore                = 80;
</span><span class="c1">//  private static final int opc_fastore                = 81;
</span><span class="c1">//  private static final int opc_dastore                = 82;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_aastore</span>                <span class="o">=</span> <span class="n">83</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_bastore                = 84;
</span><span class="c1">//  private static final int opc_castore                = 85;
</span><span class="c1">//  private static final int opc_sastore                = 86;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_pop</span>                    <span class="o">=</span> <span class="n">87</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_pop2                   = 88;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dup</span>                    <span class="o">=</span> <span class="n">89</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_dup_x1                 = 90;
</span><span class="c1">//  private static final int opc_dup_x2                 = 91;
</span><span class="c1">//  private static final int opc_dup2                   = 92;
</span><span class="c1">//  private static final int opc_dup2_x1                = 93;
</span><span class="c1">//  private static final int opc_dup2_x2                = 94;
</span><span class="c1">//  private static final int opc_swap                   = 95;
</span><span class="c1">//  private static final int opc_iadd                   = 96;
</span><span class="c1">//  private static final int opc_ladd                   = 97;
</span><span class="c1">//  private static final int opc_fadd                   = 98;
</span><span class="c1">//  private static final int opc_dadd                   = 99;
</span><span class="c1">//  private static final int opc_isub                   = 100;
</span><span class="c1">//  private static final int opc_lsub                   = 101;
</span><span class="c1">//  private static final int opc_fsub                   = 102;
</span><span class="c1">//  private static final int opc_dsub                   = 103;
</span><span class="c1">//  private static final int opc_imul                   = 104;
</span><span class="c1">//  private static final int opc_lmul                   = 105;
</span><span class="c1">//  private static final int opc_fmul                   = 106;
</span><span class="c1">//  private static final int opc_dmul                   = 107;
</span><span class="c1">//  private static final int opc_idiv                   = 108;
</span><span class="c1">//  private static final int opc_ldiv                   = 109;
</span><span class="c1">//  private static final int opc_fdiv                   = 110;
</span><span class="c1">//  private static final int opc_ddiv                   = 111;
</span><span class="c1">//  private static final int opc_irem                   = 112;
</span><span class="c1">//  private static final int opc_lrem                   = 113;
</span><span class="c1">//  private static final int opc_frem                   = 114;
</span><span class="c1">//  private static final int opc_drem                   = 115;
</span><span class="c1">//  private static final int opc_ineg                   = 116;
</span><span class="c1">//  private static final int opc_lneg                   = 117;
</span><span class="c1">//  private static final int opc_fneg                   = 118;
</span><span class="c1">//  private static final int opc_dneg                   = 119;
</span><span class="c1">//  private static final int opc_ishl                   = 120;
</span><span class="c1">//  private static final int opc_lshl                   = 121;
</span><span class="c1">//  private static final int opc_ishr                   = 122;
</span><span class="c1">//  private static final int opc_lshr                   = 123;
</span><span class="c1">//  private static final int opc_iushr                  = 124;
</span><span class="c1">//  private static final int opc_lushr                  = 125;
</span><span class="c1">//  private static final int opc_iand                   = 126;
</span><span class="c1">//  private static final int opc_land                   = 127;
</span><span class="c1">//  private static final int opc_ior                    = 128;
</span><span class="c1">//  private static final int opc_lor                    = 129;
</span><span class="c1">//  private static final int opc_ixor                   = 130;
</span><span class="c1">//  private static final int opc_lxor                   = 131;
</span><span class="c1">//  private static final int opc_iinc                   = 132;
</span><span class="c1">//  private static final int opc_i2l                    = 133;
</span><span class="c1">//  private static final int opc_i2f                    = 134;
</span><span class="c1">//  private static final int opc_i2d                    = 135;
</span><span class="c1">//  private static final int opc_l2i                    = 136;
</span><span class="c1">//  private static final int opc_l2f                    = 137;
</span><span class="c1">//  private static final int opc_l2d                    = 138;
</span><span class="c1">//  private static final int opc_f2i                    = 139;
</span><span class="c1">//  private static final int opc_f2l                    = 140;
</span><span class="c1">//  private static final int opc_f2d                    = 141;
</span><span class="c1">//  private static final int opc_d2i                    = 142;
</span><span class="c1">//  private static final int opc_d2l                    = 143;
</span><span class="c1">//  private static final int opc_d2f                    = 144;
</span><span class="c1">//  private static final int opc_i2b                    = 145;
</span><span class="c1">//  private static final int opc_i2c                    = 146;
</span><span class="c1">//  private static final int opc_i2s                    = 147;
</span><span class="c1">//  private static final int opc_lcmp                   = 148;
</span><span class="c1">//  private static final int opc_fcmpl                  = 149;
</span><span class="c1">//  private static final int opc_fcmpg                  = 150;
</span><span class="c1">//  private static final int opc_dcmpl                  = 151;
</span><span class="c1">//  private static final int opc_dcmpg                  = 152;
</span><span class="c1">//  private static final int opc_ifeq                   = 153;
</span><span class="c1">//  private static final int opc_ifne                   = 154;
</span><span class="c1">//  private static final int opc_iflt                   = 155;
</span><span class="c1">//  private static final int opc_ifge                   = 156;
</span><span class="c1">//  private static final int opc_ifgt                   = 157;
</span><span class="c1">//  private static final int opc_ifle                   = 158;
</span><span class="c1">//  private static final int opc_if_icmpeq              = 159;
</span><span class="c1">//  private static final int opc_if_icmpne              = 160;
</span><span class="c1">//  private static final int opc_if_icmplt              = 161;
</span><span class="c1">//  private static final int opc_if_icmpge              = 162;
</span><span class="c1">//  private static final int opc_if_icmpgt              = 163;
</span><span class="c1">//  private static final int opc_if_icmple              = 164;
</span><span class="c1">//  private static final int opc_if_acmpeq              = 165;
</span><span class="c1">//  private static final int opc_if_acmpne              = 166;
</span><span class="c1">//  private static final int opc_goto                   = 167;
</span><span class="c1">//  private static final int opc_jsr                    = 168;
</span><span class="c1">//  private static final int opc_ret                    = 169;
</span><span class="c1">//  private static final int opc_tableswitch            = 170;
</span><span class="c1">//  private static final int opc_lookupswitch           = 171;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_ireturn</span>                <span class="o">=</span> <span class="n">172</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_lreturn</span>                <span class="o">=</span> <span class="n">173</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_freturn</span>                <span class="o">=</span> <span class="n">174</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_dreturn</span>                <span class="o">=</span> <span class="n">175</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_areturn</span>                <span class="o">=</span> <span class="n">176</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_return</span>                 <span class="o">=</span> <span class="n">177</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_getstatic</span>              <span class="o">=</span> <span class="n">178</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_putstatic</span>              <span class="o">=</span> <span class="n">179</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_getfield</span>               <span class="o">=</span> <span class="n">180</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_putfield</span>               <span class="o">=</span> <span class="n">181</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokevirtual</span>          <span class="o">=</span> <span class="n">182</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokespecial</span>          <span class="o">=</span> <span class="n">183</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokestatic</span>           <span class="o">=</span> <span class="n">184</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_invokeinterface</span>        <span class="o">=</span> <span class="n">185</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_new</span>                    <span class="o">=</span> <span class="n">187</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_newarray               = 188;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_anewarray</span>              <span class="o">=</span> <span class="n">189</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_arraylength            = 190;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_athrow</span>                 <span class="o">=</span> <span class="n">191</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_checkcast</span>              <span class="o">=</span> <span class="n">192</span><span class="o">;</span>
    <span class="c1">//  private static final int opc_instanceof             = 193;
</span><span class="c1">//  private static final int opc_monitorenter           = 194;
</span><span class="c1">//  private static final int opc_monitorexit            = 195;
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">opc_wide</span>                   <span class="o">=</span> <span class="n">196</span><span class="o">;</span>
<span class="c1">//  private static final int opc_multianewarray         = 197;
</span><span class="c1">//  private static final int opc_ifnull                 = 198;
</span><span class="c1">//  private static final int opc_ifnonnull              = 199;
</span><span class="c1">//  private static final int opc_goto_w                 = 200;
</span><span class="c1">//  private static final int opc_jsr_w                  = 201;
</span><span class="c1"></span>
    <span class="c1">// end of constants copied from sun.tools.java.RuntimeConstants
</span><span class="c1"></span>
    <span class="cm">/** name of the superclass of proxy classes */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">superclassName</span><span class="o">;</span>

    <span class="cm">/** name of field for storing a proxy instance&#39;s invocation handler */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">handlerFieldName</span> <span class="o">=</span> <span class="s">&#34;h&#34;</span><span class="o">;</span>

    <span class="cm">/** debugging flag for saving generated class files */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">saveGeneratedFiles</span> <span class="o">=</span>
            <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                    <span class="k">new</span> <span class="n">GetBooleanAction</span><span class="o">(</span>
                            <span class="s">&#34;sun.misc.ProxyGeneratorEx.saveGeneratedFiles&#34;</span><span class="o">)).</span><span class="na">booleanValue</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * Generate a proxy class given a name and a list of proxy interfaces.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateProxyClass</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Class</span> <span class="n">superclass</span><span class="o">,</span>
                                            <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">ProxyGeneratorEx</span> <span class="n">gen</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProxyGeneratorEx</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classFile</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="na">generateClassFile</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">saveGeneratedFiles</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                    <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="kd">public</span> <span class="n">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                            <span class="k">try</span> <span class="o">{</span>
                                <span class="n">FileOutputStream</span> <span class="n">file</span> <span class="o">=</span>
                                        <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">);</span>
                                <span class="n">file</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">classFile</span><span class="o">);</span>
                                <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span>
                                        <span class="s">&#34;I/O exception saving generated file: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">classFile</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* preloaded Method objects for methods in java.lang.Object */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">hashCodeMethod</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">equalsMethod</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span> <span class="n">toStringMethod</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">hashCodeMethod</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">);</span>
            <span class="n">equalsMethod</span> <span class="o">=</span>
                    <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;equals&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">});</span>
            <span class="n">toStringMethod</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchMethodError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/** name of proxy class */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">className</span><span class="o">;</span>

    <span class="cm">/** proxy interfaces */</span>
    <span class="kd">private</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">;</span>

    <span class="cm">/** constant pool of class being generated */</span>
    <span class="kd">private</span> <span class="n">ConstantPool</span> <span class="n">cp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConstantPool</span><span class="o">();</span>

    <span class="cm">/** FieldInfo struct for each field of generated class */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FieldInfo</span><span class="o">&gt;</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FieldInfo</span><span class="o">&gt;();</span>

    <span class="cm">/** MethodInfo struct for each method of generated class */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MethodInfo</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">MethodInfo</span><span class="o">&gt;();</span>

    <span class="cm">/**
</span><span class="cm">     * maps method signature string to list of ProxyMethod objects for
</span><span class="cm">     * proxy methods with that signature
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;&gt;</span> <span class="n">proxyMethods</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;&gt;();</span>

    <span class="cm">/** count of ProxyMethod objects added to proxyMethods */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">proxyMethodCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Class</span> <span class="n">superclass</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Construct a ProxyGeneratorEx to generate a proxy class with the
</span><span class="cm">     * specified name and for the given interfaces.
</span><span class="cm">     *
</span><span class="cm">     * A ProxyGeneratorEx object contains the state for the ongoing
</span><span class="cm">     * generation of a particular proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="nf">ProxyGeneratorEx</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">Class</span> <span class="n">supperclass</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">superclassName</span> <span class="o">=</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">supperclass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">superclass</span> <span class="o">=</span> <span class="n">supperclass</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">interfaces</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate a class file for the proxy class.  This method drives the
</span><span class="cm">     * class file generation process.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateClassFile</span><span class="o">()</span> <span class="o">{</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 1: Assemble ProxyMethod objects for all methods to
</span><span class="cm">         * generate proxy dispatching code for.
</span><span class="cm">         */</span>

        <span class="cm">/*
</span><span class="cm">         * Record that proxy methods are needed for the hashCode, equals,
</span><span class="cm">         * and toString methods of java.lang.Object.  This is done before
</span><span class="cm">         * the methods from the proxy interfaces so that the methods from
</span><span class="cm">         * java.lang.Object take precedence over duplicate methods in the
</span><span class="cm">         * proxy interfaces.
</span><span class="cm">         */</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">hashCodeMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">equalsMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">toStringMethod</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="cm">/*
</span><span class="cm">         * Now record all of the methods from the proxy interfaces, giving
</span><span class="cm">         * earlier interfaces precedence over later ones with duplicate
</span><span class="cm">         * methods.
</span><span class="cm">         */</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getMethods</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">j</span><span class="o">],</span> <span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Now record all of the methods from the proxy superclass
</span><span class="c1"></span>        <span class="n">Method</span><span class="o">[]</span> <span class="n">superclassMethods</span> <span class="o">=</span> <span class="n">superclass</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">superclassMethods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">superclassMethods</span><span class="o">[</span><span class="n">j</span><span class="o">],</span> <span class="n">superclass</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * For each set of proxy methods with the same signature,
</span><span class="cm">         * verify that the methods&#39; return types are compatible.
</span><span class="cm">         */</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">checkReturnTypes</span><span class="o">(</span><span class="n">sigmethods</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 2: Assemble FieldInfo and MethodInfo structs for all of
</span><span class="cm">         * fields and methods in the class we are generating.
</span><span class="cm">         */</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">generateConstructor</span><span class="o">());</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>

                    <span class="c1">// add static field for method&#39;s Method object
</span><span class="c1"></span>                    <span class="n">fields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">FieldInfo</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodFieldName</span><span class="o">,</span>
                            <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">,</span>
                            <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_STATIC</span><span class="o">));</span>

                    <span class="c1">// generate code for proxy method and add it
</span><span class="c1"></span>                    <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">generateMethod</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// add field: InvocationHandler
</span><span class="c1"></span>            <span class="n">fields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">FieldInfo</span><span class="o">(</span><span class="n">handlerFieldName</span><span class="o">,</span>
                    <span class="s">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span class="o">,</span>
                    <span class="n">ACC_PRIVATE</span><span class="o">));</span>

            <span class="n">methods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">generateStaticInitializer</span><span class="o">());</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;unexpected I/O Exception&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;method limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;field limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/* ============================================================
</span><span class="cm">         * Step 3: Write the final class file.
</span><span class="cm">         */</span>

        <span class="cm">/*
</span><span class="cm">         * Make sure that constant pool indexes are reserved for the
</span><span class="cm">         * following items before starting to write the final class file.
</span><span class="cm">         */</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">));</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">superclassName</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * Disallow new constant pool additions beyond this point, since
</span><span class="cm">         * we are about to write the final constant pool table.
</span><span class="cm">         */</span>
        <span class="n">cp</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">();</span>

        <span class="n">ByteArrayOutputStream</span> <span class="n">bout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">bout</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;ClassFile&#34; structure.
</span><span class="cm">             * See JVMS section 4.1.
</span><span class="cm">             */</span>
            <span class="c1">// u4 magic;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">0xCAFEBABE</span><span class="o">);</span>
            <span class="c1">// u2 minor_version;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">CLASSFILE_MINOR_VERSION</span><span class="o">);</span>
            <span class="c1">// u2 major_version;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">CLASSFILE_MAJOR_VERSION</span><span class="o">);</span>

            <span class="n">cp</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>             <span class="c1">// (write constant pool)
</span><span class="c1"></span>
            <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span> <span class="o">|</span> <span class="n">ACC_SUPER</span><span class="o">);</span>
            <span class="c1">// u2 this_class;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">)));</span>
            <span class="c1">// u2 super_class;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">superclassName</span><span class="o">));</span>

            <span class="c1">// u2 interfaces_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="c1">// u2 interfaces[interfaces_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                        <span class="n">dotToSlash</span><span class="o">(</span><span class="n">interfaces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">())));</span>
            <span class="o">}</span>

            <span class="c1">// u2 fields_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="c1">// field_info fields[fields_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">FieldInfo</span> <span class="n">f</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">f</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// u2 methods_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="c1">// method_info methods[methods_count];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">MethodInfo</span> <span class="n">m</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">m</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dout</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">dout</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// (no ClassFile attributes for proxy classes)
</span><span class="c1"></span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;unexpected I/O Exception&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">bout</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Add another method to be proxied, either by creating a new
</span><span class="cm">     * ProxyMethod object or augmenting an old one for a duplicate
</span><span class="cm">     * method.
</span><span class="cm">     *
</span><span class="cm">     * &#34;fromClass&#34; indicates the proxy interface that the method was
</span><span class="cm">     * found through, which may be different from (a subinterface of)
</span><span class="cm">     * the method&#39;s &#34;declaring class&#34;.  Note that the first Method
</span><span class="cm">     * object passed for a given name and descriptor identifies the
</span><span class="cm">     * Method object (and thus the declaring class) that will be
</span><span class="cm">     * passed to the invocation handler&#39;s &#34;invoke&#34; method for a given
</span><span class="cm">     * set of duplicate methods.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addProxyMethod</span><span class="o">(</span><span class="n">Method</span> <span class="n">m</span><span class="o">,</span> <span class="n">Class</span> <span class="n">fromClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getExceptionTypes</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">getParameterDescriptors</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">=</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sig</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sigmethods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="o">==</span> <span class="n">pm</span><span class="o">.</span><span class="na">returnType</span><span class="o">)</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * Found a match: reduce exception types to the
</span><span class="cm">                     * greatest set of exceptions that can thrown
</span><span class="cm">                     * compatibly with the throws clauses of both
</span><span class="cm">                     * overridden methods.
</span><span class="cm">                     */</span>
                    <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">legalExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
                    <span class="n">collectCompatibleTypes</span><span class="o">(</span>
                            <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">,</span> <span class="n">legalExceptions</span><span class="o">);</span>
                    <span class="n">collectCompatibleTypes</span><span class="o">(</span>
                            <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">,</span> <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">legalExceptions</span><span class="o">);</span>
                    <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">legalExceptions</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
                    <span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span>
                            <span class="n">legalExceptions</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">exceptionTypes</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">sigmethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;(</span><span class="n">3</span><span class="o">);</span>
            <span class="n">proxyMethods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">sig</span><span class="o">,</span> <span class="n">sigmethods</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sigmethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ProxyMethod</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="n">returnType</span><span class="o">,</span>
                <span class="n">exceptionTypes</span><span class="o">,</span> <span class="n">fromClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * For a given set of proxy methods with the same signature, check
</span><span class="cm">     * that their return types are compatible according to the Proxy
</span><span class="cm">     * specification.
</span><span class="cm">     *
</span><span class="cm">     * Specifically, if there is more than one such method, then all
</span><span class="cm">     * of the return types must be reference types, and there must be
</span><span class="cm">     * one return type that is assignable to each of the rest of them.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkReturnTypes</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*
</span><span class="cm">         * If there is only one method with a given signature, there
</span><span class="cm">         * cannot be a conflict.  This is the only case in which a
</span><span class="cm">         * primitive (or void) return type is allowed.
</span><span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * List of return types that are not yet known to be
</span><span class="cm">         * assignable from (&#34;covered&#34; by) any of the others.
</span><span class="cm">         */</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">uncoveredReturnTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span><span class="nl">
</span><span class="nl">
</span><span class="nl">        nextNewReturnType:</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">newReturnType</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">returnType</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">newReturnType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                        <span class="s">&#34;methods with same signature &#34;</span> <span class="o">+</span>
                                <span class="n">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodName</span><span class="o">,</span>
                                        <span class="n">pm</span><span class="o">.</span><span class="na">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
                                <span class="s">&#34; but incompatible return types: &#34;</span> <span class="o">+</span>
                                <span class="n">newReturnType</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; and others&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Compare the new return type to the existing uncovered
</span><span class="cm">             * return types.
</span><span class="cm">             */</span>
            <span class="n">ListIterator</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">liter</span> <span class="o">=</span> <span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">listIterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">liter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">uncoveredReturnType</span> <span class="o">=</span> <span class="n">liter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

                <span class="cm">/*
</span><span class="cm">                 * If an existing uncovered return type is assignable
</span><span class="cm">                 * to this new one, then we can forget the new one.
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">newReturnType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">uncoveredReturnType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">assert</span> <span class="o">!</span><span class="n">added</span><span class="o">;</span>
                    <span class="k">continue</span> <span class="n">nextNewReturnType</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="cm">/*
</span><span class="cm">                 * If the new return type is assignable to an existing
</span><span class="cm">                 * uncovered one, then should replace the existing one
</span><span class="cm">                 * with the new one (or just forget the existing one,
</span><span class="cm">                 * if the new one has already be put in the list).
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">uncoveredReturnType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// (we can assume that each return type is unique)
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(!</span><span class="n">added</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">liter</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">);</span>
                        <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">liter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="cm">/*
</span><span class="cm">             * If we got through the list of existing uncovered return
</span><span class="cm">             * types without an assignability relationship, then add
</span><span class="cm">             * the new return type to the list of uncovered ones.
</span><span class="cm">             */</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">added</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newReturnType</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/*
</span><span class="cm">         * We shouldn&#39;t end up with more than one return type that is
</span><span class="cm">         * not assignable from any of the others.
</span><span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uncoveredReturnTypes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&#34;methods with same signature &#34;</span> <span class="o">+</span>
                            <span class="n">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">pm</span><span class="o">.</span><span class="na">methodName</span><span class="o">,</span> <span class="n">pm</span><span class="o">.</span><span class="na">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
                            <span class="s">&#34; but incompatible return types: &#34;</span> <span class="o">+</span> <span class="n">uncoveredReturnTypes</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A FieldInfo object contains information about a particular field
</span><span class="cm">     * in the class being generated.  The class mirrors the data items of
</span><span class="cm">     * the &#34;field_info&#34; structure of the class file format (see JVMS 4.5).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">FieldInfo</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">FieldInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">accessFlags</span> <span class="o">=</span> <span class="n">accessFlags</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Make sure that constant pool indexes are reserved for the
</span><span class="cm">             * following items before starting to write the final class file.
</span><span class="cm">             */</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;field_info&#34; structure.
</span><span class="cm">             * See JVMS section 4.5.
</span><span class="cm">             */</span>
            <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">accessFlags</span><span class="o">);</span>
            <span class="c1">// u2 name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
            <span class="c1">// u2 descriptor_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">));</span>
            <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>  <span class="c1">// (no field_info attributes for proxy classes)
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * An ExceptionTableEntry object holds values for the data items of
</span><span class="cm">     * an entry in the &#34;exception_table&#34; item of the &#34;Code&#34; attribute of
</span><span class="cm">     * &#34;method_info&#34; structures (see JVMS 4.7.3).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ExceptionTableEntry</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">startPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">endPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">handlerPc</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">catchType</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ExceptionTableEntry</span><span class="o">(</span><span class="kt">short</span> <span class="n">startPc</span><span class="o">,</span> <span class="kt">short</span> <span class="n">endPc</span><span class="o">,</span>
                                   <span class="kt">short</span> <span class="n">handlerPc</span><span class="o">,</span> <span class="kt">short</span> <span class="n">catchType</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">startPc</span> <span class="o">=</span> <span class="n">startPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">endPc</span> <span class="o">=</span> <span class="n">endPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">handlerPc</span> <span class="o">=</span> <span class="n">handlerPc</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">catchType</span> <span class="o">=</span> <span class="n">catchType</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="cm">/**
</span><span class="cm">     * A MethodInfo object contains information about a particular method
</span><span class="cm">     * in the class being generated.  This class mirrors the data items of
</span><span class="cm">     * the &#34;method_info&#34; structure of the class file format (see JVMS 4.6).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">MethodInfo</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">maxStack</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="n">maxLocals</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">ByteArrayOutputStream</span> <span class="n">code</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ExceptionTableEntry</span><span class="o">&gt;</span> <span class="n">exceptionTable</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ExceptionTableEntry</span><span class="o">&gt;();</span>
        <span class="kd">public</span> <span class="kt">short</span><span class="o">[]</span> <span class="n">declaredExceptions</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">MethodInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">accessFlags</span> <span class="o">=</span> <span class="n">accessFlags</span><span class="o">;</span>

            <span class="cm">/*
</span><span class="cm">             * Make sure that constant pool indexes are reserved for the
</span><span class="cm">             * following items before starting to write the final class file.
</span><span class="cm">             */</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Code&#34;</span><span class="o">);</span>
            <span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Exceptions&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Write all the items of the &#34;method_info&#34; structure.
</span><span class="cm">             * See JVMS section 4.6.
</span><span class="cm">             */</span>
            <span class="c1">// u2 access_flags;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">accessFlags</span><span class="o">);</span>
            <span class="c1">// u2 name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
            <span class="c1">// u2 descriptor_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">));</span>
            <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>  <span class="c1">// (two method_info attributes:)
</span><span class="c1"></span>
            <span class="c1">// Write &#34;Code&#34; attribute. See JVMS section 4.7.3.
</span><span class="c1"></span>
            <span class="c1">// u2 attribute_name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Code&#34;</span><span class="o">));</span>
            <span class="c1">// u4 attribute_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">12</span> <span class="o">+</span> <span class="n">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">8</span> <span class="o">*</span> <span class="n">exceptionTable</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="c1">// u2 max_stack;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">maxStack</span><span class="o">);</span>
            <span class="c1">// u2 max_locals;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">maxLocals</span><span class="o">);</span>
            <span class="c1">// u2 code_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="c1">// u1 code[code_length];
</span><span class="c1"></span>            <span class="n">code</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="c1">// u2 exception_table_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">exceptionTable</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ExceptionTableEntry</span> <span class="n">e</span> <span class="o">:</span> <span class="n">exceptionTable</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// u2 start_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">startPc</span><span class="o">);</span>
                <span class="c1">// u2 end_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">endPc</span><span class="o">);</span>
                <span class="c1">// u2 handler_pc;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">handlerPc</span><span class="o">);</span>
                <span class="c1">// u2 catch_type;
</span><span class="c1"></span>                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">catchType</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// u2 attributes_count;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

            <span class="c1">// write &#34;Exceptions&#34; attribute.  See JVMS section 4.7.4.
</span><span class="c1"></span>
            <span class="c1">// u2 attribute_name_index;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getUtf8</span><span class="o">(</span><span class="s">&#34;Exceptions&#34;</span><span class="o">));</span>
            <span class="c1">// u4 attributes_length;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">2</span> <span class="o">+</span> <span class="n">2</span> <span class="o">*</span> <span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="c1">// u2 number_of_exceptions;
</span><span class="c1"></span>            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="c1">// u2 exception_index_table[number_of_exceptions];
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">declaredExceptions</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">declaredExceptions</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A ProxyMethod object represents a proxy method in the proxy class
</span><span class="cm">     * being generated: a method whose implementation will encode and
</span><span class="cm">     * dispatch invocations to the proxy instance&#39;s invocation handler.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ProxyMethod</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span> <span class="n">returnType</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">Class</span> <span class="n">fromClass</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">methodFieldName</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">ProxyMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                            <span class="n">Class</span> <span class="n">returnType</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">exceptionTypes</span><span class="o">,</span>
                            <span class="n">Class</span> <span class="n">fromClass</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">methodName</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parameterTypes</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">returnType</span> <span class="o">=</span> <span class="n">returnType</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">exceptionTypes</span> <span class="o">=</span> <span class="n">exceptionTypes</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fromClass</span> <span class="o">=</span> <span class="n">fromClass</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">methodFieldName</span> <span class="o">=</span> <span class="s">&#34;m&#34;</span> <span class="o">+</span> <span class="n">proxyMethodCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Return a MethodInfo object for this method, including generating
</span><span class="cm">         * the code and exception table entry.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateMethod</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">getMethodDescriptor</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">,</span> <span class="n">returnType</span><span class="o">);</span>
            <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">desc</span><span class="o">,</span>
                    <span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span><span class="o">);</span>

            <span class="kt">int</span><span class="o">[]</span> <span class="n">parameterSlot</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">nextSlot</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterSlot</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">parameterSlot</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nextSlot</span><span class="o">;</span>
                <span class="n">nextSlot</span> <span class="o">+=</span> <span class="n">getWordsPerType</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">localSlot0</span> <span class="o">=</span> <span class="n">nextSlot</span><span class="o">;</span>
            <span class="kt">short</span> <span class="n">pc</span><span class="o">,</span> <span class="n">tryBegin</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">;</span>

            <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

            <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getfield</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                    <span class="n">className</span><span class="o">,</span>
                    <span class="n">handlerFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span class="o">));</span>

            <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getstatic</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                    <span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">),</span>
                    <span class="n">methodFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>

                <span class="n">code_ipush</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_anewarray</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Object&#34;</span><span class="o">));</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                    <span class="n">code_ipush</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                    <span class="n">codeWrapArgument</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">parameterSlot</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">out</span><span class="o">);</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aastore</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aconst_null</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokeinterface</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getInterfaceMethodRef</span><span class="o">(</span>
                    <span class="s">&#34;java/lang/reflect/InvocationHandler&#34;</span><span class="o">,</span>
                    <span class="s">&#34;invoke&#34;</span><span class="o">,</span>
                    <span class="s">&#34;(Ljava/lang/Object;Ljava/lang/reflect/Method;&#34;</span> <span class="o">+</span>
                            <span class="s">&#34;[Ljava/lang/Object;)Ljava/lang/Object;&#34;</span><span class="o">));</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="o">==</span> <span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_pop</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">codeUnwrapReturnValue</span><span class="o">(</span><span class="n">returnType</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">tryEnd</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

            <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">catchList</span> <span class="o">=</span> <span class="n">computeUniqueCatchList</span><span class="o">(</span><span class="n">exceptionTypes</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">catchList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex</span> <span class="o">:</span> <span class="n">catchList</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                            <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
                            <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getName</span><span class="o">()))));</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

                <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

                <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                        <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span> <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">)));</span>

                <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                        <span class="s">&#34;java/lang/reflect/UndeclaredThrowableException&#34;</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                        <span class="s">&#34;java/lang/reflect/UndeclaredThrowableException&#34;</span><span class="o">,</span>
                        <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/Throwable;)V&#34;</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;code size limit exceeded&#34;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
            <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">localSlot0</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
            <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">exceptionTypes</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exceptionTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span>
                        <span class="n">dotToSlash</span><span class="o">(</span><span class="n">exceptionTypes</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">()));</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for wrapping an argument of the given type
</span><span class="cm">         * whose value can be found at the specified local variable
</span><span class="cm">         * index, in order for it to be passed (as an Object) to the
</span><span class="cm">         * invocation handler&#39;s &#34;invoke&#34; method.  The code is written
</span><span class="cm">         * to the supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeWrapArgument</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="o">,</span>
                                      <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">byte</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">char</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">code_iload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_lload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_fload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">code_dload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokestatic</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                        <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span>
                        <span class="s">&#34;valueOf&#34;</span><span class="o">,</span> <span class="n">prim</span><span class="o">.</span><span class="na">wrapperValueOfDesc</span><span class="o">));</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">code_aload</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for unwrapping a return value of the given
</span><span class="cm">         * type from the invocation handler&#39;s &#34;invoke&#34; method (as type
</span><span class="cm">         * Object) to its correct type.  The code is written to the
</span><span class="cm">         * supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeUnwrapReturnValue</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_checkcast</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                        <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span>
                        <span class="n">prim</span><span class="o">.</span><span class="na">unwrapMethodName</span><span class="o">,</span> <span class="n">prim</span><span class="o">.</span><span class="na">unwrapMethodDesc</span><span class="o">));</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">byte</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">char</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span>
                        <span class="n">type</span> <span class="o">==</span> <span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ireturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_lreturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_freturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dreturn</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
                <span class="o">}</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_checkcast</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">())));</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_areturn</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Generate code for initializing the static field that stores
</span><span class="cm">         * the Method object for this proxy method.  The code is written
</span><span class="cm">         * to the supplied stream.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeFieldInitialization</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">IOException</span>
        <span class="o">{</span>
            <span class="n">codeClassForName</span><span class="o">(</span><span class="n">fromClass</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">code_ldc</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">methodName</span><span class="o">),</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">code_ipush</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_anewarray</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/Class&#34;</span><span class="o">));</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

                <span class="n">code_ipush</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">PrimitiveTypeInfo</span> <span class="n">prim</span> <span class="o">=</span>
                            <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>

                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_getstatic</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                            <span class="n">prim</span><span class="o">.</span><span class="na">wrapperClassName</span><span class="o">,</span> <span class="s">&#34;TYPE&#34;</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/Class;&#34;</span><span class="o">));</span>

                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">codeClassForName</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">out</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_aastore</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                    <span class="s">&#34;java/lang/Class&#34;</span><span class="o">,</span>
                    <span class="s">&#34;getMethod&#34;</span><span class="o">,</span>
                    <span class="s">&#34;(Ljava/lang/String;[Ljava/lang/Class;)&#34;</span> <span class="o">+</span>
                            <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>

            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_putstatic</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span>
                    <span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">),</span>
                    <span class="n">methodFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/Method;&#34;</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate the constructor method for the proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateConstructor</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span>
                <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/reflect/InvocationHandler;)V&#34;</span><span class="o">,</span>
                <span class="n">ACC_PUBLIC</span><span class="o">);</span>

        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="n">superclassName</span><span class="o">,</span>
                <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;()V&#34;</span><span class="o">));</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">code_aload</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="c1">// write field h
</span><span class="c1"></span>        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_putfield</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getFieldRef</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">handlerFieldName</span><span class="o">,</span> <span class="s">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>

        <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate the static initializer method for the proxy class.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">MethodInfo</span> <span class="nf">generateStaticInitializer</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">MethodInfo</span> <span class="n">minfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodInfo</span><span class="o">(</span>
                <span class="s">&#34;&lt;clinit&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;()V&#34;</span><span class="o">,</span> <span class="n">ACC_STATIC</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">localSlot0</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
        <span class="kt">short</span> <span class="n">pc</span><span class="o">,</span> <span class="n">tryBegin</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">;</span>

        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pm</span><span class="o">.</span><span class="na">codeFieldInitialization</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_return</span><span class="o">);</span>

        <span class="n">tryEnd</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
                <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoSuchMethodException&#34;</span><span class="o">)));</span>

        <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoSuchMethodError&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">,</span> <span class="s">&#34;getMessage&#34;</span><span class="o">,</span> <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/NoSuchMethodError&#34;</span><span class="o">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)V&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">exceptionTable</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionTableEntry</span><span class="o">(</span>
                <span class="n">tryBegin</span><span class="o">,</span> <span class="n">tryEnd</span><span class="o">,</span> <span class="n">pc</span><span class="o">,</span>
                <span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/ClassNotFoundException&#34;</span><span class="o">)));</span>

        <span class="n">code_astore</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_new</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">&#34;java/lang/NoClassDefFoundError&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_dup</span><span class="o">);</span>

        <span class="n">code_aload</span><span class="o">(</span><span class="n">localSlot0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokevirtual</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/Throwable&#34;</span><span class="o">,</span> <span class="s">&#34;getMessage&#34;</span><span class="o">,</span> <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokespecial</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/NoClassDefFoundError&#34;</span><span class="o">,</span>
                <span class="s">&#34;&lt;init&gt;&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)V&#34;</span><span class="o">));</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_athrow</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">minfo</span><span class="o">.</span><span class="na">code</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;code size limit exceeded&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">minfo</span><span class="o">.</span><span class="na">maxStack</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">maxLocals</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">localSlot0</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
        <span class="n">minfo</span><span class="o">.</span><span class="na">declaredExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>

        <span class="k">return</span> <span class="n">minfo</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/*
</span><span class="cm">     * =============== Code Generation Utility Methods ===============
</span><span class="cm">     */</span>

    <span class="cm">/*
</span><span class="cm">     * The following methods generate code for the load or store operation
</span><span class="cm">     * indicated by their name for the given local variable.  The code is
</span><span class="cm">     * written to the supplied stream.
</span><span class="cm">     */</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_iload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_iload</span><span class="o">,</span> <span class="n">opc_iload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_lload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_lload</span><span class="o">,</span> <span class="n">opc_lload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_fload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_fload</span><span class="o">,</span> <span class="n">opc_fload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_dload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_dload</span><span class="o">,</span> <span class="n">opc_dload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_aload</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_aload</span><span class="o">,</span> <span class="n">opc_aload_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

<span class="c1">//  private void code_istore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_istore, opc_istore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_lstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_lstore, opc_lstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_fstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_fstore, opc_fstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
<span class="c1">//  private void code_dstore(int lvar, DataOutputStream out)
</span><span class="c1">//      throws IOException
</span><span class="c1">//  {
</span><span class="c1">//      codeLocalLoadStore(lvar, opc_dstore, opc_dstore_0, out);
</span><span class="c1">//  }
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_astore</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">codeLocalLoadStore</span><span class="o">(</span><span class="n">lvar</span><span class="o">,</span> <span class="n">opc_astore</span><span class="o">,</span> <span class="n">opc_astore_0</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code for a load or store instruction for the given local
</span><span class="cm">     * variable.  The code is written to the supplied stream.
</span><span class="cm">     *
</span><span class="cm">     * &#34;opcode&#34; indicates the opcode form of the desired load or store
</span><span class="cm">     * instruction that takes an explicit local variable index, and
</span><span class="cm">     * &#34;opcode_0&#34; indicates the corresponding form of the instruction
</span><span class="cm">     * with the implicit index 0.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeLocalLoadStore</span><span class="o">(</span><span class="kt">int</span> <span class="n">lvar</span><span class="o">,</span> <span class="kt">int</span> <span class="n">opcode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">opcode_0</span><span class="o">,</span>
                                    <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">assert</span> <span class="n">lvar</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">0xFFFF</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode_0</span> <span class="o">+</span> <span class="n">lvar</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">lvar</span> <span class="o">&lt;=</span> <span class="n">0xFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">lvar</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * Use the &#34;wide&#34; instruction modifier for local variable
</span><span class="cm">             * indexes that do not fit into an unsigned byte.
</span><span class="cm">             */</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_wide</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opcode</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">lvar</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code for an &#34;ldc&#34; instruction for the given constant pool
</span><span class="cm">     * index (the &#34;ldc_w&#34; instruction is used if the index does not fit
</span><span class="cm">     * into an unsigned byte).  The code is written to the supplied stream.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_ldc</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">assert</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">0xFFFF</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">0xFF</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ldc</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_ldc_w</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code to push a constant integer value on to the operand
</span><span class="cm">     * stack, using the &#34;iconst_&lt;i&gt;&#34;, &#34;bipush&#34;, or &#34;sipush&#34; instructions
</span><span class="cm">     * depending on the size of the value.  The code is written to the
</span><span class="cm">     * supplied stream.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">code_ipush</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">5</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_iconst_0</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MIN_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_bipush</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">0xFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">Short</span><span class="o">.</span><span class="na">MIN_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">Short</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_sipush</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">0xFFFF</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Generate code to invoke the Class.forName with the name of the given
</span><span class="cm">     * class to get its Class object at runtime.  The code is written to
</span><span class="cm">     * the supplied stream.  Note that the code generated by this method
</span><span class="cm">     * may caused the checked ClassNotFoundException to be thrown.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">codeClassForName</span><span class="o">(</span><span class="n">Class</span> <span class="n">cl</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">code_ldc</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">cl</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">out</span><span class="o">);</span>

        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">opc_invokestatic</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">cp</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">(</span>
                <span class="s">&#34;java/lang/Class&#34;</span><span class="o">,</span>
                <span class="s">&#34;forName&#34;</span><span class="o">,</span> <span class="s">&#34;(Ljava/lang/String;)Ljava/lang/Class;&#34;</span><span class="o">));</span>
    <span class="o">}</span>


    <span class="cm">/*
</span><span class="cm">     * ==================== General Utility Methods ====================
</span><span class="cm">     */</span>

    <span class="cm">/**
</span><span class="cm">     * Convert a fully qualified class name that uses &#39;.&#39; as the package
</span><span class="cm">     * separator, the external representation used by the Java language
</span><span class="cm">     * and APIs, to a fully qualified class name that uses &#39;/&#39; as the
</span><span class="cm">     * package separator, the representation used in the class file
</span><span class="cm">     * format (see JVMS section 4.2).
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">dotToSlash</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the &#34;method descriptor&#34; string for a method with the given
</span><span class="cm">     * parameter types and return type.  See JVMS section 4.3.3.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getMethodDescriptor</span><span class="o">(</span><span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
                                              <span class="n">Class</span> <span class="n">returnType</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">getParameterDescriptors</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">)</span> <span class="o">+</span>
                <span class="o">((</span><span class="n">returnType</span> <span class="o">==</span> <span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">?</span> <span class="s">&#34;V&#34;</span> <span class="o">:</span> <span class="n">getFieldType</span><span class="o">(</span><span class="n">returnType</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the list of &#34;parameter descriptor&#34; strings enclosed in
</span><span class="cm">     * parentheses corresponding to the given parameter types (in other
</span><span class="cm">     * words, a method descriptor without a return descriptor).  This
</span><span class="cm">     * string is useful for constructing string keys for methods without
</span><span class="cm">     * regard to their return type.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getParameterDescriptors</span><span class="o">(</span><span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&#34;(&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">desc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">getFieldType</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]));</span>
        <span class="o">}</span>
        <span class="n">desc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">desc</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the &#34;field type&#34; string for the given type, appropriate for
</span><span class="cm">     * a field descriptor, a parameter descriptor, or a return descriptor
</span><span class="cm">     * other than &#34;void&#34;.  See JVMS section 4.3.2.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFieldType</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">PrimitiveTypeInfo</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">baseTypeString</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
            <span class="cm">/*
</span><span class="cm">             * According to JLS 20.3.2, the getName() method on Class does
</span><span class="cm">             * return the VM type descriptor format for array classes (only);
</span><span class="cm">             * using that should be quicker than the otherwise obvious code:
</span><span class="cm">             *
</span><span class="cm">             *     return &#34;[&#34; + getTypeDescriptor(type.getComponentType());
</span><span class="cm">             */</span>
            <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&#34;L&#34;</span> <span class="o">+</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span> <span class="o">+</span> <span class="s">&#34;;&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Returns a human-readable string representing the signature of a
</span><span class="cm">     * method with the given name and parameter types.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFriendlyMethodSignature</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                                                     <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;(&#39;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Class</span> <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">dimensions</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">parameterType</span> <span class="o">=</span> <span class="n">parameterType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">();</span>
                <span class="n">dimensions</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">parameterType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">dimensions</span><span class="o">--</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;[]&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sig</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sig</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Return the number of abstract &#34;words&#34;, or consecutive local variable
</span><span class="cm">     * indexes, required to contain a value of the given type.  See JVMS
</span><span class="cm">     * section 3.6.1.
</span><span class="cm">     *
</span><span class="cm">     * Note that the original version of the JVMS contained a definition of
</span><span class="cm">     * this abstract notion of a &#34;word&#34; in section 3.4, but that definition
</span><span class="cm">     * was removed for the second edition.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getWordsPerType</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Add to the given list all of the types in the &#34;from&#34; array that
</span><span class="cm">     * are not already contained in the list and are assignable to at
</span><span class="cm">     * least one of the types in the &#34;with&#34; array.
</span><span class="cm">     *
</span><span class="cm">     * This method is useful for computing the greatest common set of
</span><span class="cm">     * declared exceptions from duplicate methods inherited from
</span><span class="cm">     * different interfaces.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">collectCompatibleTypes</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">from</span><span class="o">,</span>
                                               <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">with</span><span class="o">,</span>
                                               <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">list</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">from</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">list</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">with</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">with</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">from</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Given the exceptions declared in the throws clause of a proxy method,
</span><span class="cm">     * compute the exceptions that need to be caught from the invocation
</span><span class="cm">     * handler&#39;s invoke method and rethrown intact in the method&#39;s
</span><span class="cm">     * implementation before catching other Throwables and wrapping them
</span><span class="cm">     * in UndeclaredThrowableExceptions.
</span><span class="cm">     *
</span><span class="cm">     * The exceptions to be caught are returned in a List object.  Each
</span><span class="cm">     * exception in the returned list is guaranteed to not be a subclass of
</span><span class="cm">     * any of the other exceptions in the list, so the catch blocks for
</span><span class="cm">     * these exceptions may be generated in any order relative to each other.
</span><span class="cm">     *
</span><span class="cm">     * Error and RuntimeException are each always contained by the returned
</span><span class="cm">     * list (if none of their superclasses are contained), since those
</span><span class="cm">     * unchecked exceptions should always be rethrown intact, and thus their
</span><span class="cm">     * subclasses will never appear in the returned list.
</span><span class="cm">     *
</span><span class="cm">     * The returned List will be empty if java.lang.Throwable is in the
</span><span class="cm">     * given list of declared exceptions, indicating that no exceptions
</span><span class="cm">     * need to be caught.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">computeUniqueCatchList</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">exceptions</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">uniqueList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
        <span class="c1">// unique exceptions to catch
</span><span class="c1"></span>
        <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Error</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>            <span class="c1">// always catch/rethrow these
</span><span class="c1"></span>        <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="nl">
</span><span class="nl">
</span><span class="nl">        nextException:</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exceptions</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">Throwable</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="cm">/*
</span><span class="cm">                 * If Throwable is declared to be thrown by the proxy method,
</span><span class="cm">                 * then no catch blocks are necessary, because the invoke
</span><span class="cm">                 * can, at most, throw Throwable anyway.
</span><span class="cm">                 */</span>
                <span class="n">uniqueList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">Throwable</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex</span><span class="o">))</span> <span class="o">{</span>
                <span class="cm">/*
</span><span class="cm">                 * Ignore types that cannot be thrown by the invoke method.
</span><span class="cm">                 */</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="cm">/*
</span><span class="cm">             * Compare this exception against the current list of
</span><span class="cm">             * exceptions that need to be caught:
</span><span class="cm">             */</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">uniqueList</span><span class="o">.</span><span class="na">size</span><span class="o">();)</span> <span class="o">{</span>
                <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ex2</span> <span class="o">=</span> <span class="n">uniqueList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ex2</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex</span><span class="o">))</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * if a superclass of this exception is already on
</span><span class="cm">                     * the list to catch, then ignore this one and continue;
</span><span class="cm">                     */</span>
                    <span class="k">continue</span> <span class="n">nextException</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">ex2</span><span class="o">))</span> <span class="o">{</span>
                    <span class="cm">/*
</span><span class="cm">                     * if a subclass of this exception is on the list
</span><span class="cm">                     * to catch, then remove it;
</span><span class="cm">                     */</span>
                    <span class="n">uniqueList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">j</span><span class="o">++;</span>        <span class="c1">// else continue comparing.
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// This exception is unique (so far): add it to the list to catch.
</span><span class="c1"></span>            <span class="n">uniqueList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">uniqueList</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * A PrimitiveTypeInfo object contains assorted information about
</span><span class="cm">     * a primitive type in its public fields.  The struct for a particular
</span><span class="cm">     * primitive type can be obtained using the static &#34;get&#34; method.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PrimitiveTypeInfo</span> <span class="o">{</span>

        <span class="cm">/** &#34;base type&#34; used in various descriptors (see JVMS section 4.3.2) */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">baseTypeString</span><span class="o">;</span>

        <span class="cm">/** name of corresponding wrapper class */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">wrapperClassName</span><span class="o">;</span>

        <span class="cm">/** method descriptor for wrapper class &#34;valueOf&#34; factory method */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">wrapperValueOfDesc</span><span class="o">;</span>

        <span class="cm">/** name of wrapper class method for retrieving primitive value */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">unwrapMethodName</span><span class="o">;</span>

        <span class="cm">/** descriptor of same method */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">unwrapMethodDesc</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span><span class="n">PrimitiveTypeInfo</span><span class="o">&gt;</span> <span class="n">table</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span><span class="n">PrimitiveTypeInfo</span><span class="o">&gt;();</span>
        <span class="kd">static</span> <span class="o">{</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">byte</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">char</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Character</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Double</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Float</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">add</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Class</span> <span class="n">primitiveClass</span><span class="o">,</span> <span class="n">Class</span> <span class="n">wrapperClass</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">table</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">PrimitiveTypeInfo</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span> <span class="n">wrapperClass</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nf">PrimitiveTypeInfo</span><span class="o">(</span><span class="n">Class</span> <span class="n">primitiveClass</span><span class="o">,</span> <span class="n">Class</span> <span class="n">wrapperClass</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">assert</span> <span class="n">primitiveClass</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">();</span>

            <span class="n">baseTypeString</span> <span class="o">=</span>
                    <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">primitiveClass</span><span class="o">,</span> <span class="n">0</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
            <span class="n">wrapperClassName</span> <span class="o">=</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">wrapperClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">wrapperValueOfDesc</span> <span class="o">=</span>
                    <span class="s">&#34;(&#34;</span> <span class="o">+</span> <span class="n">baseTypeString</span> <span class="o">+</span> <span class="s">&#34;)L&#34;</span> <span class="o">+</span> <span class="n">wrapperClassName</span> <span class="o">+</span> <span class="s">&#34;;&#34;</span><span class="o">;</span>
            <span class="n">unwrapMethodName</span> <span class="o">=</span> <span class="n">primitiveClass</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;Value&#34;</span><span class="o">;</span>
            <span class="n">unwrapMethodDesc</span> <span class="o">=</span> <span class="s">&#34;()&#34;</span> <span class="o">+</span> <span class="n">baseTypeString</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">PrimitiveTypeInfo</span> <span class="nf">get</span><span class="o">(</span><span class="n">Class</span> <span class="n">cl</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**
</span><span class="cm">     * A ConstantPool object represents the constant pool of a class file
</span><span class="cm">     * being generated.  This representation of a constant pool is designed
</span><span class="cm">     * specifically for use by ProxyGeneratorEx; in particular, it assumes
</span><span class="cm">     * that constant pool entries will not need to be resorted (for example,
</span><span class="cm">     * by their type, as the Java compiler does), so that the final index
</span><span class="cm">     * value can be assigned and used when an entry is first created.
</span><span class="cm">     *
</span><span class="cm">     * Note that new entries cannot be created after the constant pool has
</span><span class="cm">     * been written to a class file.  To prevent such logic errors, a
</span><span class="cm">     * ConstantPool instance can be marked &#34;read only&#34;, so that further
</span><span class="cm">     * attempts to add new entries will fail with a runtime exception.
</span><span class="cm">     *
</span><span class="cm">     * See JVMS section 4.4 for more information about the constant pool
</span><span class="cm">     * of a class file.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConstantPool</span> <span class="o">{</span>

        <span class="cm">/**
</span><span class="cm">         * list of constant pool entries, in constant pool index order.
</span><span class="cm">         *
</span><span class="cm">         * This list is used when writing the constant pool to a stream
</span><span class="cm">         * and for assigning the next index value.  Note that element 0
</span><span class="cm">         * of this list corresponds to constant pool index 1.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;(</span><span class="n">32</span><span class="o">);</span>

        <span class="cm">/**
</span><span class="cm">         * maps constant pool data of all types to constant pool indexes.
</span><span class="cm">         *
</span><span class="cm">         * This map is used to look up the index of an existing entry for
</span><span class="cm">         * values of all types.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Short</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Short</span><span class="o">&gt;(</span><span class="n">16</span><span class="o">);</span>

        <span class="cm">/** true if no new constant pool entries may be added */</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">readOnly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Utf8 entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getUtf8</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Integer entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getInteger</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Float entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getFloat</span><span class="o">(</span><span class="kt">float</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">getValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Float</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_Class entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">utf8Index</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_CLASS</span><span class="o">,</span> <span class="n">utf8Index</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_String entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getString</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">utf8Index</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_STRING</span><span class="o">,</span> <span class="n">utf8Index</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_FieldRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getFieldRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span>
                                 <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_FIELD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_MethodRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getMethodRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span>
                                  <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_METHOD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_InterfaceMethodRef entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getInterfaceMethodRef</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                                           <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="kt">short</span> <span class="n">classIndex</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">nameAndTypeIndex</span> <span class="o">=</span> <span class="n">getNameAndType</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_INTERFACEMETHOD</span><span class="o">,</span> <span class="n">classIndex</span><span class="o">,</span> <span class="n">nameAndTypeIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for a CONSTANT_NameAndType entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getNameAndType</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">descriptor</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">short</span> <span class="n">nameIndex</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="kt">short</span> <span class="n">descriptorIndex</span> <span class="o">=</span> <span class="n">getUtf8</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">getIndirect</span><span class="o">(</span><span class="k">new</span> <span class="n">IndirectEntry</span><span class="o">(</span>
                    <span class="n">CONSTANT_NAMEANDTYPE</span><span class="o">,</span> <span class="n">nameIndex</span><span class="o">,</span> <span class="n">descriptorIndex</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Set this ConstantPool instance to be &#34;read only&#34;.
</span><span class="cm">         *
</span><span class="cm">         * After this method has been called, further requests to get
</span><span class="cm">         * an index for a non-existent entry will cause an InternalError
</span><span class="cm">         * to be thrown instead of creating of the entry.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReadOnly</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Write this constant pool to a stream as part of
</span><span class="cm">         * the class file format.
</span><span class="cm">         *
</span><span class="cm">         * This consists of writing the &#34;constant_pool_count&#34; and
</span><span class="cm">         * &#34;constant_pool[]&#34; items of the &#34;ClassFile&#34; structure, as
</span><span class="cm">         * described in JVMS section 4.1.
</span><span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">DataOutputStream</span> <span class="n">dataOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

            <span class="c1">// constant_pool_count: number of entries plus one
</span><span class="c1"></span>            <span class="n">dataOut</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span> <span class="n">e</span> <span class="o">:</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dataOut</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Add a new constant pool entry and return its index.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">addEntry</span><span class="o">(</span><span class="n">Entry</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pool</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
            <span class="cm">/*
</span><span class="cm">             * Note that this way of determining the index of the
</span><span class="cm">             * added entry is wrong if this pool supports
</span><span class="cm">             * CONSTANT_Long or CONSTANT_Double entries.
</span><span class="cm">             */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">65535</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                        <span class="s">&#34;constant pool size limit exceeded&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for an entry of a type that contains
</span><span class="cm">         * a direct value.  The type of the given object determines the
</span><span class="cm">         * type of the desired entry as follows:
</span><span class="cm">         *
</span><span class="cm">         *      java.lang.String        CONSTANT_Utf8
</span><span class="cm">         *      java.lang.Integer       CONSTANT_Integer
</span><span class="cm">         *      java.lang.Float         CONSTANT_Float
</span><span class="cm">         *      java.lang.Long          CONSTANT_Long
</span><span class="cm">         *      java.lang.Double        CONSTANT_DOUBLE
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Short</span> <span class="n">index</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="na">shortValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">readOnly</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span>
                            <span class="s">&#34;late constant pool addition: &#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="n">addEntry</span><span class="o">(</span><span class="k">new</span> <span class="n">ValueEntry</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="n">Short</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Get or assign the index for an entry of a type that contains
</span><span class="cm">         * references to other constant pool entries.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">short</span> <span class="nf">getIndirect</span><span class="o">(</span><span class="n">IndirectEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Short</span> <span class="n">index</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="na">shortValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">readOnly</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;late constant pool addition&#34;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="n">addEntry</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="k">new</span> <span class="n">Short</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Entry is the abstact superclass of all constant pool entry types
</span><span class="cm">         * that can be stored in the &#34;pool&#34; list; its purpose is to define a
</span><span class="cm">         * common method for writing constant pool entries to a class file.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span>
                    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * ValueEntry represents a constant pool entry of a type that
</span><span class="cm">         * contains a direct value (see the comments for the &#34;getValue&#34;
</span><span class="cm">         * method for a list of such types).
</span><span class="cm">         *
</span><span class="cm">         * ValueEntry objects are not used as keys for their entries in the
</span><span class="cm">         * Map &#34;map&#34;, so no useful hashCode or equals methods are defined.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ValueEntry</span> <span class="kd">extends</span> <span class="n">Entry</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">ValueEntry</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_UTF8</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Integer</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_INTEGER</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Float</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_FLOAT</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeFloat</span><span class="o">(((</span><span class="n">Float</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">floatValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Long</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">CONSTANT_LONG</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(((</span><span class="n">Long</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">longValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="n">Double</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(</span><span class="n">CONSTANT_DOUBLE</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(((</span><span class="n">Double</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;bogus value entry: &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * IndirectEntry represents a constant pool entry of a type that
</span><span class="cm">         * references other constant pool entries, i.e., the following types:
</span><span class="cm">         *
</span><span class="cm">         *      CONSTANT_Class, CONSTANT_String, CONSTANT_Fieldref,
</span><span class="cm">         *      CONSTANT_Methodref, CONSTANT_InterfaceMethodref, and
</span><span class="cm">         *      CONSTANT_NameAndType.
</span><span class="cm">         *
</span><span class="cm">         * Each of these entry types contains either one or two indexes of
</span><span class="cm">         * other constant pool entries.
</span><span class="cm">         *
</span><span class="cm">         * IndirectEntry objects are used as the keys for their entries in
</span><span class="cm">         * the Map &#34;map&#34;, so the hashCode and equals methods are overridden
</span><span class="cm">         * to allow matching.
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IndirectEntry</span> <span class="kd">extends</span> <span class="n">Entry</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kt">int</span> <span class="n">tag</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">short</span> <span class="n">index0</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">short</span> <span class="n">index1</span><span class="o">;</span>

            <span class="cm">/**
</span><span class="cm">             * Construct an IndirectEntry for a constant pool entry type
</span><span class="cm">             * that contains one index of another entry.
</span><span class="cm">             */</span>
            <span class="kd">public</span> <span class="nf">IndirectEntry</span><span class="o">(</span><span class="kt">int</span> <span class="n">tag</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index0</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index1</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="cm">/**
</span><span class="cm">             * Construct an IndirectEntry for a constant pool entry type
</span><span class="cm">             * that contains two indexes for other entries.
</span><span class="cm">             */</span>
            <span class="kd">public</span> <span class="nf">IndirectEntry</span><span class="o">(</span><span class="kt">int</span> <span class="n">tag</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index0</span><span class="o">,</span> <span class="kt">short</span> <span class="n">index1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index0</span> <span class="o">=</span> <span class="n">index0</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">index1</span> <span class="o">=</span> <span class="n">index1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">tag</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index0</span><span class="o">);</span>
                <span class="cm">/*
</span><span class="cm">                 * If this entry type contains two indexes, write
</span><span class="cm">                 * out the second, too.
</span><span class="cm">                 */</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_FIELD</span> <span class="o">||</span>
                        <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_METHOD</span> <span class="o">||</span>
                        <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_INTERFACEMETHOD</span> <span class="o">||</span>
                        <span class="n">tag</span> <span class="o">==</span> <span class="n">CONSTANT_NAMEANDTYPE</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">index1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">index0</span> <span class="o">+</span> <span class="n">index1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">IndirectEntry</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">IndirectEntry</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">IndirectEntry</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">tag</span> <span class="o">&amp;&amp;</span>
                            <span class="n">index0</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">index0</span> <span class="o">&amp;&amp;</span> <span class="n">index1</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">index1</span><span class="o">)</span>
                    <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>And this is the modified <code>Proxy</code> which I name <code>ProxyEx</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// ProxyEx.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy.supportclass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyEx</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getProxyClass</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ProxyGeneratorEx</span><span class="o">.</span><span class="na">generateProxyClass</span><span class="o">(</span><span class="n">superclass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;$&#34;</span><span class="o">,</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">defineClass0</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="s">&#34;$Dog&#34;</span><span class="o">,</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * TODO: no class cache support and no class name generation
</span><span class="cm">     *
</span><span class="cm">     * @param loader
</span><span class="cm">     * @param superclass
</span><span class="cm">     * @param interfaces
</span><span class="cm">     * @param h
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">newProxyInstance</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">InvocationHandler</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">proxyClass</span> <span class="o">=</span> <span class="n">getProxyClass</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">proxyClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">InvocationHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">defineClass0</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">proxyClass</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Method</span> <span class="n">defineClass0Method</span> <span class="o">=</span> <span class="n">proxyClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;defineClass0&#34;</span><span class="o">,</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">defineClass0Method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">defineClass0Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">loader</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>Now let&rsquo;s get a try with our dynamic proxy.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Dog.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy.supportclass</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">bark</span><span class="o">(){}</span>
<span class="o">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// DogInvocationHandler.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy.supportclass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DogInvocationHandler</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="s">&#34;bark&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;dog barked&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Main.java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">dynamicproxy.supportclass</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;sun.misc.ProxyGeneratorEx.saveGeneratedFiles&#34;</span><span class="o">,</span><span class="s">&#34;true&#34;</span><span class="o">);</span>

<span class="c1">//        Class aClass = ProxyEx.getProxyClass(A.class.getClassLoader(), A.class, new Class[]{});
</span><span class="c1"></span>        <span class="n">Dog</span> <span class="n">dog</span> <span class="o">=</span> <span class="o">(</span><span class="n">Dog</span><span class="o">)</span> <span class="n">ProxyEx</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Dog</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">Dog</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">],</span> <span class="k">new</span> <span class="n">DogInvocationHandler</span><span class="o">());</span>
        <span class="n">dog</span><span class="o">.</span><span class="na">bark</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>Here you should see the console will print &ldquo;dog barked&rdquo;.</p>

    </div>
    <footer class="post-footer">
     

     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://yangchao.me/post/dbvisualizer-tips/" rel="next" title="DbVisualizer Tips">
        <i class="fa fa-chevron-left"></i> DbVisualizer Tips
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://yangchao.me/post/how-jvm-handle-method-invocation/" rel="prev" title="How JVM handle method invocation">
        How JVM handle method invocation <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     <div class="post-nav">
<div style="border: 1px dashed #e0e0e0; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
    <div style="float:left;margin-top:0px;">
    <img src="http://yangchao.me/images/qrcode/qrcode_8cm.jpg" width="129px" height="129px"/>
    <div style="text-align:center;">微信扫一扫交流</div>
    </div>
    <div>
        <p style="margin-top:0px;">
            标题：Dynamic Proxy revisit
        <br />作者：<a target="_blank" href="http://yangchao.me/">Chao</a>
        <br />关注：richdyang（CHAO）
        <br />声明：自由转载-非商用-非衍生-保持署名（创作共享3.0许可证）
        </p>
    </div>
</div>
<div class="clear"></div>
</div>
     
     
     




    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

  <ul class="sidebar-nav motion-element">
    <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
      Table of Content
    </li>
    <li class="sidebar-nav-overview" data-target="site-overview">
      Site Information
    </li>
  </ul>

    <section class="site-overview sidebar-panel ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://yangchao.me/img/author.jpg"
        alt="Chao" />
    <p class="site-author-name" itemprop="name">Chao</p>
    <p class="site-description motion-element" itemprop="description"> 
        Programmer &amp; Life explorer</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://yangchao.me/post/">
        <span class="site-state-item-count">137</span>
        <span class="site-state-item-name">Blogs</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://yangchao.me/categories/">      
         
        <span class="site-state-item-count">48</span>
        
        <span class="site-state-item-name">Categories</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://yangchao.me/tags/">
         
        <span class="site-state-item-count">19</span>
        
        <span class="site-state-item-name">Tags</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/richdyang" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://linkedin.com/in/richdyang" target="_blank" title="Linkedin">
            <i class="fa fa-fw fa-linkedin"></i>
            Linkedin
        </a>
        </span>
    
</div>

      
      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
    <div class="post-toc">
        <div class="post-toc-content"><nav id="TableOfContents">
<ul>
<li><a href="#dynamic-proxy-in-jdk">Dynamic Proxy in JDK</a></li>
<li><a href="#implement-dynamic-proxy-supporting-class">Implement Dynamic Proxy supporting Class</a></li>
</ul>
</nav></div>
    </div>
</section>

  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2018</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">Chao Yang</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.34</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?0b07433b4ab8d587dae7d34e71973839";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=58416275" charset="UTF-8"></script> 
<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://yangchao.me/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://yangchao.me/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://yangchao.me/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://yangchao.me/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://yangchao.me/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://yangchao.me/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://yangchao.me/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://yangchao.me/js/utils.js"></script>
<script type="text/javascript" src="http://yangchao.me/js/motion.js"></script>
<script type="text/javascript" src="http://yangchao.me/js/affix.js"></script>
<script type="text/javascript" src="http://yangchao.me/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://yangchao.me/js/scrollspy.js"></script>
<script type="text/javascript" src="http://yangchao.me/js/post-details.js"></script>
<script type="text/javascript" src="http://yangchao.me/js/toc.js"></script>

<script type="text/javascript" src="http://yangchao.me/js/bootstrap.js"></script>

<script type="text/javascript" src="http://yangchao.me/js/search.js"></script>
</body>
</html>